{"pages":[{"title":"About","text":"","link":"/about/index.html"}],"posts":[{"title":"Hello World","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new &quot;My New Post&quot; More info: Writing Run server1$ hexo server More info: Server Generate static files1$ hexo generate More info: Generating Deploy to remote sites1$ hexo deploy More info: Deployment","link":"/2019/03/hello-world/"},{"title":"Icarus ä¸»é¢˜è‡ªå®šä¹‰ï¼ˆåŸºäº2.xï¼‰","text":"æœ¬æ–‡æ˜¯åŸºäºicarus 2.xçš„ç‰ˆæœ¬ï¼Œicarusä»3.0å¼€å§‹ä½¿ç”¨jsxé‡å†™äº†ï¼ŒæŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬ã€‚ æœ¬åšå®¢æ‰€é€‰å–çš„ä¸»é¢˜æ˜¯ Icarus ï¼Œå¹¶åšäº†ä¸€äº›ä¸ªæ€§åŒ–çš„ä¿®æ”¹ï¼Œå¾ˆå¤šä¿®æ”¹éƒ½å¯ä»¥ç›´è§‚çš„çœ‹åˆ°ã€‚è¯¦ç»†çš„å·®å¼‚å¯ä»¥æŸ¥çœ‹ diffï¼Œè¿™é‡Œè®°å½•ä¸€äº›ä¸»è¦çš„æ”¹åŠ¨ã€‚ æ³¨: å¯ä»¥é€šè¿‡å˜é‡ page.layout æ¥åˆ¤æ–­å½“å‰é¡µé¢ç±»å‹ï¼Œ'post' è¡¨ç¤ºå½“å‰æ˜¯æ–‡ç« é¡µé¢ï¼Œå…·ä½“å¯å‚è€ƒ hexo æ–‡æ¡£ã€‚ å¸ƒå±€æ–‡ç« é¡µé¢ä¸¤æ å¸ƒå±€ä¸»é¢˜é»˜è®¤æ˜¯ä¸‰æ å¸ƒå±€ï¼Œå¹¶ä¸”æ˜¾ç¤ºäº†å¾ˆå¤šçš„ widget ï¼Œä½†åœ¨é˜…è¯»æ–‡ç« æ—¶æ˜¾å¾—æœ‰äº›æ‹¥æŒ¤ã€‚å› æ­¤åœ¨æ–‡ç« é¡µé¢ï¼Œä¿®æ”¹ä¸ºä¸¤æ å¸ƒå±€ï¼Œå¹¶æ˜¾ç¤ºç‰¹å®šçš„ widgetã€‚ diff:includes/helpers/layout.js12345678910 const widgets = hexo.extend.helper.get('get_config').bind(this)('widgets');- return widgets.filter(widget =&gt; widget.hasOwnProperty('position') &amp;&amp; widget.position === position);+ if (this.page.layout !== 'post') {+ return widgets.filter(widget =&gt; widget.hasOwnProperty('position') &amp;&amp; widget.position === position);+ }+ if (position === 'left') {+ return widgets.filter(widget =&gt; widget.hasOwnProperty('position') &amp;&amp; (widget.type === 'toc' || widget.type === 'profile'));+ } else {+ return []+ } å¯ä»¥å‚è€ƒä¸Šè¿°ä»£ç ï¼Œå³å¯å®ç°ä¸åŒé¡µé¢ä¸åŒ widgetã€‚ ä½†ä¸¤æ æ•´ä½“å®½åº¦è·Ÿä¸‰æ ä¸åŒã€‚å› æ­¤å¼ºåˆ¶æŒ‡å®šä¸ºä¸‰æ å¸ƒå±€ï¼Œå¹¶ä¸”ä¿®æ”¹ç›¸åº”çš„å®½åº¦ï¼Œè¿™æ ·æ‰€æœ‰çš„é¡µé¢ä¾§è¾¹æ å®½åº¦ä¿æŒä¸€è‡´ã€‚ diff:layout/common/widget.ejs123456 &lt;% function side_column_class() { switch (column_count()) { case 2:- return 'is-4-tablet is-4-desktop is-4-widescreen';+ return 'is-4-tablet is-4-desktop is-3-widescreen'; case 3: diff:layout/layout.ejs12345678910-&lt;body class=&quot;is-&lt;%= column_count() %&gt;-column&quot;&gt;+&lt;body class=&quot;is-3-column&quot;&gt; &lt;%- partial('common/navbar', { page }) %&gt; &lt;% function main_column_class() { switch (column_count()) { case 1: return 'is-12'; case 2:- return 'is-8-tablet is-8-desktop is-8-widescreen';+ return 'is-8-tablet is-8-desktop is-9-widescreen'; å¹¶ä¿®æ”¹åœ¨ä¸åŒå±å¹•å°å¤§ä¸‹çš„å®½åº¦ diff:source/css/style.styl12345678910111213 .is-2-column .container max-width: screen-desktop - 2 * gap width: screen-desktop - 2 * gap+ .is-3-column .container+ max-width: screen-widescreen - gap+ width: screen-widescreen - gap @media screen and (min-width: screen-fullhd)+ .is-3-column .container+ max-width: screen-fullhd - 2 * gap+ width: screen-fullhd - 2 * gap .is-2-column .container max-width: screen-widescreen - 2 * gap width: screen-widescreen - 2 * gap ä¼˜åŒ–æ–‡ç« æ ‡é¢˜å¸ƒå±€æ ‡é¢˜ç§»åŠ¨åˆ°æ–‡ç« ä¿¡æ¯ä¸Šæ–¹ï¼Œå¢åŠ æ›´æ–°æ—¶é—´ï¼Œå¹¶å¢åŠ äº†iconã€‚ diff:layout/common/article.ejs1234567891011121314151617 &lt;div class=&quot;card-content article &lt;%= post.hasOwnProperty('direction') ? post.direction : '' %&gt;&quot;&gt;+ &lt;h1 class=&quot;title is-size-3 is-size-4-mobile has-text-weight-normal&quot;&gt;+ &lt;% if (index) { %&gt;+ &lt;a class=&quot;has-link-black-ter&quot; href=&quot;&lt;%- url_for(post.link ? post.link : post.path) %&gt;&quot;&gt;&lt;i class=&quot;fas fa-angle-double-right&quot;&gt;&lt;/i&gt;&lt;%= post.title %&gt;&lt;/a&gt;+ &lt;% } else { %&gt;+ &lt;i class=&quot;fas fa-angle-double-right&quot;&gt;&lt;/i&gt;&lt;%= post.title %&gt;+ &lt;% } %&gt;+ &lt;/h1&gt; &lt;% if (post.layout != 'page') { %&gt; &lt;div class=&quot;level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto&quot;&gt; &lt;div class=&quot;level-left&quot;&gt;- &lt;time class=&quot;level-item has-text-grey&quot; datetime=&quot;&lt;%= date_xml(post.date) %&gt;&quot;&gt;&lt;%= date(post.date) %&gt;&lt;/time&gt;+ &lt;time class=&quot;level-item has-text-grey&quot; datetime=&quot;&lt;%= date_xml(post.date) %&gt;&quot;&gt;&lt;i class=&quot;far fa-calendar-alt&quot;&gt;&amp;nbsp;&lt;/i&gt;&lt;%= date(post.date) %&gt;&lt;/time&gt;+ &lt;% if (post.updated &amp;&amp; post.updated &gt; post.date) { %&gt;+ &lt;time class=&quot;level-item has-text-grey is-hidden-mobile&quot; datetime=&quot;&lt;%= date_xml(post.updated) %&gt;&quot;&gt;&lt;i class=&quot;far fa-calendar-check&quot;&gt;&amp;nbsp;&lt;/i&gt;&lt;%= date(post.updated) %&gt;&lt;/time&gt;+ &lt;% } %&gt; &lt;% if (post.categories &amp;&amp; post.categories.length) { %&gt; å…¶ä¸­åˆ›å»ºæ—¶é—´ä½¿ç”¨æ—¥æœŸã€‚ diff:source/js/main.js12345- if (typeof(moment) === 'function') {- $('.article-meta time').each(function () {- $(this).text(moment($(this).attr('datetime')).fromNow());- });- } ä¼˜åŒ–æ–‡ç« ç»“å°¾å¸ƒå±€åœ¨æ–‡ç« ç»“å°¾å¢åŠ ä¸€ä¸ª hrï¼Œå¹¶ä¿®æ”¹ tags å±•ç¤ºã€‚åœ¨é¢„è§ˆæ—¶ä¹Ÿæ˜¾ç¤º tagsï¼Œå¹¶ä¸”å°† Read More æŒ‰é’®æ”¾ç½®åœ¨å³è¾¹ã€‚ diff:layout/common/article.ejs123456789101112131415161718192021222324252627282930313233343536 &lt;% if (!index &amp;&amp; post.tags &amp;&amp; post.tags.length) { %&gt;+ &lt;hr style=&quot;height:1px;margin:1rem 0&quot;/&gt; &lt;div class=&quot;level is-size-7 is-uppercase&quot;&gt; &lt;div class=&quot;level-start&quot;&gt; &lt;div class=&quot;level-item&quot;&gt;- &lt;span class=&quot;is-size-6 has-text-grey has-mr-7&quot;&gt;#&lt;/span&gt;+ &lt;i class=&quot;fas fa-tags has-text-grey&quot;&gt;&lt;/i&gt;&amp;nbsp; &lt;%- list_tags(post.tags, { class: 'has-link-grey ', show_count: false,- style: 'link'+ style: 'link',+ separator: ',&amp;nbsp;' }) %&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; &lt;% } %&gt; &lt;% if (index &amp;&amp; post.excerpt) { %&gt;- &lt;div class=&quot;level is-mobile&quot;&gt;+ &lt;hr style=&quot;height:1px;margin:1rem 0&quot;/&gt;+ &lt;div class=&quot;level is-mobile is-flex&quot;&gt;+ &lt;div class=&quot;level-start&quot;&gt;+ &lt;% if (post.tags &amp;&amp; post.tags.length) { %&gt;+ &lt;div class=&quot;level-item is-size-7 is-uppercase&quot;&gt;+ &lt;i class=&quot;fas fa-tags has-text-grey&quot;&gt;&lt;/i&gt;&amp;nbsp;+ &lt;%- list_tags(post.tags, {+ class: 'has-link-grey ',+ show_count: false,+ style: 'link',+ separator: ',&amp;nbsp;'+ }) %&gt;+ &lt;/div&gt;+ &lt;% } %&gt;+ &lt;/div&gt; &lt;div class=&quot;level-start&quot;&gt; ä¼˜åŒ–ä¸ªäººä¿¡æ¯å¸ƒå±€å‡å°‘å¤´åƒå¤§å°ï¼Œå¤´åƒä¸‹æ–¹è®¡æ•°çš„åœ°æ–¹å¢åŠ é“¾æ¥ï¼Œfollowå‰å¢åŠ iconã€‚ diff:layout/widget/profile.ejs1234567- &lt;nav class=&quot;level is-mobile&quot;&gt;+ &lt;nav class=&quot;level menu-list is-mobile&quot; style=&quot;margin-bottom:1rem&quot;&gt; &lt;div class=&quot;level-item has-text-centered is-marginless&quot;&gt;- &lt;div&gt;+ &lt;a href=&quot;&lt;%- url_for('/archives/') %&gt;&quot;&gt; &lt;p class=&quot;heading&quot;&gt;...... ä¼˜åŒ–ç§»åŠ¨ç«¯æ˜¾ç¤ºåœ¨ç§»åŠ¨ç«¯ï¼Œéšè— archive å’Œ tagcloudã€‚ diff:layout/widget/archive.ejs12-&lt;div class=&quot;card widget&quot;&gt;+&lt;div class=&quot;card widget is-hidden-mobile&quot;&gt; diff:layout/widget/tagcloud.ejs12-&lt;div class=&quot;card widget&quot;&gt;+&lt;div class=&quot;card widget is-hidden-mobile&quot;&gt; ç›®å½•ç²˜æ€§å¸ƒå±€å¢åŠ  column-left is-sticky ç±»ã€‚ diff:layout/widget/toc.ejs12-&lt;div class=&quot;card widget&quot; id=&quot;toc&quot;&gt;+&lt;div class=&quot;card widget column-left is-sticky&quot; id=&quot;toc&quot;&gt; åŠŸèƒ½å¢åŠ ç‰ˆæƒè¯´æ˜diff:layout/common/article.ejs1234567891011121314 &lt;div class=&quot;content&quot;&gt; &lt;%- index &amp;&amp; post.excerpt ? post.excerpt : post.content %&gt; &lt;/div&gt;+ &lt;% if (!index &amp;&amp; post.layout === 'post' &amp;&amp; post.copyright !== false) { %&gt;+ &lt;ul class=&quot;post-copyright&quot;&gt;+ &lt;li&gt;&lt;strong&gt;æœ¬æ–‡æ ‡é¢˜ï¼š&lt;/strong&gt;&lt;a href=&quot;&lt;%= post.permalink %&gt;&quot;&gt;&lt;%= page.title %&gt;&lt;/a&gt;&lt;/li&gt;+ &lt;li&gt;&lt;strong&gt;æœ¬æ–‡ä½œè€…ï¼š&lt;/strong&gt;&lt;a href=&quot;&lt;%= theme.url %&gt;&quot;&gt;&lt;%= theme.author %&gt;&lt;/a&gt;&lt;/li&gt;+ &lt;li&gt;&lt;strong&gt;æœ¬æ–‡é“¾æ¥ï¼š&lt;/strong&gt;&lt;a href=&quot;&lt;%= post.permalink %&gt;&quot;&gt;&lt;%= post.permalink %&gt;&lt;/a&gt;&lt;/li&gt;+ &lt;li&gt;&lt;strong&gt;å‘å¸ƒæ—¶é—´ï¼š&lt;/strong&gt;&lt;%= post.date.format(&quot;YYYY-MM-DD&quot;) %&gt;&lt;/li&gt;+ &lt;li&gt;&lt;strong&gt;ç‰ˆæƒå£°æ˜ï¼š&lt;/strong&gt;æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ &lt;a href=&quot;https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh&quot; rel=&quot;external nofollow&quot; target=&quot;_blank&quot;&gt;CC BY-NC-SA 4.0&lt;/a&gt; è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼+ &lt;/li&gt;+ &lt;/ul&gt;+ &lt;% } %&gt; &lt;% if (!index &amp;&amp; post.tags &amp;&amp; post.tags.length) { %&gt; å¹¶å¢åŠ æ ·å¼ diff:source/css/style.styl12345678+.post-copyright+ font-size: 1rem+ letter-spacing: 0.02rem+ word-break: break-all+ margin: 2.5rem 0 0+ padding: 1rem 1rem+ border-left: 3px solid #FF1700+ background-color: #F9F9F9 å¢åŠ æ ‡é¢˜è‡ªåŠ¨è®¡æ•°diff:source/css/style.styl1234567+.article {counter-reset:section}+.article h2{counter-reset:sub-section}+.article h3{counter-reset:composite}+.article h4{counter-reset:detail}+.article h2:before{content:counter(section) &quot; &quot;;counter-increment:section}+.article h3:before{content:counter(section) &quot;.&quot; counter(sub-section) &quot; &quot;;counter-increment:sub-section}+.article h4:before{content:counter(section) &quot;.&quot; counter(sub-section) &quot;.&quot; counter(composite) &quot; &quot;;counter-increment:composite} é»˜è®¤æ˜¾ç¤ºç›®å½•æ­£å¸¸å¼€å¯ç›®å½•éœ€è¦åœ¨ meta ä¿¡æ¯ä¸­åŠ å…¥ toc: true å¼€å¯ï¼Œä½†ç»å¤§éƒ¨åˆ†æ–‡ç« éƒ½æ˜¯æœ‰ç›®å½•çš„ï¼Œå› æ­¤ä¿®æ”¹ä¸ºé»˜è®¤å¼€å¯ã€‚å› ä¸ºæœ‰å¤šä¸ªåœ°æ–¹å¼•ç”¨äº† get_config('toc') å¹¶ä¸”éœ€è¦åˆ¤æ–­å½“å‰é¡µé¢ï¼Œæ”¹èµ·æ¥ç¨å¾®éº»çƒ¦ä¸€äº›ï¼Œå› æ­¤ç›´æ¥ä¿®æ”¹äº† get_config æ–¹æ³•ã€‚ diff:includes/helpers/config.js1234567 return defaultValue; } else { const property = readProperty(specs, configName);- return property === null ? null : property[descriptors.defaultValue];+ const result = property === null ? null : property[descriptors.defaultValue];+ return (configName === 'toc' &amp;&amp; this.page.layout === 'post' &amp;&amp; result === null) ? true : result; } é¡µé¢footeræ˜¾ç¤ºä¸€ç»„iconé»˜è®¤æƒ…å†µä¸‹ä¸€ä¸ªiconå¯¹åº”ä¸€ä¸ªé“¾æ¥ï¼Œä½†ä¾‹å¦‚ CC BY-NC-SA 4.0 éœ€è¦å››ä¸ªå›¾æ ‡ä¸€ç»„ã€‚å› æ­¤ä¿®æ”¹ä»£ç ï¼Œä½¿å¾—é…ç½® link.icon å¯ä»¥æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•ˆæœå¯ä»¥å‚è€ƒé¡µé¢åº•éƒ¨ã€‚ diff:layout/common/footer.ejs1234 &lt;% } else { %&gt;- &lt;i class=&quot;&lt;%= link.icon %&gt;&quot;&gt;&lt;/i&gt;+ &lt;% for (let icon of (Array.isArray(link.icon) ? link.icon : [link.icon])) { %&gt;&lt;i class=&quot;&lt;%= icon %&gt;&quot;&gt;&lt;/i&gt;&amp;nbsp;&lt;% } %&gt; &lt;% } %&gt; diff:includes/specs/icon_link.spec.js12345 icon: { [required]: true,- [type]: 'string',+ [type]: ['string', 'array'], [doc]: 'Link icon class names' _config.yml ä¸­é…ç½®å¦‚ä¸‹ _config.yml123456789footer: links: CC BY-NC-SA 4.0: icon: - fab fa-creative-commons - fab fa-creative-commons-by - fab fa-creative-commons-nc - fab fa-creative-commons-sa url: 'https://creativecommons.org/licenses/by-nc-sa/4.0/' å¯ä»¥é…ç½®æ–‡ç« å¼€å¤´æ˜¯å¦æ˜¾ç¤ºå›¾ç‰‡Icarus æ”¯æŒæ–‡ç« è®¾ç½®ä¸€ä¸ªå›¾ç‰‡ï¼Œåœ¨æ–‡ç« å¼€å¤´ã€æœ€è¿‘çš„æ–‡ç« ã€æ—¶é—´çº¿ç­‰åœ°æ–¹æ˜¾ç¤ºã€‚ä½†æœ‰äº›å›¾æ”¾å¤§ä¹‹åä¼šæ˜¾å¾—å¾ˆä¸åè°ƒï¼Œå› æ­¤ä¿®æ”¹ä»¥æ”¯æŒè‡ªå®šä¹‰æ˜¯å¦æ˜¾ç¤ºã€‚ä¿®æ”¹ has_thumbnail æ–¹æ³•ï¼Œå¢åŠ å‚æ•° isArticle å‚æ•°ï¼Œé»˜è®¤ falseï¼Œå¹¶åœ¨æ–‡ç« é¡µé¢ä¿®æ”¹è°ƒç”¨å‚æ•°ã€‚ diff:includes/helpers/page.js1234567891011- hexo.extend.helper.register('has_thumbnail', function (post) {+ hexo.extend.helper.register('has_thumbnail', function (post, isArticle = false) { const getConfig = hexo.extend.helper.get('get_config').bind(this); const allowThumbnail = getConfig('article.thumbnail', true); if (!allowThumbnail) { return false; }+ if (isArticle &amp;&amp; post['article-thumbnail'] === false){+ return false;+ } return post.hasOwnProperty('thumbnail') &amp;&amp; post.thumbnail; diff:layout/common/article.ejs1234 &lt;div class=&quot;card&quot;&gt;- &lt;% if (has_thumbnail(post)) { %&gt;+ &lt;% if (has_thumbnail(post, true)) { %&gt; &lt;div class=&quot;card-image&quot;&gt; è¿™æ ·ä¿®æ”¹ä¹‹åï¼Œå¦‚æœæ–‡ç«  meta ä¿¡æ¯ä¸­åŒ…å« article-thumbnail: falseï¼Œå°±å¯ä»¥å–æ¶ˆå›¾ç‰‡çš„æ˜¾ç¤ºã€‚ æ ·å¼ä¿®æ”¹ logo å’Œ faviconç”¨ Python è®¾è®¡ Logoï¼Œå¹¶å¾®è°ƒæ ·å¼ã€‚ æŒ‰é’®èƒŒæ™¯é¢œè‰²å¢åŠ æ¸å˜diff:source/css/style.styl123456 .menu-list li ul margin-right: 0+ .menu-list a+ transition: background-color 0.3s ease-in-out .menu-list a.level display: flex card å¢åŠ æµ®åŠ¨æ•ˆæœ:hover æ—¶å¢å¤§é˜´å½±ï¼Œå¹¶å¢åŠ åŠ¨ç”»å±æ€§ ease-in-outã€‚ diff:source/css/style.styl12345 .card border-radius: 4px box-shadow: 0 4px 10px rgba(0,0,0,0.05), 0 0 1px rgba(0,0,0,0.1)+ &amp;:hover+ box-shadow: 0 6px 15px rgba(0,0,0,0.15), 0 0 1px rgba(0,0,0,0.1) diff:source/js/animation.js123 element.style.transform = '';- element.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';+ element.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out, box-shadow 0.3s ease-in-out'; æ›´æ–°2020-02-16 åˆå¹¶äº† 2.7.0 ç‰ˆæœ¬ï¼Œå†²çªä¸ç®—å¤ªå¤šï¼Œæœ‰ä¸¤ä¸ªç‚¹éœ€è¦æ³¨æ„ä¸€ä¸‹ã€‚ icarus çš„é…ç½®é‡Œé¢ï¼Œplugins.clipboard éœ€è¦ç§»é™¤ï¼Œç›¸å…³çš„é…ç½®ç§»åŠ¨åˆ° article.highlight.clipboardã€‚ _config.yml12345678910article: # Code highlight settings highlight: # Code highlight themes # https://github.com/highlightjs/highlight.js/tree/master/src/styles theme: github-gist # Show code copying button clipboard: true # Default folding status of the code blocks. Can be &quot;&quot;, &quot;folded&quot;, &quot;unfolded&quot; fold: unfolded å¦‚æœä¹‹å‰ links widget æ²¡æœ‰é…ç½®é“¾æ¥ï¼Œå¯èƒ½ä¼šé‡åˆ°ç¼–è¯‘é”™è¯¯ï¼Œéœ€è¦å¢åŠ ä¸€ä¸‹åˆ¤æ–­ã€‚ diff:layout/widget/links.locals.js12345 const links = get_config_from_obj(locals.widget, 'links');- if (Object.keys(links).length == 0) {+ if (!links || Object.keys(links).length == 0) { return null; } æ€»ç»“è¿™é‡Œåªåˆ—ä¸¾äº†éƒ¨åˆ†æ”¹åŠ¨ï¼Œè¯¦ç»†çš„å·®å¼‚å¯ä»¥æŸ¥çœ‹ diffã€‚ æœ¬æ–‡ä¼šæŒç»­æ›´æ–°ï¼Œä¿æŒè·Ÿæœ€æ–°çš„åšå®¢æ•ˆæœä¸€è‡´ï¼Œå¸Œæœ›èƒ½ç»™ä½ è‡ªå®šä¹‰ä¸»é¢˜ä¸€äº›å¸®åŠ©ã€‚ å¦‚æœæœ‰å…¶ä»–æƒ³æ³•æˆ–è€…æ„è§ï¼Œå¯ä»¥åœ¨ä¸‹æ–¹ç•™è¨€ã€‚ ğŸ˜Š","link":"/2019/03/customize-icarus-2/"},{"title":"Ubuntu å†…æ ¸å‡çº§","text":"Linux å†…æ ¸å¤§æ¦‚å‡ å¤©å°±ä¼šæœ‰ä¸€ä¸ªå°ç‰ˆæœ¬æ›´æ–°ï¼Œå‡ ä¸ªæœˆå°±ä¼šæœ‰ä¸€æ¬¡ä¸»è¦ç‰ˆæœ¬çš„æ›´æ–°ï¼Œä¾‹å¦‚ï¼š 2018-10-22 v4.19 2018-12-24 v4.20 2019-03-04 v5.0 2019-03-10 v5.0.1 2019-03-14 v5.0.2 2019-03-19 v5.0.3 ä¸ºäº†ä½¿ç”¨ä¸€äº›æ–°çš„ç‰¹æ€§ï¼Œæˆ–è€…ä¸ºäº†æå‡æ€§èƒ½å’Œå®‰å…¨æ€§ï¼Œæˆ–è€…åªæ˜¯ä¸ºäº†ä¿®å¤æŸäº›é—®é¢˜ï¼Œéœ€è¦å¯¹å†…æ ¸è¿›è¡Œå•ç‹¬å‡çº§ã€‚ The Linux Kernel ArchivesUbuntu Kernel Mainline å‡çº§å†…æ ¸æ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œä½†ä¸æ’é™¤å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œè¯·åˆç†è¯„ä¼°é£é™©ã€‚ æŸ¥çœ‹å½“å‰å†…æ ¸ç‰ˆæœ¬å¯ä»¥é€šè¿‡ uname æŸ¥çœ‹å½“å‰å†…æ ¸ç‰ˆæœ¬ï¼Œ 12$ uname -srLinux 4.4.0-92-generic æˆ–è€…è¾“å…¥ uname -a æŸ¥çœ‹å®Œæ•´ä¿¡æ¯ã€‚ Ubuntu å†…æ ¸å‡çº§æœ€å¥½æ˜¯å‡çº§åˆ°é•¿æœŸæ”¯æŒç‰ˆï¼ˆlongtermï¼‰æœ¬æˆ–è€…ç¨³å®šç‰ˆï¼ˆstableï¼‰ï¼Œå¯ä»¥åœ¨ The Linux Kernel ArchivesæŸ¥çœ‹å½“å‰çš„ç‰ˆæœ¬ï¼Œè¿™é‡Œä»¥ longterm: 4.19.36 ä¸ºä¾‹ã€‚ ä¹‹ååœ¨ Ubuntu Kernel Mainline æ‰¾åˆ°å¯¹åº”çš„ç‰ˆæœ¬å·ï¼Œhttps://kernel.ubuntu.com/~kernel-ppa/mainline/v4.19.36/ ã€‚ åœ¨å¯¹åº”çš„æ¶æ„Build for xxx succeededï¼Œä¸‹è½½ä¸åŒ…å« lowlatency çš„æ‰€æœ‰debæ–‡ä»¶ã€‚ä¾‹å¦‚åœ¨ x86_64 ä¸‹ï¼Œæ€»å…±éœ€è¦ä¸‹è½½4ä¸ªæ–‡ä»¶ã€‚ 1234linux-headers-4.19.36-041936_4.19.36-041936.201904200430_all.deblinux-headers-4.19.36-041936-generic_4.19.36-041936.201904200430_amd64.deblinux-image-unsigned-4.19.36-041936-generic_4.19.36-041936.201904200430_amd64.deblinux-modules-4.19.36-041936-generic_4.19.36-041936.201904200430_amd64.deb å®‰è£… 1sudo dpkg -i linux-*.deb é‡å¯ 1sudo reboot ç¡®è®¤å‡çº§æˆåŠŸ 12$ uname -srLinux 4.19.36-041936-generic è¿™é‡Œçœ‹åˆ°å†…æ ¸ç‰ˆæœ¬å·²ç»å‡çº§æˆåŠŸäº†ï¼Œå…¶ä»–ç‰ˆæœ¬æˆ–è€…æ¶æ„æ“ä½œä¹Ÿç±»ä¼¼ã€‚ åˆ é™¤æ—§çš„å†…æ ¸ç‰ˆæœ¬å¦‚æœç¡®å®è¦ç§»é™¤æ—§çš„å†…æ ¸ç‰ˆæœ¬ï¼Œå¯ä»¥é€šè¿‡è¯¥å‘½ä»¤æŸ¥çœ‹å·²ç»å®‰è£…çš„å†…æ ¸ç‰ˆæœ¬ï¼Œ 1dpkg --get-selections | grep linux ç„¶åç›´æ¥ä½¿ç”¨ apt-get purge åˆ é™¤æ—§ç‰ˆæœ¬çš„åŒ…ï¼ˆæœ‰æ˜ç¡®çš„ç‰ˆæœ¬å·ï¼‰ã€‚ æ€»ç»“è¿˜æœ‰ä¸€äº›å…¶ä»–æ–¹æ³•ï¼Œä¾‹å¦‚ç›´æ¥ç”¨ apt-get å‡çº§ï¼Œè¿˜æœ‰ä¸€äº›å·¥å…·ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ How to update kernel to the latest mainline version without any Distro-upgrade?","link":"/2019/04/kernel-update/"},{"title":"ç”¨ Python è®¾è®¡ Logo","text":"ç”¨ Python è®¾è®¡ä¸€ä¸ªç®€å•çš„ logo ã€‚ é¢„è§ˆlogo.svg favicon.svg ä»£ç ä»£ç åªä¾èµ– matplotlibã€‚ 12345678910111213141516171819202122232425262728293031import matplotlib.pyplot as pltlines = [[[1, 4], [5, 8.08]], [[1, 4], [5, 1.92]], [[5, 9], [2.96, 7.04]], [[5, 6.5], [7.04, 5.5]], [[8, 9], [4, 2.96]]]color = '#00a4ef'linewidth = 28# favicon.svgplt.figure(figsize=(4, 4))plt.axis('off')plt.axis([0, 10, 0, 10])for l in lines: plt.plot(l[0], l[1], color, linewidth=linewidth)plt.savefig('favicon.svg')# logo.svgplt.figure(figsize=(10, 4))plt.axis('off')plt.axis([0, 25, 0, 10])for l in lines: plt.plot(l[0], l[1], color, linewidth=linewidth)plt.text(11, 2, 'Lxy', fontsize=180)plt.savefig('logo.svg') SVG å‹ç¼©å‹ç¼©SVGå¯ä»¥å‡å°‘å›¾ç‰‡å¤§å°ï¼Œå°è¯•äº†å‡ ä¸ªåœ¨çº¿å‹ç¼©svgçš„ç½‘ç«™ï¼Œæ•ˆæœéƒ½ä¸å¤ªç†æƒ³ï¼Œä¸»è¦æ˜¯å½¢çŠ¶å¤„ç†ä¸å‡†ç¡®ï¼Œè·ŸåŸå›¾æ˜¾ç¤ºä¸ä¸€æ ·ã€‚åæ¥è¯•äº† https://vecta.io/nano æ•ˆæœéå¸¸å¥½è€Œä¸”å‹ç¼©ç‡ä¹Ÿä¸é”™ï¼Œä¸Šè¿°ä¸¤å¼ å›¾ç‰‡å‹ç¼©ç‡è¶…è¿‡ 60% ã€‚ æ›¿æ¢æœ¬åšå®¢ä½¿ç”¨çš„æ˜¯ icarus ä¸»é¢˜ï¼Œåœ¨ themes/icarus/source/img ç›®å½•ä¸‹æ›¿æ¢ favicon.svg å’Œ logo.svg å³å¯ï¼Œå…¶ä»–ä¸»é¢˜æ“ä½œä¹Ÿç±»ä¼¼ã€‚","link":"/2019/03/python-logo/"},{"title":"Icarus ä¸»é¢˜è‡ªå®šä¹‰","text":"æœ¬æ–‡æ˜¯åŸºäºicarus 4.xçš„ç‰ˆæœ¬ï¼Œicarusåœ¨2.0ä½¿ç”¨çš„æ˜¯ejsï¼Œå¦‚æœéœ€è¦è¯·æŸ¥çœ‹æ—§ç‰ˆæœ¬ã€‚ æœ¬åšå®¢æ‰€é€‰å–çš„ä¸»é¢˜æ˜¯ Icarus ï¼Œå¹¶åšäº†ä¸€äº›ä¸ªæ€§åŒ–çš„ä¿®æ”¹ï¼Œå¾ˆå¤šä¿®æ”¹éƒ½å¯ä»¥ç›´è§‚çš„çœ‹åˆ°ã€‚è¯¦ç»†çš„å·®å¼‚å¯ä»¥æŸ¥çœ‹ diffï¼Œè¿™é‡Œè®°å½•ä¸€äº›ä¸»è¦çš„æ”¹åŠ¨ã€‚ å¸ƒå±€æ–‡ç« é¡µé¢ä¸¤æ å¸ƒå±€ä¸»é¢˜é»˜è®¤æ˜¯ä¸‰æ å¸ƒå±€ï¼Œåœ¨é˜…è¯»æ–‡ç« æ—¶æ˜¾å¾—æœ‰äº›æ‹¥æŒ¤ã€‚å¯ä»¥é€šè¿‡é…ç½®çš„æ–¹å¼æŠŠæ‰€æœ‰æ–‡ç« å˜ä¸ºä¸¤æ å¸ƒå±€ï¼Œåœ¨_config.post.ymlæŠŠéœ€è¦çš„widgetæ˜¾ç¤ºåœ¨ä¸€è¾¹å³å¯ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚ ä½†ä¸¤æ æ•´ä½“å®½åº¦è·Ÿä¸‰æ ä¸åŒï¼Œå› æ­¤å¼ºåˆ¶æŒ‡å®šä¸ºä¸‰æ å¸ƒå±€ï¼Œå¹¶ä¸”ä¿®æ”¹ç›¸åº”çš„å®½åº¦ï¼Œè¿™æ ·æ‰€æœ‰çš„é¡µé¢ä¾§è¾¹æ å®½åº¦ä¿æŒä¸€è‡´ã€‚ diff:layout/layout.jsx1234 &lt;Head site={site} config={config} helper={helper} page={page} /&gt;- &lt;body class={`is-${columnCount}-column`}&gt;+ &lt;body class={`is-3-column`}&gt; &lt;Navbar config={config} helper={helper} page={page} /&gt; diff:layout/layout.jsx1234 'is-12': columnCount === 1,- 'is-8-tablet is-8-desktop is-8-widescreen': columnCount === 2,+ 'is-8-tablet is-8-desktop is-9-widescreen': columnCount === 2, 'is-8-tablet is-8-desktop is-6-widescreen': columnCount === 3 diff:layout/common/widgets.jsx12345678 function getColumnSizeClass(columnCount) { switch (columnCount) { case 2:- return 'is-4-tablet is-4-desktop is-4-widescreen';+ return 'is-4-tablet is-4-desktop is-3-widescreen'; case 3: return 'is-4-tablet is-4-desktop is-3-widescreen'; } å¹¶ä¼˜åŒ–åœ¨ä¸åŒå±å¹•å°å¤§ä¸‹çš„å®½åº¦ diff:include/style/responsive.styl1234567891011121314151617 +widescreen()+ .is-3-column .container+ max-width: $widescreen - $gap+ width: $widescreen - $gap+ .is-1-column .container, .is-2-column .container max-width: $desktop - 2 * $gap width: $desktop - 2 * $gap +fullhd()+ .is-3-column .container+ max-width: $fullhd - 2 * $gap+ width: $fullhd - 2 * $gap+ .is-2-column .container max-width: $widescreen - 2 * $gap width: $widescreen - 2 * $gap ä¼˜åŒ–æ–‡ç« æ ‡é¢˜å¸ƒå±€æ ‡é¢˜ç§»åŠ¨åˆ°æ–‡ç« ä¿¡æ¯ä¸Šæ–¹ï¼Œå¢åŠ æ›´æ–°æ—¶é—´ï¼Œå¹¶å¢åŠ äº†icon diff:layout/common/article.jsx123456789101112131415161718192021222324252627282930313233 &lt;article class={`card-content article${'direction' in page ? ' ' + page.direction : ''}`} role=&quot;article&quot;&gt; {/* Metadata */}+ {/* Title */}+ &lt;h1 className=&quot;title is-size-3 is-size-4-mobile has-text-weight-normal&quot;&gt;+ {index ?+ &lt;a className=&quot;has-link-black-ter&quot; href={url_for(page.link || page.path)}&gt;+ &lt;i className=&quot;fas fa-angle-double-right&quot;&gt;&lt;/i&gt;{page.title}+ &lt;/a&gt; :+ [&lt;i className=&quot;fas fa-angle-double-right&quot;&gt;&lt;/i&gt;, page.title]+ }+ &lt;/h1&gt; {page.layout !== 'page' ? &lt;div class=&quot;article-meta is-size-7 is-uppercase level is-mobile&quot;&gt; &lt;div class=&quot;level-left&quot;&gt; {/* Creation Date */}- {page.date &amp;&amp; &lt;span class=&quot;level-item&quot; dangerouslySetInnerHTML={{- __html: _p('article.created_at', `&lt;time dateTime=&quot;${date_xml(page.date)}&quot; title=&quot;${new Date(page.date).toLocaleString()}&quot;&gt;${date(page.date)}&lt;/time&gt;`)- }}&gt;&lt;/span&gt;}+ {page.date &amp;&amp; &lt;span class=&quot;level-item&quot;&gt;+ &lt;i className=&quot;far fa-calendar-alt&quot;&gt;&amp;nbsp;&lt;/i&gt;+ &lt;time dateTime={date_xml(page.date)} title={date_xml(page.date)}&gt;{date(page.date)}&lt;/time&gt;+ &lt;/span&gt;} {/* Last Update Date */}- {page.updated &amp;&amp; &lt;span class=&quot;level-item&quot; dangerouslySetInnerHTML={{- __html: _p('article.updated_at', `&lt;time dateTime=&quot;${date_xml(page.updated)}&quot; title=&quot;${new Date(page.updated).toLocaleString()}&quot;&gt;${date(page.updated)}&lt;/time&gt;`)- }}&gt;&lt;/span&gt;}+ {shouldShowUpdated &amp;&amp; &lt;span class=&quot;level-item is-hidden-mobile&quot;&gt;+ &lt;i class=&quot;far fa-calendar-check&quot;&gt;&amp;nbsp;&lt;/i&gt;+ &lt;time dateTime={date_xml(page.updated)} title={date_xml(page.updated)}&gt;{date(page.updated)}&lt;/time&gt;+ &lt;/span&gt;} {/* author */} {page.author ? &lt;span class=&quot;level-item&quot;&gt; {page.author} &lt;/span&gt; : null} å…¶ä¸­æ—¶é—´ç›´æ¥ä½¿ç”¨æ—¥æœŸ diff:source/js/main.js12345- if (typeof moment === 'function') {- $('.article-meta time').each(function() {- $(this).text(moment($(this).attr('datetime')).fromNow());- });- } ä¼˜åŒ–æ–‡ç« ç»“å°¾å¸ƒå±€åœ¨æ–‡ç« ç»“å°¾å¢åŠ ä¸€ä¸ª hrï¼Œå¹¶ä¿®æ”¹ tags å±•ç¤ºã€‚åœ¨é¢„è§ˆæ—¶ï¼ˆä¸»é¡µï¼‰ä¹Ÿæ˜¾ç¤º tagsï¼Œå¹¶ä¸”å°† Read More æŒ‰é’®æ”¾ç½®åœ¨å³è¾¹ã€‚ diff:layout/common/article.jsx123456789101112131415161718192021 {/* Licensing block */} {!index &amp;&amp; article &amp;&amp; article.licenses &amp;&amp; Object.keys(article.licenses) ? &lt;ArticleLicensing.Cacheable page={page} config={config} helper={helper} /&gt; : null}+ &lt;hr style=&quot;height:1px;margin:1rem 0&quot;/&gt;+ &lt;div className=&quot;level is-mobile is-flex&quot;&gt; {/* Tags */}- {!index &amp;&amp; page.tags &amp;&amp; page.tags.length ? &lt;div class=&quot;article-tags is-size-7 mb-4&quot;&gt;- &lt;span class=&quot;mr-2&quot;&gt;#&lt;/span&gt;- {page.tags.map(tag =&gt; {- return &lt;a class=&quot;link-muted mr-2&quot; rel=&quot;tag&quot; href={url_for(tag.path)}&gt;{tag.name}&lt;/a&gt;;+ {page.tags &amp;&amp; page.tags.length ? &lt;div class=&quot;article-tags is-size-7 is-uppercase&quot;&gt;+ &lt;i class=&quot;fas fa-tags has-text-grey&quot;&gt;&lt;/i&gt;&amp;nbsp;+ {page.tags.map((tag, index) =&gt; {+ return &lt;a class=&quot;link-muted&quot; rel=&quot;tag&quot; href={url_for(tag.path)}&gt;{tag.name}{index !== page.tags.length-1? ', ':''}&lt;/a&gt;; })} &lt;/div&gt; : null} {/* &quot;Read more&quot; button */}- {index &amp;&amp; page.excerpt ? &lt;a class=&quot;article-more button is-small is-size-7&quot; href={`${url_for(page.link || page.path)}#more`}&gt;{__('article.more')}&lt;/a&gt; : null}+ {index &amp;&amp; page.excerpt ? &lt;a class=&quot;article-more button is-small is-size-7&quot; href={`${url_for(page.link || page.path)}#more`}&gt;&lt;i class=&quot;fas fa-book-reader has-text-grey&quot;&gt;&lt;/i&gt;&amp;nbsp;&amp;nbsp;{__('article.more')}&lt;/a&gt; : null}+ &lt;/div&gt; {/* Share button */} ä¼˜åŒ–ä¸ªäººä¿¡æ¯å¸ƒå±€å‡å°‘å¤´åƒå¤§å°ï¼Œå¤´åƒä¸‹æ–¹è®¡æ•°çš„åœ°æ–¹å¢åŠ é“¾æ¥ï¼Œfollowå‰å¢åŠ iconã€‚ diff:layout/widget/profile.jsx123456789101112- &lt;div class=&quot;level-item has-text-centered is-marginless&quot;&gt;+ &lt;a class=&quot;level-item has-text-centered is-marginless&quot; href={counter.category.url}&gt; &lt;div&gt; &lt;p class=&quot;heading&quot;&gt;{counter.category.title}&lt;/p&gt;- &lt;a href={counter.category.url}&gt;+ &lt;div&gt; &lt;p class=&quot;title&quot;&gt;{counter.category.count}&lt;/p&gt;- &lt;/a&gt;+ &lt;/div&gt; &lt;/div&gt;- &lt;/div&gt;+ &lt;/a&gt; ä¼˜åŒ–ç§»åŠ¨ç«¯æ˜¾ç¤ºåœ¨ç§»åŠ¨ç«¯ï¼Œéšè— archive å’Œ tagsã€‚ diff:source/js/main.js12345 }++ $('div.container div.card[data-type=tags]').addClass('is-hidden-mobile');+ $('div.container div.card[data-type=archives]').addClass('is-hidden-mobile'); }(jQuery, window.moment, window.ClipboardJS, window.IcarusThemeSettings)); ç›®å½•ç²˜æ€§å®šä½åŸæ¥åªæ”¯æŒä¾§è¾¹æ æ•´ä½“ç²˜æ€§å®šä½ï¼Œä¸ºäº†é˜…è¯»ä½“éªŒï¼Œåªé’ˆå¯¹ç›®å½•å¼€å¯ç²˜æ€§å®šä½ï¼Œå¢åŠ  column-left is-sticky ç±»ï¼Œå¹¶è°ƒæ•´æ ·å¼ã€‚ diff:source/js/main.js123 if ($toc.length &gt; 0) {+ $toc.addClass('column-left is-sticky'); const $mask = $('&lt;div&gt;'); diff:include/style/widget.styl123+#toc+ max-height: calc(100vh - 22px)+ overflow-y: scroll åŠŸèƒ½å¢åŠ é»˜è®¤ç¼©ç•¥å›¾diff:layout/layout.jsx12345 const { site, config, page, helper, body } = this.props;+ site.posts &amp;&amp; site.posts.filter(p =&gt; !p.thumbnail).forEach(p =&gt; p.thumbnail = '/img/thumbnail.svg');+ const language = page.lang || page.language || config.language; diff:layout/archive.jsx12345 const { url_for, __, date_xml, date } = helper;+ page.posts &amp;&amp; page.posts.filter(p =&gt; !p.thumbnail).forEach(p =&gt; p.thumbnail = '/img/thumbnail.svg');+ const language = page.lang || page.language || config.language; å¢åŠ è®¸å¯åè®®æ–°ç‰ˆå·²ç»æ”¯æŒè®¸å¯åè®®ï¼Œç›´æ¥é…ç½®å³å¯ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚ å¢åŠ æ ‡é¢˜è‡ªåŠ¨è®¡æ•°diff:include/style/article.styl1234567+.article {counter-reset:section}+.article h2{counter-reset:sub-section}+.article h3{counter-reset:composite}+.article h4{counter-reset:detail}+.article h2:before{content:counter(section) &quot; &quot;;counter-increment:section}+.article h3:before{content:counter(section) &quot;.&quot; counter(sub-section) &quot; &quot;;counter-increment:sub-section}+.article h4:before{content:counter(section) &quot;.&quot; counter(sub-section) &quot;.&quot; counter(composite) &quot; &quot;;counter-increment:composite} é»˜è®¤æ˜¾ç¤ºç›®å½•æ–°ç‰ˆæ”¯æŒç›´æ¥é…ç½®ï¼Œåœ¨_config.ymlå¢åŠ toc: trueå³å¯ã€‚ é¡µé¢footeræ˜¾ç¤ºä¸€ç»„iconé»˜è®¤æƒ…å†µä¸‹ä¸€ä¸ªiconå¯¹åº”ä¸€ä¸ªé“¾æ¥ï¼Œä½†ä¾‹å¦‚ CC BY-NC-SA 4.0 éœ€è¦å››ä¸ªå›¾æ ‡ä¸€ç»„ã€‚å› æ­¤ä¿®æ”¹ä»£ç ï¼Œä½¿å¾—é…ç½® link.icon å¯ä»¥æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•ˆæœå¯ä»¥å‚è€ƒé¡µé¢åº•éƒ¨ã€‚ diff:layout/common/footer.jsx123456789101112 const link = links[name]; return &lt;p class=&quot;control&quot;&gt; &lt;a class={`button is-transparent ${link.icon ? 'is-large' : ''}`} target=&quot;_blank&quot; rel=&quot;noopener&quot; title={name} href={link.url}&gt;- {link.icon ? &lt;i class={link.icon}&gt;&lt;/i&gt; : name}+ {link.icon ?+ (Array.isArray(link.icon) ?+ link.icon.map(i =&gt; [&lt;i className={i}&gt;&lt;/i&gt;, '\\u00A0']) :+ &lt;i className={link.icon}&gt;&lt;/i&gt;+ ) : name} &lt;/a&gt; &lt;/p&gt;; })} å¿½ç•¥æ ¡éªŒçš„schema diff:include/schema/common/footer.json1- &quot;$ref&quot;: &quot;/misc/poly_links.json&quot;, _config.yml ä¸­é…ç½®å¦‚ä¸‹ _config.yml123456789footer: links: CC BY-NC-SA 4.0: icon: - fab fa-creative-commons - fab fa-creative-commons-by - fab fa-creative-commons-nc - fab fa-creative-commons-sa url: 'https://creativecommons.org/licenses/by-nc-sa/4.0/' æ ·å¼ä¿®æ”¹ logo å’Œ faviconç”¨ Python è®¾è®¡ Logoï¼Œå¹¶å¾®è°ƒæ ·å¼ã€‚ æŒ‰é’®èƒŒæ™¯é¢œè‰²å¢åŠ æ¸å˜diff:include/style/widget.styl123456789 .widget .menu-list li ul margin-right: 0+ a+ transition: background-color 0.3s ease-in-out .level margin-bottom: 0 card å¢åŠ æµ®åŠ¨æ•ˆæœ:hover æ—¶å¢å¤§é˜´å½±ï¼Œå¹¶å¢åŠ åŠ¨ç”»å±æ€§ ease-in-outã€‚ diff:include/style/card.styl12345 .card overflow: visible border-radius: $card-radius+ &amp;:hover+ box-shadow: 0 6px 15px rgba(0,0,0,0.15), 0 0 1px rgba(0,0,0,0.1) diff:source/js/animation.js123456 setTimeout(() =&gt; { $('body &gt; .navbar, body &gt; .section, body &gt; .footer').forEach(element =&gt; { element.style.opacity = '1';- element.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';+ element.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out, box-shadow 0.3s ease-in-out'; }); diff:source/js/animation.js1234 element.style.transform = '';- element.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';+ element.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out, box-shadow 0.3s ease-in-out'; }, i * 100); ä¿®æ”¹tagçš„é¢œè‰²diff:include/style/widget.styl1234567891011 .tags .tag:first-child- background: $primary- color: $primary-invert+ background: whitesmoke+ color: #4a4a4a .tag:last-child- background: $light-grey+ background: #e7e7e7 color: $white-invert æ›´æ–°2020-12-04 åŸºäº 4.1.1 ç‰ˆæœ¬é‡æ–°æ”¹åŠ¨ã€‚2021-09-06 åˆå¹¶ 4.4.0ï¼Œå®˜æ–¹ä¹Ÿæ”¯æŒæ–‡ç«  licensesé…ç½®å¤šä¸ªå›¾æ ‡ï¼Œä¸è¿‡ç›®å‰è¿˜æ˜¯è‡ªå·±å®ç°çš„ã€‚ æ€»ç»“è¿™é‡Œåªåˆ—ä¸¾äº†éƒ¨åˆ†æ”¹åŠ¨ï¼Œè¯¦ç»†çš„å·®å¼‚å¯ä»¥æŸ¥çœ‹ diffã€‚ æœ¬æ–‡ä¼šæŒç»­æ›´æ–°ï¼Œä¿æŒè·Ÿæœ€æ–°çš„åšå®¢æ•ˆæœä¸€è‡´ï¼Œå¸Œæœ›èƒ½ç»™ä½ è‡ªå®šä¹‰ä¸»é¢˜ä¸€äº›å¸®åŠ©ã€‚ å¦‚æœæœ‰å…¶ä»–æƒ³æ³•æˆ–è€…æ„è§ï¼Œå¯ä»¥åœ¨ä¸‹æ–¹ç•™è¨€ã€‚","link":"/2019/03/customize-icarus/"},{"title":"Quine è‡ªäº§ç”Ÿç¨‹åº â€” Java","text":"Quine ä»¥å“²å­¦å®¶å¥æ©ï¼ˆWillard Van Orman Quineï¼‰å‘½åï¼ŒæŒ‡çš„æ˜¯è¾“å‡ºç»“æœä¸ºç¨‹åºè‡ªèº«æºç çš„ç¨‹åºï¼Œä¹Ÿç§°ä¸º è‡ªäº§ç”Ÿç¨‹åºã€‚æœ‰ç‚¹ç±»ä¼¼äºä»£ç ä¸­çš„ä¸åŠ¨ç‚¹ï¼Œä¸¾ä¸€ä¸ªä¾‹å­ quine.py1exec(s:='print(&quot;exec(s:=%r)&quot;%s)') é‚£ä¹ˆä»¥ä¸‹å‘½ä»¤å…¨éƒ¨è¾“å‡º exec(s:='print(&quot;exec(s:=%r)&quot;%s)') 123python quine.pypython -c $(python quine.py)python -c $(python -c $(python quine.py)) ç†è®ºä¸Šå›¾çµå®Œå¤‡çš„è¯­è¨€éƒ½å¯ä»¥æ„é€ å‡º Quineï¼Œé‚£ä¹ˆå¦‚ä½•åœ¨ Java ä¸­æ„é€ å‘¢ï¼Ÿ ç»´åŸºç™¾ç§‘çš„ä¾‹å­ä¸‹é¢çš„ä¾‹å­æ¥è‡ªç»´åŸºç™¾ç§‘ https://en.wikipedia.org/wiki/Quine_(computing) 12345678910111213141516171819202122232425262728293031public class Quine{ public static void main(String[] args) { char q = 34; // Quotation mark character String[] l = { // Array of source code &quot;public class Quine&quot;, &quot;{&quot;, &quot; public static void main(String[] args)&quot;, &quot; {&quot;, &quot; char q = 34; // Quotation mark character&quot;, &quot; String[] l = { // Array of source code&quot;, &quot; &quot;, &quot; };&quot;, &quot; for(int i = 0; i &lt; 6; i++) // Print opening code&quot;, &quot; System.out.println(l[i]);&quot;, &quot; for(int i = 0; i &lt; l.length; i++) // Print string array&quot;, &quot; System.out.println(l[6] + q + l[i] + q + ',');&quot;, &quot; for(int i = 7; i &lt; l.length; i++) // Print this code&quot;, &quot; System.out.println(l[i]);&quot;, &quot; }&quot;, &quot;}&quot;, }; for(int i = 0; i &lt; 6; i++) // Print opening code System.out.println(l[i]); for(int i = 0; i &lt; l.length; i++) // Print string array System.out.println(l[6] + q + l[i] + q + ','); for(int i = 7; i &lt; l.length; i++) // Print this code System.out.println(l[i]); }} å¤§æ¦‚çš„åŸç†æ˜¯ï¼ˆæ˜¯ä¸€ä¸ªé€šç”¨çš„æ¨¡å¼ï¼‰ åœ¨ä»£ç ä¸­é¢„ç•™ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€è¡Œä»£ç  å…ˆè¾“å‡ºä»£ç åˆ°æ•°ç»„ä¹‹å‰ String[] l = { çš„è¡Œ å†è¾“å‡ºæ•°ç»„ï¼ˆéœ€è¦å¤„ç†ç¼©è¿›ï¼‰ å†è¾“å‡ºå‰©ä¸‹çš„è¡Œ æœ€åæŠŠè¿™ä¸ªä»£ç ç²˜è´´åˆ°æ•°ç»„ä¸­ è¿˜æœ‰ä¸€ä¸ª Java 15 åŠä»¥ä¸Šï¼ˆtext blocksï¼‰çš„ä¾‹å­ 1234567891011121314151617public class Quine { public static void main(String[] args) { String textBlockQuotes = new String(new char[]{'&quot;', '&quot;', '&quot;'}); char newLine = 10; String source = &quot;&quot;&quot;public class Quine { public static void main(String[] args) { String textBlockQuotes = new String(new char[]{'&quot;', '&quot;', '&quot;'}); char newLine = 10; String source = %s; System.out.print(source.formatted(textBlockQuotes + newLine + source + textBlockQuotes)); }}&quot;&quot;&quot;; System.out.print(source.formatted(textBlockQuotes + newLine + source + textBlockQuotes)); }} è½¬ä¹‰å­—ç¬¦ä¸Šé¢çš„ä¾‹å­æ˜¯é€šè¿‡ %s æ›¿æ¢è‡ªèº«ä»£ç æ¥å®Œæˆçš„ï¼Œä¹‹å‰çš„ Java ç‰ˆæœ¬ä¸­éœ€è¦å¯¹æ¢è¡Œå’ŒåŒå¼•å·è¿›è¡Œè½¬ä¹‰ã€‚æŒ‰ç…§è¿™ä¸ªæ€è·¯å¯ä»¥æ›¿æ¢æˆå¦‚ä¸‹å®ç°ï¼ˆé€šè¿‡ char è·³è¿‡è½¬ä¹‰ï¼‰ 1234567891011121314151617public class Quine { public static void main(String[] args) { char quote = 34; char[] replace = {92,'n',34,10,32,32,32,32,32,32,32,32,32,32,32,32,'+',32,34}; String source = &quot;public class Quine {\\n&quot; + &quot; public static void main(String[] args) {\\n&quot; + &quot; char quote = 34;\\n&quot; + &quot; char[] replace = {92,'n',34,10,32,32,32,32,32,32,32,32,32,32,32,32,'+',32,34};\\n&quot; + &quot; String source = %s;\\n&quot; + &quot; String self = source.replace(String.valueOf((char)10), new String(replace));\\n&quot; + &quot; System.out.print(String.format(source, quote + self + quote));\\n&quot; + &quot; }\\n&quot; + &quot;}&quot;; String self = source.replace(String.valueOf((char)10), new String(replace)); System.out.print(String.format(source, quote + self + quote)); }} ä»£ç ä¼šæœ‰ç‚¹éº»çƒ¦ï¼ˆä¸ºäº†ä¿ç•™æ ¼å¼ï¼‰ï¼Œä¸Šé¢ replace ä»£ç ç›¸å½“äº 1source.replace(&quot;\\n&quot;, &quot;\\\\n\\&quot;\\n + \\&quot;&quot;) å¦‚æœä¸è€ƒè™‘æ ¼å¼å’Œæ¢è¡Œçš„è¯ï¼ˆåªèƒ½å†™åœ¨ä¸€è¡Œäº†ï¼‰ 1class Q{public static void main(String[]a){String s=&quot;class Q{public static void main(String[]a){String s=%c%s%1$c;System.out.printf(s,34,s);}}&quot;;System.out.printf(s,34,s);}} è¿™é‡Œè¿˜æœ‰æ›´å¤šçš„ä¾‹å­ http://www.nyx.net/~gthompso/self_java.txt ã€‚ è¿˜æœ‰ä¸€ç§æ›´åŠ é€šç”¨çš„æ–¹æ¡ˆï¼Œé€šè¿‡ç¼–ç çš„æ–¹å¼ç»•è¿‡è½¬ä¹‰å­—ç¬¦çš„å½±å“ï¼Œå‚è€ƒ https://www.zhihu.com/question/22006572/answer/47923822 å…ˆå†™ä¸€ä¸ªé€šç”¨çš„ä»£ç  1234567public class Quine { public static void main(String[] args) { String s = &quot;__&quot;; // é€šè¿‡ URLDecoder System.out.println(java.net.URLDecoder.decode(s).replaceFirst(&quot;__&quot;, s)); }} ç„¶åæŠŠä¸Šé¢çš„ä»£ç é€šè¿‡ URLEncoder ç¼–ç ï¼Œç„¶åæ›¿æ¢å¼•å·é‡Œé¢ 1234567public class Quine { public static void main(String[] args) { String s = &quot;public+class+Quine+%7B%0A++++public+static+void+main%28String%5B%5D+args%29+%7B%0A++++++++String+s+%3D+%22__%22%3B%0A++++++++%2F%2F+%E9%80%9A%E8%BF%87+URLDecoder%0A++++++++System.out.println%28java.net.URLDecoder.decode%28s%29.replaceFirst%28%22__%22%2C+s%29%29%3B%0A++++%7D%0A%7D&quot;; // é€šè¿‡ URLDecoder System.out.println(java.net.URLDecoder.decode(s).replaceFirst(&quot;__&quot;, s)); }} åŒç† 1234567public class Quine { public static void main(String[] args) { String s = &quot;cHVibGljIGNsYXNzIFF1aW5lIHsKICAgIHB1YmxpYyBzdGF0aWMgdm9pZCBtYWluKFN0cmluZ1tdIGFyZ3MpIHsKICAgICAgICBTdHJpbmcgcyA9ICJfXyI7CiAgICAgICAgLy8g6YCa6L+HIEJhc2U2NAogICAgICAgIFN5c3RlbS5vdXQucHJpbnRsbihuZXcgU3RyaW5nKGphdmEudXRpbC5CYXNlNjQuZ2V0RGVjb2RlcigpLmRlY29kZShzKSkucmVwbGFjZUZpcnN0KCJfXyIsIHMpKTsKICAgIH0KfQ==&quot;; // é€šè¿‡ Base64 System.out.println(new String(java.util.Base64.getDecoder().decode(s)).replaceFirst(&quot;__&quot;, s)); }} Ouroboros programs div.ouroboros > div { display: inline-block; vertical-align: top; width: 49%; } public class Quine{ public static void main(String[] args) { char q = 34; String[] l = { &quot; &quot;, &quot;=============&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; C++ Code &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;=============&quot;, &quot;#include &lt;iostream&gt;&quot;, &quot;#include &lt;string&gt;&quot;, &quot;using namespace std;&quot;, &quot;&quot;, &quot;int main(int argc, char* argv[])&quot;, &quot;{&quot;, &quot; char q = 34;&quot;, &quot; string l[] = {&quot;, &quot; };&quot;, &quot; for(int i = 20; i &lt;= 25; i++)&quot;, &quot; cout &lt;&lt; l[i] &lt;&lt; endl;&quot;, &quot; for(int i = 0; i &lt;= 34; i++)&quot;, &quot; cout &lt;&lt; l[0] + q + l[i] + q + ',' &lt;&lt; endl;&quot;, &quot; for(int i = 26; i &lt;= 34; i++)&quot;, &quot; cout &lt;&lt; l[i] &lt;&lt; endl;&quot;, &quot; return 0;&quot;, &quot;}&quot;, &quot;=============&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; Java Code &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;==========&quot;, &quot;public class Quine&quot;, &quot;{&quot;, &quot; public static void main( String[] args )&quot;, &quot; {&quot;, &quot; char q = 34;&quot;, &quot; String[] l = {&quot;, &quot; };&quot;, &quot; for(int i = 2; i &lt;= 9; i++)&quot;, &quot; System.out.println(l[i]);&quot;, &quot; for(int i = 0; i &lt; l.length; i++)&quot;, &quot; System.out.println( l[0] + q + l[i] + q + ',' );&quot;, &quot; for(int i = 10; i &lt;= 18; i++))&quot;, &quot; System.out.println(l[i]);&quot;, &quot; }&quot;, &quot;}&quot;, }; for(int i = 2; i &lt;= 9; i++) System.out.println(l[i]); for(int i = 0; i &lt; l.length; i++) System.out.println( l[0] + q + l[i] + q + ',' ); for(int i = 10; i &lt;= 18; i++) System.out.println(l[i]); }} #include &lt;iostream&gt;#include &lt;string&gt;using namespace std;int main(int argc, char* argv[]){ char q = 34; string l[] = { &quot; &quot;, &quot;=============&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; C++ Code &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;=============&quot;, &quot;#include &lt;iostream&gt;&quot;, &quot;#include &lt;string&gt;&quot;, &quot;using namespace std;&quot;, &quot;&quot;, &quot;int main(int argc, char* argv[])&quot;, &quot;{&quot;, &quot; char q = 34;&quot;, &quot; string l[] = {&quot;, &quot; };&quot;, &quot; for(int i = 20; i &lt;= 25; i++)&quot;, &quot; cout &lt;&lt; l[i] &lt;&lt; endl;&quot;, &quot; for(int i = 0; i &lt;= 34; i++)&quot;, &quot; cout &lt;&lt; l[0] + q + l[i] + q + ',' &lt;&lt; endl;&quot;, &quot; for(int i = 26; i &lt;= 34; i++)&quot;, &quot; cout &lt;&lt; l[i] &lt;&lt; endl;&quot;, &quot; return 0;&quot;, &quot;}&quot;, &quot;=============&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; Java Code &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;=============&quot;, &quot;public class Quine&quot;, &quot;{&quot;, &quot; public static void main(String[] args)&quot;, &quot; {&quot;, &quot; char q = 34;&quot;, &quot; String[] l = {&quot;, &quot; };&quot;, &quot; for(int i = 2; i &lt;= 9; i++)&quot;, &quot; System.out.println( l[i] );&quot;, &quot; for(int i = 0; i &lt; l.length; i++)&quot;, &quot; System.out.println(l[0] + q + l[i] + q + ',');&quot;, &quot; for(int i = 10; i &lt;= 18; i++)&quot;, &quot; System.out.println(l[i]);&quot;, &quot; }&quot;, &quot;}&quot;, }; for(int i = 20; i &lt;= 25; i++) cout &lt;&lt; l[i] &lt;&lt; endl; for(int i = 0; i &lt;= 34; i++) cout &lt;&lt; l[0] + q + l[i] + q + ',' &lt;&lt; endl; for(int i = 26; i &lt;= 34; i++) cout &lt;&lt; l[i] &lt;&lt; endl; return 0;} è¿™ä¸ªä¾‹å­æ¥è‡ªç»´åŸºç™¾ç§‘ https://en.wikipedia.org/wiki/Quine_(computing) ä¸¤æ®µä»£ç ç»“æ„ä¸Šéå¸¸ç›¸ä¼¼ï¼Œè€Œä¸”è·Ÿç¬¬ä¸€ä¸ªä¾‹å­ä¹Ÿå¾ˆåƒã€‚Java çš„ä»£ç è¾“å‡º C++ çš„ä»£ç ï¼ŒC++ çš„ä»£ç è¾“å‡º Java çš„ä»£ç ï¼Œå¾ªç¯ç”Ÿæˆã€‚ ä¹Ÿå¯ä»¥ç”¨ä¸Šé¢å ä½ç¬¦çš„æ€è·¯ï¼Œè¿™é‡Œæ¼”ç¤ºå¤šä¸ª Java ä»£ç ç›¸äº’ç”Ÿæˆçš„ä¾‹å­ï¼Œclass A -&gt; class B -&gt; class C 123456789101112131415public class A { public static void main(String[] args) { String s = &quot;public+class A+%7B%0A++++public+static+void+main%28String%5B%5D+args%29+%7B%0A++++++++String+s+%3D+%22__%22%3B%0A++++++++String+code+%3D+java.net.URLDecoder.decode%28s%29.replaceFirst%28%22__%22%2C+s%29%3B%0A++++++++String+a+%3D+%22class+%22+%2B+%22A%22%3B%0A++++++++String+b+%3D+%22class+%22+%2B+%22B%22%3B%0A++++++++String+c+%3D+%22class+%22+%2B+%22C%22%3B%0A++++++++if+%28code.contains%28a%29%29+%7B%0A++++++++++++code+%3D+code.replaceAll%28a%2C+b%29%3B%0A++++++++%7D+else+if+%28code.contains%28b%29%29+%7B%0A++++++++++++code+%3D+code.replaceAll%28b%2C+c%29%3B%0A++++++++%7D%0A++++++++System.out.println%28code%29%3B%0A++++%7D%0A%7D&quot;; String code = java.net.URLDecoder.decode(s).replaceFirst(&quot;__&quot;, s); String a = &quot;class &quot; + &quot;A&quot;; String b = &quot;class &quot; + &quot;B&quot;; String c = &quot;class &quot; + &quot;C&quot;; if (code.contains(a)) { code = code.replaceAll(a, b); } else if (code.contains(b)) { code = code.replaceAll(b, c); } System.out.println(code); }} å…¶ä»–è¯­è¨€çš„ä¾‹å­ä¸‹é¢çš„ä¾‹å­æ¥è‡ª https://rosettacode.org/wiki/Quine C12#include &lt;stdio.h&gt;int main(){char*c=&quot;#include &lt;stdio.h&gt;%cint main(){char*c=%c%s%c;printf(c,10,34,c,34,10);return 0;}%c&quot;;printf(c,10,34,c,34,10);return 0;} Go12345678package main import &quot;fmt&quot; func main() { a := &quot;package main\\n\\nimport \\&quot;fmt\\&quot;\\n\\nfunc main() {\\n\\ta := %q\\n\\tfmt.Printf(a, a)\\n}\\n&quot; fmt.Printf(a, a)} JavaScript1(f=_=&gt;`(f=${f})()`)() Quine Relayhttps://github.com/mame/quine-relay This is a Ruby program that generates Rust program that generates Scala program that generates â€¦(through 128 languages in total)â€¦ REXX program that generates the original Ruby code again. å¤šç§è¯­è¨€çš„ Quine å¾ªç¯ï¼Œ Ruby -&gt; Rust -&gt; Scala -&gt; ... -&gt; Ruby æœ€ç»ˆç”Ÿæˆè·ŸåŸæ¥ç›¸åŒçš„ Ruby ç¨‹åºï¼Œä¸€å…± 128 ç§è¯­è¨€ã€‚åŸç†å¯ä»¥å‚è€ƒ https://www.zhihu.com/question/21568155 ã€‚ å‚è€ƒhttps://en.wikipedia.org/wiki/Quine_(computing)http://www.nyx.net/~gthompso/quine.htmhttps://www.zhihu.com/question/22006572https://github.com/mame/quine-relayhttps://rosettacode.org/wiki/Quine","link":"/2021/09/quine-java/"},{"title":"Java è¿›é˜¶ â€” ç±»åŠ è½½æœºåˆ¶","text":"ç±»åŠ è½½æœºåˆ¶æ˜¯ Java æŠ€æœ¯ä½“ç³»ä¸­éå¸¸æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œè´Ÿè´£æŠŠ class æ–‡ä»¶åŠ è½½åˆ° JVMã€‚ ç±»åŠ è½½å™¨å¯ä»¥è¯´æ˜¯ Java è¯­è¨€çš„ä¸€é¡¹åˆ›æ–°ï¼Œå®ƒæ˜¯æ—©æœŸ Java è¯­è¨€èƒ½å¤Ÿå¿«é€Ÿæµè¡Œçš„é‡è¦åŸå› ä¹‹ä¸€ã€‚ç±»åŠ è½½å™¨æœ€åˆæ˜¯ä¸ºäº†æ»¡è¶³ Java Applet çš„éœ€æ±‚è€Œè®¾è®¡å‡ºæ¥çš„ï¼Œåœ¨ä»Šå¤©ç”¨åœ¨æµè§ˆå™¨ä¸Šçš„ Java Applet æŠ€æœ¯åŸºæœ¬ä¸Šå·²ç»è¢«æ·˜æ±°ï¼Œä½†ç±»åŠ è½½å™¨å´åœ¨ç±»å±‚æ¬¡åˆ’åˆ†ã€OSGiã€ç¨‹åºçƒ­éƒ¨ç½²ã€ä»£ç åŠ å¯†ç­‰é¢†åŸŸå¤§æ”¾å¼‚å½©ï¼Œæˆä¸º Java æŠ€æœ¯ä½“ç³»ä¸­ä¸€å—é‡è¦çš„åŸºçŸ³ï¼Œå¯è°“æ˜¯å¤±ä¹‹æ¡‘æ¦†ï¼Œæ”¶ä¹‹ä¸œéš…ã€‚ â€”â€”ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹ å¼€å§‹ä¹‹å‰å…ˆæŠ›å‡ºäº”ä¸ªé—®é¢˜ï¼Œçœ‹çœ‹èƒ½å¦ç»™å‡ºå‡†ç¡®çš„å›ç­” å¦‚ä½•å¯åŠ¨ä¸€ä¸ª Java åº”ç”¨ï¼ŸJVM å¯åŠ¨çš„æ—¶å€™æ˜¯å¦‚ä½•æŸ¥æ‰¾ç±»çš„ï¼Ÿ æ˜¯å…ˆæœ‰çš„ Class è¿˜æ˜¯å…ˆæœ‰çš„ ClassLoaderï¼ŸJVM å¯åŠ¨çš„æ—¶å€™æ˜¯å¦‚ä½•å¤„ç† ClassLoader çš„ï¼Ÿ ClassLoader çš„å±‚æ¬¡ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„ï¼ŸåŒäº²å§”æ´¾æ¨¡å‹æ˜¯ä»€ä¹ˆï¼ŸcontextClassLoader æ˜¯ä»€ä¹ˆï¼Ÿ ç±»åŠ è½½è¿‡ç¨‹ä¸­ä¼šé‡åˆ°å“ªäº›é”™è¯¯ Error æˆ–è€…å¼‚å¸¸ Exceptionï¼ŸNoClassDefFoundError å’Œ ClassNotFoundException åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦è‡ªå®šä¹‰ ClassLoaderï¼Ÿå¦‚ä½•è‡ªå®šä¹‰ ClassLoaderï¼Ÿ Java åº”ç”¨å¯åŠ¨æ— è®ºæ˜¯é€šè¿‡ä»€ä¹ˆè„šæœ¬å¯åŠ¨è¿˜æ˜¯åœ¨ IDE é‡Œé¢ç›´æ¥æ‰§è¡Œï¼Œæœ€ç»ˆéƒ½æ˜¯é€šè¿‡æ‰§è¡Œ java å‘½ä»¤ã€‚ IDEA å¯åŠ¨åº”ç”¨çš„ç¬¬ä¸€è¡Œæ—¥å¿— mvn å‘½ä»¤ï¼Œå…¶å®æ˜¯ä¸ªè„šæœ¬ apache-maven-3.6.3/bin/mvn12345678910111213141516# ...# Provide a &quot;standardized&quot; way to retrieve the CLI args that will# work with both Windows and non-Windows executions.MAVEN_CMD_LINE_ARGS=&quot;$MAVEN_CONFIG $@&quot;export MAVEN_CMD_LINE_ARGSexec &quot;$JAVACMD&quot; \\ $MAVEN_OPTS \\ $MAVEN_DEBUG_OPTS \\ -classpath &quot;${CLASSWORLDS_JAR}&quot; \\ &quot;-Dclassworlds.conf=${MAVEN_HOME}/bin/m2.conf&quot; \\ &quot;-Dmaven.home=${MAVEN_HOME}&quot; \\ &quot;-Dlibrary.jansi.path=${MAVEN_HOME}/lib/jansi-native&quot; \\ &quot;-Dmaven.multiModuleProjectDirectory=${MAVEN_PROJECTBASEDIR}&quot; \\ ${CLASSWORLDS_LAUNCHER} &quot;$@&quot; æ¥çœ‹ä¸€ä¸‹ java å‘½ä»¤çš„å¸®åŠ© 12345$ java -helpUsage: java [-options] class [args...] (to execute a class) or java [-options] -jar jarfile [args...] (to execute a jar file) æ–‡æ¡£ä¸­å¯¹äº Java å¯åŠ¨æ—¶ç±»æŸ¥æ‰¾çš„è¯´æ˜ https://docs.oracle.com/javase/8/docs/technotes/tools/findingclasses.html How the Java Launcher Finds Classes The Java launcher, java, initiates the Java virtual machine. The virtual machine searches for and loads classes in this order: Bootstrap classes - Classes that comprise the Java platform, including the classes in rt.jar and several other important jar files. Extension classes - Classes that use the Java Extension mechanism. These are bundled as .jar files located in the extensions directory. User classes - Classes defined by developers and third parties that do not take advantage of the extension mechanism. div.inline-code-gray code { color: steelblue !important } How the Java Launcher Finds User Classes User classes are classes which build on the Java platform. To find user classes, the launcher refers to the user class path â€“ a list of directories, JAR archives, and ZIP archives which contain class files.A class file has a subpath name that reflects the classâ€™s fully-qualified name. For example, if the class com.mypackage.MyClass is stored under /myclasses, then /myclasses must be in the user class path and the full path to the class file must be /myclasses/com/mypackage/MyClass.class. If the class is stored in an archive named myclasses.jar, then myclasses.jar must be in the user class path, and the class file must be stored in the archive as com/mypackage/MyClass.class.The user class path is specified as a string, with a colon (:) separating the class path entries on Solaris, and a semi-colon (;) separating entries on Microsoft Windows systems. The java launcher puts the user class path string in the java.class.path system property. The possible sources of this value are: The default value, â€œ.â€, meaning that user class files are all the class files in the current directory (or under it, if in a package). The value of the CLASSPATH environment variable, which overrides the default value. The value of the -cp or -classpath command line option, which overrides both the default value and the CLASSPATH value. The JAR archive specified by the -jar option, which overrides all other values. If this option is used, all user classes must come from the specified archive. IDE å’Œ mavenIDE ä¼šé€šè¿‡ maven æ’ä»¶ï¼Œè§£æé¡¹ç›®æ¨¡å—ï¼Œè®¡ç®— classpathï¼Œæœ€ç»ˆé€šè¿‡ -classpath å½±å“å¯åŠ¨ï¼Œæ‰€ä»¥ä¿®æ”¹ä¾èµ–çš„æ—¶å€™éœ€è¦é‡æ–°åŠ è½½é¡¹ç›®ã€‚ IDE å¤šæ¨¡å—çš„ classpathæ¯ä¸ªæ¨¡å—çš„ classpath æ˜¯ç‹¬ç«‹è®¡ç®—çš„ï¼Œåœ¨ä¸åŒæ¨¡å—å¯åŠ¨ main æ–¹æ³•çš„çš„æ—¶å€™ -classpath å‚æ•°æ˜¯ä¸åŒçš„ï¼Œä¾‹å¦‚æœ‰ä¸¤ä¸ªæ¨¡å— A Bï¼ŒA ä¾èµ– B å’Œç¬¬ä¸‰æ–¹ C.jar , B ä¾èµ–ç¬¬ä¸‰æ–¹ D.jar 1234Aâ”œâ”€â”€ C.jarâ””â”€â”€ B â””â”€â”€D.jar æœ€ç»ˆå¯åŠ¨ A ä¸­çš„ main æ–¹æ³•ï¼ˆä¼šæŒ‡å‘å¯¹åº”æ¨¡å—çš„ target/classes ç›®å½•ï¼‰ 1java -classpath ${é¡¹ç›®}/A/target/classes:${é¡¹ç›®}/B/target/classes:${ä»“åº“}/C.jar:${ä»“åº“}/D.jar ... å¦‚æœæ˜¯å¯åŠ¨ B ä¸­çš„ main æ–¹æ³•ï¼ˆæ­¤æ—¶æ˜¯æ‰¾ä¸åˆ° A ä¸­å®šä¹‰ç±»çš„ï¼‰ 1java -classpath ${é¡¹ç›®}/B/target/classes:${ä»“åº“}/D.jar ... Spring åŒ…æ‰«æä¸ classpath çš„å…³ç³»Spring åªèƒ½æ‰«æç±»åŠ è½½èƒ½åŠ è½½åˆ°çš„ç±»ï¼Œå¯ä»¥ç®€å•è®¤ä¸ºå°±æ˜¯åªèƒ½åŠ è½½ classpath ä¸‹çš„ç±»ã€‚ Object Class ClassLoader (java.lang.*)ä»»ä½•å¯¹è±¡éƒ½æ˜¯ä¸€ä¸ªç±»çš„å®ä¾‹ï¼Œé‚£ä¹ˆ java.lang.String.class æ˜¯ä¸€ä¸ªå¯¹è±¡å—ï¼Ÿï¼ˆjava.lang.Class extend java.lang.Objectï¼‰ Class å®ä¾‹æ˜¯é€šè¿‡ ClassLoader çš„å®ä¾‹åŠ è½½çš„ï¼Œä½† ClassLoader å®ä¾‹æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥ä¹Ÿä¼šæœ‰ Classï¼Œä¸‹é¢è¿™å‡ ä¸ªå€¼æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ 1234Class.classClassLoader.classClass.class.getClassLoader()ClassLoader.class.getClassLoader() ä» JDK æºç çœ‹ç±»çš„åŠ è½½SystemDictionary ç®¡ç†äº†æ‰€æœ‰åŠ è½½çš„ç±» hotspot/src/share/vm/classfile/systemDictionary.hppsystemDictionary.hpp12345678class SystemDictionary : AllStatic { //... // Hashtable holding loaded classes. static Dictionary* _dictionary; //...} è€Œ Dictionary å°±æ˜¯ä¸€ä¸ª Hashtable hotspot/src/share/vm/classfile/dictionary.hppdictionary.hpp123class Dictionary : public TwoOopHashtable&lt;Klass*, mtClass&gt; { //...} å†æ¥çœ‹ä¸‹ Klass hotspot/src/share/vm/oops/klass.hppklass.hpp123456789// A Klass provides:// 1: language level class object (method dictionary etc.)// 2: provide vm dispatch behavior for the object// Both functions are combined into one C++ class.// ...class Klass : public Metadata { // ...} hotspot/src/share/vm/oops/instanceKlass.hppinstanceKlass.hpp123456789101112131415161718192021222324252627282930313233343536373839404142// An InstanceKlass is the VM level representation of a Java class.// It contains all information needed for at class at execution runtime.// InstanceKlass layout:// [C++ vtbl pointer ] Klass// [subtype cache ] Klass// [instance size ] Klass// [java mirror ] Klass// [super ] Klass// [access_flags ] Klass// [name ] Klass// [first subklass ] Klass// [next sibling ] Klass// [array klasses ]// [methods ]// [local interfaces ]// [transitive interfaces ]// [fields ]// [constants ]// [class loader ]// [source file name ]// [inner classes ]// [static field size ]// [nonstatic field size ]// [static oop fields size ]// [nonstatic oop maps size ]// [has finalize method ]// [deoptimization mark bit ]// [initialization state ]// [initializing thread ]// [Java vtable length ]// [oop map cache (stack maps) ]// [EMBEDDED Java vtable ] size in words = vtable_len// [EMBEDDED nonstatic oop-map blocks] size in words = nonstatic_oop_map_size// The embedded nonstatic oop-map blocks are short pairs (offset, length)// indicating where oops are located in instances of this klass.// [EMBEDDED implementor of the interface] only exist for interface// [EMBEDDED host klass ] only exist for an anonymous class (JSR 292 enabled)class InstanceKlass: public Klass { // ...} åœ¨ hotspot ä»£ç é‡Œé¢ Klass æ˜¯ç±»çš„åº•å±‚å®ç°ï¼Œç±»åŠ è½½æœ€ç»ˆçš„ç»“æœå°±æ˜¯åˆ›å»ºä¸€ä¸ª Klass ï¼ˆæˆ–å…¶å­ç±»ï¼‰å¯¹è±¡ï¼Œè€Œ SystemDictionary ç®¡ç†äº†æ‰€æœ‰çš„åŠ è½½çš„ç±»ã€‚ Java è™šæ‹Ÿæœºå¯åŠ¨æ¥çœ‹ä¸€ä¸‹ JVM å¯åŠ¨çš„æ—¶å€™è·Ÿ ClassLoader ç›¸å…³çš„ä¸»è¦æµç¨‹ï¼Œä» main æ–¹æ³•åˆ° java main æ–¹æ³• 12345678910111213141516171819main (jdk/src/share/bin/main.c)-&gt; JLI_Launch (jdk/src/share/bin/java.c) -&gt; LoadJavaVM (jdk/src/share/bin/java.c) // åŠ è½½åŠ¨æ€åº“æ‰¾åˆ°hotspotå®ç° -&gt; JVMInit (jdk/src/share/bin/java.c) -&gt; ContinueInNewThread (jdk/src/share/bin/java.c) -&gt; ContinueInNewThread0 (jdk/src/solaris/bin/java_md_solinux.c) -&gt; JavaMain (jdk/src/share/bin/java.c) -&gt; InitializeJVM (jdk/src/share/bin/java.c) -&gt; JNI_CreateJavaVM (hotspot/src/share/vm/prims/jni.cpp) -&gt; Threads::create_vm (hotspot/src/share/vm/runtime/thread.cpp) -&gt; init_globals (hotspot/src/share/vm/runtime/init.cpp) -&gt; universe2_init (hotspot/src/share/vm/runtime/universe.cpp) -&gt; Universe::genesis (hotspot/src/share/vm/runtime/universe.cpp) -&gt; SystemDictionary::initialize (hotspot/src/share/vm/classfile/systemDictionary.cpp) -&gt; SystemDictionary::initialize_preloaded_classes (hotspot/src/share/classfile/systemDictionary.cpp) -&gt; SystemDictionary::compute_java_system_loader (hotspot/src/share/classfile/systemDictionary.cpp) -&gt; LoadMainClass (jdk/src/share/bin/java.c) // åŠ è½½ MainClass -&gt; GetStaticMethodID (jdk/src/share/bin/java.c) // æ‰¾ main æ–¹æ³• -&gt; CallStaticVoidMethod (jdk/src/share/bin/java.c) // è°ƒç”¨ main æ–¹æ³• hotspot/src/share/vm/classfile/systemDictionary.hppsystemDictionary.hpp12345678910111213141516171819202122232425262728293031323334#define WK_KLASSES_DO(do_klass) \\ /* well-known classes */ \\ do_klass(Object_klass, java_lang_Object, Pre ) \\ do_klass(String_klass, java_lang_String, Pre ) \\ do_klass(Class_klass, java_lang_Class, Pre ) \\ do_klass(Cloneable_klass, java_lang_Cloneable, Pre ) \\ do_klass(ClassLoader_klass, java_lang_ClassLoader, Pre ) \\ do_klass(Serializable_klass, java_io_Serializable, Pre ) \\ do_klass(System_klass, java_lang_System, Pre ) \\ do_klass(Throwable_klass, java_lang_Throwable, Pre ) \\ do_klass(Error_klass, java_lang_Error, Pre ) \\ do_klass(ThreadDeath_klass, java_lang_ThreadDeath, Pre ) \\ do_klass(Exception_klass, java_lang_Exception, Pre ) \\ do_klass(RuntimeException_klass, java_lang_RuntimeException, Pre ) \\ do_klass(SecurityManager_klass, java_lang_SecurityManager, Pre ) \\ do_klass(ProtectionDomain_klass, java_security_ProtectionDomain, Pre ) \\ do_klass(AccessControlContext_klass, java_security_AccessControlContext, Pre ) \\ do_klass(ClassNotFoundException_klass, java_lang_ClassNotFoundException, Pre ) \\ do_klass(NoClassDefFoundError_klass, java_lang_NoClassDefFoundError, Pre ) \\ do_klass(LinkageError_klass, java_lang_LinkageError, Pre ) \\ do_klass(ClassCastException_klass, java_lang_ClassCastException, Pre ) \\ do_klass(ArrayStoreException_klass, java_lang_ArrayStoreException, Pre ) \\ do_klass(VirtualMachineError_klass, java_lang_VirtualMachineError, Pre ) \\ do_klass(OutOfMemoryError_klass, java_lang_OutOfMemoryError, Pre ) \\ do_klass(StackOverflowError_klass, java_lang_StackOverflowError, Pre ) \\ do_klass(IllegalMonitorStateException_klass, java_lang_IllegalMonitorStateException, Pre ) \\ do_klass(Reference_klass, java_lang_ref_Reference, Pre ) \\ \\ /* Preload ref klasses and set reference types */ \\ do_klass(SoftReference_klass, java_lang_ref_SoftReference, Pre ) \\ do_klass(WeakReference_klass, java_lang_ref_WeakReference, Pre ) \\ do_klass(FinalReference_klass, java_lang_ref_FinalReference, Pre ) \\ do_klass(PhantomReference_klass, java_lang_ref_PhantomReference, Pre ) \\ // ... hotspot/src/share/vm/classfile/systemDictionary.cppsystemDictionary.cpp123456789101112void SystemDictionary::initialize_preloaded_classes(TRAPS) { // ... initialize_wk_klasses_through(WK_KLASS_ENUM_NAME(Class_klass), scan, CHECK); // ... Universe::initialize_basic_type_mirrors(CHECK); // ... initialize_wk_klasses_through(WK_KLASS_ENUM_NAME(Reference_klass), scan, CHECK);. // ... initialize_wk_klasses_through(WK_KLASS_ENUM_NAME(PhantomReference_klass), scan, CHECK); // ... initialize_wk_klasses_until(WKID_LIMIT, scan, CHECK);} SystemClassLoaderé™¤äº† Bootstrap ClassLoader ä¹‹å¤–çš„ç±»åŠ è½½å™¨éƒ½æ˜¯åœ¨ Java ä»£ç é‡Œé¢å®šä¹‰çš„ï¼Œç³»ç»Ÿç±»åŠ è½½å™¨ ClassLoader.getSystemClassLoader() java.lang.ClassLoader123456789101112131415161718192021222324252627282930313233343536public abstract class ClassLoader { // ... // The class loader for the system // @GuardedBy(&quot;ClassLoader.class&quot;) private static ClassLoader scl; // Set to true once the system class loader has been set // @GuardedBy(&quot;ClassLoader.class&quot;) private static boolean sclSet; // ... @CallerSensitive public static ClassLoader getSystemClassLoader() { initSystemClassLoader(); if (scl == null) { return null; } SecurityManager sm = System.getSecurityManager(); if (sm != null) { checkClassLoaderPermission(scl, Reflection.getCallerClass()); } return scl; } private static synchronized void initSystemClassLoader() { if (!sclSet) { if (scl != null) throw new IllegalStateException(&quot;recursive invocation&quot;); sun.misc.Launcher l = sun.misc.Launcher.getLauncher(); // ... sclSet = true; } }} sun.misc.Launcher12345678910111213141516171819202122232425public class Launcher { // ... public Launcher() { // Create the extension class loader ClassLoader extcl; try { extcl = ExtClassLoader.getExtClassLoader(); } catch (IOException e) { throw new InternalError(&quot;Could not create extension class loader&quot;, e); } // Now create the class loader to use to launch the application try { loader = AppClassLoader.getAppClassLoader(extcl); } catch (IOException e) { throw new InternalError(&quot;Could not create application class loader&quot;, e); } // Also set the context class loader for the primordial thread. Thread.currentThread().setContextClassLoader(loader); // ... }} åŒæ—¶å¯ä»¥çœ‹åˆ° AppClassLoader çš„ parent æ˜¯ ExtClassLoaderï¼ŒåŒæ—¶ SystemClassLoader ä¹Ÿæ˜¯åœ¨ JVM åˆå§‹åŒ–çš„æ—¶å€™è¿›è¡Œåˆå§‹åŒ–çš„ hotspot/src/share/vm/classfile/systemDictionary.cppsystemDictionary.cpp1234567891011void SystemDictionary::compute_java_system_loader(TRAPS) { KlassHandle system_klass(THREAD, WK_KLASS(ClassLoader_klass)); JavaValue result(T_OBJECT); JavaCalls::call_static(&amp;result, KlassHandle(THREAD, WK_KLASS(ClassLoader_klass)), vmSymbols::getSystemClassLoader_name(), vmSymbols::void_classloader_signature(), CHECK); _java_system_loader = (oop)result.get_jobject();} MainClass çš„åŠ è½½jdk/src/share/bin/java.cjava.c12345678910111213141516171819202122232425262728int JNICALL JavaMain(void * _args){ // ... mainClass = LoadMainClass(env, mode, what); // ... mainID = (*env)-&gt;GetStaticMethodID(env, mainClass, &quot;main&quot;, &quot;([Ljava/lang/String;)V&quot;); // ... /* Invoke main method. */ (*env)-&gt;CallStaticVoidMethod(env, mainClass, mainID, mainArgs); // ...}static jclass LoadMainClass(JNIEnv *env, int mode, char *name){ // ... jclass cls = GetLauncherHelperClass(env); // ... // sun.launcher.LauncherHelper#checkAndLoadMain NULL_CHECK0(mid = (*env)-&gt;GetStaticMethodID(env, cls, &quot;checkAndLoadMain&quot;, &quot;(ZILjava/lang/String;)Ljava/lang/Class;&quot;)); str = NewPlatformString(env, name); result = (*env)-&gt;CallStaticObjectMethod(env, cls, mid, USE_STDERR, mode, str); // ... return (jclass)result;} sun.launcher.LauncherHelper123456789101112public enum LauncherHelper { private static final ClassLoader scloader = ClassLoader.getSystemClassLoader(); public static Class&lt;?&gt; checkAndLoadMain(boolean printToStderr, int mode, String what) { // ... mainClass = scloader.loadClass(cn); // ... return mainClass; }} å› æ­¤ MainClass æ˜¯ç”± ClassLoader.getSystemClassLoader() åŠ è½½çš„ ä¸€äº›ç»“è®º ä» hotspot çš„è§’åº¦æ¥è®²ï¼Œæ‰€æœ‰ç±»éƒ½æ˜¯é€šè¿‡ Klass å¯¹è±¡æ¥æè¿°çš„ ç±»æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µ Object.class != Object ç±»ï¼Œå¯ä»¥è¯´ Object.class ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæ˜¯ç”¨æ¥è¡¨ç¤ºåº•å±‚ï¼ˆC++ï¼‰Klass çš„ä¸€ä¸ªå¯¹è±¡ ä¸€å®šæ˜¯å…ˆæœ‰ç±»ï¼Œæ‰æœ‰å¯¹è±¡ã€‚ä¸€åˆ‡éƒ½æ˜¯å¯¹è±¡ï¼Œéƒ½ç»§æ‰¿è‡ªjava.lang.Objectï¼ˆé™¤äº†åŸºæœ¬ç±»å‹ï¼‰ åœ¨ JVM åŠ è½½çš„è¿‡ç¨‹ä¸­ï¼Œä¼šé¢„å…ˆåˆå§‹åŒ–ä¸€äº› Klass å¯¹è±¡ï¼ˆwell known classesï¼‰ï¼Œæ¥æè¿°å…·ä½“çš„ç±» æœ€æ—©åŠ è½½çš„å‡ ä¸ªç±»ï¼ˆæŒ‰ç…§é¡ºåºï¼‰java.lang.Object , java.lang.String , java.lang.Class , 9 ä¸ªåŸºæœ¬ç±»å‹ï¼ˆåŒ…å« Void.TYPEï¼‰, java.lang.Cloneable , java.lang.ClassLoader è¿™äº›ç±»æ˜¯é¢„åŠ è½½ï¼Œä¸éœ€è¦æœ‰ä¸€ä¸ª java.lang.ClassLoader çš„å®ä¾‹æ¥åŠ è½½ï¼Œè¿™ä¸ªæ—¶å€™ JVM éƒ½æ²¡æœ‰å®Œå…¨åˆå§‹åŒ– é»˜è®¤ä¼šæœ‰ä¸‰ä¸ª ClassLoaderï¼ŒBootstrap ClassLoader æ˜¯ C++å®ç°çš„ Class.class.getClassLoader() == null ï¼ˆBootstrap ClassLoader åœ¨ Java å±‚é¢å°±æ˜¯ nullï¼‰ ä¸»ç±»çš„ ClassLoader å°±æ˜¯ ClassLoader.getSystemClassLoader() Bootstrap ClassLoader çš„å­˜åœ¨æ˜¯ä¸€ä¸ªæ¯”è¾ƒè‡ªç„¶çš„äº‹æƒ…ï¼Œä¸éœ€è¦æ­»è®°ç¡¬èƒŒã€‚ ä¸‹é¢è¯­å¥åˆ†åˆ«è¾“å‡ºä»€ä¹ˆï¼Ÿ 12345678910public class Test { public static void main(String[] args) { System.out.println(Test.class.getClassLoader()); System.out.println(javax.sql.DataSource.class.getClassLoader()); System.out.println(String.class.getClassLoader()); System.out.println(ClassLoader.getSystemClassLoader()); System.out.println(ClassLoader.getSystemClassLoader().getParent()); System.out.println(ClassLoader.getSystemClassLoader().getParent().getParent()); }} å¯ä»¥è‡ªå·±è¯•ä¸€ä¸‹ï¼Œä¸åŒç‰ˆæœ¬ä¼šæœ‰å·®å¼‚ã€‚ ç±»çš„åŠ è½½ã€é“¾æ¥ã€åˆå§‹åŒ–é€šè¿‡ç±»çš„å…¨åï¼ˆbinary nameï¼‰è·å–äºŒè¿›åˆ¶æµåŠ è½½åˆ° JVMï¼Œå¹¶ç”Ÿæˆä¸€ä¸ª java.lang.Class å¯¹è±¡è¡¨ç¤ºè¿™ä¸ªç±»ã€‚ å›¾ç‰‡æ¥æºäºç½‘ç»œ æ¥çœ‹ä¸€ä¸‹ Java è™šæ‹Ÿæœºè§„èŒƒå…³äºç±»åŠ è½½çš„æè¿° https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-5.html How the Java Launcher Finds Classes The Java launcher, java, initiates the Java virtual machine. The virtual machine searches for and loads classes in this order: Bootstrap classes - Classes that comprise the Java platform, including the classes in rt.jar and several other important jar files. Extension classes - Classes that use the Java Extension mechanism. These are bundled as .jar files located in the extensions directory. User classes - Classes defined by developers and third parties that do not take advantage of the extension mechanism. ç°åœ¨æˆ‘ä»¬çŸ¥é“ï¼Œç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™ï¼Œä¸€å…±æœ‰ä¸‰ä¸ª ClassLoader Bootstrap ClassLoader (C++ null) ExtClassLoader (SystemDictionary::compute_java_system_loader æ—¶åˆå§‹åŒ–) AppClassLoader (SystemDictionary::compute_java_system_loader æ—¶åˆå§‹åŒ–) åç»­ ExtClassLoader æŒ‡ sun.misc.Launcher$ExtClassLoader ä¸€ä¸ªçš„å®ä¾‹ï¼ŒAppClassLoader æŒ‡ sun.misc.Launcher$AppClassLoader çš„ä¸€ä¸ªçš„å®ä¾‹ ç±»å‹åˆ¤æ–­ä¸¤ä¸ªç±»å‹æ˜¯å¦ç›¸ç­‰ï¼Œæ˜¯æŒ‡å…¨åï¼ˆbinary nameï¼‰ç›¸ç­‰ä¸”æ˜¯åŒä¸€ä¸ªç±»åŠ è½½å™¨å®ŒæˆåŠ è½½çš„ã€‚åŒ…æ‹¬å…¼å®¹æ€§åˆ¤æ–­ java.lang.Class.isAssignableFrom java.lang.Class.isInstance java.lang.Class.equals instanceof å…³é”®å­— ç±»å‹è½¬æ¢ é‚£ä¹ˆä¸åŒç±»åŠ è½½å™¨åœ¨åŠ è½½åŒä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œåº”è¯¥å¦‚ä½•å¤„ç† 123456789101112131415public class Test { public static void main(String[] args) throws ClassNotFoundException { String name = &quot;java.lang.Object&quot;; Class&lt;?&gt; objectClass1 = Object.class; Class&lt;?&gt; objectClass2 = ClassLoader.getSystemClassLoader().loadClass(name); Class&lt;?&gt; objectClass3 = new URLClassLoader(new URL[0]).loadClass(name); objectClass2.isAssignableFrom(Test.class); objectClass3.isInstance(new Test()); objectClass1.getClassLoader(); // null objectClass2.getClassLoader(); // ? objectClass3.getClassLoader(); // ? }} å¦‚æœæ¯ä¸ª ClassLoader éƒ½å»åŠ è½½ä¸€é java.lang.Object é‚£ä¹ˆä¸åŒç±»åŠ è½½åŠ è½½çš„ Class æ˜¯ä¸æ˜¯ç›¸ç­‰çš„ï¼Ÿå¦‚æœä¸æƒ³ç­‰å¯¹è±¡å°±æ²¡æœ‰åŠæ³•ç›¸äº’è½¬æ¢ï¼Œé‚£ä¹ˆæ•´ä¸ªç¨‹åºå°±ä¼šè¡¨ç°çš„å¾ˆå¥‡æ€ªï¼Œä»è¿™ä¸ªè§’åº¦ä¸Šè®² AppClassLoader å»åŠ è½½ Bootstrap classes ä¹Ÿåº”è¯¥æ˜¯ç”± Bootstrap ClassLoader åŠ è½½çš„ AppClassLoader å»åŠ è½½ Extension classes ä¹Ÿåº”è¯¥æ˜¯ç”± ExtClassLoader åŠ è½½çš„ ExtClassLoader å»åŠ è½½ Bootstrap classes ä¹Ÿåº”è¯¥æ˜¯ç”± Bootstrap ClassLoader åŠ è½½çš„ è¿™å°±æ˜¯ä¸€ä¸ªå§”æ‰˜ï¼ˆdelegationï¼‰çš„æ¨¡å‹ã€‚ åŒäº²å§”æ´¾æ¥çœ‹ä¸€ä¸‹ ClassLoader æ˜¯å¦‚ä½•åŠ è½½ä¸€ä¸ªç±»çš„https://docs.oracle.com/javase/8/docs/api/java/lang/ClassLoader.html The ClassLoader class uses a delegation model to search for classes and resources. Each instance of ClassLoader has an associated parent class loader. When requested to find a class or resource, a ClassLoader instance will delegate the search for the class or resource to its parent class loader before attempting to find the class or resource itself. The virtual machineâ€™s built-in class loader, called the â€œbootstrap class loaderâ€, does not itself have a parent but may serve as the parent of a ClassLoader instance. è¿™ä¸ªä¸€èˆ¬å°±ç§°ä¸ºåŒäº²å§”æ´¾æ¨¡å‹ï¼ˆParent Delegation Model ï¼‰ã€‚ è¿™ä¸ªåè¯çš„ç¿»è¯‘ä¸å¥½ï¼Œâ€œåŒâ€è¿™ä¸ªå­—ä¸æ˜¯å¾ˆå‡†ç¡® java.lang.ClassLoader12345678910111213public abstract class ClassLoader { private static native void registerNatives(); static { registerNatives(); } // The parent class loader for delegation // Note: VM hardcoded the offset of this field, thus all new fields // must be added *after* it. private final ClassLoader parent; // ...} å…¶ä¸­ AppClassLoader çš„ parent æ˜¯ ExtClassLoaderï¼ŒExtClassLoader çš„ parent æ˜¯ Bootstrap ClassLoaderï¼ˆnullï¼‰ï¼Œè¿™ä¸ªè·Ÿä¹‹å‰çš„ç†è§£æ˜¯ä¸€è‡´çš„ AppClassLoader å»åŠ è½½ Bootstrap classes ä¹Ÿåº”è¯¥æ˜¯ç”± Bootstrap ClassLoader åŠ è½½çš„ AppClassLoader å»åŠ è½½ Extension classes ä¹Ÿåº”è¯¥æ˜¯ç”± ExtClassLoader åŠ è½½çš„ ExtClassLoader å»åŠ è½½ Bootstrap classes ä¹Ÿåº”è¯¥æ˜¯ç”± Bootstrap ClassLoader åŠ è½½çš„ åŠ è½½ç±»å¯¹åº”çš„æ–¹æ³•https://docs.oracle.com/javase/8/docs/api/java/lang/ClassLoader.html#loadClass-java.lang.String-boolean- java.lang.ClassLoader123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051public abstract class ClassLoader { // ... protected Class&lt;?&gt; loadClass(String name, boolean resolve) throws ClassNotFoundException { synchronized (getClassLoadingLock(name)) { // First, check if the class has already been loaded Class&lt;?&gt; c = findLoadedClass(name); if (c == null) { long t0 = System.nanoTime(); try { if (parent != null) { c = parent.loadClass(name, false); } else { c = findBootstrapClassOrNull(name); } } catch (ClassNotFoundException e) { // ClassNotFoundException thrown if class not found // from the non-null parent class loader } if (c == null) { // If still not found, then invoke findClass in order // to find the class. // ... c = findClass(name); } } if (resolve) { resolveClass(c); } return c; } } // ... /** * Finds the class with the specified &lt;a href=&quot;#name&quot;&gt;binary name&lt;/a&gt;. * This method should be overridden by class loader implementations that * follow the delegation model for loading classes, and will be invoked by * the {@link #loadClass &lt;tt&gt;loadClass&lt;/tt&gt;} method after checking the * parent class loader for the requested class. The default implementation * throws a &lt;tt&gt;ClassNotFoundException&lt;/tt&gt;. */ protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException { throw new ClassNotFoundException(name); } // ...} å›¾ç‰‡æ¥æºäºç½‘ç»œ ä»ä¸Šé¢çš„ä»£ç æ¥çœ‹ï¼ŒåŒäº²å§”æ´¾çš„å®ç°æ—¶éå¸¸ç®€å•çš„ã€‚é‚£ä¸ºä»€ä¹ˆéœ€è¦åŒäº²å§”æ´¾ï¼Ÿæ€»æ„Ÿè§‰è¿™ä¸ªé—®é¢˜ä¸æ˜¯å¾ˆå¥½å›ç­”ï¼Œå› ä¸ºä»ä¸Šé¢çš„åˆ†ææ¥çœ‹ï¼Œå¦‚æœæ˜¯è¿™ä¸ª ClassLoader çš„æ¨¡å‹ï¼Œé‚£ä¹ˆåŒäº²å§”æ´¾å°±æ˜¯æ¯”è¾ƒè‡ªç„¶çš„æ–¹æ¡ˆ ä¿è¯ç±»çš„å”¯ä¸€æ€§ é¿å…é‡å¤åŠ è½½ å®‰å…¨ï¼Œæ ¸å¿ƒç±»ä¸ä¼šè¢«ç¯¡æ”¹ï¼ˆæ¯”å¦‚ -classpath ä¸­åŒ…å« java.lang.Objectï¼Œä½†å§”æ‰˜ç»™ Bootstrap ClassLoader ä¹‹åå°±åªèƒ½åŠ è½½é»˜è®¤çš„ç±»ï¼‰ ä¸ºäº†ä¿è¯å®‰å…¨æ€§ï¼Œjava. å¼€å¤´çš„ç±»æ˜¯ä¸èƒ½å»å®šä¹‰çš„ï¼ˆä¾‹å¦‚åœ¨ -classpath ä¸­åŒ…å« java.lang.Object2ï¼‰ java.lang.ClassLoader1234567891011private ProtectionDomain preDefineClass(String name, ProtectionDomain pd){ // ... // relies on the fact that spoofing is impossible if a class has a name // of the form &quot;java.*&quot; if ((name != null) &amp;&amp; name.startsWith(&quot;java.&quot;)) { throw new SecurityException(&quot;Prohibited package name: &quot; + name.substring(0, name.lastIndexOf('.'))); } // ...} è¿™é‡Œæœ‰å¯¹ä¸Šè¿°è¿‡ç¨‹æ›´è¯¦ç»†çš„è§£é‡Šhttps://docs.oracle.com/javase/8/docs/technotes/guides/security/spec/security-spec.doc5.html SPI ä¸ ContextClassLoaderæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ SPI 12345678public class Test { public static void main(String[] args) { Connection conn = DriverManager.getConnection(&quot;jdbc:mysql://localhost:3306/mysql&quot;, &quot;root&quot;, &quot;123456&quot;); System.out.println(conn.getClass() == com.mysql.cj.jdbc.ConnectionImpl.class); System.out.println(com.mysql.cj.jdbc.ConnectionImpl.class.getClassLoader()); System.out.println(DriverManager.class.getClassLoader()); }} å¯èƒ½è¿™é‡Œçœ‹ä¸Šå»æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯ DriverManager æ˜¯ Bootstrap ClassLoader åŠ è½½çš„ï¼Œæœ€ç»ˆ ConnectionImpl æ˜¯åº”ç”¨è‡ªå·±çš„ classpath ä¸‹ï¼Œæ˜¯ AppClassLoader åŠ è½½çš„ã€‚ é‚£èƒ½ä¸èƒ½å†™æ­» SPI å°±ç”¨ java.lang.ClassLoader.getSystemClassLoader() æ¥åŠ è½½å‘¢ï¼Ÿ æ¥çœ‹ä¸€ä¸‹ DriverManager æ˜¯å¦‚ä½•åŠ è½½å…·ä½“ Driver å®ç°çš„ java.sql.DriverManager12345678910111213141516public class DriverManager { // ... static { loadInitialDrivers(); } // ... private static void loadInitialDrivers() { // ... // SPI ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class); Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator(); // ... }} java.util.ServiceLoader12345678public final class ServiceLoader&lt;S&gt; implements Iterable&lt;S&gt; { // ... public static &lt;S&gt; ServiceLoader&lt;S&gt; load(Class&lt;S&gt; service) { ClassLoader cl = Thread.currentThread().getContextClassLoader(); return ServiceLoader.load(service, cl); } // ...} è§£å†³è¿™ä¸ªé—®é¢˜æ˜¯é€šè¿‡çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ Thread.currentThread().getContextClassLoader() ï¼Œæ¯ä¸ªçº¿ç¨‹ç»‘å®šä¸€ä¸ªç±»åŠ è½½å™¨ 12345Thread.currentThread().setContextClassLoader(classloader1)ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);Thread.currentThread().setContextClassLoader(classloader2)ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class); ContextClassLoader å¹¶ä¸æ˜¯ä¸€ä¸ªä¼˜é›…çš„è®¾è®¡ï¼Œä¸è¿‡ä¸€èˆ¬åœ¨ä»£ç ä¸­å¾ˆå°‘éœ€è¦å…³æ³¨ã€‚ä¸»è¦ä½¿ç”¨åœºæ™¯æ˜¯å„ç§æ¡†æ¶ï¼Œæ¡†æ¶åˆ©ç”¨ä¸Šä¸‹æ–‡åŠ è½½å™¨åŠ è½½å¯¹åº”çš„èµ„æºæˆ–è€…ç±»ã€‚ åŒäº²å§”æ´¾æœºåˆ¶çš„ç ´ååŒäº²å§”æ´¾çš„æ ¸å¿ƒå°±æ˜¯ parent å±æ€§å’Œ loadClass æ–¹æ³• java.lang.ClassLoader1protected Class&lt;?&gt; loadClass(String name, boolean resolve) protected è¯´æ˜è¿™ä¸ªæ–¹æ³•æ˜¯å¯ä»¥è¦†ç›–çš„ï¼Œå› æ­¤åŒäº²å§”æ´¾ä¸æ˜¯å¼ºåˆ¶çš„ï¼Œè‚¯å®šæœ‰ä¸€äº›åœºæ™¯æ˜¯å¯ä»¥æ”¹å†™è¿™ä¸ªé€»è¾‘çš„ã€‚ ä¸€èˆ¬è®¤ä¸º SPI æ˜¯ç ´åäº†åŒäº²å§”æ´¾æœºåˆ¶çš„ï¼ˆå§”æ´¾ç»™å¦å¤–ä¸€ä¸ªä¸Šä¸‹æ–‡ ClassLoader è€Œä¸ parentï¼‰ï¼Œæ­¤å¤–å°±æ˜¯è¦†ç›– loadClass æ–¹æ³•ç ´ååŒäº²å§”æ´¾çš„æœºåˆ¶ï¼Œå…·ä½“çš„ä½¿ç”¨åœºæ™¯åé¢ä¼šè®²ã€‚ ç±»çš„åˆå§‹åŒ–æ—¶æœºhttps://docs.oracle.com/javase/specs/jvms/se8/html/jvms-5.html Initialization of a class or interface consists of executing its class or interface initialization method (Â§2.9). A class or interface C may be initialized only as a result of: The execution of any one of the Java Virtual Machine instructions new, getstatic, putstatic, or invokestatic that references C (Â§new, Â§getstatic, Â§putstatic, Â§invokestatic). These instructions reference a class or interface directly or indirectly through either a field reference or a method reference.Upon execution of a new instruction, the referenced class is initialized if it has not been initialized already.Upon execution of a getstatic, putstatic, or invokestatic instruction, the class or interface that declared the resolved field or method is initialized if it has not been initialized already. The first invocation of a java.lang.invoke.MethodHandle instance which was the result of method handle resolution (Â§5.4.3.5) for a method handle of kind 2 (REF_getStatic), 4 (REF_putStatic), 6 (REF_invokeStatic), or 8 (REF_newInvokeSpecial).This implies that the class of a bootstrap method is initialized when the bootstrap method is invoked for an invokedynamic instruction (Â§invokedynamic), as part of the continuing resolution of the call site specifier. Invocation of certain reflective methods in the class library (Â§2.12), for example, in class Class or in package java.lang.reflect. If C is a class, the initialization of one of its subclasses. If C is an interface that declares a non-abstract, non-static method, the initialization of a class that implements C directly or indirectly. If C is a class, its designation as the initial class at Java Virtual Machine startup (Â§5.2). æœ‰ä¸”åªæœ‰ä¸Šè¿° 6 ç§æƒ…å†µï¼ˆä¸”è¿™ä¸ªç±»æ²¡æœ‰è¢«åŠ è½½ï¼‰ä¼šå»åŠ è½½ä¸€ä¸ªç±»ï¼Œç®€å•æ¥è¯´ new è¯»å–/ä¿®æ”¹é™æ€å˜é‡ï¼ˆæ’é™¤åœ¨å¸¸é‡æ± çš„ï¼‰è°ƒç”¨é™æ€æ–¹æ³• åŠ¨æ€è¯­è¨€æ”¯æŒ java.lang.invoke.MethodHandle ç›¸å…³ class library ä¸­çš„ä¸€äº›æ–¹æ³•ï¼Œä¾‹å¦‚ Class å’Œ ClassLoader çš„éƒ¨åˆ†æ–¹æ³•ã€åå°„ï¼ˆjava.lang.reflectï¼‰ç­‰ åˆå§‹åŒ–ç±»çš„æŸä¸ªå­ç±»çš„æ—¶å€™ åˆå§‹åŒ–åŒ…å«é»˜è®¤æ–¹æ³•æ¥å£çš„æŸä¸ªå®ç°ç±»çš„ Java å¯åŠ¨ç±»ï¼ˆmain Classï¼‰ å…¶ä¸­ 4 å’Œ 5 å¯ä»¥ç»Ÿä¸€æˆä¸€ä¸ªé€’å½’çš„æè¿°ï¼Œå¦‚æœè¦åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œéœ€è¦å…ˆåˆå§‹åŒ–çˆ¶ç±»å’ŒåŒ…å« default æ–¹æ³•çš„æ¥å£ã€‚6 åœ¨å®ç°çš„æ—¶å€™å…¶å®å±äº 3 çš„ï¼Œæ˜¯é€šè¿‡java.lang.ClassLoader.loadClassåŠ è½½çš„ï¼ˆsun.launcher.LauncherHelperï¼‰ã€‚ ç±»åŠ è½½çš„ç›¸å…³å¼‚å¸¸ç±»åŠ è½½è¿‡ç¨‹ï¼Œéœ€è¦è¿›è¡ŒéªŒè¯ï¼Œæ¯”å¦‚æ–‡ä»¶æ ¼å¼ã€JAVA ç‰ˆæœ¬ã€final çº¦æŸã€å¯è®¿é—®æ€§çº¦æŸç­‰ï¼Œå…·ä½“ç»†èŠ‚å°±ä¸èµ˜è¿°äº† åŒæ—¶è¿˜æœ‰ä¸€ä¸ªæœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„å¼‚å¸¸ 12345678910try { if (parent != null) { c = parent.loadClass(name, false); } else { c = findBootstrapClassOrNull(name); }} catch (ClassNotFoundException e) { // ClassNotFoundException thrown if class not found // from the non-null parent class loader} åœ¨åŒäº²å§”æ´¾çš„è¿‡ç¨‹ä¸­ parent å¦‚æœåŠ è½½ä¸äº†æŸä¸ªç±»ï¼Œéœ€è¦æŠ›å‡º java.lang.ClassNotFoundExceptionï¼ˆè¿™é‡Œåª catch äº†è¿™ä¸ªå¼‚å¸¸ï¼‰ã€‚ public class ClassNotFoundException extends ReflectiveOperationException Thrown when an application tries to load in a class through its string name using: The forName method in class Class. The findSystemClass method in class ClassLoader . The loadClass method in class ClassLoader.but no definition for the class with the specified name could be found. public class NoClassDefFoundError extends LinkageError Thrown if the Java Virtual Machine or a ClassLoader instance tries to load in the definition of a class (as part of a normal method call or as part of creating a new instance using the new expression) and no definition of the class could be found.The searched-for class definition existed when the currently executing class was compiled, but the definition can no longer be found. java.lang.NoClassDefFoundError æ˜¯ä¸€ä¸ª Errorï¼Œå‘ç”Ÿåœ¨å®ä¾‹åŒ–ä¸€ä¸ªç±»çš„æ—¶å€™ï¼ˆç±»å·²ç»æ‰¾åˆ°äº†ï¼‰ï¼Œä¸€èˆ¬æƒ…å†µæ˜¯è¿™ä¸ªç±»ä¾èµ–çš„æŸäº›å®šä¹‰ä¸å­˜åœ¨ï¼Œä¸€èˆ¬ä¼šå‡ºç°åœ¨ jar åŒ…çš„ç‰ˆæœ¬ä¸å…¼å®¹ä¸Šã€‚ ç±»çš„å¸è½½æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼Œåˆ™ç±»ä¼šè¢«å¸è½½ è¯¥ç±»çš„æ‰€æœ‰å®ä¾‹ï¼ˆåŒ…å«å­ç±»çš„å®ä¾‹ï¼‰éƒ½è¢«å›æ”¶ è¯¥ç±»çš„ ClassLoader ä¸å­˜åœ¨ä»»ä½•å¼•ç”¨ è¯¥ç±»çš„ Class å¯¹è±¡ä¸å­˜åœ¨ä»»ä½•å¼•ç”¨ï¼ˆåŒ…æ‹¬ç›¸å…³çš„ Method Field ç­‰ï¼Œæ— æ³•é€šè¿‡åå°„è®¿é—®ï¼‰ æ³¨æ„é»˜è®¤çš„ä¸‰ä¸ªç±»åŠ è½½å¯¹åº”çš„ç±»æ˜¯ä¸ä¼šè¢«å¸è½½çš„ï¼ˆClassLoader ä¼šä¸€ç›´è¢«å¼•ç”¨ï¼‰ã€‚ è‡ªå®šä¹‰ ClassLoaderå¦‚ä½•è‡ªå®šä¹‰ ClassLoaderä¸€èˆ¬æ˜¯ç»§æ‰¿ java.net.URLClassLoader æˆ–è€…ç›´æ¥ç»§æ‰¿ java.lang.ClassLoaderï¼Œç„¶åè¦†ç›– findClass æˆ– loadClass æ–¹æ³• è¦†ç›– findClassè¿™ç§ä¿®æ”¹ä¸€èˆ¬ä¸ç ´ååŒäº²å§”æ´¾ï¼Œä¼šä¿®æ”¹æŸ¥æ‰¾ç±»çš„é€»è¾‘ï¼Œå®ç°æŸäº›åŠ¨æ€çš„é€»è¾‘ã€‚å¯ä»¥å®ç°ä½†ä¸é™äºä»¥ä¸‹çš„é€»è¾‘ ä»ç½‘ç»œè·å– ä»ç‰¹å®šç›®å½•è·å– ç‰¹å®šç›®å½•ç»“æ„çš„å‹ç¼©åŒ… War åŒ… WEB-INF SpringBoot FatJar å¯¹äºŒè¿›åˆ¶æµåšé¢„å¤„ç†ï¼Œä¾‹å¦‚è§£å¯†æˆ–éªŒè¯ç­¾å å†…å­˜ç›´æ¥å®šä¹‰ Class æ–‡ä»¶ï¼ˆé…åˆå­—èŠ‚ç çš„åº“ï¼‰ï¼ˆåŠ¨æ€ä»£ç†ï¼‰ å®ç°çƒ­åŠ è½½ ç±»ä¼¼ JSP çš„æŠ€æœ¯ â€¦ è¦†ç›– loadClassä¸€èˆ¬æ˜¯ä¿®æ”¹ç±»åŠ è½½çš„å±‚çº§ç»“æ„ï¼Œå¯ä»¥å®ç°ä½†ä¸é™äºä»¥ä¸‹çš„é€»è¾‘ æ¨¡å—åŒ– è‡ªå®šä¹‰æŸç§ç±»éš”ç¦»çš„æœºåˆ¶ï¼Œä¾‹å¦‚ Tomcat â€¦ å½“ç„¶ä¸Šé¢ä¸¤ç§ä¹Ÿå¯ä»¥è¿›è¡Œç»„åˆ åº”ç”¨åœºæ™¯SpringBootspring boot åº”ç”¨æ‰“åŒ…ä¹‹åå¯ä»¥ç›´æ¥é€šè¿‡ java -jar å‘½ä»¤å¯åŠ¨ ã€‚ å®ç°åŸç†æ˜¯ spring-boot-maven-plugin åœ¨æ„å»ºï¼ˆrepackageï¼‰çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ org.springframework.boot.maven.RepackageMojo æ‰“åŒ…æˆç‰¹å®šç»“æ„çš„ Jar åŒ…https://docs.spring.io/spring-boot/docs/current/maven-plugin/reference/htmlsingle/#packaging.layers org.springframework.boot.loader.tools.Layouts.Jar12345678910111213141516171819202122232425262728293031/** * Executable JAR layout. */public static class Jar implements RepackagingLayout { @Override public String getLauncherClassName() { return &quot;org.springframework.boot.loader.JarLauncher&quot;; } @Override public String getLibraryDestination(String libraryName, LibraryScope scope) { return &quot;BOOT-INF/lib/&quot;; } @Override public String getClassesLocation() { return &quot;&quot;; } @Override public String getRepackagedClassesLocation() { return &quot;BOOT-INF/classes/&quot;; } @Override public boolean isExecutable() { return true; } // ...} å¯ä»¥æ‰¾ä¸€ä¸ª spring boot çš„ Fat Jar è§£å‹çœ‹ä¸€ä¸‹çœ‹çœ‹ 1234567891011121314151617181920212223242526.â”œâ”€â”€ BOOT-INFâ”‚ â”œâ”€â”€ classesâ”‚ â”‚ â”œâ”€â”€ application.propertiesâ”‚ â”‚ â””â”€â”€ comâ”‚ â”‚ â””â”€â”€ exampleâ”‚ â”‚ â””â”€â”€ demoâ”‚ â”‚ â””â”€â”€ DemoApplication.classâ”‚ â”œâ”€â”€ classpath.idxâ”‚ â”œâ”€â”€ layers.idxâ”‚ â””â”€â”€ libâ”‚ â”œâ”€â”€ ...â”‚ â”œâ”€â”€ spring-boot-2.5.4.jarâ”‚ â”œâ”€â”€ spring-boot-autoconfigure-2.5.4.jarâ”‚ â”œâ”€â”€ spring-context-5.3.9.jarâ”‚ â””â”€â”€ spring-core-5.3.9.jarâ”œâ”€â”€ META-INFâ”‚ â””â”€â”€ MANIFEST.MFâ””â”€â”€ org â””â”€â”€ springframework â””â”€â”€ boot â””â”€â”€ loader â”œâ”€â”€ JarLauncher.class â”œâ”€â”€ LaunchedURLClassLoader.class â”œâ”€â”€ Launcher.class â”œâ”€â”€ ... java -jar å‘½ä»¤ä¼šåœ¨ MANIFEST.MF é‡Œé¢æ‰¾ Main-Class æ¥è¿è¡Œï¼Œçœ‹ä¸‹ META-INF/MANIFEST.MF æ–‡ä»¶å†…å®¹ META-INF/MANIFEST.MF123456789101112Manifest-Version: 1.0Spring-Boot-Classpath-Index: BOOT-INF/classpath.idxImplementation-Title: demoImplementation-Version: 0.0.1-SNAPSHOTSpring-Boot-Layers-Index: BOOT-INF/layers.idxStart-Class: com.example.demo.DemoApplicationSpring-Boot-Classes: BOOT-INF/classes/Spring-Boot-Lib: BOOT-INF/lib/Build-Jdk-Spec: 1.8Spring-Boot-Version: 2.5.4Created-By: Maven Jar Plugin 3.2.0Main-Class: org.springframework.boot.loader.JarLauncher é‚£ä¹ˆæ˜¯å¦‚ä½•å¯åŠ¨çš„å‘¢ï¼Ÿ org.springframework.boot.loader.JarLauncher1234567891011121314151617181920212223242526public class JarLauncher extends ExecutableArchiveLauncher { static final String BOOT_INF_CLASSES = &quot;BOOT-INF/classes/&quot;; static final String BOOT_INF_LIB = &quot;BOOT-INF/lib/&quot;; public JarLauncher() { } protected JarLauncher(Archive archive) { super(archive); } @Override protected boolean isNestedArchive(Archive.Entry entry) { if (entry.isDirectory()) { return entry.getName().equals(BOOT_INF_CLASSES); } return entry.getName().startsWith(BOOT_INF_LIB); } public static void main(String[] args) throws Exception { new JarLauncher().launch(args); } // ...} org.springframework.boot.loader.ExecutableArchiveLauncher123456789101112131415161718192021222324252627282930public abstract class ExecutableArchiveLauncher extends Launcher { // ... @Override protected String getMainClass() throws Exception { Manifest manifest = this.archive.getManifest(); String mainClass = null; if (manifest != null) { mainClass = manifest.getMainAttributes().getValue(&quot;Start-Class&quot;); } if (mainClass == null) { throw new IllegalStateException(&quot;No 'Start-Class' manifest entry specified in &quot; + this); } return mainClass; } @Override protected List&lt;Archive&gt; getClassPathArchives() throws Exception { List&lt;Archive&gt; archives = new ArrayList&lt;Archive&gt;(this.archive.getNestedArchives(new EntryFilter() { @Override public boolean matches(Entry entry) { return isNestedArchive(entry); } })); postProcessClassPathArchives(archives); return archives; } // ...} org.springframework.boot.loader.Launcher123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051public abstract class Launcher { /** * Launch the application. This method is the initial entry point that should be * called by a subclass {@code public static void main(String[] args)} method. * @param args the incoming arguments * @throws Exception if the application fails to launch */ protected void launch(String[] args) throws Exception { JarFile.registerUrlProtocolHandler(); ClassLoader classLoader = createClassLoader(getClassPathArchives()); launch(args, getMainClass(), classLoader); } /** * Create a classloader for the specified archives. * @param archives the archives * @return the classloader * @throws Exception if the classloader cannot be created */ protected ClassLoader createClassLoader(List&lt;Archive&gt; archives) throws Exception { List&lt;URL&gt; urls = new ArrayList&lt;URL&gt;(archives.size()); for (Archive archive : archives) { urls.add(archive.getUrl()); } return createClassLoader(urls.toArray(new URL[urls.size()])); } /** * Create a classloader for the specified URLs. * @param urls the URLs * @return the classloader * @throws Exception if the classloader cannot be created */ protected ClassLoader createClassLoader(URL[] urls) throws Exception { return new LaunchedURLClassLoader(urls, getClass().getClassLoader()); } /** * Launch the application given the archive file and a fully configured classloader. * @param args the incoming arguments * @param mainClass the main class to run * @param classLoader the classloader * @throws Exception if the launch fails */ protected void launch(String[] args, String mainClass, ClassLoader classLoader) throws Exception { Thread.currentThread().setContextClassLoader(classLoader); createMainMethodRunner(mainClass, args, classLoader).run(); } // ...} å› ä¸ºæ˜¯ Fat Jar çš„æ¨¡å¼ï¼ˆJar in Jarï¼‰ï¼Œå› æ­¤éœ€è¦è‡ªå·±å®ç° LaunchedURLClassLoader æ¥å®šåˆ¶ç±»çš„æŸ¥æ‰¾é€»è¾‘ã€‚ TomcatTomcat å¯ä»¥åŒæ—¶åŠ è½½å¤šä¸ª web åº”ç”¨ï¼Œå¹¶ä¸”å¯ä»¥çƒ­åŠ è½½ï¼Œæ”¯æŒåŠ¨æ€åŠ è½½æˆ–è€…å¸è½½ web åº”ç”¨ã€‚å¤§æ¦‚çš„å®ç°æ€è·¯ Tomcat è‡ªèº«çš„ä»£ç ä¼šæœ‰ä¸€ä¸ª ClassLoader Tomcat ä¸ºæ¯ä¸ª Web åº”ç”¨åˆ›å»ºä¸€ä¸ª org.apache.catalina.loader.WebappClassLoader åŠ è½½ Web åº”ç”¨è‡ªå·±çš„ç±»ï¼Œä¸” parent ä¼šæŒ‡å‘ Tomcat è‡ªèº«çš„ç±»åŠ è½½å™¨ WebappClassLoader åŠ è½½çš„æ—¶å€™ ä¼šå…ˆé€šè¿‡ javaseClassLoader åŠ è½½ï¼Œé»˜è®¤ä¸º ClassLoader.getSystemClassLoader().getParent() éƒ¨åˆ†ç±»ä¼šé€šè¿‡ parent æ¥è¿›è¡ŒåŠ è½½ï¼Œè¿™æ ·åº”ç”¨å¯ä»¥å…±äº«ä¸€äº›ç±»çš„å®šä¹‰ï¼ˆä¾‹å¦‚ javax.servlet.* å’Œ org.apache.tomcat.*ï¼‰ ä¹‹åä¼šåŠ è½½ Web åº”ç”¨ç›®å½•ä¸‹çš„ç±»ï¼Œå› æ­¤å¯ä»¥å®ç°ä¸åŒåº”ç”¨ä¹‹é—´çš„ç±»æ˜¯éš”ç¦»çš„ ä¸Šè¿°è¿‡ç¨‹ä¼šç ´ååŒäº²å§”æ´¾çš„æ¨¡å‹ã€‚æ¥çœ‹ä¸€ä¸‹ Tomcat çš„ç›®å½•ç»“æ„ï¼Œwebapps ç›®å½•ä¸‹åŒ…å«äº†æ‰€æœ‰çš„ Web åº”ç”¨ 12345678910111213141516171819202122.â”œâ”€â”€ binâ”‚ â”œâ”€â”€ ...â”‚ â”œâ”€â”€ shutdown.shâ”‚ â””â”€â”€ startup.shâ”œâ”€â”€ confâ”‚ â”œâ”€â”€ ...â”‚ â”œâ”€â”€ server.xmlâ”‚ â””â”€â”€ web.xmlâ”œâ”€â”€ libâ”‚ â”œâ”€â”€ ...â”‚ â”œâ”€â”€ servlet-api.jarâ”‚ â”œâ”€â”€ tomcat-api.jarâ”‚ â””â”€â”€ tomcat-websocket.jarâ”œâ”€â”€ logsâ”œâ”€â”€ webappsâ”‚ â”œâ”€â”€ ROOTâ”‚ â”œâ”€â”€ docsâ”‚ â”œâ”€â”€ examplesâ”‚ â”œâ”€â”€ host-managerâ”‚ â””â”€â”€ managerâ””â”€â”€ work Tomcat æ–‡æ¡£å…³äº WebappClassLoaderBase.loadClass çš„æè¿° https://tomcat.apache.org/tomcat-8.5-doc/api/org/apache/catalina/loader/WebappClassLoaderBase.html org.apache.catalina.loader.WebappClassLoaderBase12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394public abstract class WebappClassLoaderBase extends URLClassLoader implements ... { // ... @Override public Class&lt;?&gt; loadClass(String name, boolean resolve) throws ClassNotFoundException { // ... // (0) Check our previously loaded local class cache // ... // (0.1) Check our previously loaded class cache // ... // ä¹‹å‰ä¼šåˆ¤æ–­æ˜¯å¦å·²ç»åŠ è½½è¿‡ // javaseLoader é»˜è®¤å°±æ˜¯ java.lang.ClassLoader.getSystemClassLoader().getParent() ClassLoader javaseLoader = getJavaseClassLoader(); boolean tryLoadingFromJavaseLoader; // åˆ¤æ–­æ˜¯å¦åº”è¯¥ç”¨ javaseLoader åŠ è½½ // ... // é€šè¿‡ javaseLoader åŠ è½½ if (tryLoadingFromJavaseLoader) { try { clazz = javaseLoader.loadClass(name); if (clazz != null) { // ... return clazz; } } catch (ClassNotFoundException e) { } } boolean delegateLoad = delegate || filter(name, true); // (1) Delegate to our parent if requested if (delegateLoad) { try { clazz = Class.forName(name, false, parent); if (clazz != null) { // ... return clazz; } } catch (ClassNotFoundException e) { // Ignore } } // (2) Search local repositories try { clazz = findClass(name); if (clazz != null) { // ... return clazz; } } catch (ClassNotFoundException e) { } // (3) Delegate to parent unconditionally if (!delegateLoad) { try { clazz = Class.forName(name, false, parent); if (clazz != null) { // ... return clazz; } } catch (ClassNotFoundException e) { } } throw new ClassNotFoundException(name); } protected boolean filter(String name, boolean isClassName) { // ... if (name.startsWith(&quot;javax&quot;)) { /* 5 == length(&quot;javax&quot;) */ if (name.length() == 5) { return false; } ch = name.charAt(5); if (isClassName &amp;&amp; ch == '.') { /* 6 == length(&quot;javax.&quot;) */ if (name.startsWith(&quot;servlet.jsp.jstl.&quot;, 6)) { return false; } if (name.startsWith(&quot;el.&quot;, 6) || name.startsWith(&quot;servlet.&quot;, 6) || name.startsWith(&quot;websocket.&quot;, 6) || name.startsWith(&quot;security.auth.message.&quot;, 6)) { return true; } } // ... } // ... }} Tomcat ClassLoader çš„å±‚æ¬¡ç»“æ„ å›¾ç‰‡æ¥æºäºç½‘ç»œ å…¶ä»–åŠ¨æ€è¯­è¨€ï¼Œä¾‹å¦‚ groovy.lang.GroovyClassLoaderä¾èµ–å†²çªéš”ç¦» https://www.zhihu.com/question/46719811/answer/1739289578 ã€‚OSGI æ¨¡å—åŒ–ï¼Œåæ¥ Java æ ‡å‡†ä¹Ÿå¼•å…¥äº†çš„æ¨¡å—åŒ–ã€‚çƒ­åŠ è½½ä¹Ÿå¯ä»¥ç”¨å¤šä¸ª ClassLoader æ¥å¤„ç†ï¼ˆIDEA é‡æ–°åŠ è½½ç±»ï¼Œä¸æ˜¯é€šè¿‡ ClassLoader å®ç°çš„ï¼‰ã€‚ ClassLoader é—®é¢˜æ’æŸ¥æ€è·¯åœ¨é‡åˆ° ClassLoader ç›¸å…³é—®é¢˜çš„æ—¶å€™ï¼Œå¯ä»¥è¯•è¯•å¦‚ä¸‹çš„æ€è·¯ï¼ˆä¸€èˆ¬åœ¨æœ‰å¤šä¸ª ClassLoader çš„æ—¶å€™ï¼‰ object.getClass().getClassLoader() / clazz.getClassLoader() æŸ¥çœ‹æŸä¸ªç±»çš„ ClassLoaderï¼Œåˆ¤æ–­æ˜¯å¦ç¬¦åˆé¢„æœŸ Thread.currentThread().getContextClassLoader() è·å–å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡ ClassLoaderï¼Œåˆ¤æ–­æ˜¯å¦ç¬¦åˆé¢„æœŸ åœ¨é‡åˆ°ç±»åŠ è½½ç›¸å…³é”™è¯¯ï¼Œè¦èƒ½æƒ³åˆ°å¯èƒ½æ˜¯ ClassLoader ä¸å¯¹ åœ¨ä½¿ç”¨æ¡†æ¶çš„æ—¶å€™ï¼Œå¦‚æœé‡åˆ°ç±»åŠ è½½ç›¸å…³é”™è¯¯ï¼Œè¦æƒ³åˆ°å¯èƒ½æ˜¯ ContextClassLoader ä¸å¯¹ object.getClass().getProtectionDomain().getCodeSource() / clazz.getProtectionDomain().getCodeSource() å¯ä»¥æŸ¥çœ‹æŸä¸ªç±»åŠ è½½çš„è·¯å¾„ï¼ˆå¦‚æœä¸¤ä¸ª Jar åŒ…éƒ½æœ‰ç›¸åŒçš„ç±»ï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆæ˜¯åŠ è½½äº†å“ªä¸ª Jar åŒ…çš„ç±»ï¼‰ï¼Œåˆ¤æ–­æ˜¯å¦ç¬¦åˆé¢„æœŸ èƒ½é€šè¿‡ arthas ç±»å’Œç±»åŠ è½½ç›¸å…³çš„å‘½ä»¤ï¼ˆscï¼Œclassloaderï¼Œjad ç­‰ï¼‰æ¥æ’æŸ¥é—®é¢˜ åœ¨ä¿®æ”¹ contextClassLoader çš„æ—¶å€™ï¼Œè¦æ³¨æ„æ¢å¤ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹ä»£ç  12345678ClassLoader classLoader;ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();try { Thread.currentThread().setContextClassLoader(classLoader); // ...} finally { Thread.currentThread().setContextClassLoader(contextClassLoader);} è¡¥å……ï¼šoop klass æ¨¡å‹ä¸Šé¢æåˆ°ï¼Œåœ¨ hotspot ä»£ç é‡Œé¢ Klass æ˜¯ç±»çš„åº•å±‚å®ç°ï¼Œç±»åŠ è½½æœ€ç»ˆçš„ç»“æœå°±æ˜¯åˆ›å»ºä¸€ä¸ª Klass å¯¹è±¡ï¼Œoop æ˜¯æè¿°å¯¹è±¡å„ç§ä¿¡æ¯çš„æŒ‡é’ˆï¼Œoop klass æ¨¡å‹æ˜¯ JVMï¼ˆhotspotï¼‰å†…éå¸¸æ ¸å¿ƒçš„æ¨¡å‹ã€‚ hotspot/src/share/vm/oops/klass.hppklass.hpp12345678// A Klass provides:// 1: language level class object (method dictionary etc.)// 2: provide vm dispatch behavior for the object// Both functions are combined into one C++ class.// ...class Klass : public Metadata { // ...} å›¾ç‰‡æ¥æºäºç½‘ç»œ åœ¨ C++å±‚é¢æœ‰å¤šä¸ªä¸åŒçš„ç±»æ¥æè¿°è¿™ä¸ªä½“ç³»ï¼Œoop klass æ¨¡å‹è¿™éƒ¨åˆ†å†…å®¹æœ‰å…´è¶£å¯ä»¥è‡ªè¡Œæœç´¢ã€‚ åŸºæœ¬ç±»å‹int.class å’Œ java.lang.Integer.class æ˜¯ä¸åŒçš„ï¼Œint.class == java.lang.Integer.TYPEã€‚åŸºæœ¬ç±»å‹çš„å€¼æœ¬è´¨ä¸Šæ¥è¯´ä¸æ˜¯ oopï¼ˆä¹Ÿæ²¡æœ‰ç±»å‹æŒ‡é’ˆï¼‰ï¼Œæ‰€ä»¥ int.class æ›´åƒæ˜¯ JVM ç±»å‹ç³»ç»Ÿçš„ä¸€ä¸ªç‰¹ä¾‹ï¼ˆcreate_basic_type_mirror ä»åå­—ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼‰ï¼Œè¿™äº›ç±»å‹ä¹Ÿæ˜¯åœ¨ JVM åˆå§‹åŒ–è¿‡ç¨‹ä¸­è¿›è¡ŒåŠ è½½çš„ï¼ˆSystemDictionary::initialize_preloaded_classesï¼‰ã€‚ hotspot/src/share/vm/memory/universe.cppuniverse.cpp12345678910111213141516171819202122232425262728293031void Universe::initialize_basic_type_mirrors(TRAPS) { assert(_int_mirror==NULL, &quot;basic type mirrors already initialized&quot;); _int_mirror = java_lang_Class::create_basic_type_mirror(&quot;int&quot;, T_INT, CHECK); _float_mirror = java_lang_Class::create_basic_type_mirror(&quot;float&quot;, T_FLOAT, CHECK); _double_mirror = java_lang_Class::create_basic_type_mirror(&quot;double&quot;, T_DOUBLE, CHECK); _byte_mirror = java_lang_Class::create_basic_type_mirror(&quot;byte&quot;, T_BYTE, CHECK); _bool_mirror = java_lang_Class::create_basic_type_mirror(&quot;boolean&quot;,T_BOOLEAN, CHECK); _char_mirror = java_lang_Class::create_basic_type_mirror(&quot;char&quot;, T_CHAR, CHECK); _long_mirror = java_lang_Class::create_basic_type_mirror(&quot;long&quot;, T_LONG, CHECK); _short_mirror = java_lang_Class::create_basic_type_mirror(&quot;short&quot;, T_SHORT, CHECK); _void_mirror = java_lang_Class::create_basic_type_mirror(&quot;void&quot;, T_VOID, CHECK); _mirrors[T_INT] = _int_mirror; _mirrors[T_FLOAT] = _float_mirror; _mirrors[T_DOUBLE] = _double_mirror; _mirrors[T_BYTE] = _byte_mirror; _mirrors[T_BOOLEAN] = _bool_mirror; _mirrors[T_CHAR] = _char_mirror; _mirrors[T_LONG] = _long_mirror; _mirrors[T_SHORT] = _short_mirror; _mirrors[T_VOID] = _void_mirror;} æ•°ç»„ç±»å‹éœ€è¦æ³¨æ„çš„æ˜¯æ•°ç»„æ˜¯ JVM å†…éƒ¨ç›´æ¥ç”Ÿæˆçš„ï¼Œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç±»å‹ï¼ˆArrayKlassï¼‰ã€‚åœ¨å®šä¹‰ SomeClass[] array = new SomeClass[1] æ—¶å¹¶ä¸ä¼šå¯¼è‡´ SomeClass ç±»çš„åˆå§‹åŒ–ã€‚æ•°ç»„ä¹Ÿæ˜¯ JVM ç±»å‹ç³»ç»Ÿçš„ç‰¹ä¾‹ã€‚ è¡¥å……ï¼šJava æ ‡å‡†æ¨¡å—åŒ–ï¼ˆJava 9+ï¼‰åœ¨å¼•å…¥æ¨¡å—åŒ–ä¹‹åï¼Œæ•´ä¸ªç±»åŠ è½½æœºåˆ¶ä¼šæœ‰ä¸€äº›å˜åŒ–ï¼Œåé¢ä¼šå•ç‹¬å†™ä¸€éæ–‡ç« æ¥è®²è§£ã€‚ å‚è€ƒhttps://docs.oracle.com/javase/specs/jvms/se8/html/jvms-5.htmlhttps://hg.openjdk.java.net/jdk8https://docs.oracle.com/javase/8/docs/technotes/tools/findingclasses.htmlhttps://docs.oracle.com/javase/8/docs/technotes/guides/security/spec/security-spec.doc5.htmlã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹https://www.cnblogs.com/mazhimazhi/","link":"/2021/09/java-classloader/"},{"title":"Valhalla (0): åºè¨€","text":"åœ¨ JDK 1.8 ä¸­ï¼Œå¢åŠ äº† java.util.Optionalã€java.time.LocalDateTime ç­‰ç±»ï¼Œåœ¨è¿™äº›ç±»çš„æ³¨é‡Šä¸­æœ‰è¿™ä¹ˆä¸€è¡Œï¼š This is a value-based class; use of identity-sensitive operations (including reference equality (==), identity hash code, or synchronization) on instances of Optional may have unpredictable results and should be avoided. å¼•å…¥äº†ä¸€ä¸ªæ–°çš„æ¦‚å¿µï¼ŒåŸºäºå€¼ï¼ˆvalue-basedï¼‰çš„ç±»ã€‚ åœ¨ JDK 16 çš„æ–°ç‰¹æ€§ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªä¸å¤ªèµ·çœ¼çš„ JEP 390: Warnings for Value-Based Classesã€‚åªæ˜¯å¯¹åŸºäºå€¼çš„ç±»å¢åŠ äº†ä¸€äº›è­¦å‘Šä¿¡æ¯ï¼Œå¯¹åŠŸèƒ½æ²¡æœ‰ä»»ä½•å½±å“ã€‚ å¯å°±åœ¨è¿™ä¸ªä¸èµ·çœ¼çš„æ¦‚å¿µèƒŒåï¼Œå´è·Ÿä¸€ä¸ªè¶³ä»¥é¢ è¦† Java çš„é¡¹ç›®æœ‰å…³ï¼Œè¿™ä¸ªé¡¹ç›®å°±æ˜¯ Valhallaã€‚ ç³»åˆ—æ–‡ç« ï¼ˆæœªå®Œå¾…ç»­ï¼‰ Valhalla (0): åºè¨€ Valhalla (1): èƒŒæ™¯ How We Got the Generics We Have Valhalla (2): ç°çŠ¶ The Road to Valhalla Valhalla (5): è§£è¯» JEP 390 Warnings for Value-Based Classes Valhalla (6): è§£è¯» JEP 401 Primitive Objects Valhalla (7): è§£è¯» JEP 402 Unify the Basic Primitives with Objects Valhallahttps://openjdk.java.net/projects/valhalla/ åœ¨ OpenJDK ä¸­æœ‰ä¸€äº›å¾ˆé‡è¦çš„é¡¹ç›®æ¯”å¦‚ Amber Loom Panama Valhalla ç­‰ã€‚ç›¸å½“äºæ˜¯ OpenJDK çš„åˆ†æ”¯ï¼Œè¿›è¡Œä¸€äº›æ¢ç´¢ï¼Œè¿™äº›é¡¹ç›®å¸¦æ¥çš„æ”¹åŠ¨æœ€ç»ˆæœ‰å¯èƒ½ä¼šåˆå¹¶åˆ°æ­£å¼ç‰ˆæœ¬çš„ JDKã€‚ Valhalla é¡¹ç›®åœ¨ 14 å¹´å°±å¯åŠ¨äº†ï¼Œå°±ä¸¤ä¸ªç›®æ ‡ï¼š Value Typesï¼ˆå€¼ç±»å‹ï¼‰ Generic Specializationï¼ˆç‰¹åŒ–æ³›å‹ï¼‰ JEPsç›®å‰å·²ç»å‘å¸ƒçš„ JEP: JEP 390 Warnings for Value-Based Classes å€™é€‰çŠ¶æ€ï¼ˆCandidateï¼‰çš„ JEPï¼š JEP 218: Generics over Primitive Types JEP 401 Primitive Objects (Preview) JEP 402 Unify the Basic Primitives with Objects (Preview) å€™é€‰æ„å‘³ç€å¾ˆæœ‰å¯èƒ½åœ¨è¿‘æœŸçš„ç‰ˆæœ¬åŠ å…¥é¢„è§ˆ è¿˜æœ‰è‰ç¨¿çŠ¶æ€çš„ JEPï¼š JEP draft: Universal Generics (Preview) JEP draft: Value Objects (Preview) è®¾è®¡æ–‡æ¡£èƒŒæ™¯ Background: How We Got the Generics We Have ç°çŠ¶ The State of Valhalla The Road to Valhalla The Language Model The JVM Model ä¸ºä»€ä¹ˆä¼šé¢ è¦† Javaæœªæ¥ä¼šå‡ºç°å¦‚ä¸‹é¢ è¦†æ€§çš„ä»£ç ï¼š 1234567891011// ç›®å‰ new çš„å¯¹è±¡ä¸€å®šæ˜¯ä¸ç›¸ç­‰çš„assert new Point() == new Point();// åŸºæœ¬ç±»å‹çš„æ³›å‹List&lt;int&gt; ints = new ArrayList&lt;&gt;();// æ•°ç»„åå˜ï¼Œç›®å‰çš„æ•°ç»„æ˜¯ä¸å˜çš„Object[] array = new int[0];// ç›®å‰ true ä¸æ˜¯å¯¹è±¡assert true instanceof Boolean;true.toString();// ç›®å‰ new ä¸€ä¸ªå®ä¾‹ï¼ŒgetClass ä¸€å®šæ˜¯ ç±»å.classassert new Point().getClass() != Point.class; åŒæ—¶æœ‰å¦‚ä¸‹é¢ è¦†æ€§æ”¹å˜ï¼š æ‰€æœ‰å€¼éƒ½æ˜¯å¯¹è±¡ï¼ˆåŒ…æ‹¬ intã€double ç­‰ï¼‰ ä¸æ˜¯æ‰€æœ‰çš„å¯¹è±¡éƒ½ä¿å­˜åœ¨å †ä¸­ ï¼ˆå¯èƒ½ï¼‰Arrays ç­‰åªéœ€è¦ä¸€ç»„ sort æ–¹æ³•äº†ï¼ˆä»¥å‰ int[] double[] éƒ½æœ‰è‡ªå·±çš„ sort æ–¹æ³•ï¼‰ ï¼ˆå¯èƒ½ï¼‰java.lang.Object ä¼šå˜æˆæŠ½è±¡ç±»ï¼Œä½†æ˜¯å¯ä»¥ç»§ç»­ new Object() ç¿»è¯‘çº¦å®šåé¢æœ‰å¾ˆå¤šå†…å®¹æ˜¯ç¿»è¯‘çš„ï¼Œä¼šæŒ‰ç…§å¦‚ä¸‹çº¦å®šï¼š è‹±è¯­ ä¸­æ–‡ è¯´æ˜ Bsic Primitive Type åŸºæœ¬ç±»å‹ Primitive Data Type åŸºæœ¬ç±»å‹ åŒåŸºæœ¬æ•°æ®ç±»å‹/åŸå§‹ç±»å‹ Reference Type å¼•ç”¨ç±»å‹ Value Type å€¼ç±»å‹ Basic Primitive Value åŸºæœ¬å€¼ Reference Value å¼•ç”¨å€¼ Identity æŒ‡â€œæœ‰å”¯ä¸€æ ‡è¯†çš„â€ï¼Œåç»­ä¸åšç¿»è¯‘ Identity-free æŒ‡â€œæ²¡æœ‰å”¯ä¸€æ ‡è¯†çš„â€ï¼Œåç»­ä¸åšç¿»è¯‘ Identity-related Behavior Identity ç›¸å…³æ“ä½œ Identity-sensitive Operation Identity ç›¸å…³æ“ä½œ Primitive Wrapper Class åŒ…è£…ç±» Primitive Object åŸå§‹å¯¹è±¡ Primitive Classe åŸå§‹ç±» Identity Object Identity ç±» Identity Classe Identity å¯¹è±¡ Primitive Value Type åŸå§‹å€¼ç±»å‹ Primitive Reference Type åŸå§‹å¼•ç”¨ç±»å‹ Reference-favoring Primitive Classe å¼•ç”¨ä¼˜å…ˆçš„åŸå§‹ç±» æ¦‚å¿µè§£é‡ŠTypeæœ‰è¿™ä¹ˆå‡ ä¸ªè·Ÿç±»å‹ç›¸å…³çš„æ¦‚å¿µ å€¼ï¼ˆValueï¼‰ï¼šåœ¨ Java ä¸­æœ‰åŸºæœ¬å€¼å’Œå¼•ç”¨å€¼ã€‚ ç±»å‹ï¼ˆTypeï¼‰ï¼šæè¿°å€¼å’Œå¯æ‰§è¡Œæ“ä½œçš„é›†åˆï¼Œæ¯ä¸€ä¸ªå€¼å¯¹åº”ä¸€ä¸ªç±»å‹ã€‚åœ¨ Java ä¸­æœ‰å€¼ç±»å‹å’Œå¼•ç”¨ç±»å‹ï¼Œä¸€äº›è¯­è¨€è¿˜æœ‰æŒ‡é’ˆç±»å‹ã€‚ ç±»ï¼ˆClassï¼‰ï¼šä¸€ç§å…·ä½“çš„ç±»å‹ class typeï¼Œæˆ–æŒ‡ class çš„å£°æ˜ã€‚ å¯¹è±¡ï¼ˆObjectï¼‰ï¼šç±»çš„å®ä¾‹ã€‚ ç±»å¯¹è±¡ï¼ˆClass Objectï¼‰ï¼šç‰¹æŒ‡ java.lang.Class çš„å®ä¾‹ï¼Œåœ¨è¿è¡Œæ—¶è¡¨ç¤ºä¸€ä¸ªç±»ã€‚ ä¸ºä»€ä¹ˆè¯´ Class æ˜¯ä¸€ç§ Typeï¼Œæ¥çœ‹ä¸€ä¸‹ Class çš„å®šä¹‰ï¼ˆClass implements Typeï¼‰ï¼š 1234public final class Class&lt;T&gt; implements java.io.Serializable, GenericDeclaration, Type, AnnotatedElement {} é™¤äº†ç±»ç±»å‹ï¼Œè¿˜æœ‰ ParameterizedTypeã€GenericArrayType ç­‰ç±»å‹ï¼Œä¸€èˆ¬ç”¨åœ¨åå°„ç›¸å…³çš„ APIã€‚åŒæ—¶ç±»å‹è¿˜æœ‰ä¸€ä¸ªå…³è”çš„æ¦‚å¿µç±»å‹ç³»ç»Ÿï¼Œç¼–è¯‘æœŸä¹Ÿä¼šæœ‰ç±»å‹æ£€æŸ¥ã€‚ å€¼å’Œç±»å‹å¯¹åº”ï¼Œç±»å’Œå¯¹è±¡å¯¹åº”ï¼Œå¯ä»¥å‚è€ƒ java.lang.reflect.Type çš„ç›¸å…³æ–‡æ¡£ã€‚æ€»çš„æ¥è¯´ç±»å‹æ˜¯ä¸€ä¸ªæ›´åŠ æŠ½è±¡çš„æ¦‚å¿µã€‚ Value Typeè·Ÿå¼•ç”¨ç›¸åï¼Œæ•°æ®ç›´æ¥å­˜å‚¨åœ¨æ ˆä¸­ï¼Œæ›´åƒæ˜¯ä¸€ä¸ªç›’å­ï¼ŒåŒ…è£…äº†è‹¥å¹²ä¸ªå€¼ï¼Œè¿™ä¸ªæ¦‚å¿µå¯ä»¥å‚è€ƒ C è¯­è¨€ä¸­çš„ structã€‚ Identityåœ¨é¢å‘å¯¹è±¡çš„ç¨‹åºè®¾è®¡ä¸­ï¼Œå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ä¹‹åï¼Œä¸ç®¡æˆ‘ä»¬æ€ä¹ˆä¿®æ”¹å®ƒçš„çŠ¶æ€ï¼ˆå±æ€§å€¼ï¼‰ï¼Œæˆ‘ä»¬éƒ½è¯´å®ƒè¿˜æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼ˆè™½ç„¶å®ƒå˜åŒ–äº†ï¼‰ï¼Œå› æ­¤æœ‰ä¸¤ç§ç»´åº¦æ¥æ¯”è¾ƒä¸€ä¸ªå¯¹è±¡ï¼ŒçŠ¶æ€å’Œ Identityã€‚ Identity å°±æ˜¯å”¯ä¸€æ ‡è¯†ï¼Œåœ¨å®ç°ä¸Šå¯ä»¥è¢«è®¤ä¸ºæ˜¯åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼ˆä¸è€ƒè™‘ GC çš„è¯ï¼‰ã€‚ å…·ä½“åˆ° Java çš„è¯ equals æ–¹æ³•ç”¨æ¥æ¯”è¾ƒå¯¹è±¡çš„çŠ¶æ€ï¼Œ== å’Œ != ç”¨æ¥æ¯”è¾ƒå¯¹è±¡çš„ Identityï¼ˆé€šå¸¸æˆ‘ä»¬è¯´çš„æ˜¯ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼‰ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰å”¯ä¸€çš„ Identityï¼ˆè¿™ä¸ªæ¦‚å¿µå¯ä»¥å‚è€ƒ System.identityHashCode è¿™ä¸ªæ–¹æ³•ï¼‰ï¼Œå› æ­¤ 12assert new Object() != new Object();assert new Integer(1) != new Integer(1); é‚£ä¹ˆ Identity-free/Identity-less å°±æ˜¯åè¿‡æ¥çš„æ„æ€ï¼Œä¾‹å¦‚åŸºæœ¬ç±»å‹å°±æ˜¯ Identity-free çš„ï¼Œæ‰€ä»¥ 1assert 1 == 1; æ‰€ä»¥åœ¨ç›®å‰ç‰ˆæœ¬çš„ Java ä¸­ï¼Œæ‰€æœ‰çš„å¼•ç”¨ç±»å‹éƒ½æ˜¯ Identity çš„ã€åŸºæœ¬ç±»å‹éƒ½æ˜¯ Identity-free çš„ï¼Œä¸è¿‡æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šè¿™ä¹ˆå»æè¿°ï¼Œä½†è¿™ä¸ªæ¦‚å¿µæ˜¯éå¸¸é‡è¦çš„ã€‚ Identity ä¸å¤ªå¥½ç¿»è¯‘ï¼Œåé¢å°±å½“å½¢å®¹è¯ç”¨äº†ï¼ŒæŒ‡â€œæœ‰å”¯ä¸€æ ‡è¯†çš„â€ï¼ŒIdentity-free æŒ‡â€œæ²¡æœ‰å”¯ä¸€æ ‡è¯†çš„â€ åœ¨ Java ä¸­æœ‰ä¸€äº›å¯¹è±¡ï¼Œå…¶å®æ˜¯ä¸éœ€è¦åŒºåˆ†ä¸åŒå®ä¾‹çš„ï¼Œä¾‹å¦‚ Integer.valueOf(1000) å°±è¡¨ç¤ºçš„æ˜¯ 1000 è¿™ä¸ªæ•°å­—ï¼Œæ²¡å¿…è¦åŒºåˆ†è¿™ä¸ª 1000 å’Œé‚£ä¸ª 1000ã€‚ LocalTime.of(10, 0) å°±è¡¨ç¤ºâ€œæ—©ä¸Š 10 ç‚¹â€ï¼ŒåŒºåˆ†ä¸åŒâ€œæ—©ä¸Š 10 ç‚¹â€çš„å®ä¾‹æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚å¦‚æœæœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯ doSomeThing(LocalTime localTime) ï¼Œé‚£ä¹ˆå‡ ä¹æ‰€æœ‰çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä¼ å…¥ä¸åŒå®ä¾‹çš„â€œæ—©ä¸Š 10 ç‚¹â€åº”è¯¥éƒ½æ˜¯ä¸€æ ·çš„è¡Œä¸ºã€‚ ä¸æ˜¯è¯´ä¸èƒ½åŒºåˆ†ï¼Œè€Œæ˜¯è¯´æ²¡æ„ä¹‰ï¼Œè¿™é‡Œåªè§£é‡Š Identity è¿™ä¸ªæ¦‚å¿µã€‚ Value-Based Classeshttps://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/doc-files/ValueBased.html è¿™ä¸ªæ¦‚å¿µæœ€æ—©åœ¨ java 8 å°±æå‡ºäº†https://docs.oracle.com/javase/8/docs/api/java/lang/doc-files/ValueBased.html åœ¨ä¸Šé¢çš„è®¨è®ºä¸­ï¼Œæˆ‘ä»¬å‘ç°æœ‰ä¸€äº›ç±»å‹åº”è¯¥æ˜¯ Identity-free çš„ï¼Œä¾‹å¦‚ java.lang.Integer å’Œ java.time.LocalTimeï¼Œä¸åº”è¯¥å»åŒºåˆ†ä¸åŒçš„å®ä¾‹ã€‚ å†å…·ä½“ä¸€ç‚¹ï¼Œæ»¡è¶³ä¸‹åˆ—è§„èŒƒçš„ç±»è¢«ç§°ä¸ºåŸºäºå€¼çš„ç±»ï¼ˆvalue-based classesï¼‰ æ‰€æœ‰çš„å®ä¾‹å­—æ®µéƒ½æ˜¯ final çš„ï¼ˆä¸å¯å˜çš„ï¼Œä½†å¯ä»¥åŒ…å«å¼•ç”¨å¹¶æŒ‡å‘å¯å˜å¯¹è±¡ï¼Œä¾‹å¦‚ java.util.Optionalï¼‰ã€‚ equalsã€hashCode å’Œ toString çš„å®ç°åªä¾èµ–å®ä¾‹å­—æ®µçš„å€¼ï¼ˆåŒ…å«å¼•ç”¨çš„å¯¹è±¡ï¼‰è€Œä¸æ˜¯ Identityã€‚ æ–¹æ³•åœ¨å¤„ç†ç›¸ç­‰çš„ï¼ˆequalsï¼‰å®ä¾‹æ—¶è¡Œä¸ºæ˜¯ä¸€è‡´çš„ï¼ˆè®¤ä¸ºå®ä¾‹æ˜¯å¯è‡ªç”±æ›¿æ¢çš„ï¼ˆfreely substitutableï¼‰ï¼‰ã€‚ å®ä¾‹ä¸æ‰§è¡ŒåŒæ­¥æ“ä½œï¼ˆsynchronizedï¼‰ã€‚ æ²¡æœ‰å£°æ˜å¯è®¿é—®çš„æ„é€ å‡½æ•°ï¼ˆå¯ä»¥åŒ…å«åºŸå¼ƒçš„ï¼‰ã€‚ ä¸æä¾›ä»»ä½•å¯ä»¥ç”Ÿæˆç‹¬ç«‹ Identity çš„å¯¹è±¡åˆ›å»ºæœºåˆ¶ï¼š ç®€å•æ¥è¯´å°±æ˜¯ä»»ä½•æ–¹å¼åˆ›å»ºçš„å¯¹è±¡éƒ½æ˜¯ Identity-free çš„ã€‚ ç‰¹åˆ«çš„ï¼Œæ‰€æœ‰çš„å·¥å‚æ–¹æ³•éƒ½å¿…é¡»ä¿è¯ï¼Œç‹¬ç«‹ç”Ÿæˆçš„ä¸¤ä¸ªå®ä¾‹å¦‚æœ equals é‚£ä¹ˆä¸€å®š == ã€‚ ç‰¹åˆ«çš„ï¼ŒObject.clone() åº”è¯¥è¿”å›ç›¸åŒ == çš„å¯¹è±¡ã€‚ æ˜¯ final çš„ï¼Œçˆ¶ç±»ï¼ˆä»¬ï¼‰åªèƒ½æ˜¯ Object æˆ–è€…æ²¡æœ‰å­—æ®µã€æ²¡æœ‰åˆå§‹åŒ–ä»£ç ã€æ„é€ å‡½æ•°éƒ½æ˜¯ç©ºçš„æŠ½è±¡ç±»ã€‚ å¦‚æœåŸºäºå€¼çš„ä¸¤ä¸ªå¯¹è±¡æ˜¯ç›¸ç­‰çš„ï¼ˆequalsï¼‰ï¼Œç¨‹åºä¹Ÿä¸åº”è¯¥å°è¯•å»åŒºåˆ†å®ƒä»¬ ä¸ç®¡æ˜¯é€šè¿‡ç›´æ¥æˆ–é—´æ¥çš„å¼•ç”¨ã€ä½¿ç”¨ Identity hashã€åºåˆ—åŒ–ç­‰ä»»ä½•æœºåˆ¶ã€‚ ä¸åº”è¯¥æ‰§è¡ŒåŒæ­¥æ“ä½œï¼ˆsynchronizedï¼‰ï¼Œå› ä¸ºæ²¡æœ‰åŠæ³•ä¿è¯ç‹¬å å¯¹è±¡ç›‘è§†å™¨ã€‚ ä¸Šè¿°è¡Œä¸ºéƒ½æ˜¯ Identity ç›¸å…³çš„è¡Œä¸ºï¼ˆIdentity-related Behaviorï¼‰ï¼Œåœ¨æœªæ¥ç‰ˆæœ¬çš„ Java ä¸­å¯èƒ½ä¼šå˜åŒ–ï¼Œä¾‹å¦‚åŒæ­¥ä¼šå¤±è´¥ã€‚ ç›®å‰åŸºäºå€¼çš„ç±»åªæ˜¯ä¸€ç§å®šä¹‰ï¼Œä¸ºäº†åç»­ç‰ˆæœ¬æ›´å¥½çš„å‘å±•ï¼Œåœ¨ JDK 16 ä¸­å¼•å…¥äº†æ–°çš„ JEP 390: Warnings for Value-Based Classesï¼Œä¼šå¯¹ä¸Šè¿°çš„ä¸€äº›è¡Œä¸ºè¿›è¡Œè­¦å‘Šã€‚ åªå¢åŠ äº†è­¦å‘Šä¿¡æ¯ï¼Œæ²¡æœ‰ä»»ä½•åŠŸèƒ½å˜åŒ–It does not make any changes to the Java Language or Java Virtual Machine specifications. Primitive Class and Primitive ObjectsåŸºäºå€¼çš„ç±»åªæ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œä»»ä½•ä¸€ä¸ªç±»åªè¦æ»¡è¶³ä¸Šè¿°è§„èŒƒå°±æ˜¯åŸºäºå€¼çš„ï¼Œç›®å‰å¹¶ä¸ä¼šå¯¹å®é™…å†™ä»£ç äº§ç”Ÿä»»ä½•å½±å“ã€‚ åœ¨ Valhalla é¡¹ç›®ä¸­å¼•å…¥ä¸€ç§æ–°çš„ç±»å‹ï¼ŒåŸå§‹ç±»ï¼ˆprimitive classï¼‰(é¢„è§ˆ) åŸºäºå€¼çš„ Identity-free å› æ­¤åœ¨æœªæ¥çš„ Java ä»£ç ä¸­å¯èƒ½ä¼šå‡ºç° 123primitive class Point {...}assert new Point() == new Point();assert new Point() == Point.default; æ˜¯ä¸æ˜¯æ„Ÿè§‰ Java çš„åº•å±‚é€»è¾‘éƒ½æ”¹å˜äº†ï¼Œå°¤å…¶æ˜¯ä¸¤ä¸ª new å‡ºæ¥çš„å¯¹è±¡å±…ç„¶æ˜¯ == çš„ï¼Œåœ¨åŸºæœ¬ç±»å‹å’Œå¼•ç”¨ç±»å‹ä¹‹é—´å¢åŠ äº†ä¸€ç§æ–°çš„ç±»å‹ã€‚ Codes like a class, works like an int.ï¼ˆåƒ class ä¸€æ ·ç¼–å†™ï¼Œåƒ int ä¸€æ ·è¿è¡Œï¼‰è¿™é‡Œåªè§£é‡Šæ–°çš„æ¦‚å¿µï¼Œåé¢ä¼šè¿›ä¸€æ­¥æ¢è®¨ä¸ºä»€ä¹ˆéœ€è¦å¢åŠ æ–°çš„ç±»å‹ åœ¨ä»¥å‰çš„è‰æ¡ˆä¸­ç§°ä¸º â€œinline classâ€ / â€œinline typeâ€ ï¼Œæ¥çœ‹çœ‹ç›®å‰æœ€æ–°çš„å®šä¹‰https://mail.openjdk.java.net/pipermail/valhalla-spec-experts/2020-October/001415.html å¯¹è±¡ä¼šç»†åˆ†æˆä¸¤ç§ç±»å‹ Primitive Object åŸå§‹å¯¹è±¡ï¼šæ˜¯ä¸€ç§æ–°çš„ Identity-free çš„å¯¹è±¡ï¼Œç›¸ç­‰ã€åŒæ­¥ç­‰ç›¸å…³æ“ä½œçš„è¡Œä¸ºä¼šæœ‰æ‰€ä¸åŒ Identity Objectï¼šé™¤äº† Primitive Object ä¹‹å¤–çš„å¯¹è±¡ï¼ˆåŒ…æ‹¬æ•°ç»„ï¼‰ ç±»å‹ä¹Ÿä¼šè¿›è¡Œç»†åˆ† Identity Classï¼šå®ä¾‹æ˜¯ Identity Object çš„ç±»ã€‚ Primitive Class åŸå§‹ç±»ï¼ˆä»¥å‰å« Inline Classï¼‰ï¼šæ˜¯ä¸€ç§ç‰¹æ®Šçš„ç±»ï¼Œå®ƒçš„å®ä¾‹æ˜¯åŸå§‹å¯¹è±¡ã€‚ç±»æ˜¯ final çš„ï¼Œå¹¶ä¸”å—åˆ°å„ç§é™åˆ¶ã€‚éåŸå§‹ç±»è¦ä¸ç„¶æ˜¯ Identity Class è¦ä¸ç„¶æ˜¯æŠ½è±¡ç±»ï¼ˆæˆ–è€…æ˜¯ java.lang.Objectï¼‰ã€‚ Primitive Value Type åŸå§‹å€¼ç±»å‹ï¼ˆä»¥å‰å« Inline Typeï¼‰ï¼šæ˜¯ä¸€ç§ç±»å‹ï¼Œæ˜¯å€¼ä¸ºåŸå§‹å¯¹è±¡ï¼ˆå°±æ˜¯å¯¹è±¡æœ¬èº«ï¼Œè€Œä¸æ˜¯å¼•ç”¨ï¼‰ã€‚æ¯ä¸€ä¸ªåŸå§‹ç±»éƒ½æœ‰ä¸€ä¸ªåŸå§‹å€¼ç±»å‹ï¼Œé€šå¸¸å°±æ˜¯ ç±»å æ¥è¡¨ç¤ºã€‚ Primitive Reference Type åŸå§‹å¼•ç”¨ç±»å‹ï¼šæ˜¯ä¸€ç§ç±»å‹ï¼Œå€¼ä¸ºåŸå§‹å¯¹è±¡çš„å¼•ç”¨æˆ–è€… nullã€‚æ¯ä¸€ä¸ªåŸå§‹ç±»éƒ½æœ‰ä¸€ä¸ªåŸå§‹å¼•ç”¨ç±»å‹ï¼Œé€šå¸¸å°±æ˜¯ ç±»å.ref æ¥è¡¨ç¤ºã€‚ Primitive Typeï¼šPrimitive Value Type æˆ–è€… Primitive Reference Typeã€‚ Reference Typeï¼šä»ç„¶è¡¨ç¤ºå¯¹è±¡çš„å¼•ç”¨æˆ–è€… nullï¼ˆè·Ÿä»¥å‰ç›¸åŒï¼Œå¼ºè°ƒåŒ…å«äº† Primitive Reference Typeï¼‰ã€‚ ç±» Class / ç±»å‹ Type æ˜¯ä¸¤ä¸ªæ¦‚å¿µï¼Œå‚è€ƒä¸Šæ–‡ã€‚ åœ¨ Java è¯­è¨€ä¸­ï¼ŒåŸºæœ¬ç±»å‹å°†ï¼ˆè®¡åˆ’ï¼‰å˜æˆåŸå§‹å¯¹è±¡ï¼Œè€Œç”¨ java.lang.Integer ç­‰ä½œä¸ºå®ƒä»¬çš„åŸå§‹ç±»ã€‚åœ¨éœ€è¦çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨å†…ç½®çš„åŸå§‹å€¼ç±»å‹ï¼ˆbuilt-in primitive value typeï¼‰æŒ‡ä»£å®ƒä»¬çš„ç±»å‹ã€‚ æ„å‘³ç€ï¼Œåé¢å°±æ²¡æœ‰åŸºæœ¬ç±»å‹äº†ï¼Œåªæœ‰åŸå§‹å¯¹è±¡å’Œ Identity å¯¹è±¡ï¼ŒJava å°†çœŸæ­£å˜æˆä¸€åˆ‡çš†å¯¹è±¡ã€‚int double ç­‰å«ä¹‰ä¼šå‘ç”Ÿéå¸¸å¤§çš„å˜åŒ–ï¼Œä½†åœ¨ä½¿ç”¨ä¸Šå‡ ä¹æ²¡æœ‰å˜åŒ–ã€‚ è¿™äº›æ¦‚å¿µæœ‰ä¸€äº›ç¹çï¼Œæˆ‘ä»¬æ¥ä¸¾ä¸€äº›ä¾‹å­ 1234567891011121314java.lang.Integer.val.class // åŸå§‹ç±»int.class // åŸå§‹ç±»java.lang.Integer.class // åŸå§‹ç±»java.lang.Object.class // éåŸå§‹ç±»int.class ç­‰ä»·äº Integer.val.classjava.lang.Integer.val // åŸå§‹å€¼ç±»å‹java.lang.Integer // åŸå§‹å¼•ç”¨ç±»å‹int.ref // åŸå§‹å¼•ç”¨ç±»å‹int // åŸå§‹å€¼ç±»å‹ï¼ˆå…³é”®å­—ï¼‰int.ref ç­‰ä»·äº Integerint ç­‰ä»·äº Integer.val","link":"/2021/10/valhalla/"},{"title":"Valhalla (1): èƒŒæ™¯ How We Got the Generics We Have","text":"ç¿»è¯‘ https://openjdk.java.net/projects/valhalla/design-notes/in-defense-of-erasureã€‚ åœ¨æˆ‘ä»¬è®¨è®ºæ³›å‹è¯¥å¦‚ä½•å‘å±•æ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆè¦çœ‹çœ‹å½“å‰æ³›å‹æ˜¯ä»€ä¹ˆæ ·çš„ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦èšç„¦åœ¨æ³›å‹æ˜¯å¦‚ä½•å‘å±•åˆ°ç°åœ¨çš„ï¼Œä»¥åŠä¸ºä»€ä¹ˆä¼šæ˜¯è¿™ä¸ªæ ·å­ï¼Œäº†è§£è¿™äº›å¯ä»¥å¸®åŠ©æˆ‘ä»¬åŸºäºç°æœ‰çš„æ³›å‹å°è¯•æ„å»ºå‡ºâ€œæ›´å¥½â€çš„æ³›å‹ã€‚ ç‰¹åˆ«æ˜¯ï¼Œæˆ‘ä»¬å¼ºè°ƒæ“¦é™¤å®é™…ä¸Šæ˜¯ 2004 å¹´å°†æ³›å‹æ·»åŠ åˆ° Java æ—¶æ˜æ™ºä¸”åŠ¡å®çš„é€‰æ‹©ï¼Œè€Œä¸”å¾ˆå¤šå¯¼è‡´æˆ‘ä»¬é€‰æ‹©æ“¦é™¤çš„å› ç´ è‡³ä»Šä»åœ¨è¿ä½œã€‚ ç³»åˆ—æ–‡ç« ï¼ˆæœªå®Œå¾…ç»­ï¼‰ Valhalla (0): åºè¨€ Valhalla (1): èƒŒæ™¯ How We Got the Generics We Have Valhalla (2): ç°çŠ¶ The Road to Valhalla Valhalla (5): è§£è¯» JEP 390 Warnings for Value-Based Classes Valhalla (6): è§£è¯» JEP 401 Primitive Objects Valhalla (7): è§£è¯» JEP 402 Unify the Basic Primitives with Objects æ“¦é™¤ Erasureå‘ä»»ä½•å¼€å‘äººå‘˜è¯¢é—® Java æ³›å‹ï¼Œä½ å¯èƒ½ä¼šå¾—åˆ°å…³äºæ“¦é™¤çš„è´Ÿé¢æƒ…ç»ªï¼ˆè™½ç„¶é€šå¸¸æ˜¯ä¸çŸ¥æƒ…çš„ï¼‰ã€‚æ“¦é™¤å¯èƒ½æ˜¯ Java ä¸­æœ€å¹¿æ³›ã€æœ€æ·±å…¥è¢«è¯¯è§£çš„æ¦‚å¿µäº†ã€‚ æ“¦é™¤ä¸æ˜¯ Java ç‰¹æœ‰çš„ï¼Œä¹Ÿä¸æ˜¯æ³›å‹ç‰¹æœ‰çš„ï¼Œå®ƒæ˜¯ä¸€ç§æ— å¤„ä¸åœ¨ä¸”å¿…è¦çš„å·¥å…·ï¼Œç”¨äºå°†ä»£ç è½¬æ¢ä¸ºè¾ƒä½çº§åˆ«çš„ä»£ç ï¼ˆä¾‹å¦‚ä» Java æºä»£ç ç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼Œæˆ–å°† C æºä»£ç ç¼–è¯‘ä¸ºæœ¬åœ°ä»£ç ï¼‰ã€‚è¿™æ˜¯å› ä¸ºå½“æˆ‘ä»¬ä»é«˜çº§è¯­è¨€è½¬æ¢åˆ°åˆ°ä¸­é—´è¡¨ç¤ºå†åˆ°æœ¬åœ°ä»£ç å†åˆ°ç¡¬ä»¶æ—¶ï¼Œåº•å±‚æä¾›çš„ç±»å‹æŠ½è±¡å‡ ä¹æ€»æ˜¯æ¯”é«˜å±‚æä¾›æ›´å¼±æ›´ç®€å•ï¼Œè¿™ä¹Ÿæ˜¯åˆç†çš„ï¼ˆæˆ‘ä»¬ä¸æƒ³å°†è™šæ‹Ÿåˆ†æ´¾çš„è¯­ä¹‰åŠ å…¥åˆ° X86 æŒ‡ä»¤é›†ä¸­ï¼Œæˆ–è€…åœ¨å…¶å¯„å­˜å™¨ä¸­æ”¯æŒ Java çš„åŸºæœ¬ç±»å‹ï¼‰ã€‚æ“¦é™¤æ˜¯ä¸€ç§å°†æ›´ä¸°å¯Œçš„ç±»å‹æ˜ å°„åˆ°è¾ƒä½çº§åˆ«çš„ç®€å•ç±»å‹çš„æŠ€æœ¯ï¼ˆç†æƒ³æƒ…å†µä¸‹ï¼Œåœ¨æ›´é«˜çº§åˆ«æ‰§è¡Œå®Œæ•´çš„ç±»å‹æ£€æŸ¥ä¹‹åï¼‰ï¼Œè¿™ä¹Ÿæ˜¯ç¼–è¯‘å™¨çš„æ—¥å¸¸å·¥ä½œã€‚ ä¾‹å¦‚ï¼ŒJava å­—èŠ‚ç åŒ…å«åœ¨å †æ ˆå’Œå±€éƒ¨å˜é‡ï¼ˆiloadã€istoreï¼‰ä¹‹é—´ç§»åŠ¨æ•´æ•°å€¼çš„æŒ‡ä»¤ï¼Œä»¥åŠå¯¹æ•´æ•°ï¼ˆiaddã€imul ç­‰ï¼‰è¿›è¡Œç®—æœ¯è¿ç®—çš„æŒ‡ä»¤ã€‚å•ç²¾åº¦æµ®ç‚¹æ•°ï¼ˆfloadã€fstoreã€fmul ç­‰ï¼‰ã€é•¿æ•´æ•°ï¼ˆlloadã€lstoreã€lmulï¼‰ã€åŒç²¾åº¦æµ®ç‚¹æ•°ï¼ˆdloadã€dstoreã€dmulï¼‰å’Œå¯¹è±¡å¼•ç”¨ï¼ˆaloadã€astoreï¼‰éƒ½æœ‰ç±»ä¼¼çš„æŒ‡ä»¤ã€‚ä½†å…¶ä»–åŸºæœ¬ç±»å‹ï¼ˆbyteã€shortã€char å’Œ booleanï¼‰æ²¡æœ‰è¿™æ ·çš„æŒ‡ä»¤ï¼Œå› ä¸ºè¿™äº›ç±»å‹è¢«ç¼–è¯‘å™¨æ“¦é™¤ä¸ºæ•´æ•°ï¼Œå¹¶ä½¿ç”¨æ•´æ•°ç§»åŠ¨å’Œç®—æœ¯æŒ‡ä»¤ã€‚è¿™æ˜¯å­—èŠ‚ç æŒ‡ä»¤é›†è®¾è®¡çš„æƒè¡¡ï¼Œå®ƒé™ä½äº†æŒ‡ä»¤é›†çš„å¤æ‚æ€§ï¼Œè¿›è€Œå¯ä»¥æé«˜è¿è¡Œæ—¶çš„æ•ˆç‡ã€‚Java è¯­è¨€çš„è®¸å¤šå…¶ä»–ç‰¹æ€§ï¼ˆä¾‹å¦‚æ£€æŸ¥å¼‚å¸¸ã€æ–¹æ³•é‡è½½ã€æšä¸¾ã€definite assignment analysisã€å†…éƒ¨ç±»ã€é€šè¿‡ lambda æˆ–å±€éƒ¨ç±»æ•è·å±€éƒ¨å˜é‡ç­‰ï¼‰æ˜¯â€œè¯­è¨€é”™è§‰â€ï¼Œå®ƒä»¬åœ¨ Java ç¼–è¯‘å™¨ä¸­æ£€æŸ¥ï¼Œä½†åœ¨è½¬æ¢ä¸ºç±»æ–‡ä»¶æ—¶è¢«æ“¦é™¤äº†ã€‚ ç±»ä¼¼åœ°ï¼Œåœ¨å°† C ç¼–è¯‘ä¸ºæœ¬æœºä»£ç æ—¶ï¼Œæœ‰ç¬¦å·å’Œæ— ç¬¦å·æ•´æ•°éƒ½è¢«æ“¦é™¤åˆ°é€šç”¨å¯„å­˜å™¨ä¸­ï¼ˆæ²¡æœ‰å•ç‹¬çš„æœ‰ç¬¦å·å¯„å­˜å™¨å’Œæ— ç¬¦å·å¯„å­˜å™¨ï¼‰ï¼Œå¹¶ä¸” const å˜é‡å­˜å‚¨åœ¨å¯å˜å¯„å­˜å™¨å’Œå¯å˜çš„å†…å­˜ä¸­ã€‚æˆ‘ä»¬æ ¹æœ¬ä¸è§‰å¾—è¿™ç§æ“¦é™¤å¾ˆå¥‡æ€ªã€‚ åŒæ„ä¸å¼‚æ„ç¿»è¯‘ Homogeneous vs. Heterogeneous Translationsåœ¨å…·æœ‰å‚æ•°å¤šæ€æ€§çš„è¯­è¨€ä¸­ï¼Œç¿»è¯‘æ³›å‹ç±»å‹æœ‰ä¸¤ç§å¸¸ç”¨çš„æ–¹æ³•ï¼šåŒæ„å’Œå¼‚æ„ç¿»è¯‘ã€‚åœ¨åŒæ„ç¿»è¯‘ä¸­ï¼Œæ³›å‹ç±» Foo&lt;T&gt; è¢«è½¬æ¢ä¸ºå•ä¸€çš„äº§ç‰©ï¼Œä¾‹å¦‚ Foo.class ï¼ˆå¯¹äºæ³›å‹æ–¹æ³•ä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ã€‚åœ¨å¼‚æ„ç¿»è¯‘ä¸­ï¼Œæ³›å‹ç±»å‹æˆ–æ–¹æ³•çš„æ¯ä¸ªå®ä¾‹(Foo&lt;String&gt;ã€Foo&lt;Integer&gt;) éƒ½è¢«è§†ä¸ºä¸€ä¸ªå•ç‹¬çš„å®ä½“ï¼Œå¹¶ç”Ÿæˆç‹¬ç«‹çš„äº§ç‰©ã€‚ä¾‹å¦‚ï¼ŒC++ ä½¿ç”¨å¼‚æ„ç¿»è¯‘ï¼Œæ¨¡æ¿çš„ä¸åŒå®ä¾‹æ˜¯å®Œå…¨ä¸åŒçš„ç±»å‹ï¼Œå…·æœ‰ä¸åŒçš„è¯­ä¹‰å’Œä¸åŒçš„ç”Ÿæˆä»£ç ã€‚vector&lt;int&gt; å’Œ vector&lt;float&gt; æ˜¯ä¸åŒçš„ç±»å‹ã€‚ä¸€æ–¹é¢ï¼Œè¿™å¯¹äºç±»å‹å®‰å…¨ï¼ˆæ¯ä¸ªå®ä¾‹å¯ä»¥åœ¨æ‰©å±•åå•ç‹¬è¿›è¡Œç±»å‹æ£€æŸ¥ï¼‰å’Œç”Ÿæˆä»£ç çš„è´¨é‡ï¼ˆå› ä¸ºæ¯ä¸ªå®ä¾‹å¯ä»¥å•ç‹¬ä¼˜åŒ–ï¼‰éå¸¸æœ‰ç”¨ã€‚å¦ä¸€æ–¹é¢ï¼Œè¿™æ„å‘³ç€æ›´å¤§çš„ä»£ç ç©ºé—´å ç”¨ï¼ˆå› ä¸º vector&lt;int&gt; å’Œ vector&lt;float&gt; æœ‰ç‹¬ç«‹çš„ä»£ç ï¼‰ï¼Œæˆ‘ä»¬ä¸èƒ½è°ˆè®ºâ€œæŸä¸ªä¸œè¥¿çš„ vectorâ€ï¼ˆå°±åƒ Java é€šè¿‡é€šé…ç¬¦æ‰€åšçš„é‚£æ ·ï¼‰ï¼Œå› ä¸ºæ¯ä¸ªå®ä¾‹éƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„ä¸ç›¸å…³çš„ç±»å‹ã€‚ï¼ˆä½œä¸ºå¯¹å¯èƒ½çš„å ç”¨ç©ºé—´æˆæœ¬çš„æç«¯æ¼”ç¤ºï¼ŒScala è¯•éªŒäº†ä¸€ä¸ª @specialized æ³¨è§£ï¼Œå½“åº”ç”¨äºç±»å‹å˜é‡æ—¶ï¼Œä¼šå¯¼è‡´ç¼–è¯‘å™¨ä¸ºæ‰€æœ‰åŸºæœ¬ç±»å‹ç”Ÿæˆä¸“é—¨çš„ç‰ˆæœ¬ã€‚è¿™å¬èµ·æ¥å¾ˆé…·ï¼Œä½†å¯¼è‡´ç”Ÿæˆç±»çš„æ•°é‡éšç€ç±»å‹å˜é‡çš„æ•°é‡çˆ†ç‚¸å¼å¢é•¿ï¼Œå› æ­¤å¯ä»¥ä»å‡ è¡Œä»£ç è½»æ¾ç”Ÿæˆä¸€ä¸ª 100MB çš„ JAR æ–‡ä»¶ã€‚ï¼‰ åœ¨åŒæ„å’Œå¼‚æ„ç¿»è¯‘ä¹‹é—´çš„é€‰æ‹©ï¼Œæ¶‰åŠåˆ°è¯­è¨€è®¾è®¡è€…ä¸€ç›´åœ¨è¿›è¡Œçš„å„ç§æƒè¡¡ã€‚å¼‚æ„ç¿»è¯‘æä¾›äº†æ›´å¤šçš„ç±»å‹ç‰¹å¼‚æ€§ï¼Œä½†ä»£ä»·æ˜¯æ›´å¤§çš„é™æ€å’ŒåŠ¨æ€å¼€é”€ï¼Œä»¥åŠæ›´å°‘çš„è¿è¡Œæ—¶å…±äº«ï¼Œæ‰€æœ‰è¿™äº›éƒ½ä¼šå¯¹æ€§èƒ½äº§ç”Ÿå½±å“ã€‚åŒæ„ç¿»è¯‘æ›´é€‚åˆæŠ½è±¡ç›¸ä¼¼çš„å‚æ•°ç±»å‹ï¼Œä¾‹å¦‚ Java çš„é€šé…ç¬¦æˆ– C# çš„ declaration-site varianceï¼ˆC++ ç¼ºå°‘è¿™ä¸¤è€…ï¼Œvector&lt;int&gt; å’Œ vector&lt;float&gt; ä¹‹é—´æ²¡æœ‰ä»»ä½•å…±åŒç‚¹ï¼‰ã€‚æœ‰å…³ç¿»è¯‘ç­–ç•¥çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜…è¿™ç¯‡æœ‰å½±å“åŠ›çš„è®ºæ–‡ã€‚ åœ¨ Java ä¸­æ“¦é™¤æ³›å‹ Erased Generics in JavaJava ä½¿ç”¨åŒæ„ç¿»è¯‘æ¥ç¿»è¯‘æ³›å‹ã€‚æ³›å‹åœ¨ç¼–è¯‘æ—¶è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œä½†æ˜¯åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶ï¼Œåƒ List&lt;String&gt; è¿™æ ·çš„æ³›å‹ç±»å‹ä¼šè¢«æ“¦é™¤åˆ° Listï¼Œè€Œåƒ &lt;T extends Object&gt; è¿™æ ·çš„ç±»å‹å˜é‡ä¼šè¢«æ“¦é™¤åˆ°å®ƒä»¬çš„è¾¹ç•Œï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹å°±æ˜¯ Objectï¼‰ã€‚å¦‚æœæˆ‘ä»¬æœ‰ï¼š 123456789class Box&lt;T&gt; { private T t; public Box(T t) { this.t = t; } public Box&lt;T&gt; copy() { return new Box&lt;&gt;(t); } public T t() { return t; }} javac ç¼–è¯‘å™¨æ„å»ºå‡ºä¸€ä¸ªå•ä¸€çš„ç±»æ–‡ä»¶ Box.classï¼Œä½œä¸º Box çš„æ‰€æœ‰å®ä¾‹åŒ–çš„å®ç°ï¼ŒåŒ…æ‹¬é€šé…ç¬¦ (Box&lt;?&gt;) å’ŒåŸå§‹ç±»å‹ (Box)ã€‚å­—æ®µã€æ–¹æ³•ã€çˆ¶ç±»å‹çš„æè¿°éƒ½è¢«æ“¦é™¤ï¼Œç±»å‹å˜é‡è¢«æ“¦é™¤åˆ°å®ƒä»¬çš„è¾¹ç•Œï¼Œæ³›å‹ç±»å‹å‚æ•°è¢«æ“¦é™¤åˆ°å®ƒä»¬çš„åŸå§‹ç±»å‹ï¼ˆList&lt;String&gt; æ“¦é™¤åˆ° Listï¼‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 123456789class Box { private Object t; public Box(Object t) { this.t = t; } public Box copy() { return new Box(t); } public Object t() { return t; }} æ³¨ï¼šä¸Šé¢ä¸€æ®µæè¿°æ¯”è¾ƒç»•ï¼ŒæŒ‡çš„æ˜¯ç±»å‹å‚æ•°å‡ºç°åœ¨ä¸åŒçš„ä½ç½®ï¼Œä¾‹å¦‚ï¼š 12345678910111213class Demo&lt; F extends Number, M extends List&lt;F&gt;, S extends Serializable, E extends Object&gt; implements List&lt;S&gt; { private F field; private List&lt;E&gt; list; private S object; M t(M m) { return m; }} è¢«æ“¦é™¤ä¸ºï¼š 123456789class Demo implements List { private Number field; private List list; private Serializable object; List t(List m) { return m; }} æ³›å‹ç­¾åä¼šè¢«ä¿ç•™åœ¨ Signature å±æ€§ä¸­ï¼Œä»¥ä¾¿ç¼–è¯‘å™¨åœ¨è¯»å–ç±»æ–‡ä»¶æ—¶å¯ä»¥çœ‹åˆ°æ³›å‹ç­¾åï¼Œä½† JVM åœ¨é“¾æ¥æ—¶ä»…ä½¿ç”¨æ“¦é™¤åçš„æè¿°ç¬¦ã€‚è¿™ç§è½¬æ¢æ–¹æ¡ˆæ„å‘³ç€åœ¨ç±»æ–‡ä»¶çº§åˆ«ï¼ŒBox&lt;T&gt; çš„å¸ƒå±€å’Œ API éƒ½è¢«æ“¦é™¤äº†ã€‚åŒæ ·çš„äº‹æƒ…ä¹Ÿä¼šå‘ç”Ÿåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯¹ Box&lt;String&gt; çš„å¼•ç”¨è¢«æ“¦é™¤åˆ° Boxï¼Œå¹¶ä¸”ä¼šæ’å…¥åˆ° String çš„ç±»å‹è½¬æ¢ã€‚ä¾‹å¦‚ï¼š 12Box&lt;String&gt; box = new Box&lt;&gt;();String value = box.t(); ä¼šè¢«è½¬æ¢æˆï¼š 12Box box = new Box();String value = (String)box.t(); æœ‰æ²¡æœ‰æ›¿ä»£æ–¹æ¡ˆ Why? What were the Alternatives?æ­£æ˜¯åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œäººä»¬å¾ˆå®¹æ˜“ç”Ÿæ°”å¹¶å®£ç§°è¿™æ˜¯æ„šè ¢æˆ–æ‡’æƒ°çš„é€‰æ‹©ï¼Œæˆ–è€…è¯´æ“¦é™¤æ˜¯ä¸€ç§éå¸¸ hack çš„è¡Œä¸ºã€‚æ¯•ç«Ÿï¼Œä¸ºä»€ä¹ˆç¼–è¯‘å™¨ä¼šä¸¢å¼ƒå®Œç¾çš„ç±»å‹ä¿¡æ¯å‘¢ï¼Ÿ ä¸ºäº†æ›´å¥½åœ°ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è¿˜åº”è¯¥é—®ï¼šæˆ‘ä»¬æ˜¯å¦è¦ç‰¹åŒ–è¯¥ç±»å‹ä¿¡æ¯ï¼Œæˆ‘ä»¬å¸Œæœ›ç”¨å®ƒåšä»€ä¹ˆï¼Œä»¥åŠä¸ä¹‹ç›¸å…³çš„æˆæœ¬æ˜¯å¤šå°‘ï¼Ÿæˆ‘ä»¬å¯ä»¥è®¾æƒ³å‡ ç§ä¸åŒçš„åœºæ™¯ï¼Œéœ€è¦ä½¿ç”¨ç‰¹åŒ–çš„ç±»å‹å‚æ•°ä¿¡æ¯ï¼š åå°„ï¼šå¯¹äºæŸäº›äººæ¥è¯´ï¼Œâ€œç‰¹åŒ–æ³›å‹â€ä»…ä»…æ„å‘³ç€å¯ä»¥çŸ¥é“ List å®ƒæ˜¯ä»€ä¹ˆçš„åˆ—è¡¨ï¼Œæ— è®ºæ˜¯ä½¿ç”¨è¯¸å¦‚ instanceof ä¹‹ç±»çš„è¯­è¨€ç‰¹æ€§æˆ–å¯¹ç±»å‹å˜é‡è¿›è¡Œæ¨¡å¼åŒ¹é…ï¼Œè¿˜æ˜¯ä½¿ç”¨åå°„åº“æ¥æŸ¥è¯¢ç±»å‹å‚æ•°ã€‚ ç‰¹åŒ– API å’Œå¸ƒå±€ï¼šåœ¨æœ‰åŸºæœ¬ç±»å‹æˆ–è€…å†…è”ç±»çš„è¯­è¨€ä¸­ï¼Œå°† Pair&lt;int, int&gt; å¸ƒå±€æ‰å¹³åŒ–æˆä¸¤ä¸ª int ä¼šæ›´å¥½ï¼Œè€Œä¸æ˜¯ä¸¤ä¸ªæŒ‡å‘åŒ…è£…å¯¹è±¡çš„å¼•ç”¨ã€‚ è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥ï¼šå½“ä½¿ç”¨è€…å°è¯•å°† Integer æ”¾å…¥ List&lt;String&gt; ä¸­æ—¶ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ List åŸå§‹ç±»å‹å¼•ç”¨ï¼‰ï¼Œä¼šå¯¼è‡´å†…å­˜æ±¡æŸ“ã€‚èƒ½å¤Ÿè¯†åˆ«è¿™ç±»é—®é¢˜å¹¶å¤±è´¥ï¼Œä¼šæ¯”ï¼ˆå¯èƒ½çš„ï¼‰åç»­å†é€šè¿‡ç±»å‹è½¬æ¢æ£€æµ‹ä¼šæ›´å¥½ã€‚ æŠŠ Integer æ”¾å…¥ List&lt;String&gt; ï¼Œåœ¨åç»­ä¸ä¼šè¯»å–çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½æ˜¯ä¸ä¼šå‡ºæŠ¥é”™çš„ã€‚ è™½ç„¶å¹¶ä¸ç›¸äº’æ’æ–¥ï¼Œä½†è¿™ä¸‰ç§å¯èƒ½ï¼ˆåå°„ã€ç‰¹åŒ–å’Œç±»å‹æ£€æŸ¥ï¼‰æœ‰åŠ©äºå®ç°ä¸åŒçš„ç›®æ ‡ï¼ˆåˆ†åˆ«æ˜¯ä¾¿åˆ©æ€§ã€æ€§èƒ½å’Œå®‰å…¨æ€§ï¼‰ï¼Œå¹¶ä¸”å…·æœ‰ä¸åŒçš„å«ä¹‰å’Œæˆæœ¬ã€‚è™½ç„¶è¯´â€œæˆ‘ä»¬æƒ³è¦ç‰¹åŒ–â€å¾ˆå®¹æ˜“ï¼Œä½†å¦‚æœæ·±å…¥ç ”ç©¶ï¼Œä¼šå‘ç°ï¼Œå¯¹äºä»€ä¹ˆæ˜¯æœ€é‡è¦çš„ã€å®ƒä»¬çš„æˆæœ¬å’Œæ”¶ç›Šæ˜¯ä»€ä¹ˆï¼Œæ˜¯å­˜åœ¨å·¨å¤§åˆ†æ­§çš„ã€‚ è¦äº†è§£æ“¦é™¤åœ¨è¿™é‡Œæ˜¯å¤šä¹ˆæ˜æ™ºå’ŒåŠ¡å®çš„é€‰æ‹©ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»äº†è§£å½“æ—¶çš„ç›®æ ‡ã€ä¼˜å…ˆäº‹é¡¹å’Œé™åˆ¶ä»¥åŠæ›¿ä»£æ–¹æ¡ˆã€‚ é€æ­¥è¿ç§»å…¼å®¹æ€§ Goal: Gradual Migration CompatibilityJava æ³›å‹å®šäº†ä¸€ä¸ªé›„å¿ƒå‹ƒå‹ƒçš„è¦æ±‚ï¼šå¿…é¡»èƒ½å¤Ÿä»¥äºŒè¿›åˆ¶å…¼å®¹å’Œæºä»£ç å…¼å®¹çš„æ–¹å¼å°†ç°æœ‰çš„éæ³›å‹ç±»æ¼”åŒ–ä¸ºæ³›å‹ç±»ã€‚ è¿™æ„å‘³ç€ç°æœ‰çš„è°ƒç”¨è€…å’Œå­ç±»ï¼Œæ¯”å¦‚ ArrayListï¼Œå¯ä»¥ç»§ç»­é‡æ–°ç¼–è¯‘è€Œä¸æ”¹å˜æˆæ³›å‹çš„ ArrayList&lt;T&gt;ï¼Œå¹¶ä¸”ç°æœ‰çš„ç±»æ–‡ä»¶å°†ç»§ç»­é“¾æ¥åˆ°æ³›å‹çš„ ArrayList&lt;T&gt; çš„æ–¹æ³•ã€‚æ»¡è¶³ä¸Šè¿°è¦æ±‚ï¼Œæ„å‘³ç€è°ƒç”¨è€…å’Œæ³›åŒ–ç±»çš„å­ç±»å¯ä»¥é€‰æ‹©ç«‹å³ã€ç¨åæˆ–æ°¸è¿œä¸è¿›è¡Œæ³›åŒ–ï¼Œå¹¶ä¸”å¯ä»¥ç‹¬ç«‹äºå…¶ä»–è°ƒç”¨è€…æˆ–å­ç±»çš„ç»´æŠ¤è€…çš„é€‰æ‹©ã€‚ å¦‚æœæ²¡æœ‰è¿™ä¸ªè¦æ±‚ï¼Œç”Ÿæˆä¸€ä¸ªç±»å°†éœ€è¦ä¸€ä¸ªâ€œæˆªæ­¢æ—¥æœŸâ€ï¼Œæ‰€æœ‰è°ƒç”¨è€…å’Œå­ç±»å°±ç®—ä¸ä¿®æ”¹ï¼Œä½†è‡³å°‘å¿…é¡»é‡æ–°ç¼–è¯‘ã€‚å¯¹äºåƒ ArrayList è¿™æ ·çš„æ ¸å¿ƒç±»ï¼Œè¿™æœ¬è´¨ä¸Šè¦æ±‚é‡æ–°ç¼–è¯‘ä¸–ç•Œä¸Šæ‰€æœ‰çš„ Java ä»£ç ï¼ˆæˆ–æ°¸ä¹…é™çº§ä¿ç•™åœ¨ Java 1.4 ä¸Šï¼‰ã€‚å› ä¸ºæ•´ä¸ª Java ç”Ÿæ€ä¸­å·²ç»ä¸å­˜åœ¨è¿™æ ·çš„â€œæˆªæ­¢æ—¥æœŸâ€ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ³›å‹ç±»å‹ç³»ç»Ÿï¼Œå…è®¸æ ¸å¿ƒå¹³å°ç±»ï¼ˆä»¥åŠæµè¡Œçš„ç¬¬ä¸‰æ–¹åº“ï¼‰è¢«æ³›åŒ–ï¼Œè€Œä¸éœ€è¦è°ƒç”¨è€…çŸ¥é“å®ƒä»¬è¢«æ³›åŒ–ã€‚ï¼ˆæ›´ç³Ÿç³•çš„æ˜¯ï¼Œå®ƒä¸ä¼šæ˜¯ä¸€ä¸ªç¡®å®šçš„æ—¶é—´ï¼Œå› ä¸ºä¸–ç•Œä¸Šæ‰€æœ‰çš„ä»£ç éƒ½ä¸å¯èƒ½åœ¨åŒä¸€ä¸ªæ—¶åˆ»è¢«æ³›å‹åŒ–ï¼‰ å¦ä¸€ç§æ»¡è¶³æ­¤è¦æ±‚çš„æ–¹å¼æ˜¯ï¼šéš”ç¦»æ‰€æœ‰å¯ä»¥è¢«æ³›åŒ–çš„ä»£ç è¢«è®¤ä¸ºæ˜¯ä¸å¯æ¥å—çš„ï¼Œæˆ–è€…è®©å¼€å‘äººå‘˜åœ¨æ³›å‹ä¹‹é—´è¿›è¡Œé€‰æ‹©å¹¶ä¿ç•™å®ƒä»¬å·²æœ‰çš„ä»£ç ã€‚é€šè¿‡ä½¿æ³›åŒ–æˆä¸ºå…¼å®¹æ“ä½œï¼Œå¯ä»¥ä¿ç•™å·²æœ‰çš„ä»£ç ï¼Œè€Œä¸æ˜¯åºŸå¼ƒæ‰ã€‚ åŸæ–‡æœ‰ç‚¹ç»•ï¼Œæ„Ÿè§‰ä¸Šæ˜¯åœ¨è¯´ï¼Œå¯ä»¥å•ç‹¬è®¾è®¡ä¸€å¥— APIï¼ˆä¾‹å¦‚ GenericList&lt;T&gt; ï¼‰ï¼Œç„¶åä¹‹å‰çš„ API ç»§ç»­å­˜åœ¨ï¼ˆä¾‹å¦‚åªæœ‰ List è€Œä¸å­˜åœ¨ List&lt;T&gt; ï¼‰ï¼Œè¿™æ ·å¼€å‘äººå‘˜å¯ä»¥è‡ªè¡Œé€‰æ‹©ï¼Œä¹‹å‰çš„ä»£ç éƒ½å¯ä»¥ç»§ç»­ä¿ç•™ã€‚ å¯¹â€œæˆªæ­¢æ—¥æœŸâ€çš„åŒæ¶æ¥è‡ª Java è®¾è®¡çš„ä¸€ä¸ªåŸºæœ¬åŸåˆ™ï¼šJava æ˜¯å•ç‹¬ç¼–è¯‘å’ŒåŠ¨æ€é“¾æ¥çš„ã€‚å•ç‹¬ç¼–è¯‘æ˜¯æŒ‡å°†æ¯ä¸ªæºæ–‡ä»¶ç¼–è¯‘æˆä¸€ä¸ªæˆ–å¤šä¸ªç±»æ–‡ä»¶ï¼Œè€Œä¸æ˜¯å°†ä¸€ç»„æºæ–‡ä»¶ç¼–è¯‘æˆå•ä¸ªäº§ç‰©ã€‚åŠ¨æ€é“¾æ¥æ„å‘³ç€ç±»ä¹‹é—´çš„å¼•ç”¨åœ¨è¿è¡Œæ—¶åŸºäºç¬¦å·ä¿¡æ¯é“¾æ¥çš„ï¼šå¦‚æœç±» C åœ¨è°ƒç”¨äº† D ä¸­ void m(int x) æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨ C çš„ç±»æ–‡ä»¶ä¸­æˆ‘ä»¬è®°å½•äº†è°ƒç”¨çš„æ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦ (I)Vï¼Œå¹¶åœ¨é“¾æ¥æ—¶åœ¨ D ä¸­æŸ¥æ‰¾ä¸€ä¸ªæ–¹æ³•ä½¿ç”¨æ­¤åç§°å’Œæè¿°ç¬¦ï¼Œå¦‚æœæ‰¾åˆ°åŒ¹é…é¡¹ï¼Œåˆ™é“¾æ¥è¯¥è°ƒç”¨ã€‚ è¿™å¬èµ·æ¥åƒæ˜¯éå¸¸å·¨å¤§çš„å·¥ä½œï¼Œä½†æ˜¯å°†ç¼–è¯‘å’ŒåŠ¨æ€é“¾æ¥åˆ†å¼€æ˜¯ Java çš„æœ€å¤§ä¼˜åŠ¿ä¹‹ä¸€ï¼šå¯ä»¥é’ˆå¯¹ä¸€ä¸ªç‰ˆæœ¬çš„ D ç¼–è¯‘ Cï¼Œå¹¶åœ¨ç±»è·¯å¾„ä¸Šä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„ D è¿è¡Œï¼ˆåªè¦ä¸ç ´åäºŒè¿›åˆ¶å…¼å®¹æ€§ï¼‰ã€‚å¯¹åŠ¨æ€é“¾æ¥çš„æ‰¿è¯ºå…è®¸æˆ‘ä»¬ç®€å•åœ°åœ¨ç±»è·¯å¾„ä¸Šæ”¾ç½®ä¸€ä¸ªæ–°çš„ JAR ä»¥æ›´æ–°åˆ°ä¾èµ–é¡¹çš„æ–°ç‰ˆæœ¬ï¼Œè€Œæ— éœ€é‡æ–°ç¼–è¯‘ä»»ä½•ä¸œè¥¿ã€‚ æˆ‘ä»¬ç»å¸¸è¿™æ ·åšï¼Œç”šè‡³éƒ½æ²¡æœ‰æ³¨æ„åˆ°ã€‚ä½†æ˜¯å¦‚æœå‡ºç°é—®é¢˜ï¼Œå®ƒç¡®å®ä¼šè¢«æ³¨æ„åˆ°ã€‚ åœ¨æ³›å‹è¢«å¼•å…¥ Java çš„æ—¶å€™ï¼Œä¸–ç•Œä¸Šå·²ç»æœ‰éå¸¸å¤šçš„ Java ä»£ç ï¼Œå®ƒä»¬çš„ç±»æ–‡ä»¶ä¸­å……æ»¡äº†å¯¹ java.util.ArrayList ç­‰ API çš„å¼•ç”¨ã€‚å¦‚æœæˆ‘ä»¬ä¸èƒ½å…¼å®¹åœ°æ³›åŒ–è¿™äº› APIï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†ä¸å¾—ä¸ç¼–å†™æ–°çš„ API æ¥æ›¿æ¢å®ƒä»¬ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œæ‰€æœ‰æ—§ API çš„è°ƒç”¨ä»£ç éƒ½å°†é™·å…¥ä¸€ä¸ªç«™ä¸ä½è„šçš„é€‰æ‹©ï¼šè¦ä¹ˆæ°¸è¿œåœç•™åœ¨ 1.4ï¼Œè¦ä¹ˆé‡å†™å®ƒä»¬ä»¥åŒæ—¶ä½¿ç”¨æ–°çš„ APIï¼ˆä¸ä»…åŒ…æ‹¬åº”ç”¨ç¨‹åºä»£ç ï¼Œè¿˜åŒ…æ‹¬åº”ç”¨ç¨‹åºä¾èµ–çš„æ‰€æœ‰ç¬¬ä¸‰æ–¹åº“ï¼‰ã€‚è¿™ä¼šå½±å“å½“æ—¶å‡ ä¹æ‰€æœ‰å­˜åœ¨çš„ Java ä»£ç ã€‚ C# åšå‡ºäº†ç›¸åçš„é€‰æ‹©ï¼šæ›´æ–°ä»–ä»¬çš„ VMï¼Œå¹¶ä½¿å®ƒä»¬ç°æœ‰çš„åº“å’Œæ‰€æœ‰ä¾èµ–å®ƒçš„ç”¨æˆ·ä»£ç æ— æ•ˆï¼ˆéœ€è¦å‡çº§åˆ°æ³›å‹ï¼‰ã€‚å½“æ—¶ä»–ä»¬å¯ä»¥è¿™æ ·åšï¼Œå› ä¸ºä¸–ç•Œä¸Šçš„ C# ä»£ç ç›¸å¯¹è¾ƒå°‘ï¼Œä½† Java å½“æ—¶æ²¡æœ‰è¿™ä¸ªé€‰é¡¹ã€‚ ç„¶è€Œè¿™ç§é€‰æ‹©çš„ä¸€ä¸ªç»“æœæ˜¯ï¼Œä¸€ä¸ªæ³›å‹ç±»å°†åŒæ—¶æ‹¥æœ‰æ³›å‹å’Œéæ³›å‹è°ƒç”¨è€…æˆ–å­ç±»ï¼Œè¿™å°†æ˜¯ä¸€ç§é¢„æœŸçš„æƒ…å†µã€‚è¿™å¯¹è½¯ä»¶å¼€å‘è¿‡ç¨‹æ¥è¯´æ˜¯ä¸€ä¸ªç¦éŸ³ï¼ˆå…¼å®¹ï¼‰ï¼Œä½†åœ¨è¿™ç§æ··åˆä½¿ç”¨ä¸‹å¯¹ç±»å‹å®‰å…¨æœ‰æ½œåœ¨çš„å½±å“ã€‚ å†…å­˜æ±¡æŸ“ Heap Pollutionä»¥è¿™ç§æ–¹å¼æ“¦é™¤ï¼Œå¹¶æ”¯æŒæ³›å‹å’Œéæ³›å‹è°ƒç”¨è€…ä¹‹é—´çš„ç›¸äº’æ“ä½œï¼Œä¼šäº§ç”Ÿå†…å­˜æ±¡æŸ“çš„å¯èƒ½æ€§ï¼šå­˜å‚¨åœ¨ Box ä¸­å†…å®¹çš„è¿è¡Œæ—¶ç±»å‹ï¼Œä¸é¢„æœŸçš„ç¼–è¯‘æ—¶ç±»å‹ä¸å…¼å®¹ã€‚ å½“è°ƒç”¨è€…ä½¿ç”¨ Box&lt;String&gt; æ—¶ï¼Œä¼šæ’å…¥ T åˆ° String çš„ç±»å‹è½¬æ¢ï¼Œæ‰€ä»¥åœ¨ç±»å‹å˜é‡ï¼ˆBox çš„å®ç°ï¼‰åˆ°å…·ä½“ç±»å‹è½¬æ¢çš„æ—¶å€™ï¼Œå†…å­˜æ±¡æŸ“ä¼šè¢«æ£€æµ‹å‡ºæ¥ã€‚åœ¨å­˜åœ¨å †æ±¡æŸ“çš„æƒ…å†µä¸‹ï¼Œç±»å‹è½¬æ¢ä¼šå¤±è´¥ã€‚ å†…å­˜æ±¡æŸ“å¯èƒ½æ¥è‡ªéæ³›å‹ä»£ç ä½¿ç”¨æ³›å‹ç±»ï¼Œæˆ–è€…å½“æˆ‘ä»¬ä½¿ç”¨æœªç»æ£€æŸ¥çš„å¼ºåˆ¶è½¬æ¢æˆ–åŸå§‹ç±»å‹ï¼Œæ¥ä¼ªé€ å¯¹é”™è¯¯æ³›å‹ç±»å‹å˜é‡çš„å¼•ç”¨æ—¶ ï¼ˆå½“æˆ‘ä»¬ä½¿ç”¨æœªç»æ£€æŸ¥çš„å¼ºåˆ¶è½¬æ¢æˆ–åŸå§‹ç±»å‹æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå‘å‡ºè­¦å‘Šï¼‰ï¼Œä¾‹å¦‚ï¼š 1234Box&lt;String&gt; bs = new Box&lt;&gt;(&quot;hi!&quot;); // safeBox&lt;?&gt; bq = bs; // safe, via subtypingBox&lt;Integer&gt; bi = (Box&lt;Integer&gt;) bq; // unchecked cast -- warning issuedInteger i = bi.get(); // ClassCastException in synthetic cast to Integer è¿™æ®µä»£ç çš„é”™è¯¯æ˜¯ä» Box&lt;?&gt; åˆ° Box&lt;Integer&gt; çš„æœªç»æ£€æŸ¥çš„è½¬æ¢ï¼šæˆ‘ä»¬å¿…é¡»ç›¸ä¿¡å¼€å‘äººå‘˜çš„è¯´æ³•ï¼Œå³æŒ‡å®šçš„ Box ç¡®å®æ˜¯ Box&lt;Integer&gt;ã€‚ä½†æ˜¯å†…å­˜æ±¡æŸ“å¹¶æ²¡æœ‰ç«‹å³è¢«æ•è·ï¼Œåªæœ‰å½“æˆ‘ä»¬å°è¯•å°† Box ä¸­çš„å­—ç¬¦ä¸²ç”¨ä½œæ•´æ•°æ—¶ï¼Œæ‰ä¼šæ£€æµ‹åˆ°å‡ºç°é—®é¢˜ã€‚åœ¨åŒæ„ç¿»è¯‘ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å°† Box ç”¨ä½œ Box&lt;String&gt; ä¹‹å‰å°† Box&lt;Integer&gt; è½¬æ¢æˆ Box&lt;String&gt;ï¼Œä¸ä¼šå‘ç”Ÿä»»ä½•äº‹æƒ…ï¼ˆæ— è®ºå¥½åï¼‰ã€‚ä½†åœ¨å¼‚æ„ç¿»è¯‘ä¸‹ï¼ŒBox&lt;String&gt; å’Œ Box&lt;Integer&gt; å°†å…·æœ‰ä¸åŒçš„è¿è¡Œæ—¶ç±»å‹ï¼Œå¹¶ä¸”æ­¤è½¬æ¢å°†å¤±è´¥ã€‚ Java è¯­è¨€å®é™…ä¸Šä¸ºæ³›å‹æä¾›äº†ç›¸å½“å¼ºå¤§çš„å®‰å…¨ä¿è¯ï¼Œåªè¦æˆ‘ä»¬éµå¾ªä»¥ä¸‹è§„åˆ™ï¼šå¦‚æœç¨‹åºç¼–è¯‘æ—¶æ²¡æœ‰æœªæ£€æŸ¥æˆ–åŸå§‹ç±»å‹è­¦å‘Šï¼ˆä¸è€ƒè™‘åå°„ä¹‹ç±»çš„æƒ…å†µï¼‰ï¼Œåˆ™ç¼–è¯‘å™¨æ’å…¥çš„å¼ºåˆ¶è½¬æ¢æ°¸è¿œä¸ä¼šå¤±è´¥ã€‚ æœªæ£€æŸ¥è­¦å‘Šï¼šUnchecked cast: â€˜â€¦â€™ to â€˜â€¦â€™ ã€‚åŸå§‹ç±»å‹è­¦å‘Šï¼šRaw use of parameterized class â€˜â€¦â€™ ã€‚ æ¢å¥è¯è¯´ï¼Œåªæœ‰å½“æˆ‘ä»¬ä¸éæ³›å‹ä»£ç è¿›è¡Œäº¤äº’æˆ–å¯¹ç¼–è¯‘å™¨æ’’è°æ—¶ï¼Œæ‰ä¼šå‘ç”Ÿå†…å­˜æ±¡æŸ“ã€‚åœ¨å‘ç°å†…å­˜æ±¡æŸ“æ—¶ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ªæ˜ç¡®çš„å¼‚å¸¸ï¼ˆClassCastExceptionï¼‰ï¼Œå‘Šè¯‰æˆ‘ä»¬é¢„æœŸçš„ç±»å‹å’Œå®é™…çš„ç±»å‹ã€‚ JVM ç”Ÿæ€ Context: Ecosystem of JVM Implementations and Languageså›´ç»•æ³›å‹çš„è®¾è®¡é€‰æ‹©è¿˜å—åˆ° JVM å®ç°ç”Ÿæ€ç»“æ„å’Œåœ¨ JVM ä¸Šè¿è¡Œçš„è¯­è¨€ç»“æ„çš„å½±å“ã€‚è™½ç„¶å¯¹å¤§å¤šæ•°å¼€å‘äººå‘˜æ¥è¯´ï¼Œâ€œJavaâ€æ˜¯ä¸€ä¸ªæ•´ä½“çš„æ¦‚å¿µï¼Œä½†å®é™…ä¸Š Java è¯­è¨€å’Œ Java è™šæ‹Ÿæœº (JVM) æ˜¯ç‹¬ç«‹çš„å®ä½“ï¼Œåˆ†åˆ«æœ‰è‡ªå·±çš„è§„èŒƒã€‚ Java ç¼–è¯‘å™¨ä¸º JVM ç”Ÿæˆç±»æ–‡ä»¶ï¼ˆå…¶æ ¼å¼å’Œè¯­ä¹‰åœ¨ Java è™šæ‹Ÿæœºè§„èŒƒä¸­åˆ—å‡ºï¼‰ï¼Œä½†æ˜¯ JVM ä¼šå¾ˆä¹æ„è¿è¡Œä»»ä½•æœ‰æ•ˆçš„ç±»æ–‡ä»¶ï¼Œè€Œä¸ç®¡å®ƒæœ€åˆæ¥è‡ªä»€ä¹ˆæºè¯­è¨€ã€‚æ®ç»Ÿè®¡ï¼Œæœ‰è¶…è¿‡ 200 ç§è¯­è¨€ä½¿ç”¨ JVM ä½œä¸ºç¼–è¯‘ç›®æ ‡ï¼Œå…¶ä¸­ä¸€äº›ä¸ Java è¯­è¨€ï¼ˆä¾‹å¦‚ Scalaã€Kotlinï¼‰æœ‰å¾ˆå¤šå…±åŒç‚¹ï¼Œè€Œå¦ä¸€äº›åˆ™æ˜¯éå¸¸ä¸åŒçš„è¯­è¨€ï¼ˆä¾‹å¦‚ï¼ŒJRubyã€Jythonã€Jaskellï¼‰ã€‚ JVM ä½œä¸ºç¼–è¯‘ç›®æ ‡å¦‚æ­¤æˆåŠŸçš„ä¸€ä¸ªåŸå› ï¼ˆå³ä½¿æ˜¯ä¸ Java å®Œå…¨ä¸åŒçš„è¯­è¨€ï¼‰ï¼Œæ˜¯å®ƒæä¾›äº†ä¸€ä¸ªç›¸å½“æŠ½è±¡çš„è®¡ç®—æ¨¡å‹ï¼Œè€Œå— Java è¯­è¨€æœ¬èº«çš„å½±å“æœ‰é™ï¼ˆç‹¬ç«‹çš„è§„èŒƒï¼‰ã€‚è¯­è¨€å’Œè™šæ‹Ÿæœºä¹‹é—´çš„æŠ½è±¡å±‚ä¸ä»…æ¿€å‘äº†åœ¨ JVM ä¸Šè¿è¡Œçš„å…¶ä»–è¯­è¨€çš„ç”Ÿæ€ï¼Œè€Œä¸”å¯¹ JVM ç‹¬ç«‹å®ç°çš„ç”Ÿæ€ä¹Ÿå¾ˆæœ‰ç”¨ã€‚è™½ç„¶ä»Šå¤©çš„å¸‚åœºå·²ç»å¤§å¹…æ•´åˆï¼Œä½†åœ¨å°†æ³›å‹æ·»åŠ åˆ° Java æ—¶ï¼Œæœ‰åå¤šç§å•†ä¸šä¸Šå¯è¡Œçš„ JVM å®ç°ã€‚å°†æ³›å‹ç‰¹åŒ–æ„å‘³ç€æˆ‘ä»¬ä¸ä»…éœ€è¦å¢å¼ºè¯­è¨€ä»¥æ”¯æŒæ³›å‹ï¼Œè¿˜éœ€è¦å¢å¼º JVMã€‚ è™½ç„¶å½“æ—¶åœ¨æŠ€æœ¯ä¸Šå¯ä»¥ä¸º JVM æ·»åŠ æ³›å‹æ”¯æŒï¼Œä½†è¿™ä¸ä»…æ˜¯ä¸€é¡¹éœ€è¦å¤§é‡å®ç°è€…ä¹‹é—´åè°ƒçš„é‡å¤§å·¥ç¨‹ï¼Œè€Œä¸” JVM ä¸Šçš„è¯­è¨€ç”Ÿæ€ä¹Ÿå¯èƒ½æœ‰å…³äºç‰¹åŒ–æ³›å‹çš„æ„è§ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç‰¹åŒ–çš„è§£é‡Šæ‰§è¡ŒåŒ…æ‹¬è¿è¡Œæ—¶çš„ç±»å‹æ£€æŸ¥ï¼ŒScalaï¼ˆåŠå®ƒçš„ declaration-site varianceï¼‰æ˜¯å¦æ„¿æ„è®© JVM å¼ºåˆ¶æ‰§è¡Œ Java ä¸­çš„ï¼ˆä¸å˜çš„ï¼‰æ³›å‹å­ç±»å‹è§„åˆ™ï¼Ÿ æ“¦é™¤æ˜¯åŠ¡å®çš„å¦¥å Erasure was the Pragmatic Compromiseæ€»ä¹‹ï¼Œè¿™äº›é™åˆ¶ï¼ˆæŠ€æœ¯å’Œç”Ÿæ€ï¼‰ä½œä¸ºä¸€è‚¡å¼ºå¤§çš„åŠ›é‡æ¨åŠ¨æˆ‘ä»¬èµ°å‘åŒæ„ç¿»è¯‘ç­–ç•¥ï¼Œå³åœ¨ç¼–è¯‘æ—¶æ“¦é™¤æ³›å‹ç±»å‹ä¿¡æ¯ã€‚ æ€»è€Œè¨€ä¹‹ï¼Œæ¨åŠ¨æˆ‘ä»¬åšå‡ºè¿™ä¸€å†³å®šçš„å› ç´ åŒ…æ‹¬ï¼š è¿è¡Œæ—¶æˆæœ¬ã€‚å¼‚æ„è½¬æ¢éœ€è¦å„ç§è¿è¡Œæ—¶æˆæœ¬ï¼šæ›´å¤§çš„é™æ€å’ŒåŠ¨æ€å ç”¨ç©ºé—´ã€æ›´å¤§çš„ç±»åŠ è½½æˆæœ¬ã€æ›´å¤§çš„ JIT æˆæœ¬å’Œä»£ç ç¼“å­˜å‹åŠ›ç­‰ã€‚è¿™å¯èƒ½ä½¿å¼€å‘äººå‘˜ä¸å¾—ä¸åœ¨ç±»å‹å®‰å…¨å’Œæ€§èƒ½ä¹‹é—´åšå‡ºé€‰æ‹©ã€‚ è¿ç§»çš„å…¼å®¹æ€§ã€‚å½“æ—¶è¿˜æ²¡æœ‰å·²çŸ¥çš„ç¿»è¯‘æ–¹æ¡ˆå…è®¸è¿ç§»åˆ°ç‰¹åŒ–çš„æ³›å‹ï¼Œå¹¶ä¿æŒæºä»£ç å’ŒäºŒè¿›åˆ¶å…¼å®¹ï¼Œä»è€Œé€ æˆâ€œæˆªæ­¢æ—¥æœŸâ€å¹¶ä½¿å¼€å‘äººå‘˜éœ€è¦å¯¹å¤§é‡ç°æœ‰ä»£ç è¿›è¡Œæ”¹åŠ¨ã€‚ è¿˜æ˜¯è¿è¡Œæ—¶æˆæœ¬ã€‚å¦‚æœå°†ç‰¹åŒ–è§£é‡Šä¸ºåœ¨è¿è¡Œæ—¶æ£€æŸ¥ç±»å‹ï¼ˆå°±åƒåŠ¨æ€æ£€æŸ¥ Java åå˜æ•°ç»„ä¸­çš„å­˜å‚¨ä¸€æ ·ï¼‰ï¼Œè¿™å°†å¯¹è¿è¡Œæ—¶äº§ç”Ÿé‡å¤§å½±å“ï¼Œå› ä¸º JVM å¿…é¡»åœ¨è¿è¡Œæ—¶å¯¹æ¯ä¸ªå­—æ®µæˆ–æ•°ç»„å…ƒç´ å­˜å‚¨æ—¶æ‰§è¡Œæ³›å‹å­ç±»å‹æ£€æŸ¥ï¼Œä½¿ç”¨è¯­è¨€çš„æ³›å‹ç±»å‹ç³»ç»Ÿã€‚å½“ç±»å‹åƒ List&lt;String&gt; è¿™æ ·çš„ç®€å•ç±»å‹æ—¶ï¼Œè¿™å¯èƒ½å¬èµ·æ¥æ—¢ç®€å•åˆæˆæœ¬ä½ï¼Œä½†æ˜¯å½“é‡åˆ°åƒ Map&lt;? extends List&lt;? super Foo&gt;&gt;, ? super Set&lt;? extends Bar&gt;&gt; è¿™æ ·çš„ç±»å‹æ—¶ä¼šå¾ˆå¿«å˜å¾—æˆæœ¬é«˜æ˜‚ã€‚ï¼ˆäº‹å®ä¸Šï¼Œåæ¥çš„ç ”ç©¶å¯¹æ³›å‹å­ç±»å‹çš„å¯åˆ¤å®šæ€§äº§ç”Ÿäº†æ€€ç–‘ï¼‰ JVM ç”Ÿæ€ã€‚èƒ½å¤Ÿè®©åå‡ å®¶ JVM ä¾›åº”å•†å°±æ˜¯å¦ä»¥åŠå¦‚ä½•åœ¨è¿è¡Œæ—¶ç‰¹åŒ–ç±»å‹è¾¾æˆä¸€è‡´ï¼Œæ˜¯éå¸¸ä¸ç°å®çš„ã€‚ äº¤ä»˜ã€‚å³ä½¿æœ‰å¯èƒ½è®©åå‡ ä¸ª JVM ä¾›åº”å•†å°±ä¸€ä¸ªå®é™…å¯è¡Œçš„æ–¹æ¡ˆè¾¾æˆä¸€è‡´ï¼Œä¹Ÿä¼šå¤§å¤§å¢åŠ å¤æ‚æ€§ã€æ—¶é—´å‘¨æœŸå’Œé£é™©ï¼Œè¿™æ˜¯éå¸¸å¤æ‚ä¸”å†’é™©çš„å·¥ä½œã€‚ è¯­è¨€ç”Ÿæ€ã€‚åƒ Scala è¿™æ ·çš„è¯­è¨€å¯èƒ½ä¸ä¹æ„å°† Java çš„ä¸å˜æ³›å‹èå…¥ JVM çš„è¯­ä¹‰ä¸­ã€‚å°± JVM ä¸­æ³›å‹è·¨è¯­è¨€å¯æ¥å—çš„è¯­ä¹‰è¾¾æˆä¸€è‡´ï¼Œå°†å†æ¬¡å¢åŠ å¤æ‚æ€§ã€æ—¶é—´å‘¨æœŸå’Œé£é™©ï¼Œè¿™æ˜¯éå¸¸å¤æ‚ä¸”å†’é™©çš„å·¥ä½œã€‚ æ— è®ºå¦‚ä½•ï¼Œç”¨æˆ·éƒ½å¿…é¡»å¤„ç†æ“¦é™¤ï¼ˆå› æ­¤ä¹Ÿå¿…é¡»å¤„ç†å†…å­˜æ±¡æŸ“ï¼‰ã€‚å³ä½¿å¯ä»¥åœ¨è¿è¡Œæ—¶ä¿ç•™ç±»å‹ä¿¡æ¯ï¼Œåœ¨ç±»è¢«æ³›åŒ–ä¹‹å‰æ€»æ˜¯ä¼šç¼–è¯‘å‡ºåŸå§‹çš„ç±»æ–‡ä»¶ï¼Œå› æ­¤å †ä¸­ä»ç„¶å¯èƒ½å­˜åœ¨æ²¡æœ‰ä»»ä½•é™„åŠ ç±»å‹ä¿¡æ¯çš„ ArrayListï¼Œä¸€æ ·æœ‰å†…å­˜æ±¡æŸ“çš„é£é™©ã€‚ æŸäº›æœ‰ç”¨çš„è¯­å¥æ˜¯æ— æ³•è¡¨è¾¾çš„ã€‚å½“ç°æœ‰çš„æ³›å‹ä»£ç çŸ¥é“ä¸€äº›ç¼–è¯‘å™¨ä¸çŸ¥é“çš„è¿è¡Œæ—¶ç±»å‹æ—¶ï¼Œå®ƒå¶å°”ä¼šè¯‰è¯¸æœªç»æ£€æŸ¥çš„å¼ºåˆ¶è½¬æ¢ï¼Œå¹¶ä¸”åœ¨æ³›å‹ç±»å‹ç³»ç»Ÿä¸­æ²¡æœ‰ç®€å•çš„æ–¹æ³•æ¥è¡¨è¾¾å®ƒã€‚è®¸å¤šè¿™æ ·çš„æŠ€æœ¯å¯¹äºç‰¹åŒ–çš„æ³›å‹æ˜¯ä¸å¯èƒ½çš„ï¼Œè¿™æ„å‘³ç€å®ƒä»¬å¿…é¡»ä»¥ä¸åŒçš„æ–¹å¼è¡¨è¾¾ï¼Œè€Œä¸”é€šå¸¸æˆæœ¬æ›´é«˜ã€‚ï¼ˆæ²¡æœ‰æ˜ç™½å…·ä½“è¯´çš„æ˜¯ä»€ä¹ˆï¼Œå¯èƒ½æŒ‡ä¾‹å¦‚ instanceOf List è¿™æ ·çš„åˆ¤æ–­ï¼‰ å¾ˆæ˜æ˜¾æˆæœ¬å’Œé£é™©æ˜¯å·¨å¤§çš„ã€‚é‚£ä¹ˆä¼šæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿä¹‹å‰æˆ‘ä»¬æåˆ°äº†ç‰¹åŒ–çš„ä¸‰ä¸ªå¯èƒ½çš„å¥½å¤„ï¼šåå°„ã€å¸ƒå±€ç‰¹åŒ–å’Œè¿è¡Œæ—¶ç±»å‹æ£€æŸ¥ã€‚ä¸Šè¿°è®ºç‚¹åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ’é™¤äº†æˆ‘ä»¬è¿›è¡Œè¿è¡Œæ—¶ç±»å‹æ£€æŸ¥çš„å¯èƒ½æ€§ï¼ˆè¿è¡Œæ—¶æˆæœ¬ã€ä¸å¯åˆ¤å®šæ€§é£é™©ã€ç”Ÿæ€é£é™©ä»¥åŠåŸå§‹ç±»å‹å®ä¾‹çš„å­˜åœ¨ï¼‰ã€‚ èƒ½å¤ŸçŸ¥é“ List çš„å…ƒç´ ç±»å‹æ˜¯ä»€ä¹ˆï¼ˆä¹Ÿè®¸å¯ä»¥çŸ¥é“ï¼Œä½†ä¹Ÿå¯èƒ½æ²¡æœ‰ï¼‰å½“ç„¶ä¼šæœ‰ä¸€äº›å¥½å¤„ã€‚åªæ˜¯æˆæœ¬å’Œæ”¶ç›Šç›¸å·®äº†å‡ ä¸ªæ•°é‡çº§ã€‚ï¼ˆåŒæ„ç¿»è¯‘çš„å¦ä¸€ä¸ªä»£ä»·æ˜¯ä¸èƒ½æ”¯æŒåŸºæœ¬ç±»å‹ä½œä¸ºç±»å‹å‚æ•°ï¼Œä¾‹å¦‚å¿…é¡»ä½¿ç”¨ List&lt;Integer&gt; è€Œä¸æ˜¯ List&lt;int&gt;ï¼‰ æ™®éè®¤ä¸ºæ“¦é™¤æ˜¯ä¸å¥½çš„ hack çš„è¯¯è§£ï¼Œé€šå¸¸æºäºç¼ºä¹å¯¹æ›¿ä»£æ–¹æ¡ˆçš„çœŸå®æˆæœ¬çš„è®¤è¯†ï¼ŒåŒ…æ‹¬å·¥ç¨‹å·¥ä½œé‡ã€æ—¶é—´å‘¨æœŸã€äº¤ä»˜é£é™©ã€æ€§èƒ½ã€ç”Ÿæ€å½±å“å’Œä¾¿åˆ©æ€§ï¼Œé‰´äºå·²ç»ç¼–å†™çš„å¤§é‡ Java ä»£ç ä»¥åŠåœ¨ JVM ä¸Šè¿è¡Œçš„ JVM å®ç°å’Œè¯­è¨€çš„å¤šæ ·åŒ–ç”Ÿæ€ã€‚","link":"/2021/10/how-we-got-the-generics-we-have/"},{"title":"Valhalla (2): ç°çŠ¶ The Road to Valhalla","text":"é€šå¾€ Valhalla ä¹‹è·¯ç¿»è¯‘ https://openjdk.java.net/projects/valhalla/design-notes/state-of-valhalla/01-backgroundã€‚ è¿™æ˜¯æè¿° Valhalla ç°çŠ¶ï¼ˆ2021.12ï¼‰çš„ä¸‰ç¯‡æ–‡ç« ä¸­çš„ç¬¬ä¸€ç¯‡ï¼Œç¬¬äºŒç¯‡æ˜¯è¯­è¨€æ¨¡å‹ï¼Œç¬¬ä¸‰ç¯‡æ˜¯ JVM æ¨¡å‹ã€‚ Valhalla çš„å£å·æ˜¯ï¼šåƒ class ä¸€æ ·ç¼–å†™ï¼Œåƒ int ä¸€æ ·è¿è¡Œã€‚ ç³»åˆ—æ–‡ç« ï¼ˆæœªå®Œå¾…ç»­ï¼‰ Valhalla (0): åºè¨€ Valhalla (1): èƒŒæ™¯ How We Got the Generics We Have Valhalla (2): ç°çŠ¶ The Road to Valhalla Valhalla (5): è§£è¯» JEP 390 Warnings for Value-Based Classes Valhalla (6): è§£è¯» JEP 401 Primitive Objects Valhalla (7): è§£è¯» JEP 402 Unify the Basic Primitives with Objects èƒŒæ™¯ BackgroundValhalla é¡¹ç›®å§‹äº 2014 å¹´ï¼Œå…¶ç›®æ ‡æ˜¯ä¸ºåŸºäº JVM çš„è¯­è¨€å¸¦æ¥æ›´çµæ´»çš„æ‰å¹³åŒ–çš„æ•°æ®ç±»å‹ï¼Œä»¥æ¢å¤ç¼–ç¨‹æ¨¡å‹ä¸ç°ä»£ç¡¬ä»¶æ€§èƒ½ç‰¹å¾ä¹‹é—´çš„ä¸€è‡´æ€§ã€‚ï¼ˆæŸç§ç¨‹åº¦ä¸Šè®²ï¼Œå®ƒå¼€å§‹å¾—æ›´æ—©ï¼ŒJava çš„è®¾è®¡è€…å¸Œæœ›åœ¨è¯­è¨€çš„åˆå§‹ç‰ˆæœ¬ä¸­åŒ…å«å€¼ç±»å‹ï¼‰ Valhalla é¢„è®¡ä¼šå‘å¹³å°æ·»åŠ ä¸‰ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼šå€¼å¯¹è±¡ï¼ˆvalue objectsï¼‰ã€åŸå§‹ç±»ï¼ˆprimitive classesï¼‰å’Œç‰¹åŒ–æ³›å‹ï¼ˆspecialized genericsï¼‰ã€‚åœ¨é¡¹ç›®çš„åˆå§‹é˜¶æ®µï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨åœ¨ç†è§£è¯­è¨€å’Œ JVM è¯¥å¦‚ä½•å‘å±•ä»¥æ”¯æŒè¿™äº›åŠŸèƒ½ï¼Œä»¥åŠå¯¹ç”¨æˆ·ä»£ç è¿ç§»å…¼å®¹æ€§çš„å½±å“ã€‚ è™½ç„¶å¯ä»¥é€æ­¥å‘å¸ƒè¿™äº›åŠŸèƒ½ï¼Œä½†åœ¨å®ç°ä¹‹å‰ï¼Œæœ‰å¿…è¦å¯¹å®ƒä»¬å¦‚ä½•ååŒå·¥ä½œæœ‰ä¸€ä¸ªç«¯åˆ°ç«¯çš„äº†è§£ã€‚æˆ‘ä»¬å±•ç¤ºäº†ä¸€ç§å¯è¡Œçš„è·¯å¾„ï¼Œé€šè¿‡å€¼ç±»å‹ï¼ˆvalue classesï¼‰å’ŒåŸå§‹ç±»ï¼ˆprimitive classesï¼‰å¢å¼º Java è¯­è¨€å’Œè™šæ‹Ÿæœºï¼Œè¿ç§»ç°æœ‰çš„åŸºæœ¬ç±»å‹å’ŒåŸºäºå€¼çš„ç±»æ¥åˆ©ç”¨è¿™äº›ç‰¹æ€§ï¼Œå¹¶å…è®¸åŸºæœ¬ç±»å‹å’Œæ³›å‹è¿›è¡Œæ— ç¼çš„äº¤äº’ã€‚è¿™ä¸€ç³»åˆ—çš„æ–‡æ¡£æ€»ç»“äº†è¯¥è·¯å¾„ï¼Œå¹¶ä¼šåˆ†é˜¶æ®µäº¤ä»˜ã€‚å…¶ä¸­å‰ä¸‰ä¸ª JEP æ˜¯ JEP draft: Value Objectsã€JEP 401 å’Œ JEP 402ã€‚ï¼ˆå¦‚æœä½ æƒ³è·Ÿæœ€å¼€å§‹çš„ç‰ˆæœ¬æ¯”è¾ƒï¼Œè¯·å‚é˜…æˆ‘ä»¬çš„ 2014 å¹´çš„åŸå§‹æ–‡ä»¶ï¼‰ ç„¶è€Œï¼ŒValhalla é¡¹ç›®ä¸ä»…ä»…æ˜¯å…³äºå®ƒæä¾›çš„åŠŸèƒ½ï¼Œæˆ–è€…æ˜¯æ€§èƒ½çš„æå‡ï¼Œå®ƒæœ‰æ›´é›„å¿ƒå‹ƒå‹ƒçš„è®¡åˆ’æ¥ç»Ÿä¸€åŸºæœ¬ç±»å‹å’Œå¯¹è±¡ï¼ˆçœŸæ­£åšåˆ°ä¸€åˆ‡çš†å¯¹è±¡ï¼‰ã€‚ é—´æ¥è®¿é—®çš„ä»£ä»· The Costs of IndirectionJVM ç±»å‹ç³»ç»ŸåŒ…æ‹¬å…«ç§åŸºæœ¬ç±»å‹ï¼ˆintã€long ç­‰ï¼‰ã€å¯¹è±¡ï¼ˆå…·æœ‰ Identity çš„å¼‚æ„èšåˆï¼‰å’Œæ•°ç»„ï¼ˆå…·æœ‰ Identity çš„åŒæ„èšåˆï¼‰ã€‚è¿™ç»„æ„å»ºæ–¹å¼éå¸¸çµæ´»ï¼Œä½ å¯ä»¥å¯¹ä»»ä½•éœ€è¦çš„æ•°æ®ç»“æ„è¿›è¡Œå»ºæ¨¡ã€‚ä¸èƒ½ç”¨åŸºæœ¬ç±»å‹è¡¨ç¤ºçš„æ•°æ®ï¼ˆä¾‹å¦‚å¤æ•°ã€ä¸‰ç»´ç‚¹ã€å…ƒç»„ã€å®šç‚¹æ•°ã€å­—ç¬¦ä¸²ç­‰ï¼‰å¯ä»¥è½»æ¾åœ°ä½¿ç”¨å¯¹è±¡è¿›è¡Œå»ºæ¨¡ã€‚ä½†æ˜¯ï¼Œå¯¹è±¡æ˜¯åœ¨å †ä¸­åˆ†é…çš„ï¼ˆé™¤é VM å¯ä»¥è¯æ˜å®ƒä»¬çš„ä½œç”¨åŸŸè¶³å¤Ÿçª„ä¸”æ²¡æœ‰åˆ«åï¼‰ï¼Œéœ€è¦ä¸€ä¸ªå¯¹è±¡å¤´ï¼ˆé€šå¸¸æ˜¯ä¸¤ä¸ªæœºå™¨å­—é•¿ï¼‰ï¼Œå¹¶ä¸”å¿…é¡»é€šè¿‡å†…å­˜é—´æ¥å¼•ç”¨ã€‚ ä¾‹å¦‚ï¼Œä¸€ä¸ª XY ç‚¹å¯¹è±¡æ•°ç»„å…·æœ‰ä»¥ä¸‹å†…å­˜å¸ƒå±€ï¼š åœ¨ 1990 å¹´ä»£åˆæœŸè®¾è®¡ Java è™šæ‹Ÿæœºæ—¶ï¼Œå†…å­˜è·å–æ•°æ®çš„æˆæœ¬ä¸è®¡ç®—æ“ä½œï¼ˆä¾‹å¦‚åŠ æ³•ï¼‰çš„æˆæœ¬ç›¸å½“ã€‚éšç€å½“ä»Š CPU çš„å¤šçº§å†…å­˜ç¼“å­˜å’ŒæŒ‡ä»¤çº§å¹¶è¡Œæ€§ï¼Œä¸€æ¬¡ç¼“å­˜ miss çš„å¼€é”€å¯èƒ½ç›¸å½“äº 1000 æ¬¡è®¡ç®—æ“ä½œï¼Œç›¸å¯¹æˆæœ¬çš„å¤§å¹…å¢åŠ äº†ã€‚ å› æ­¤ï¼ŒJVM åå¥½çš„æŒ‡é’ˆå¸ƒå±€ï¼ˆæ¶‰åŠå°æ•°æ®å—ä¹‹é—´çš„å¤šæ¬¡é—´æ¥è®¿é—®ï¼‰ä¸å†æ˜¯å½“ä»Šç¡¬ä»¶ä¸Šçš„ç†æƒ³é€‰æ‹©ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯é€šè¿‡ä¸º Java å¼€å‘äººå‘˜æä¾›æ›´ç®€å•çš„é€”å¾„æ¥å®ç°æ‰å¹³ï¼ˆé«˜æ•ˆç¼“å­˜ï¼‰å’Œå¯†é›†ï¼ˆé«˜æ•ˆå†…å­˜ï¼‰çš„æ•°æ®å¸ƒå±€ï¼Œè€Œä¸ä¼šå½±å“æŠ½è±¡æˆ–ç±»å‹å®‰å…¨ï¼Œä»è€Œä½¿æ•°æ®å¸ƒå±€æ›´é€‚åˆå½“ä»Šç¡¬ä»¶çš„æ€§èƒ½æ¨¡å‹ã€‚ æˆ‘ä»¬æƒ³è¦çš„æ˜¯æœ‰ä¸€ä¸ªé€‰é¡¹æ¥è·å¾—æ›´åƒè¿™æ ·çš„å¸ƒå±€ï¼š è¿™ç§å¸ƒå±€æ¯”ä»¥å‰çš„ç‰ˆæœ¬æ›´æ‰å¹³ï¼ˆæ²¡æœ‰é—´æ¥è®¿é—®ï¼‰å’Œæ›´å¯†é›†ï¼ˆæ²¡æœ‰å¯¹è±¡å¤´ï¼‰ã€‚Valhalla é¡¹ç›®é€šè¿‡åˆ†ç¦»è¯­ä¹‰å¹¶å…è®¸ç”¨æˆ·æ§åˆ¶ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§è‡ªç„¶çš„æ–¹å¼æ¥è·å¾—è¿™ç§å¸ƒå±€ï¼Œè€Œä¸å¿…è¿‡åˆ†å…³æ³¨åº•å±‚ç»†èŠ‚ã€‚ æ‰å¹³åŒ–ä¸ä»…ä¸å †ä¸­çš„å¸ƒå±€æœ‰å…³ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ‰å¹³åŒ–è°ƒç”¨çº¦å®šï¼ˆcalling conventionï¼‰ï¼Œå³ JVM å¦‚ä½•å°†å€¼ä»ä¸€ç§æ–¹æ³•ä¼ é€’åˆ°å¦ä¸€ç§æ–¹æ³•ï¼ˆåœ¨å †æ ˆä¸Šï¼Œæˆ–åœ¨å¯„å­˜å™¨ä¸­ï¼‰ã€‚åœ¨æ²¡æœ‰ç‰¹å®šçš„ JVM ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œç›®å‰å°†ä¸€ä¸ª Point ä¼ é€’ç»™å¦ä¸€ä¸ªæ–¹æ³•æ—¶æ˜¯é€šè¿‡ä¼ é€’æŒ‡é’ˆï¼Œè¢«è°ƒç”¨è€…å¯¹è¯¥æŒ‡é’ˆè§£å¼•ç”¨ä»¥è®¿é—®å¯¹è±¡çš„çŠ¶æ€ã€‚ æˆ‘ä»¬æƒ³è¦ä¸€ä¸ªæ›´æ‰å¹³çš„è°ƒç”¨çº¦å®šï¼Œå…¶ä¸­å¯ä»¥é€šè¿‡æŒ‰å€¼ä¼ é€’ x å’Œ y æ¥ä¼ é€’ Pointã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‰å¹³åŒ–è°ƒç”¨çº¦å®šå¯ä»¥äº§ç”Ÿæ¯”å †æ‰å¹³åŒ–å¸ƒå±€æ›´æ˜¾ç€çš„æ€§èƒ½æ”¹è¿›ã€‚ éç»Ÿä¸€ç±»å‹ç³»ç»Ÿçš„ä»£ä»· The Costs of a Split Type Systemä½œä¸ºé¢å‘å¯¹è±¡çš„è¯­è¨€ï¼ŒåŸºæœ¬ç±»å‹å’Œå¯¹è±¡çš„åˆ†ç¦»ä½“ç°äº†ä¸€ä¸ªé‡å¤§çš„å¦¥åï¼šé¢å‘å¯¹è±¡çš„è¯­è¨€å¸Œæœ›ä»â€œä¸€åˆ‡éƒ½æ˜¯å¯¹è±¡â€çš„å‰æå‡ºå‘ã€‚ä½†æ˜¯ï¼Œä¸€ä¸ª int ä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹æ®Šè€Œç¥å¥‡çš„ä¸œè¥¿ï¼ˆå®ƒçš„æ•°ç»„ä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ï¼Œå¹¶ä¸”è¿™ç§ä¸ç»Ÿä¸€æ€§å¯¹æ•´ä¸ªè¯­è¨€ã€åº“å’Œè¿è¡Œæ—¶éƒ½äº§ç”Ÿäº†é‡è¦çš„å½±å“ã€‚ 1995 å¹´åšå‡ºçš„å¦¥åæ˜¯ï¼Œç”¨æˆ·å¯ä»¥å®šä¹‰çš„ä¸€åˆ‡éƒ½æ˜¯å¯¹è±¡ï¼Œä½†æ˜¯è¿˜æœ‰å…«ç§é¢å¤–çš„å†…ç½®ç±»å‹ä¸æ˜¯å¯¹è±¡ï¼Œå¹¶ä¸”æ— æ³•å®šä¹‰æ–°çš„è¿™æ ·çš„ç±»å‹ã€‚è¿™åœ¨å½“æ—¶è‚¯å®šæ˜¯è¢«è¿«çš„ï¼Œå°šä¸çŸ¥é“å¦‚ä½•æ‘†è„±â€œä¸€åˆ‡éƒ½æ˜¯å¯¹è±¡â€çš„æŸç¼šï¼Œä½†ä»ç„¶å¸Œæœ›æä¾›åˆç†çš„è®¡ç®—æ€§èƒ½ã€‚å½“æ—¶çœ‹èµ·æ¥è¿˜ä¸é”™ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤Ÿå®Œæˆä¼Ÿå¤§çš„äº‹æƒ…ï¼Œä½†è¿™æ˜¯å¯¹å¼€å‘äººå‘˜ã€åº“è®¾è®¡äººå‘˜å’Œç”¨æˆ·æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªæŒç»­çš„æŠ€æœ¯å€ºã€‚ å½“æ³›å‹åœ¨ 2004 å¹´å‡ºç°æ—¶ï¼Œå®ƒå˜å¾—ç¨å¾®å¥½ä¸€ç‚¹ï¼Œä½†ä¹Ÿå¸¦æ¥äº†æ›´å¤šçš„é—®é¢˜ã€‚å˜â€œå¥½â€çš„æ˜¯æ”¯æŒäº†è‡ªåŠ¨è£…ç®±ï¼ˆå°½ç®¡é‡è½½è§£æçš„å¤æ‚æ€§ä¹Ÿä»˜å‡ºäº†å·¨å¤§çš„ä»£ä»·ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è‡ªç”±åœ°åœ¨éœ€è¦æ•´æ•°çš„åœ°æ–¹ä½¿ç”¨ intï¼Œåä¹‹äº¦ç„¶ã€‚ä½†æ˜¯ï¼Œè¿™åªæ˜¯è§£å†³äº†è¡¨é¢é—®é¢˜ï¼Œè€Œä¸æ˜¯æ·±å±‚çš„çš„åˆ†æ­§ã€‚æˆ‘ä»¬å¿…é¡»æ„è¯†åˆ°åŸºæœ¬ç±»å‹å’Œå¼•ç”¨ç±»å‹ä¹‹é—´çš„åˆ†æ­§è¶Šæ¥è¶Šå¤šï¼Œå› ä¸ºåŸºæœ¬ç±»å‹ä¸èƒ½ç”¨ä½œæ³›å‹çš„ç±»å‹å‚æ•°ã€‚åŒæ ·çš„ï¼Œè¿™æ˜¯ä¸€ç§åŠ¡å®çš„å¦¥åï¼Œä¹Ÿæ˜¯å½“æ—¶å·²çŸ¥çš„å”¯ä¸€ä¸€ç§åœ¨æ²¡æœ‰å¤§è§„æ¨¡å…¼å®¹æ€§é—®é¢˜çš„æƒ…å†µä¸‹å‘ Java æ·»åŠ æ³›å‹çš„æ–¹æ³•ï¼Œä½†æŠ€æœ¯å€ºåªä¼šè¶Šæ¥è¶Šå¤šã€‚ å½“ 2014 å¹´ lambda å‡ºç°æ—¶ï¼Œæƒ…å†µå†æ¬¡å˜å¾—æ›´ç³Ÿã€‚ Lambda å¤§é‡æ„å»ºåœ¨æ³›å‹ä¸Šï¼Œå› æ­¤æ³›å‹é¢ä¸´çš„è®¸å¤šåæœéƒ½è¢« lambda ç»§æ‰¿äº†ã€‚è¿™å½±å“äº†åº“çš„è®¾è®¡ï¼Œjava.util.function åœ¨ç‰¹åŒ–ç‰ˆæœ¬æ—¶é‡åˆ°äº†ç»„åˆçˆ†ç‚¸çš„é—®é¢˜ï¼ˆIntPredicateã€IntToLongFunctionï¼‰ï¼Œè€Œä¸æ˜¯èƒ½å¤Ÿå‚æ•°åŒ–æ›´é€šç”¨çš„ç±»å‹ï¼ˆPredicate&lt;int&gt;ã€Function&lt;intã€long&gt;ï¼‰ã€‚æ³›å‹çš„ç›®æ ‡æ˜¯æŠ½è±¡è¡¨ç¤ºçš„å·®å¼‚ï¼Œä½†åŸºæœ¬ç±»å‹å’Œå¼•ç”¨ç±»å‹ä¹‹é—´çš„é¸¿æ²Ÿè¶Šæ¥è¶Šéš¾ä»¥å¼¥åˆã€‚ è£…ç®±çš„ä»£ä»· The Costs of BoxingJava å…«ç§å†…ç½®çš„åŸºæœ¬ç±»å‹ä¸æ˜¯å¯¹è±¡ï¼Œä½†å®ƒä»¬æœ‰åŒ…è£…ç±»ã€‚å½“åŸºæœ¬ç±»å‹æƒ³è¦åœ¨å¯¹è±¡ä¸–ç•Œä¸­äº¤äº’æ—¶ï¼Œæˆ‘ä»¬é€æ˜åœ°å°†å®ƒä»¬è½¬æ¢ä¸ºå¯¹åº”çš„åŒ…è£…ç±»ï¼Œæˆ–è€…åè¿‡æ¥ã€‚åŸºæœ¬ç±»å‹æ²¡æœ‰å®ç°åƒ Comparable é‚£æ ·å®ç°æ¥å£ï¼Œä¸è¿‡ä»–ä»¬çš„åŒ…è£…ç±»å®ç°äº†ã€‚Object æ˜¯æœ€é¡¶çº§ç±»å‹ï¼Œä½†ä»…é€‚ç”¨äºç±»ã€‚å› æ­¤åŸºæœ¬ç±»å‹ä¸èƒ½ç›´æ¥å‚ä¸æ³›å‹æˆ–åŠ¨æ€ç±»å‹åº“ï¼Œä¾‹å¦‚åå°„ï¼ˆå…¶ä¸­ä¸€åˆ‡éƒ½è¡¨ç¤ºä¸º Object æˆ– Object[]ï¼‰ï¼Œå®ƒä»¬åªèƒ½é€šè¿‡åŒ…è£…ç±»æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚ é€šè¿‡è£…ç®±ä¸ä¸€å®šæ˜¯åäº‹ï¼ŒArrayList&lt;Integer&gt; çš„å«ä¹‰å·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œè‡ªåŠ¨è£…ç®±è®©æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ç§è¯­æ³•ä¸Šæ–¹ä¾¿çš„æ–¹å¼æ¥å¤„ç†è¿™äº›ç±»å‹ã€‚ä½†åŒæ—¶å¸¦æ¥äº†å¾ˆå¤šé—®é¢˜ã€‚åŒ…è£…ç±»æœ‰ Identityï¼Œè€ŒåŸºæœ¬ç±»å‹æ²¡æœ‰ï¼ŒåŒ…è£…æ— æ³•å®Œå…¨å¼¥è¡¥è¿™ä¸€å·®è·ã€‚æ¯æ¬¡æˆ‘ä»¬ä» Integer è½¬æ¢ä¸º int æ—¶ï¼ŒIdentity éƒ½ä¼šä¸¢å¤±ï¼Œæ¯æ¬¡æˆ‘ä»¬ä» int è½¬æ¢ä¸º Integer æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ï¼ˆä½†æ˜¯éé¢„æœŸçš„ï¼‰Identityï¼ˆè¿™ä¼šé˜»æ­¢æœ‰ä»·å€¼çš„è¿è¡Œæ—¶ä¼˜åŒ–ï¼‰ã€‚è™½ç„¶ int å¯ä»¥è£…ç®±ä¸º Integerï¼Œä½† int[] ä¸ä¼šè£…ç®±ä¸º Integer[]ã€‚å¹¶ä¸”åŸºæœ¬ç±»å‹ä¸å…¶å¯¹åº”çš„åŒ…è£…ç±»å‹ä¹‹é—´çš„å…³ç³»å®Œå…¨æ˜¯ä¸´æ—¶çš„ã€‚ä½ éœ€è¦è®°ä½ä¸Šè¿°è¿™äº›å·®å¼‚ã€‚ å¼€å‘è€…çŸ¥é“è£…ç®±ä¸ä»…ä¸åˆå¸¸è§„ï¼Œè€Œä¸”è¿˜æœ‰ä¸€å®šçš„å¼€é”€ã€‚å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ä¼˜åŒ–ï¼Œè£…ç®±è½¬æ¢éœ€è¦åˆ†é…å †å†…å­˜ï¼Œå¹¶ä¸”ä½¿ç”¨è£…ç®±ç±»ä½œä¸ºå­—æ®µéœ€è¦é—´æ¥è®¿é—®ã€‚è£…ç®±ç±»æœ‰ä¸æˆ‘ä»¬åœ¨ä¸Šé¢çœ‹åˆ°çš„ Point æœ‰ç›¸åŒçš„é—®é¢˜ï¼Œåªæ˜¯æœ‰æ•ˆè½½è·è¾ƒå°ï¼ˆåªæœ‰ä¸€ä¸ªå­—æ®µï¼‰ã€‚ ä¸æ–­å¢åŠ çš„æˆæœ¬ And the Costs Roll Onåœ¨åº“çš„çº§åˆ«ï¼Œå¼€å‘äººå‘˜é¢ä¸´æ›´å›°éš¾çš„é€‰æ‹©ã€‚æœ€åŸºæœ¬çš„åº“ï¼ˆé›†åˆå’Œæµï¼‰æ˜¯åº“è®¾è®¡è€…å¿…é¡»è¿›è¡Œæƒè¡¡çš„ä¸»è¦ä¾‹å­ã€‚é›†åˆï¼ˆcollectionï¼‰åˆç†åœ°é€‰æ‹©äº†é¿å…ç‰¹åŒ–ï¼ˆJava ç”Ÿæ€ä¸­æœ‰ä¸€äº›åº“ï¼Œä¾‹å¦‚ trove æˆ– Eclipse Collectionsï¼Œå®ƒä»¬èµ°å¦ä¸€æ¡è·¯ï¼Œè¿™ä¹Ÿå¾ˆå¥½ï¼‰ï¼Œä¸è¿‡æµï¼ˆstreamï¼‰èµ°ä¸Šäº†ä¸€æ¡è¯•å›¾é€šè¿‡æ‰‹åŠ¨ç‰¹åŒ–ï¼ˆintã€long å’Œ doubleï¼‰çš„è·¯çº¿ï¼Œä½† IntStream çš„å­˜åœ¨è¯æ˜äº†åº“è®¾è®¡è€…ç»å¸¸ä¸å¾—ä¸å°†è‡ªå·±ç»•è¿›å»ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œæ‰‹åŠ¨ç‰¹åŒ–å¸¦æ¥äº†æ›´å¤šçš„æ‰‹åŠ¨ç‰¹åŒ–ï¼ˆIntStream äº§ç”Ÿäº† IntToLongFunction å’Œ PrimitiveIterator.OfIntï¼‰ï¼Œå¹¶ä¸”æ€»æ˜¯æœ‰äººè¦æ±‚æ›´å¤šï¼ˆâ€œæˆ‘çš„ CharStream åœ¨å“ªé‡Œâ€ï¼‰ã€‚æ‰‹åŠ¨ç‰¹åŒ–å‡ ä¹æ€»æ˜¯ä¼šå¼•å…¥ä¸å¯¹ç§°ã€‚æœ€åï¼Œæ‰‹åŠ¨ç‰¹åŒ–æµç±»å‹çš„å­˜åœ¨æˆä¸ºè¯¥åº“è®¾è®¡å’Œå®ç°çš„é‡å¤§é™åˆ¶ã€‚ åº“è®¾è®¡è€…ç»å¸¸é¢ä¸´è‰¯å¥½çš„å†…å­˜è¡Œä¸ºå’Œè‰¯å¥½çš„æŠ½è±¡ä¹‹é—´çš„é”™è¯¯é€‰æ‹©ã€‚ ç”¨æˆ·æœ‰çš„æ—¶å€™ä¹Ÿå¿…é¡»è¦é¢å¯¹åŸºæœ¬ç±»å‹å’ŒåŒ…è£…ç±»ä¹‹é—´çš„å·®å¼‚ã€‚å‡ ä¹æ¯ä¸ª Java å¼€å‘äººå‘˜éƒ½ç¼–å†™ä¸´æ—¶çš„ã€æ‰‹åŠ¨å®ç°çš„ ArrayList&lt;int&gt; çš„ç­‰ä»·ç‰©ï¼Œå› ä¸º ArrayList&lt;Integer&gt; ä¸å¤Ÿï¼ˆæˆ–è¢«è®¤ä¸ºä¸å¤Ÿï¼‰é€‚åˆè¿™ç§æƒ…å†µã€‚ è€Œä¸”è¿™ä¸ªæ‰‹åŠ¨å®ç°å¾ˆå°‘ä¸ List æœ‰ä»»ä½•è”ç³»ï¼Œè¿™æŠ‘åˆ¶äº†äº’æ“ä½œæ€§å¹¶è¿›ä¸€æ­¥å½±å“äº†ä»»ä½•æƒ³è¦ä½¿ç”¨å®ƒçš„ APIã€‚ è‰¯å¥½çš„å†…å­˜è¡Œä¸ºå’Œè‰¯å¥½çš„æŠ½è±¡ä¹‹é—´çš„æƒè¡¡å¯¹ç”¨æˆ·å’Œåº“è®¾è®¡è€…æ¥è¯´ä¸€æ ·è‰°éš¾ã€‚ æ ¹æœ¬åŸå›  The Root Causeä¸Šé¢ Point[] çš„ä¸åˆç†å¸ƒå±€æºè‡ªå¯¹è±¡ Identityï¼Œæ‰€æœ‰å¯¹è±¡å®ä¾‹éƒ½æ˜¯å”¯ä¸€æ ‡è¯†çš„ã€‚Identity ä½¿å¯å˜æ€§æˆä¸ºå¯èƒ½ã€‚ä¸ºäº†æ”¹å˜å¯¹è±¡çš„å­—æ®µï¼Œæˆ‘ä»¬å¿…é¡»çŸ¥é“æˆ‘ä»¬è¦ä¿®æ”¹å“ªä¸ªå¯¹è±¡ã€‚Identity è¿˜æ”¯æŒå¸ƒå±€å¤šæ€æ€§ï¼Œå…¶ä¸­å­ç±»ä¸å…¶è¶…ç±»å…±äº«ä¸€ä¸ªå…¬å…±å¸ƒå±€å‰ç¼€ï¼Œä»è€Œå…è®¸é€šè¿‡è¶…ç±»å¼•ç”¨å®‰å…¨åœ°æ“ä½œå­ç±»å®ä¾‹ã€‚å³ä½¿å¯¹äºé¿å…å¯å˜æ€§å’Œå¸ƒå±€å¤šæ€æ€§çš„ç±»ï¼ˆåŒ…æ‹¬å¤§å¤šæ•°ä¸å¯å˜çš„å…·ä½“ç±»ï¼‰ï¼ŒIdentity ä»ç„¶å¯ä»¥é€šè¿‡å„ç§ Identity ç›¸å…³çš„æ“ä½œæ¥è§‚å¯Ÿï¼ŒåŒ…æ‹¬å¯¹è±¡ç›¸ç­‰ï¼ˆ==ï¼‰ã€åŒæ­¥ã€System::identityHashCodeã€å¼±å¼•ç”¨ç­‰ã€‚ Identity æœ‰æ•ˆåœ°è¦æ±‚ä¸€ä¸ªå¯¹è±¡æ°å¥½ä½äºä¸€ä¸ªåœ°æ–¹ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è®¿é—®å®ƒï¼Œæˆ‘ä»¬å°±å»æºå¤´ã€‚è¿™å°±æ˜¯ Point[] å¸ƒå±€å……æ»¡æŒ‡é’ˆçš„åŸå› ï¼Œæ•°ç»„å…ƒç´ åªæ˜¯å¯¹å®é™…å¯¹è±¡çš„å¼•ç”¨ã€‚å¹¶ä¸” Identity è¦æ±‚ VM æ‚²è§‚åœ°ä¿ç•™ Identityï¼Œä»¥é˜²æœ‰äººæœ€ç»ˆå¯èƒ½æ‰§è¡Œ Identity ç›¸å…³çš„æ“ä½œï¼Œä»è€ŒæŠ‘åˆ¶è®¸å¤šæœ‰ç”¨çš„ä¼˜åŒ–ã€‚åœ¨ 90 å¹´ä»£åˆæœŸï¼Œâ€œä¸€åˆ‡éƒ½æ˜¯å¯¹è±¡â€æ˜¯ä¸€ä¸ªå¾ˆæœ‰å¸å¼•åŠ›çš„å£å¤´ç¦…ï¼ŒIdentity çš„æ€§èƒ½æˆæœ¬åœ¨å½“æ—¶ä¼¼ä¹å¹¶ä¸ç¹é‡ï¼Œä½†éšç€æ—¶é—´çš„æ¨ç§»ï¼Œè¿™ä¸ªæˆæœ¬è¶Šæ¥è¶Šé«˜ã€‚ Valhalla çš„åŸºæœ¬ç‰¹å¾æ˜¯æŸäº›ç±»å¯èƒ½ä¸éœ€è¦ä»–ä»¬çš„ Identityã€‚ä¸€ä¸ªæ²¡æœ‰ Identity çš„å¯¹è±¡æ˜¯ä¸€ä¸ªå€¼å¯¹è±¡ï¼Œå®ƒçš„ç±»æ˜¯ä¸€ä¸ªå€¼ç±»å‹ã€‚è¿™äº›ç±»æ”¾å¼ƒäº†ä¸€äº›çµæ´»æ€§ï¼Œä¾‹å¦‚å®ƒä»¬å¿…é¡»æ˜¯ä¸å¯å˜çš„ï¼Œä¸èƒ½æ˜¯å¸ƒå±€å¤šæ€çš„ã€‚ä½†ä½œä¸ºå›æŠ¥ï¼Œå®ƒä»¬ä¼šè·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚æ²¡æœ‰ Identity å…è®¸ JVM è‡ªç”±å¤åˆ¶å’Œé‡æ–°ç¼–ç è¿™äº›å¯¹è±¡ï¼Œåªä¿ç•™å®ƒä»¬çš„çŠ¶æ€å¹¶éœ€è¦æ›´å°‘çš„é—´æ¥è®¿é—®ã€‚ å°½ç®¡å¯¹å¯å˜æ€§å’Œå­ç±»åŒ–æœ‰é™åˆ¶ï¼Œä½†å€¼ç±»å‹å¯ä»¥ä½¿ç”¨ç±»å¯ç”¨çš„å¤§å¤šæ•°æœºåˆ¶ï¼Œæ–¹æ³•ã€æ„é€ å‡½æ•°ã€å­—æ®µã€å°è£…ã€æ¥å£ã€æ³›å‹ã€æ³¨è§£ç­‰ã€‚ æ­¤å¤–ï¼ŒæŸäº›å€¼ç±»å‹å¯èƒ½ä¼šé€‰æ‹©è¡¨ç¤ºä¸ºåŸå§‹ç±»ã€‚ åŸå§‹å‹ä¸èƒ½ä¸ºç©ºï¼Œå¹¶ä¸”å°è£…æ€§ä¸å¦‚å¼•ç”¨ç±»å‹ã€‚ä½†å®ƒä»¬çš„å€¼æ˜¯å®ä¾‹å­—æ®µçš„å€¼æœ¬èº«çš„åºåˆ—ï¼Œæœ€å¤§é™åº¦åœ°æé«˜äº† JVM å®ç°æ‰å¹³ã€å¯†é›†çš„å†…å­˜å¸ƒå±€å’Œä¼˜åŒ–è°ƒç”¨çº¦å®šçš„èƒ½åŠ›ã€‚è¿™äº›æ‰€è°“çš„åŸå§‹ç±»å¯ä»¥å°†ç±»çš„è¡¨è¾¾èƒ½åŠ›ä¸åŸºæœ¬ç±»å‹çš„è¿è¡Œæ—¶è¡Œä¸ºç»“åˆèµ·æ¥ã€‚Valhalla çš„å£å·æ˜¯ï¼šåƒ class ä¸€æ ·ç¼–å†™ï¼Œåƒ int ä¸€æ ·è¿è¡Œã€‚ Codes like a class, works like an int. ä¸åŸºæœ¬ç±»å‹ï¼ˆintã€double ç­‰ï¼‰ä¸åŒï¼Œé€šè¿‡ç±»å£°æ˜çš„åŸºæœ¬ç±»å‹å…·æœ‰å­—æ®µå’Œæ–¹æ³•ï¼Œå®ƒä»¬çš„å€¼å¯ä»¥æ ¹æ®éœ€è¦è‡ªç”±è½¬æ¢ä¸ºå€¼å¯¹è±¡ï¼Œè€Œæ²¡æœ‰è£…ç®±çš„å¼€é”€å’Œä¸´æ—¶æ€§ã€‚å®ƒä»¬çš„æ•°ç»„å¯ä»¥è¢«è§†ä¸ºå¯¹è±¡æ•°ç»„ã€‚ æ¯ä¸ªçº§åˆ«çš„ç¨‹åºéƒ½ä¼šç”¨åˆ°åŸå§‹ç±»å’ŒåŸºæœ¬ç±»ã€‚é™¤äº†æ˜¾è€Œæ˜“è§çš„å°†å†…ç½®åŸºæœ¬ç±»å‹è½¬åŒ–ä¸ºçœŸæ­£çš„ç±»ï¼Œè®¸å¤š API æŠ½è±¡ï¼Œä¾‹å¦‚æ•°å­—ã€æ—¥æœŸã€æ¸¸æ ‡å’Œ Optional ä¹‹ç±»çš„åŒ…è£…ç±»ï¼Œéƒ½å¯ä»¥è‡ªç„¶åœ°å»ºæ¨¡ä¸ºå€¼ç±»æˆ–åŸå§‹ç±»ã€‚æ­¤å¤–ï¼Œè®¸å¤šæ•°æ®ç»“æ„å¯ä»¥åœ¨å…¶å®ç°ä¸­ä½¿ç”¨åŸå§‹ç±»æ¥æé«˜æ•ˆç‡ã€‚åŒæ—¶è¯­è¨€ç¼–è¯‘å™¨å¯ä»¥å°†å®ƒä»¬ç”¨ä½œå†…ç½®æ•°å­—ç±»å‹ã€å…ƒç»„æˆ–å¤šè¿”å›ç­‰åŠŸèƒ½çš„ç¼–è¯‘ç›®æ ‡ã€‚ é‚£ä¹ˆæ³›å‹å‘¢ What about Generics?Java æ³›å‹çš„æ—©æœŸå¦¥åä¹‹ä¸€æ˜¯æ³›å‹ç±»å‹å˜é‡åªèƒ½ç”¨å¼•ç”¨ç±»å‹å®ä¾‹åŒ–ï¼Œä¸èƒ½ç”¨åŸºæœ¬ç±»å‹å®ä¾‹åŒ–ã€‚è¿™æ—¢ä¸æ–¹ä¾¿ï¼ˆå½“æˆ‘ä»¬æƒ³ç”¨ List&lt;int&gt; æ—¶æˆ‘ä»¬ä¸å¾—ä¸ç”¨ List&lt;Integer&gt;ï¼‰æˆæœ¬åˆé«˜ï¼ˆè£…ç®±æœ‰æ€§èƒ½å¼€é”€ï¼‰ã€‚å¯¹äºå…«ç§åŸºæœ¬ç±»å‹ï¼Œæˆ‘ä»¬å­¦ä¼šäº†æ¥å—è¿™ç§é™åˆ¶ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬å¯ä»¥ç¼–å†™è‡ªå·±çš„å¯æ‰å¹³åŒ–çš„æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚ä¸Šé¢çš„ Pointï¼Œé‚£ä¹ˆè®© ArrayList&lt;Point&gt; ä¸å— Point æ‰å¹³åŒ–æ•°ç»„çš„æ”¯æŒä¼¼ä¹æ˜¯ä¸åº”è¯¥çš„ï¼Œè¿™æ˜¯é‡ç‚¹ã€‚ å‚æ•°å¤šæ€æ€»æ˜¯éœ€è¦åœ¨ä»£ç å ç”¨ã€æŠ½è±¡å’Œç‰¹åŒ–ä¹‹é—´è¿›è¡Œæƒè¡¡ï¼Œä¸åŒçš„è¯­è¨€é€‰æ‹©äº†ä¸åŒçš„æƒè¡¡ã€‚ä¸€æ–¹é¢ï¼ŒC++ ä¸ºæ¨¡æ¿çš„æ¯ä¸ªå®ä¾‹åŒ–åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„ç±»ï¼Œä¸åŒçš„ç‰¹åŒ–å½¼æ­¤ä¹‹é—´æ²¡æœ‰ç±»å‹ç³»ç»Ÿçš„å…³ç³»ã€‚è¿™ç§å¼‚æ„ç¿»è¯‘æä¾›äº†é«˜åº¦çš„ç‰¹åŒ–ï¼Œä½†éœ€è¦å¤§é‡çš„ä»£ç ç©ºé—´å ç”¨ä»¥åŠæŠ½è±¡çš„æŸå¤±ï¼Œæ²¡æœ‰å’Œ Java ä¸­ List&lt;?&gt; ç­‰æ•ˆçš„ç±»å‹ï¼ˆä¸èƒ½å®šä¹‰ä¸€ä¸ª vector&lt;?&gt; æˆ–è€… vectorï¼‰ã€‚ å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬æœ‰ Java å½“å‰çš„æ“¦é™¤å®ç°ï¼Œå®ƒä¸ºæ‰€æœ‰å¼•ç”¨å®ä¾‹åŒ–ç”Ÿæˆä¸€ä¸ªç±»ï¼Œå¹¶ä¸”ä¸æ”¯æŒåŸºæœ¬ç±»å‹å®ä¾‹åŒ–ã€‚è¿™ç§åŒæ„çš„ç¿»è¯‘äº§ç”Ÿäº†é«˜åº¦çš„é‡ç”¨ï¼Œå› ä¸ºæ‰€æœ‰ï¼ˆå¼•ç”¨ï¼‰å®ä¾‹åŒ–åªæœ‰ä¸€ä¸ªç±»å’Œä¸€ä¸ªå¯¹è±¡å¸ƒå±€ã€‚å®ƒå¸¦æœ‰ä¸€ä¸ªé™åˆ¶ï¼Œå³æˆ‘ä»¬åªèƒ½å¯¹å…·æœ‰å…¬å…±è¿è¡Œæ—¶è¡¨ç¤ºçš„ç±»å‹è¿›è¡Œå¤„ç†ï¼Œè¿™åœ¨ Java ä¸­æ˜¯æ‰€æœ‰çš„å¼•ç”¨ç±»å‹ã€‚è¿™ç§é™åˆ¶æ·±æ·±æ¤æ ¹äº JVM çš„è®¾è®¡ä¸­ï¼Œå¯¹å¼•ç”¨å€¼å’ŒåŸºæœ¬å€¼çš„æ“ä½œæœ‰ä¸åŒçš„å­—èŠ‚ç ã€‚ è™½ç„¶å¤§å¤šæ•°å¼€å‘äººå‘˜å¯¹æ“¦é™¤æœ‰ä¸€å®šç¨‹åº¦çš„åŒæ¶ï¼Œä½†è¿™ç§æ–¹æ³•æœ‰ä¸€ä¸ªå¼ºå¤§çš„ä¼˜åŠ¿ï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡å…¶ä»–æ–¹å¼è·å¾—ï¼šé€æ­¥è¿ç§»å…¼å®¹æ€§ã€‚è¿™æ˜¯å°†ç±»ä»éæ³›å‹å…¼å®¹åœ°æ¼”å˜ä¸ºæ³›å‹çš„èƒ½åŠ›ï¼Œè€Œä¸ä¼šç ´åç°æœ‰çš„æºä»£ç æˆ–äºŒè¿›åˆ¶ç±»æ–‡ä»¶ï¼Œå¹¶ä½¿è°ƒç”¨è€…å’Œå­ç±»å…·æœ‰ç«‹å³ã€ç¨åæˆ–æ°¸ä¸è¿ç§»çš„çµæ´»æ€§ã€‚å‘ç”¨æˆ·æä¾›æ³›å‹ï¼Œä½†ä»¥ä¸¢å¼ƒä»–ä»¬å·²æœ‰çš„ä»£ç ä¸ºä»£ä»·ï¼Œåœ¨ 2004 å¹´å°†æ˜¯ä¸€ä¸ªç³Ÿç³•çš„å†³å®šï¼Œå½“æ—¶ Java å·²ç»æ‹¥æœ‰åºå¤§è€Œå……æ»¡æ´»åŠ›çš„å®‰è£…åŸºç¡€ã€‚å¦‚æœä»Šå¤©é€‰æ‹©ä¸å…¼å®¹ï¼Œå°†æ˜¯ä¸€ä¸ªæ›´ç³Ÿç³•çš„å†³å®šã€‚ æ³›å‹è®¡åˆ’æœ‰ä¸¤ä¸ªé˜¶æ®µï¼šé€šç”¨æ³›å‹å’Œç‰¹åŒ–æ³›å‹ã€‚åœ¨ç¬¬ä¸€é˜¶æ®µï¼Œæˆ‘ä»¬ä¿®å¤äº†é˜»æ­¢æˆ‘ä»¬ä½¿ç”¨åŸºæœ¬ç±»å‹ä½œä¸ºæ³›å‹ç±»å‹å‚æ•°çš„è¯­è¨€çº§åˆ«çš„é™åˆ¶ï¼Œå…è®¸æ³›å‹è¦†ç›–æ‰€æœ‰ç±»å‹ï¼Œä½†ä»ç„¶é€šè¿‡æ“¦é™¤å®ç°ã€‚ï¼ˆè¿™äº§ç”Ÿäº†ä¸€ç§æ›´ç»Ÿä¸€å’Œæ›´å…·è¡¨ç°åŠ›çš„è¯­è¨€ï¼Œä½†è¿˜æ²¡æœ‰ä¼˜åŒ–æ€§èƒ½ï¼Œå°½ç®¡ä¸€äº›è£…ç®±æˆæœ¬å·²ç»è¢«æ›´è½»é‡çº§çš„å€¼å¯¹è±¡è½¬æ¢æ‰€å–ä»£ï¼‰åœ¨ç¬¬äºŒé˜¶æ®µï¼Œæˆ‘ä»¬åœ¨ JVM ä¸­å¯ç”¨å¸ƒå±€å’Œä»£ç ç‰¹åŒ–çš„æ³›å‹ç±»å’Œæ–¹æ³•ï¼ŒåŒæ—¶ä¿ç•™äº†ä½¿æ³›å‹é¦–æ¬¡æˆåŠŸçš„æ‰€æœ‰é‡è¦çš„æ¸è¿›è¿ç§»èƒ½åŠ›ã€‚ ç»§ç»­å‰è¿› Moving ForwardValhalla é¡¹ç›®æœ‰éå¸¸è¿œå¤§çš„ç›®æ ‡ï¼Œå…¶åº”ç”¨å³æ·±å…¥åˆå¹¿æ³›ï¼Œå½±å“åˆ°ç±»æ–‡ä»¶æ ¼å¼ã€JVMã€Java è¯­è¨€ã€åº“å’Œç”¨æˆ·æ¨¡å‹ã€‚ï¼ˆ2014 å¹´ï¼ŒJames Gosling å°†å…¶æè¿°ä¸ºâ€œå…­ç¯‡åšå£«è®ºæ–‡ï¼Œäº¤ç»‡åœ¨ä¸€èµ·â€ï¼‰ æˆ‘ä»¬æ‰“ç®—å°† Valhalla é¡¹ç›®çš„äº¤ä»˜åˆ†ä¸ºä¸‰ä¸ªä¸»è¦é˜¶æ®µï¼šé¦–å…ˆæ˜¯ Identity-free çš„å€¼å¯¹è±¡ï¼Œç„¶åæ˜¯åŸå§‹ç±»ï¼Œè¿ç§»ç°æœ‰çš„åŸºæœ¬ç±»å‹å’Œé€šç”¨æ³›å‹ï¼Œæœ€åæ˜¯ç‰¹åŒ–æ³›å‹ã€‚","link":"/2021/12/the-road-to-valhalla/"},{"title":"Valhalla (5): è§£è¯» JEP 390 Warnings for Value-Based Classes","text":"è§£è¯» JEP 390 Warnings for Value-Based Classesï¼ŒåŸºäºå€¼çš„ç±»ï¼ˆvalue-basedï¼‰çš„ç›¸å…³è­¦å‘Šã€‚ ä»¥ç›´è¯‘ä¸ºä¸»ï¼Œéƒ¨åˆ†å†…å®¹ä¼šæ„è¯‘ï¼Œä¸€äº›åœ°æ–¹ä¼šå¢åŠ è‡ªå·±çš„è§£è¯»ã€‚ä¸€äº›æ¦‚å¿µè§£é‡Šè§ æ·±å…¥ç†è§£ Valhalla (0): åºè¨€ã€‚ ç³»åˆ—æ–‡ç« ï¼ˆæœªå®Œå¾…ç»­ï¼‰ Valhalla (0): åºè¨€ Valhalla (1): èƒŒæ™¯ How We Got the Generics We Have Valhalla (2): ç°çŠ¶ The Road to Valhalla Valhalla (5): è§£è¯» JEP 390 Warnings for Value-Based Classes Valhalla (6): è§£è¯» JEP 401 Primitive Objects Valhalla (7): è§£è¯» JEP 402 Unify the Basic Primitives with Objects æ‘˜è¦ Summaryå°†åŒ…è£…ç±»ï¼ˆjava.lang.Integerã€java.lang.Double ç­‰ï¼‰è®¾è®¡ä¸ºä¸ºåŸºäºå€¼çš„ç±»ï¼Œå¹¶åœ¨æ„é€ å‡½æ•°çš„ @Deprecated ä¸­åŠ å…¥ forRemovalï¼ˆåœ¨ JDK 9 ä¸­å·²ç»è¢«æ ‡è®°ä¸º @Deprecatedï¼‰ã€‚åœ¨ä»»ä½•åŸºäºå€¼çš„ç±»çš„å®ä¾‹ä¸Šè¿›è¡ŒåŒæ­¥ï¼ˆsynchronizedï¼‰æ—¶ï¼Œä¼šå‘å‡ºè­¦å‘Šã€‚ å¯ä»¥çœ‹ä¸‹æœ€æ–°çš„æºä»£ç ï¼Œå¢åŠ äº† forRemovalhttps://github.com/openjdk/jdk/blob/master/src/java.base/share/classes/java/lang/Integer.java 12345678910111213141516/** * Constructs a newly allocated {@code Integer} object that * represents the specified {@code int} value. * * @param value the value to be represented by the * {@code Integer} object. * * @deprecated * It is rarely appropriate to use this constructor. The static factory * {@link #valueOf(int)} is generally a better choice, as it is * likely to yield significantly better space and time performance. */@Deprecated(since=&quot;9&quot;, forRemoval = true)public Integer(int value) { this.value = value;} åŠ¨æœº MotivationValhalla é¡¹ç›®å¸Œæœ›é€šè¿‡å¼•å…¥åŸå§‹ç±»ï¼ˆprimitive classï¼‰æ¥å¯¹ Java ç¼–ç¨‹æ¨¡å‹è¿›è¡Œé‡å¤§æ”¹è¿›ã€‚åŸå§‹ç±»çš„å®ä¾‹æ˜¯ Identity-free çš„ï¼Œèƒ½å¤Ÿè¿›è¡Œå†…è”å’Œæ‰å¹³åŒ–çš„è¡¨ç¤ºã€‚è¿™æ ·çš„å®ä¾‹å¯ä»¥åœ¨å†…å­˜ä¸åŒä½ç½®ä¹‹é—´è‡ªç”±å¤åˆ¶ï¼Œä¹Ÿå¯ä»¥ä»…ä»…ç”¨å­—æ®µçš„å€¼è¿›è¡Œç¼–ç ï¼ˆè¿™é‡Œç¼–ç å¯èƒ½æŒ‡å†…å­˜ä¸­çš„å¸ƒå±€ï¼‰ã€‚ åŸå§‹ç±»çš„è®¾è®¡å’Œå®ç°å·²ç»è¶³å¤Ÿæˆç†Ÿäº†ã€‚æˆ‘ä»¬å¯ä»¥ç›¸ä¿¡åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­ï¼Œä¸€äº› Java å¹³å°çš„ç±»å°†ä¼šè¿ç§»æˆåŸå§‹ç±»ã€‚ è®¾è®¡å’Œå®ç°å·²ç»è¶³å¤Ÿæˆç†Ÿäº†ï¼Œç›¸å…³çš„ JEP éƒ½å·²ç»è¿›å…¥å€™é€‰ï¼Œå¯ä»¥å‚è€ƒåç»­æ–‡ç« ã€‚ è¿ç§»çš„å€™é€‰è€…åœ¨ API è§„èŒƒä¸­è¢«éæ­£å¼çš„æŒ‡å®šä¸ºåŸºäºå€¼çš„ï¼Œè¿™æ„å‘³ç€ ä¸å¯å˜çš„ å¯¹è±¡çš„ Identity å¯¹è‡ªèº«çš„è¡Œä¸ºæ¥è¯´ä¸é‡è¦ï¼ˆå°±æ˜¯ä¹‹å‰è¯´çš„ Identity-freeï¼‰ ä¸æä¾›ç”Ÿæˆç‹¬ç«‹ Identity å®ä¾‹çš„æœºåˆ¶ï¼Œä¾‹å¦‚å…¬å¼€çš„æ„é€ å‡½æ•°ï¼ˆæ¯æ¬¡è°ƒç”¨è¿”å›çš„å¯¹è±¡éƒ½æ˜¯ä¸€ä¸ªæ–°çš„ Identityï¼‰ éæ­£å¼çš„æŒ‡ä¸æ”¹å˜ä»»ä½•ç‰¹æ€§ï¼Œä½†ä¼šè®¾è®¡ä¸ºç¬¦åˆç›¸å…³çº¦å®šï¼Œæ–¹ä¾¿åç»­è¿ç§»ã€‚ åŒ…è£…ç±»ï¼ˆjava.lang.Integerã€java.lang.Double ç­‰ï¼‰ä¹Ÿæ‰“ç®—æˆä¸ºåŸå§‹ç±»ï¼Œè¿™äº›ç±»éƒ½æ»¡è¶³ä¸Šè¿°çš„è¦æ±‚ï¼Œé™¤äº†å…·æœ‰å…¬å¼€çš„æ„é€ å‡½æ•°ï¼ˆåœ¨ JDK 9 ä¸­å·²ç»è¢«æ ‡è®°ä¸º @Deprecatedï¼‰ï¼Œé€šè¿‡ä¸€äº›ä¿®æ”¹ï¼ŒåŒ…è£…ç±»ä¾æ—§å¯ä»¥è¢«å½“ä½œæ˜¯åŸºäºå€¼çš„ã€‚ åŸºäºä¸Šè¿°åŸå› ï¼Œåç»­åŒ…è£…ç±»çš„æ„é€ å‡½æ•°éƒ½ä¼šè¢«ç§»é™¤ã€‚åŸºäºå€¼çš„ç±»æ˜¯ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼ŒåŸå§‹ç±»æ˜¯ä¸€ä¸ªå…·ä½“çš„å®ç°ï¼Œåç»­ä¸åŠ ä¸¥æ ¼åŒºåˆ†å¯ä»¥è®¤ä¸ºè¯´çš„æ˜¯åŒä¸€ä¸ªäº‹æƒ…ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨è€…å¦‚æœæŒ‰ç…§å»ºè®®ä½¿ç”¨ï¼Œè¿ç§»æˆåŸå§‹ç±»ä¹‹åæ˜¯ä¸ä¼šæœ‰ä»€ä¹ˆå½±å“çš„ã€‚åœ¨åç»­ç‰ˆæœ¬çš„çš„ JDK ä¸­è¿è¡Œæ—¶ï¼Œéœ€è¦æ³¨æ„ ç›¸ç­‰ï¼ˆequalsï¼‰çš„å®ä¾‹ä¹Ÿæ˜¯ç›¸åŒçš„ï¼ˆ==ï¼‰ï¼Œå¦‚æœä»£ç ä¸­ä¾èµ– != å°±æœ‰å¯èƒ½äº§ç”Ÿä¸æ­£ç¡®çš„ç»“æœã€‚ ä½¿ç”¨ new Integerã€new Double ç­‰åˆ›å»ºå®ä¾‹çš„æ—¶å€™ä¼šäº§ç”Ÿ LinkageErrorsï¼Œéœ€è¦æ”¹æˆä½¿ç”¨ valueOf å·¥å‚æ–¹æ³•ã€‚ å°è¯•åœ¨è¿™äº›ç±»çš„å®ä¾‹ä¸Šè¿›è¡ŒåŒæ­¥å°†äº§ç”Ÿå¼‚å¸¸ã€‚ è¿™äº›æ”¹å˜å¯¹ä¸€äº›äººæ¥è¯´å¯èƒ½ä¸æ–¹ä¾¿ï¼Œä½†è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå¦‚æœéœ€è¦ Identity å¯ä»¥ä½¿ç”¨ä¸åŒçš„ç±»å‹ï¼ˆé€šå¸¸å¯ä»¥è‡ªå®šä¹‰çš„ç±»ï¼Œä½¿ç”¨ Object æˆ–è€… AtomicReference ä¹Ÿæ˜¯å¯ä»¥çš„ï¼‰ã€‚ä½†å¸¦æ¥çš„å¥½å¤„ä¹Ÿæ˜¯éå¸¸æ˜æ˜¾çš„ï¼Œæ›´å¥½çš„æ€§èƒ½ã€æ›´å¯é çš„ç›¸ç­‰è¯­ä¹‰ã€å¯ä»¥ç»Ÿä¸€åŸºæœ¬ç±»å‹å’Œç±»ã€‚å¯¹äºä¸Šè¿° 3 ä¸ªé—®é¢˜ï¼š å·²ç»é€šè¿‡å·¥å‚æ–¹æ³•çš„å”¯ä¸€æ€§ï¼Œé¿å…äº†ä¸Šè¿°é—®é¢˜ã€‚ä½†æ²¡æœ‰ä¸€ç§å®ç”¨çš„æ‰‹æ®µï¼Œå¯ä»¥ç›‘æµ‹ç¨‹åºå¿½ç•¥äº†è¿™ç§è§„èŒƒã€‚ä¸è¿‡é¢„è®¡è¿™ç§æƒ…å†µä¼šéå¸¸å°‘ã€‚ åœ¨æ„é€ å‡½æ•°ä¸Šå¢åŠ  forRemovalï¼Œå½“ä½¿ç”¨ä¸Šè¿°æ„é€ æ–¹æ³•æ—¶ç¼–è¯‘å™¨ä¼šç»™å‡ºæ›´å¤šçš„è­¦å‘Šã€‚ç°æœ‰çš„ Java é¡¹ç›®æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†ï¼ˆå¯èƒ½å å…¶ä¸­çš„ 1%-10%ï¼‰è°ƒç”¨äº†ä¸Šè¿°æ„é€ æ–¹æ³•ï¼Œä½†å®ƒä»¬æ›´å¤šéƒ½åªä¼šè¿è¡Œåœ¨ Java 9 ä¹‹å‰çš„ç‰ˆæœ¬ä¸Šã€‚å¤§éƒ¨åˆ†æµè¡Œçš„å¼€æºé¡¹ç›®ï¼Œéƒ½å·²ç»æ ¹æ®è­¦å‘Šä¿¡æ¯è¿›è¡Œäº†ä¿®æ”¹ã€‚å¢åŠ  forRemoval ä¹‹åï¼Œæ›´å¤šçš„é¡¹ç›®ä¹Ÿä¼šè¿›è¡Œç›¸åº”çš„ä¿®æ”¹ã€‚åœ¨åæ–‡ä¾èµ–éƒ¨åˆ†ï¼ˆDependenciesï¼‰ä¸­ä»‹ç»äº†å…¶ä»–çš„åŠŸèƒ½ï¼Œä¼šæ›´å¥½çš„å¸®åŠ©è¿ç§»ã€‚ åœ¨ç¼–è¯‘å’Œè¿è¡Œæ—¶çš„æ—¶å€™å¢åŠ ç›¸å…³çš„è­¦å‘Šï¼Œé€šçŸ¥ç¨‹åºå‘˜åŒæ­¥ï¼ˆsynchronizedï¼‰æ“ä½œåœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­å°†ä¸èµ·ä½œç”¨ã€‚ æè¿° Descriptionjava.lang ä¸­çš„åŒ…è£…ç±»ï¼ˆByteã€Shortã€Integerã€Longã€Floatã€Doubleã€Boolean å’Œ Characterï¼‰å·²è¢«æŒ‡å®šä¸ºåŸºäºå€¼çš„ã€‚ä¸ºäº†é˜²æ­¢åŸºäºå€¼çš„å®ä¾‹è¢«é”™è¯¯çš„ä½¿ç”¨ï¼š åŒ…è£…ç±»çš„æ„é€ å‡½æ•°ï¼Œå·²ç»è¢«æ ‡è®°ä¸ºåºŸå¼ƒï¼Œå¹¶ä¸”å¢åŠ äº† forRemovalã€‚javac åœ¨ç¼–è¯‘æ—¶é»˜è®¤éƒ½ä¼šæç¤ºè­¦å‘Šä¿¡æ¯ã€‚jdeprscan å·¥å…·ä¹Ÿå¯ä»¥è¯†åˆ«äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ä½¿ç”¨å·²åºŸå¼ƒ API çš„æƒ…å†µã€‚ javac æ–°å¢äº†åŒæ­¥ï¼ˆsynchronizedï¼‰è­¦å‘Šç±»å‹ï¼Œåœ¨åŸºäºå€¼çš„ç±»æˆ–è€…æ‰€æœ‰å­ç±»éƒ½æ˜¯åŸºäºå€¼çš„ç±»çš„å®ä¾‹ä¸Šä½¿ç”¨åŒæ­¥æ—¶ä¼šç»™å‡ºè­¦å‘Šã€‚é»˜è®¤æ˜¯å¼€å¯çš„ï¼Œå¯ä»¥é€šè¿‡ -Xlint:synchronization æ‰‹åŠ¨é€‰æ‹©ã€‚ HotSpot å®ç°äº†ä¸€ä¸ªè¿è¡Œæ—¶æ£€æµ‹æ‰‹æ®µï¼Œå¯ä»¥æ£€æµ‹åœ¨åŸºäºå€¼çš„å®ä¾‹ä¸Šä½¿ç”¨ monitorenter æŒ‡ä»¤ã€‚å‘½ä»¤è¡Œé€‰é¡¹ -XX:DiagnoseSyncOnValueBasedClasses=1 ä¼šå°†æ“ä½œè§†ä¸ºè‡´å‘½é”™è¯¯ã€‚å‘½ä»¤è¡Œé€‰é¡¹ -XX:DiagnoseSyncOnValueBasedClasses=2 å°†é€šè¿‡æ§åˆ¶å°å’Œ JDK Flight Recorder äº‹ä»¶æ‰“å¼€æ—¥å¿—è®°å½•ã€‚ ç¼–è¯‘æ—¶åŒæ­¥è­¦å‘Šä¾èµ–äºé™æ€ç±»å‹ï¼Œè€Œè¿è¡Œæ—¶è­¦å‘Šå¯ä»¥å¤„ç†éåŸºäºå€¼çš„ç±»å’Œæ¥å£ç±»å‹å¦‚ Objectï¼Œä¾‹å¦‚ï¼š 1234Double d = 20.0;synchronized (d) { ... } // javac warning &amp; HotSpot warningObject o = d;synchronized (o) { ... } // HotSpot warning åœ¨åŒæ­¥ä»£ç ä¹‹å¤–æ‰§è¡Œ monitorexit æŒ‡ä»¤ï¼Œæˆ–è€… waitã€notify å’Œ notifyAll æœ¬èº«å°±ä¼šæŠ›å‡º IllegalMonitorStateExceptionï¼Œå› æ­¤è¿™äº›æ“ä½œä¸éœ€è¦å†è¿›è¡Œè­¦å‘Šã€‚ æ ‡è¯†åŸºäºå€¼çš„ç±» Identifying Value-Based Classesåœ¨ JDK ä¸­ï¼Œ@jdk.internal.ValueBased æ³¨è§£ç”¨äºå‘ javac å’Œ HotSpot è¡¨æ˜ç±»æ˜¯åŸºäºå€¼çš„ï¼Œæˆ–è€…è¡¨æ˜æŠ½è±¡ç±»æˆ–æ¥å£éœ€è¦åŸºäºå€¼çš„å­ç±»ã€‚Java API å’Œ JDK ä¸­ä¸‹åˆ—ç±»å‹è¢«æ ‡è®°ä¸º @ValueBased åŒ…è£…ç±» java.lang.Runtime.Version java.util ä¸­çš„ optional ç±»ï¼šOptionalã€OptionalIntã€ OptionalLong å’Œ OptionalDouble java.time ä¸­çš„ APIï¼šInstantã€ LocalDateã€ LocalTimeã€ LocalDateTimeã€ ZonedDateTimeã€ ZoneIdã€ OffsetTimeã€ OffsetDateTimeã€ ZoneOffsetã€ Durationã€ Periodã€ Yearã€ YearMonthã€MonthDayã€MinguoDateã€ HijrahDateã€ JapaneseDate å’Œ ThaiBuddhistDate java.lang.ProcessHandle æ¥å£å’Œå®ç°ç±» java.util ä¸­çš„é›†åˆå·¥å‚æ–¹æ³•çš„å®ç°ç±»ï¼šList.ofã€ List.copyOfã€ Set.ofã€ Set.copyOfã€ Map.ofã€ Map.copyOfã€ Map.ofEntries å’Œ Map.entry åœ¨æŠ½è±¡ç±»æˆ–è€…æ¥å£ä¸­ä½¿ç”¨è¯¥æ³¨è§£ï¼Œæ„å‘³ç€æ‰€æœ‰å­ç±»ä¹Ÿä½¿ç”¨äº†è¯¥æ³¨è§£ã€‚éƒ¨åˆ†åœ¨ java.lang.constant å’Œ jdk.incubator.foreign ä¸­çš„ç±»å’Œæ¥å£ä¸€å¼€å§‹è¦æ±‚æ˜¯åŸºäºå€¼çš„ï¼Œä½†å¹¶ä¸ç¬¦åˆæœ€æ–°çš„è§„èŒƒï¼ˆä¾‹å¦‚ç»§æ‰¿äº†å­—æ®µï¼‰ï¼Œæ‰€ä»¥ä¸èƒ½è¿ç§»æˆåŸå§‹ç±»ã€‚è¿™ç§æƒ…å†µä¸‹è¿™äº›ç±»ä¸å†æ˜¯åŸºäºå€¼çš„ã€‚ å½±å“èŒƒå›´ Scope of ChangesJava SEï¼šä¼˜åŒ–äº†åŒ…è£…ç±»ã€ç°æœ‰çš„åŸºäºå€¼çš„ç±»ã€ç›¸å…³çš„æ¥å£å’Œå·¥å‚æ–¹æ³•çš„è§„èŒƒï¼Œä¿®æ”¹äº† Java ç›¸å…³çš„ APIã€‚å¯¹äº Java è¯­è¨€è§„èŒƒå’Œ Java è™šæ‹Ÿæœºè§„èŒƒï¼Œæ²¡æœ‰ä»»ä½•ä¿®æ”¹ã€‚ JDKï¼šä¸º javac å’Œ HotSpot å¢åŠ äº†æ–°çš„è­¦å‘Šå’Œæ—¥å¿—è®°å½•çš„åŠŸèƒ½ï¼Œä¸€äº›ç±»å¢åŠ äº† @jdk.internal.ValueBased æ³¨è§£ã€‚ å…¶ä»–é€‰æ‹© Alternativesæˆ‘ä»¬å¯ä»¥æ”¾å¼ƒå°†è¿™äº›ç±»è¿ç§»ä¸ºåŸå§‹ç±»çš„åŠªåŠ›ã€‚ä½†å½“æˆ‘ä»¬å®Œæˆè¿ç§»æ—¶ï¼Œå¼€å‘äººå‘˜å°†äº«å—åˆ°æ˜¾ç€çš„å¥½å¤„ï¼Œå¹¶ä¸”å¯¹ä¾èµ–é—®é¢˜è¡Œä¸ºçš„å¼€å‘äººå‘˜çš„å½±å“ç›¸å¯¹è¾ƒå°ã€‚ å¯ä»¥ç”¨è¿è¡Œæ—¶è­¦å‘Šè¡¥å……ç¼–è¯‘æ—¶å¼ƒç”¨è­¦å‘Šï¼Œè¿™ç•™ä½œå¦æœªæ¥ä¸€ä¸ª JEP çš„å·¥ä½œï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚ å¯èƒ½è¿˜æœ‰å…¶ä»–ç±»å¯ä»¥è¿ç§»ä¸ºåŸå§‹ç±»ï¼ŒåŒ…æ‹¬ä¸€äº› API ç±»å’Œç”± java.lang.invoke.LambdaMetafactory ç­‰åŠŸèƒ½ç”Ÿæˆçš„ç±»ã€‚è¯¥ JEP å°†è‡ªèº«é™åˆ¶ä¸ºåŒ…è£…ç±»å’Œå·²æŒ‡å®šä¸ºåŸºäºå€¼çš„ç±»ã€‚åŒæ ·ï¼Œå¯ä»¥åœ¨æœªæ¥çš„å·¥ä½œä¸­å¼•å…¥é¢å¤–çš„è­¦å‘Šã€‚ ä¾èµ– DependenciesåŸºäºå€¼çš„ç±»è¿ç§»ä¸ºåŸå§‹ç±»ï¼Œåœ¨å¢åŠ è¿™äº›è­¦å‘Šä¹‹åä¾ç„¶éœ€è¦å……åˆ†çš„å‡†å¤‡æ—¶é—´ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œåœ¨è¯¥ JEP å®Œæˆåçš„ä¸€æ®µæ—¶é—´å†…ï¼Œæ— æ³•å°†åŒ…è£…ç±»è¿ç§»ä¸ºåŸå§‹ç±»ã€‚ åŒ…è£…ç±»è¿ç§»ä¸ºåŸå§‹ç±»çš„å¦ä¸€ä¸ªå‰æï¼Œæ˜¯æœ‰è¶³å¤Ÿçš„å·¥å…·æ¥è¯†åˆ«å’Œè§£å†³åºŸå¼ƒæ„é€ å‡½æ•°çš„ä½¿ç”¨ã€‚å°†åœ¨å•ç‹¬çš„ JEP ä¸­ä¸¤ä¸ªåç»­åŠŸèƒ½ï¼š æ–°å¢ HotSpot è¿è¡Œæ—¶è­¦å‘Šï¼Œæ£€æµ‹å·²å¼ƒç”¨ API çš„ä½¿ç”¨ï¼ˆåŒ…æ‹¬åŒ…è£…ç±»æ„é€ å‡½æ•°ï¼‰ï¼Œä½œä¸º javac å’Œ jdeprscan çš„è¡¥å……ã€‚ æ–°å¢å·¥å…·ï¼Œæ”¯æŒè¿è¡Œæ— æ³•é‡æ–°ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå…¶ä¸­ä½¿ç”¨äº†åºŸå¼ƒçš„æ„é€ å‡½æ•°ï¼‰ã€‚ä¾‹å¦‚å¯ä»¥é‡å†™å­—èŠ‚ç ä»¥ä½¿ç”¨ valueOf æ–¹æ³•ã€‚ï¼ˆè¿™é‡Œåº”è¯¥è¿˜åŒ…å« JNI äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰","link":"/2021/10/jep-390/"},{"title":"Valhalla (7): è§£è¯» JEP 402 Unify the Basic Primitives with Objects","text":"è§£è¯» JEP 402: Unify the Basic Primitives with Objects (Preview)ï¼Œç»Ÿä¸€åŸºæœ¬ç±»å‹å’Œå¯¹è±¡ã€‚ ä»¥ç›´è¯‘ä¸ºä¸»ï¼Œéƒ¨åˆ†å†…å®¹ä¼šæ„è¯‘ï¼Œä¸€äº›åœ°æ–¹ä¼šå¢åŠ è‡ªå·±çš„è§£è¯»ã€‚ä¸€äº›æ¦‚å¿µè§£é‡Šè§ æ·±å…¥ç†è§£ Valhalla (0): åºè¨€ã€‚ ç³»åˆ—æ–‡ç« ï¼ˆæœªå®Œå¾…ç»­ï¼‰ Valhalla (0): åºè¨€ Valhalla (1): èƒŒæ™¯ How We Got the Generics We Have Valhalla (2): ç°çŠ¶ The Road to Valhalla Valhalla (5): è§£è¯» JEP 390 Warnings for Value-Based Classes Valhalla (6): è§£è¯» JEP 401 Primitive Objects Valhalla (7): è§£è¯» JEP 402 Unify the Basic Primitives with Objects æ‘˜è¦ Summaryé€šè¿‡å°†åŸºæœ¬å€¼è®¾è®¡ä¸ºåŸå§‹ç±»ï¼ˆè§ JEP 401ï¼‰çš„å®ä¾‹ï¼Œç»Ÿä¸€åŸºæœ¬ç±»å‹ï¼ˆintã€double ç­‰ï¼‰å’Œå¯¹è±¡ï¼Œç»§ç»­ç”¨åŒ…è£…ç±»çš„å£°æ˜ä½œä¸ºåŸå§‹ç±»çš„å£°æ˜ã€‚ä½œä¸ºæ”¹åŠ¨çš„ç»“æœï¼ŒJava ä¸­æ‰€æœ‰çš„å€¼éƒ½æ˜¯å¯¹è±¡äº†ã€‚è¯¥ææ¡ˆå°†ä¼šæ˜¯ä¸€é¡¹é¢„è§ˆç‰¹æ€§ã€‚ ç›®æ ‡ Goals å°† 8 ä¸ªåŒ…è£…ç±»ï¼ˆjava.lang.Integerã€java.lang.Double ç­‰ï¼‰è¿ç§»ä¸ºå¼•ç”¨ä¼˜å…ˆï¼ˆReference-favoringï¼‰çš„åŸå§‹ç±»ã€‚ åœ¨ Java è¯­è¨€ä¸­ï¼Œå°†åŸºæœ¬å€¼è§†ä¸ºè¿ç§»åçš„åŒ…è£…ç±»çš„å®ä¾‹ã€‚åŒæ—¶åŸºæœ¬ç±»å‹å…³é”®å­—ï¼ˆintã€double ç­‰ï¼‰å°†ä½œä¸ºå¯¹åº”åŸå§‹å€¼ç±»å‹çš„åˆ«åï¼Œæ–°çš„ç±»å‹æ”¯æŒæ–¹æ³•è°ƒç”¨ã€åŸå§‹å¼•ç”¨è½¬æ¢ã€æ•°ç»„åå˜ã€‚ åœ¨ Java è™šæ‹Ÿæœºä¸­ï¼Œå°†åŸºæœ¬æ•°ç»„ç±»å‹è§†ä¸ºå¯¹åº”åŸå§‹å¯¹è±¡çš„æ•°ç»„ç±»å‹ã€‚ åœ¨æ ¸å¿ƒåå°„ API ä¸­ï¼Œä¿®æ”¹ 8 ä¸ªè¡¨ç¤ºåŸºæœ¬ç±»å‹çš„ Class å¯¹è±¡ï¼ˆint.classã€double.class ç­‰ï¼‰çš„è¡Œä¸ºï¼Œä»¥ä¾¿ç¬¦åˆå®ƒä»¬çš„ç±»å‹å®šä¹‰ã€‚ è¿™å°†æ˜¯ä¸€é¡¹éå¸¸é‡å¤§çš„æ”¹åŠ¨ï¼ŒJava çœŸæ­£å˜æˆäº†ä¸€åˆ‡çš†å¯¹è±¡ï¼Œä»¥ä¸‹ä»£ç éƒ½å°†å˜å¾—åˆæ³•ï¼š 123451.equals(1); // æ”¯æŒæ–¹æ³•è°ƒç”¨int.ref one = 1; // åŸå§‹å¼•ç”¨è½¬æ¢Object[] array = new int[]{1, 2, 3}; // æ•°ç»„åå˜// int == Integer.val ç­‰ä»·// int.ref == Integer ç­‰ä»· éç›®æ ‡ Non-Goals åŸå§‹å¯¹è±¡å’ŒåŸå§‹ç±»çš„åŠŸèƒ½åœ¨ JEP 401ä¸­ä»‹ç»ï¼Œè€Œè¯¥ JEP åªè€ƒè™‘å¦‚ä½•åœ¨ 8 ä¸ªåŸºæœ¬ç±»å‹ä¸Šåº”ç”¨è¿™äº›ç‰¹æ€§ã€‚ è¯¥ JEP ä¸æ¶‰åŠåŸå§‹å€¼ç±»å‹ï¼ˆintã€double ç­‰ï¼‰å’Œ Java æ³›å‹çš„äº¤äº’ã€‚å•ç‹¬çš„ JEP å°†æ»¡è¶³åŸå§‹å€¼ç±»å‹ä½œä¸ºç±»å‹å‚æ•°çš„éœ€æ±‚ï¼Œå¹¶æœ€ç»ˆä¼˜åŒ–è¿™äº›å‚æ•°åŒ–çš„æ€§èƒ½ã€‚ è¯¥ JEP ä¸ä¼šæå‡ºä»»ä½•æ–°çš„æ•°å­—åŸºæœ¬ç±»å‹ï¼Œä¹Ÿæ²¡æœ‰ä¸º Java çš„ä¸€å…ƒå’ŒäºŒå…ƒæ“ä½œç¬¦æå‡ºä»»ä½•æ–°åŠŸèƒ½ã€‚Â· ä¸Šè¿°ç¬¬ä¸‰ç‚¹ï¼Œç›®å‰åœ¨ Java ä¸­ä¸æ”¯æŒæ— ç¬¦å·æ•°å­—ï¼Œä¹Ÿä¸æ”¯æŒ 128 ä½æ•´æ•°ï¼Œä½†å¯ä»¥é¢„æœŸï¼Œæœªæ¥å¯ä»¥åŸºäºåŸå§‹å¯¹è±¡çš„æ–¹å¼æ¥æ”¯æŒã€‚ åŠ¨æœº MotivationJava æ˜¯é¢å‘å¯¹è±¡çš„è¯­è¨€ï¼Œä½†åŸºæœ¬å€¼ï¼ˆå¸ƒå°”ã€æ•´æ•°å’Œæµ®ç‚¹æ•°ï¼‰éƒ½ä¸æ˜¯å¯¹è±¡ã€‚åœ¨åˆ›å»ºè¯­è¨€æ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªæ˜æ™ºçš„è®¾è®¡é€‰æ‹©ï¼Œå› ä¸ºæ¯ä¸ªå¯¹è±¡éƒ½éœ€è¦é¢å¤–çš„å†…å­˜å¼€é”€å’Œé—´æ¥å¯»å€ã€‚ä½†ä¹Ÿæ„å‘³ç€åŸºæœ¬å€¼ä¸æ”¯æŒå¯¹è±¡çš„ä¸€äº›æœ‰ç”¨çš„ç‰¹æ€§ï¼Œä¾‹å¦‚å®ä¾‹æ–¹æ³•ã€å­ç±»å‹å’Œåæ¥çš„æ³›å‹ã€‚ ä½œä¸ºä¸€ç§è§£å†³æ–¹æ¡ˆï¼ŒåŸæ¥çš„æ ‡å‡†åº“æä¾›äº†åŒ…è£…ç±»ï¼Œæ¯ä¸ªç±»éƒ½å­˜å‚¨äº†ä¸€ä¸ªåŸºæœ¬å€¼ï¼Œå¹¶ä½œä¸ºå¯¹è±¡å‘ˆç°ã€‚Java 5 å¼•å…¥äº†éšå¼çš„è£…ç®±/æ‹†ç®±ï¼Œå¯ä»¥æ ¹æ®ç¨‹åºè¦æ±‚æŠŠåŸºæœ¬ç±»å‹çš„å€¼è½¬æ¢æˆåŒ…è£…ç±»çš„å®ä¾‹ï¼Œåä¹‹äº¦ç„¶ã€‚ ä½†åŒ…è£…ç±»è¿™æ ·çš„è§£å†³æ–¹æ¡ˆæ˜¯ä¸å®Œç¾çš„ï¼Œå®ƒå¹¶æ²¡æœ‰å®Œå…¨å±è”½è½¬æ¢çš„å½±å“ï¼ˆä¾‹å¦‚åŒä¸€ä¸ªå€¼è£…ç®±ä¸¤æ¬¡ï¼Œå¾—åˆ°çš„å¯¹è±¡å¯èƒ½å¹¶ä¸ ==ï¼‰ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œåœ¨è®¸å¤šåº”ç”¨ç¨‹åºä¸­ï¼Œå°†åŸºæœ¬å€¼åŒ…è£…åœ¨å¯¹è±¡ä¸­æœ‰æ˜æ˜¾çš„è¿è¡Œæ—¶æˆæœ¬ï¼Œå¼€å‘äººå‘˜å¿…é¡»æƒè¡¡è¿™äº›æˆæœ¬å’Œæ›´å¼ºå¤§çš„è¡¨è¾¾èƒ½åŠ›ã€‚ JEP 401 ä¸­ä»‹ç»äº†åŸå§‹å¯¹è±¡ï¼ˆPrimitive Objectsï¼‰çš„ç‰¹æ€§ï¼Œå°† Identity-free çš„å€¼è®¾è®¡ä¸ºåŸå§‹å¯¹è±¡ï¼Œèƒ½å¤Ÿæ¶ˆé™¤äº†å¤§éƒ¨åˆ†çš„é¢å¤–å¼€é”€ã€‚ä½œä¸ºç»“æœï¼Œç°åœ¨å¯ä»¥å°†åŸºæœ¬å€¼åœ¨æ‰€æœ‰çš„ä¸Šä¸‹æ–‡ä¸­éƒ½å½“ä½œç¬¬ä¸€ç­‰çš„å¯¹è±¡ã€‚æœ€åï¼Œæˆ‘ä»¬å¯ä»¥å®£ç§°æ‰€æœ‰çš„å€¼éƒ½æ˜¯å¯¹è±¡ã€‚ æ¯ä¸ªåŸå§‹å¯¹è±¡éœ€è¦ä¸€ä¸ªåŸå§‹ç±»ï¼Œé‚£ä¹ˆ int çš„å€¼åº”è¯¥æ˜¯å±äºå“ªä¸ªç±»ï¼Ÿå¤§éƒ¨åˆ†ç°æœ‰çš„ä»£ç ï¼Œéƒ½ä¼šå‡è®¾åŸºæœ¬å€¼ä½œä¸ºå¯¹è±¡ï¼Œåº”è¯¥å±äºåŒ…è£…ç±»ã€‚ç”±äºä¸å†éœ€è¦å¯¹åŸºæœ¬å€¼è¿›è¡ŒåŒ…è£…ï¼Œæœ€å°çš„æ”¹åŠ¨æ˜¯å°†åŒ…è£…ç±»æ”¹é€ ä¸ºåŸå§‹ç±»ï¼Œä¾‹å¦‚ int å€¼ä½œä¸º java.lang.Integer çš„å®ä¾‹ï¼Œboolean å€¼ä½œä¸º java.lang.Boolean çš„å®ä¾‹ç­‰ã€‚ é€šè¿‡å°†åŸºæœ¬ç±»å‹ä¿®æ”¹ä¸ºåŸå§‹ç±»ï¼Œæˆ‘ä»¬å¯ä»¥ç»™å®ƒä»¬å¢åŠ å®ä¾‹æ–¹æ³•ï¼Œå¹¶ä¸”é›†æˆåˆ°å­ç±»å‹å›¾ä¸­ï¼ˆclass subtyping graphï¼‰ã€‚æœªæ¥çš„ JEP å°†è¿½æ±‚åŸå§‹å€¼ç±»å‹å’Œ Java æ³›å‹çš„äº¤äº’ã€‚ æè¿° Descriptionä»¥ä¸‹æè¿°æ˜¯é¢„è§ˆä¸­çš„ç‰¹æ€§ï¼Œéœ€è¦åœ¨ç¼–è¯‘å’Œè¿è¡Œæ—¶å¢åŠ  --enable-preview å‚æ•°ã€‚ åŸºæœ¬åŸå§‹ç±» Basic Primitive Classes8 ä¸ªåŸºæœ¬åŸå§‹ç±»å¦‚ä¸‹ java.lang.Boolean java.lang.Character java.lang.Byte java.lang.Short java.lang.Integer java.lang.Long java.lang.Float java.lang.Double ç¼–è¯‘å™¨å’Œå¼•å¯¼ç±»åŠ è½½å™¨ä¼šé€šè¿‡ç‰¹æ®Šçš„æ–¹å¼å®šä½ç±»æ–‡ä»¶ï¼Œå¦‚æœå¼€å¯äº†é¢„è§ˆç‰¹æ€§ï¼Œä¼šå®šä½åˆ°ä¿®æ”¹ä¹‹åçš„ç±»ã€‚ ä¿®æ”¹ä¹‹åçš„åŸå§‹ç±»ï¼Œå®ƒä»¬æ˜¯å¼•ç”¨ä¼˜å…ˆï¼ˆReference-favoringï¼‰çš„ï¼Œæ„å‘³ç€ Integerã€Double ç­‰ç±»å‹åç»§ç»­æŒ‡å®ƒä»¬çš„å¼•ç”¨ç±»å‹ï¼ˆåŸå§‹å¼•ç”¨ç±»å‹ï¼‰ã€‚ è¿™äº›ç±»çš„å…¬å¼€æ„é€ å‡½æ•°ï¼Œåœ¨ JDK 16 ä¸­å·²ç»è¢« JEP 390 æ ‡è®°ä¸ºè®¡åˆ’ç§»é™¤ï¼ˆforRemovalï¼‰ã€‚æ¶‰åŠåˆ° Identity å’ŒåŸå§‹ç±»æ„é€ å‡½æ•°ç¼–è¯‘æ–¹å¼ä¸åŒï¼Œå¯èƒ½ä¼šäº§ç”Ÿå¾®å¦™çš„äºŒè¿›åˆ¶å…¼å®¹æ€§é—®é¢˜ã€‚ä¸ºäº†é¿å…è¯¥é—®é¢˜ï¼Œä¿®æ”¹åçš„ç±»çš„æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ã€‚ Java è¯­è¨€æ¨¡å‹ Java Language Model8 ä¸ªåŸºæœ¬ç±»å‹å…³é”®å­—ï¼ˆbooleanã€charã€byteã€shortã€intã€longã€float å’Œ doubleï¼‰å°†ä½œä¸ºåŸºæœ¬åŸå§‹ç±»å’Œå¯¹åº”åŸå§‹å€¼ç±»å‹çš„åˆ«åã€‚.ref è¯­æ³•è¢«ç”¨æ¥è¡¨ç¤ºå¯¹åº”çš„å¼•ç”¨ç±»å‹ã€‚ å› ä¸ºå®ƒä»¬æ˜¯åˆ«åï¼Œå› æ­¤æ¯ä¸ªåŸå§‹ç±»ã€åŸå§‹å€¼ç±»å‹ã€åŸå§‹å¼•ç”¨ç±»å‹éƒ½æœ‰ä¸¤ç§æ–¹æ³•è¡¨ç¤ºï¼Œè§å¦‚ä¸‹è¡¨æ ¼ï¼š åŸå§‹ç±» Primitive Class å€¼ç±»å‹ Value Type å¼•ç”¨ç±»å‹ Reference Type boolean / Boolean boolean / Boolean.val boolean.ref / Boolean char / Character char / Character.val char.ref / Character byte / Byte byte / Byte.val byte.ref / Byte short / Short short / Short.val short.ref / Short int / Integer int / Integer.val int.ref / Integer long / Long long / Long.val long.ref / Long float / Float float / Float.val float.ref / Float double / Double double / Double.val double.ref / Double ä»£ç é£æ ¼ä¸Šçš„é—®é¢˜ï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨å°å†™å­—æ¯ã€åŸºäºå…³é”®å­—çš„æ–¹å¼ã€‚ åŸå§‹ç±»å£°æ˜çš„é™åˆ¶åœ¨åŸºæœ¬åŸå§‹ç±»ä¸Šä¼šæœ‰ç‰¹ä¾‹ï¼šåŸºæœ¬åŸå§‹ç±»å¯ä»¥é€’å½’å£°æ˜è‡ªèº«åŸå§‹å€¼ç±»å‹çš„å­—æ®µï¼ˆä¾‹å¦‚ int ç±»å¯ä»¥åŒ…å« int ç±»å‹çš„å­—æ®µï¼‰ã€‚ Java æ”¯æŒåŸºæœ¬ç±»å‹ä¹‹é—´çš„è½¬æ¢ï¼ˆä¾‹å¦‚ int è½¬ doubleï¼‰ï¼Œè¿™äº›è¡Œä¸ºä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚ä¸ºæ¸…æ™°æœŸé—´ï¼Œæˆ‘ä»¬ç°åœ¨ç§°ä¹‹ä¸ºæ‰©å±•æ•°å­—è½¬æ¢ï¼ˆWidening Numeric Conversionsï¼‰å’Œæ”¶ç¼©æ•°å­—è½¬æ¢ï¼ˆNarrowing Numeric Conversionsï¼‰ã€‚å¼•ç”¨ç±»å‹ï¼ˆä¾‹å¦‚ int.ref å’Œ double.refï¼‰ä¹‹é—´æ˜¯æ²¡æœ‰ç±»ä¼¼çš„è½¬æ¢çš„ã€‚ è£…ç®±/æ‹†ç®±å°†ä¼šè¢«åŸå§‹ç±»çš„åŸå§‹å¼•ç”¨è½¬æ¢ï¼ˆPrimitive Reference Conversionsï¼‰å’ŒåŸå§‹å€¼è½¬æ¢ï¼ˆPrimitive Value Conversionsï¼‰æ›¿ä»£ã€‚æ”¯æŒçš„ç±»å‹æ˜¯ä¸€æ ·çš„ï¼Œä½†è¿è¡Œæ—¶çš„è¡Œä¸ºä¼šæ›´åŠ é«˜æ•ˆã€‚ Java æ”¯æŒä¸€ç³»åˆ—çš„ä¸€å…ƒå’ŒäºŒå…ƒæ“ä½œç¬¦æ¥æ“ä½œåŸºæœ¬å€¼ï¼ˆä¾‹å¦‚ 23 * 12ã€!trueï¼‰ï¼Œè¿™äº›æ“ä½œçš„è§„åˆ™å’Œè¡Œä¸ºä¸ä¼šå˜åŒ–ã€‚ å› ä¸ºåŸºæœ¬å€¼æ˜¯å¯¹è±¡ï¼Œå®ƒä»¬ç±»å®šä¹‰é‡Œé¢ä¹Ÿå¯ä»¥å®šä¹‰å®ä¾‹æ–¹æ³•ã€‚23.compareTo(42) è¿™æ ·çš„ä»£ç ç°åœ¨æ˜¯åˆæ³•çš„ã€‚ï¼ˆTODOï¼šè¿™æ˜¯å¦ä¼šå¯¼è‡´ä»»ä½•è¯­æ³•åˆ†æçš„é—®é¢˜ï¼Ÿequals å’Œ compareTo è¿™æ ·çš„è¡Œä¸ºæ˜¯å¦æœ‰æ„ä¹‰ï¼Ÿï¼‰ å’Œå…¶ä»–åŸå§‹å€¼ç±»å‹ä¸€æ ·ï¼ŒåŸºæœ¬åŸå§‹å€¼ç±»å‹çš„æ•°ç»„æ˜¯åå˜çš„ï¼šint[] å¯ä»¥è§†ä¸º int.ref[]ã€Number[] ç­‰ã€‚ ç¼–è¯‘æœŸå’Œè¿è¡Œæ—¶ Compilation and Run Timeåœ¨ JVM ä¸­ï¼ŒåŸºæœ¬ç±»å‹å’ŒåŸå§‹ç±»ç±»å‹æ˜¯ä¸åŒçš„ï¼šç±»å‹ D è¡¨ç¤º 64 ä½æµ®ç‚¹æ•°ï¼Œå ç”¨æ ˆä¸Šä¸¤ä¸ª slotï¼Œæ”¯æŒä¸€å¥—ä¸“æœ‰çš„æ“ä½œç  (dloadã€dstoreã€daddã€dcmpg ç­‰)ã€‚ç±»å‹ Qjava/lang/Double; è¡¨ç¤º Double çš„åŸå§‹å¯¹è±¡ï¼Œå ç”¨æ ˆä¸Šä¸€ä¸ª slotï¼Œæ”¯æŒå¯¹è±¡çš„æ“ä½œç  (aloadã€astoreã€invokevirtual ç­‰)ã€‚ Java ç¼–è¯‘å™¨æœ‰ä¹‰åŠ¡æ ¹æ®éœ€æ±‚é€‚é…ä¸¤ç§ç±»å‹ï¼Œé€šè¿‡è°ƒç”¨æ–¹æ³•ä¾‹å¦‚ Double.valueOf å’Œ Double.doubleValueã€‚ç¼–è¯‘åçš„å­—èŠ‚ç è·Ÿè£…ç®±/æ‹†ç®±ç”Ÿæˆçš„å­—èŠ‚ç ç±»ä¼¼ï¼Œä½†æ˜¯è¿è¡Œæ—¶å¼€é”€ä¼šå¤§å¹…å‡å°‘ã€‚ ä¸ºäº†ä¸€è‡´æ€§ï¼ŒåŸºæœ¬åŸå§‹å€¼ç±»å‹å‡ºç°åœ¨å­—æ®µç±»å‹å’Œæ–¹æ³•ç­¾åçš„æ—¶å€™ï¼Œæ°¸è¿œç¼–è¯‘æˆ JVM ä¸­çš„åŸºæœ¬ç±»å‹ï¼ˆD è€Œä¸æ˜¯ Qjava/lang/Double;ï¼‰ï¼Œé™¤äº†åŸºæœ¬åŸå§‹ç±»æœ¬èº«çš„å®šä¹‰ï¼ˆä¾‹å¦‚ Double.valueOf è¿”å›ç±»å‹ QDouble;ï¼‰ã€‚ ç¼–è¯‘å™¨çš„é€‚é…ï¼Œå¯¹äºåŸºæœ¬æ•°ç»„ç±»å‹æ¥è¯´æ˜¯ä¸å¤Ÿçš„ã€‚ä¾‹å¦‚é€šè¿‡ newarray åˆ›å»ºçš„ç±»å‹ä¸º [D çš„æ•°ç»„ï¼Œå¯ä»¥ä¼ é€’ç»™æœŸæœ›å‚æ•°ä¸º [Ljava/lang/Double; çš„æ–¹æ³•ã€‚åŒæ—¶é€šè¿‡ anewarray åˆ›å»ºçš„ç±»å‹ä¸º [Qjava/lang/Double; çš„æ•°ç»„ï¼Œå¯ä»¥è½¬æ¢ä¸º [Dã€‚ä¸ºäº†æ”¯æŒä¸Šè¿°è¡Œä¸ºï¼ŒJVM å°† [D å’Œ [Qjava/lang/Double; è§†ä¸ºå…¼å®¹çš„ç±»å‹ã€‚ä»–ä»¬çš„å€¼åŒæ—¶æ”¯æŒä¸¤å¥—æ“ä½œç ï¼ˆdaload å’Œ aaloadã€dastore å’Œ aastoreï¼‰ï¼Œæ— è®ºæ•°ç»„æ˜¯å¦‚ä½•åˆ›å»ºçš„ã€‚ï¼ˆTODOï¼šgetClass().getComponentType() å°†å¦‚ä½•è¿”å›ï¼‰ æ ¸å¿ƒåå°„ Core Reflectionæ¯ä¸€ä¸ªåŸºæœ¬åŸå§‹ç±»å‹ï¼Œå¼€å‘äººå‘˜é€šå¸¸ä¼šé‡åˆ°ä¸¤ä¸ª Class å¯¹è±¡ã€‚ä»¥ Double ç±»ä¸ºä¾‹ï¼Œæœ‰ï¼š double.classï¼ˆæˆ–ç­‰ä»·çš„ Double.val.classï¼‰å¯¹åº” JVM çš„æè¿°ç¬¦ç±»å‹ Dã€‚isPrimitive() æ–¹æ³•è¿”å› trueã€‚å½“å¼€å¯é¢„è§ˆç‰¹æ€§çš„æ—¶å€™ï¼Œä¸ºäº†è·Ÿ Java è¯­è¨€æ¨¡å‹å¯¹é½ï¼Œå¤§å¤šæ•°å…¶ä»–è¡Œä¸ºç±»ä¼¼äº java.lang.Doubleï¼ˆä¾‹å¦‚ isPrimitiveClassã€getMethodsã€getSuperclass ç­‰ï¼‰ã€‚ Double.classï¼ˆæˆ–ç­‰ä»·çš„ double.ref.classï¼‰å¯¹åº” JVM çš„æè¿°ç¬¦ç±»å‹ Ljava/lang/Double;ã€‚isPrimitive() è¿”å› falseã€‚è·Ÿè¡¨ç¤ºåŸå§‹å¼•ç”¨ç±»å‹çš„æ ‡å‡† Class å¯¹è±¡çš„è¡Œä¸ºæ˜¯ç±»ä¼¼çš„ã€‚ åŸºæœ¬åŸå§‹å¯¹è±¡ getClass() æ–¹æ³•è¿”å›ç¬¬äºŒç§ Class å¯¹è±¡ï¼ˆä¾‹å¦‚ Double.classã€Integer.class ç­‰ï¼‰ã€‚å¯¹æ‰€æœ‰çš„åŸå§‹å¯¹è±¡æ¥è¯´ï¼Œé€šè¿‡å€¼ç±»å‹ï¼ˆ(23.0).getClass()ï¼‰æˆ–è€…å¼•ç”¨ç±»å‹ï¼ˆ((Double)23.0).getClass()ï¼‰è¿”å›çš„éƒ½æ˜¯ä¸€æ ·çš„ã€‚è¿™è·Ÿä¼ ç»Ÿçš„è£…ç®±è¡Œä¸ºæ˜¯å…¼å®¹çš„ã€‚ (23.0).getClass() == Double.class è¿˜å­˜åœ¨ç¬¬ä¸‰ä¸ª Class å¯¹è±¡ï¼Œå¯¹åº” JVM çš„æè¿°ç¬¦ç±»å‹ Qjava/lang/Double;ï¼Œä½†åœ¨å®è·µä¸­å‡ ä¹ä¸ä¼šä½¿ç”¨ï¼Œå› ä¸º Java ç¼–è¯‘å™¨å‡ ä¹ä¸ä¼šç”¨è¯¥ç±»å‹æè¿°ç¬¦åç§°ã€‚ä¹Ÿæ²¡æœ‰ç±»åè¡¨ç¤ºè¿™äº›å¯¹è±¡ã€‚isPrimitive() è¿”å› falseã€‚è·Ÿè¡¨ç¤ºåŸå§‹å€¼ç±»å‹çš„æ ‡å‡† Class å¯¹è±¡çš„è¡Œä¸ºæ˜¯ç±»ä¼¼çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´åŸå§‹ç±» Person.class çš„æè¿°ç¬¦æ˜¯ QPoint;ï¼ŒPerson.ref.class çš„æè¿°ç¬¦æ˜¯ LPoint;ï¼ŒæŒ‰ç…§ç›¸åŒçš„é€»è¾‘æ¥è¯´ double.class çš„æè¿°ç¬¦æ˜¯ Qjava/lang/Double;ï¼Œdouble.ref.class çš„æè¿°ç¬¦æ˜¯ Ljava/lang/Double;ã€‚ä½† Java ç¼–è¯‘å™¨åœ¨é‡åˆ° double.class å’Œ Double.val.class æ—¶ä¸ºäº†å…¼å®¹éƒ½ä¼šç¼–è¯‘æˆ Dï¼Œç®—æ˜¯ä¸€ç§ç‰¹æ®Šçš„å¤„ç†ã€‚ å…¶ä»–é€‰æ‹© Alternativesè¯­è¨€å¯ä»¥ä¿æŒä¸å˜ï¼ˆåŸå§‹å¯¹è±¡æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„ç‰¹æ€§ï¼Œä½†æ— éœ€å°†åŸºæœ¬å€¼è§†ä¸ºå¯¹è±¡ï¼‰ã€‚ä½†æ˜¯æ¶ˆç­åŸºæœ¬ç±»å‹å’Œå¯¹è±¡ä¹‹é—´çš„éš”é˜‚ä¼šéå¸¸æœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯å½“ Java çš„æ³›å‹æ”¯æŒåŸå§‹å¯¹è±¡æ—¶ã€‚ æ–°ç±»å¯ä»¥ä½œä¸ºåŸºæœ¬åŸå§‹ç±»ï¼ˆä¾‹å¦‚ java.lang.intï¼‰å¼•å…¥ï¼Œè€Œå°†åŒ…è£…ç±»ä½œä¸ºé—ç•™ APIã€‚ ä½†æ˜¯å…³äºè£…ç®±è¡Œä¸ºçš„å‡è®¾åœ¨æŸäº›ä»£ç ä¸­æ ¹æ·±è’‚å›ºï¼Œè€Œä¸€ç»„æ–°çš„ç±»ä¼šç ´åè¿™äº›ç¨‹åºã€‚ JVM å¯ä»¥éµå¾ª Java è¯­è¨€å°†å…¶åŸºæœ¬ç±»å‹ï¼ˆIã€D ç­‰ï¼‰ä¸å…¶åŸå§‹ç±»ç±»å‹ï¼ˆQjava/lang/Integer;ã€Qjava/lang/Double; ç­‰ï¼‰å®Œå…¨ç»Ÿä¸€ã€‚ä½†è¿™å°†æ˜¯ä¸€ä¸ªä»£ä»·é«˜æ˜‚çš„æ”¹å˜ï¼Œæœ€ç»ˆæ”¶ç›Šç”šå¾®ã€‚ ä¾‹å¦‚ï¼Œå¿…é¡»æœ‰ä¸€ç§æ–¹æ³•æ¥åè°ƒä¸¤ä¸ª slot çš„ D ç±»å‹å’Œä¸€ä¸ª slot çš„ Qjava/lang/Double; ç±»å‹ï¼Œå¯èƒ½éœ€è¦å¯¹ç±»æ–‡ä»¶æ ¼å¼è¿›è¡Œç ´åæ€§çš„ç‰ˆæœ¬æ›´æ”¹ã€‚ é£é™©å’Œå‡è®¾ Risks and Assumptionsåˆ é™¤åŒ…è£…ç±»çš„æ„é€ å‡½æ•°ï¼Œç ´åäº†é—ç•™ Java ç¨‹åºçš„äºŒè¿›åˆ¶å…¼å®¹æ€§ã€‚è¿˜æœ‰ä¸è¿ç§»åˆ°åŸå§‹ç±»å‹ç›¸å…³çš„è¡Œä¸ºå˜åŒ–ã€‚JEP 390 ä»¥åŠä¸€äº›é¢„æœŸçš„åç»­å·¥ä½œå‡è½»äº†è¿™äº›è´Ÿæ‹…ã€‚ä½†ä¸€äº›è°ƒç”¨æ„é€ å‡½æ•°æˆ–è€…ä¾èµ–è£…ç®±å¯¹è±¡ Identity çš„ç¨‹åºä¼šå‘ç”Ÿé”™è¯¯ã€‚ ç”±äºæ–°çš„åŸºæœ¬åŸå§‹ç±»å‹å°†ä½œä¸ºç±»ç±»å‹ï¼Œåå°„è¡Œä¸ºçš„å˜åŒ–å¯èƒ½å¯¼è‡´æŸäº›ç¨‹åºå‡ºç°é—®é¢˜ã€‚å­˜åœ¨è¡¨ç¤º Qjava/lang/Double; ç±»å‹çš„ä¸åŒå¯¹è±¡ï¼Œå¾ˆå®¹æ˜“è¢«å¿½ç•¥å¹¶å¯èƒ½è®©ä¸€äº›å¼€å‘äººå‘˜æ„Ÿåˆ°æƒŠè®¶ã€‚ ä¾èµ– DependenciesJEP 401 åŸå§‹å¯¹è±¡æ˜¯å¿…å¤‡çš„æ¡ä»¶ã€‚è€ƒè™‘åˆ°è¯¥åŠŸèƒ½ï¼ŒJEP 390 å·²ç»å¯¹åŸå§‹ç±»çš„å€™é€‰è€…ä»¬å¯èƒ½äº§ç”Ÿçš„ä¸å…¼å®¹æ”¹åŠ¨ï¼Œå‘ javac å’Œ HotSpot å¢åŠ äº†è­¦å‘Šã€‚ä¸€äº›åç»­å·¥ä½œå°†åœ¨å…¶ä»–çš„ JEP ä¸­è¿›è¡Œã€‚æˆ‘ä»¬æœŸæœ›ä¿®æ”¹ Java ä¸­çš„æ³›å‹æ¨¡å‹ï¼Œä½¿ç±»å‹å‚æ•°æ›´åŠ é€šç”¨ï¼ˆå¯ä»¥è¢«æ‰€æœ‰çš„ç±»å®ä¾‹åŒ–ï¼ŒåŒ…æ‹¬å¼•ç”¨å’Œå€¼ï¼‰ã€‚è¿™ä¼šåœ¨å•ç‹¬çš„ JEP ä¸­è¿›è¡Œã€‚","link":"/2021/11/jep-402/"},{"title":"Valhalla (6): è§£è¯» JEP 401 Primitive Objects","text":"è§£è¯» JEP 401 Primitive Objects (Preview) ï¼ŒåŸå§‹å¯¹è±¡ã€‚ ä»¥ç›´è¯‘ä¸ºä¸»ï¼Œéƒ¨åˆ†å†…å®¹ä¼šæ„è¯‘ï¼Œä¸€äº›åœ°æ–¹ä¼šå¢åŠ è‡ªå·±çš„è§£è¯»ã€‚ä¸€äº›æ¦‚å¿µè§£é‡Šè§ æ·±å…¥ç†è§£ Valhalla (0): åºè¨€ã€‚ ç³»åˆ—æ–‡ç« ï¼ˆæœªå®Œå¾…ç»­ï¼‰ Valhalla (0): åºè¨€ Valhalla (1): èƒŒæ™¯ How We Got the Generics We Have Valhalla (2): ç°çŠ¶ The Road to Valhalla Valhalla (5): è§£è¯» JEP 390 Warnings for Value-Based Classes Valhalla (6): è§£è¯» JEP 401 Primitive Objects Valhalla (7): è§£è¯» JEP 402 Unify the Basic Primitives with Objects æ‘˜è¦ Summaryå¢å¼º Java å¯¹è±¡æ¨¡å‹ï¼Œå…è®¸å£°æ˜åŸå§‹ç±»ï¼ˆPrimitive Classï¼‰ï¼ŒåŸå§‹ç±»çš„å®ä¾‹ç§°ä¸ºåŸå§‹å¯¹è±¡ï¼ˆPrimitive Objectï¼‰ã€‚è¿™æ ·çš„å¯¹è±¡æ²¡æœ‰ Identityï¼Œå¯ä»¥ç›´æ¥å­˜å‚¨å’Œä¼ é€’ï¼Œæ— éœ€å¯¹è±¡å¤´å’Œé—´æ¥å¯»å€ã€‚è¯¥ææ¡ˆå°†ä¼šæ˜¯ä¸€é¡¹é¢„è§ˆç‰¹æ€§ã€‚ ç›®æ ‡ Goalsè¯¥ JEP ä¼šå¯¹ Java è¯­è¨€å’Œè™šæ‹Ÿæœºè¿›è¡Œé‡å¤§çš„æ”¹åŠ¨ï¼ŒåŒ…æ‹¬ï¼š å…è®¸å£°æ˜åŸå§‹ç±» åŸå§‹ç±»æ˜¯ Identity-free çš„ï¼ˆè§æ¦‚å¿µè§£é‡Šï¼‰ åŸå§‹ç±»çš„å®ä¾‹ç§°ä¸ºåŸå§‹å¯¹è±¡ æ˜ç¡®åŸå§‹å¯¹è±¡åœ¨æ¯”è¾ƒã€åŒæ­¥å’Œå…¶ä»–ä¾èµ– Identity çš„æ“ä½œæ—¶çš„è¡Œä¸ºï¼ˆIdentity-related Behaviorï¼‰ æä¾›æ— ç¼çš„è½¬æ¢æœºåˆ¶ï¼Œå…è®¸åŒæ—¶å¯¹åŸå§‹å€¼ç±»å‹ï¼ˆPrimitive Value Typeï¼‰å’ŒåŸå§‹å¼•ç”¨ç±»å‹ï¼ˆPrimitive Reference Typeï¼‰æ“ä½œ åŸå§‹å€¼ç±»å‹ä¸éœ€è¦é—´æ¥å¯»å€å°±å¯ä»¥å­˜å‚¨å’Œä¼ é€’ï¼ˆç±»ä¼¼äº intï¼‰ åŸå§‹å¼•ç”¨ç±»å‹ï¼ˆåœ¨å¤„ç†åŸå§‹å¯¹è±¡æ—¶ï¼‰å…è®¸å¤šæ€ï¼ˆpolymorphismï¼‰å’Œç©ºå¼•ç”¨ï¼ˆnull referencesï¼‰ï¼ˆç±»ä¼¼äº Integerï¼‰ æä¾›æ— ç¼çš„è½¬æ¢æœºåˆ¶ï¼ˆç±»ä¼¼äºè‡ªåŠ¨è£…ç®±/æ‹†ç®±ï¼‰ Codes like a class, works like an int éç›®æ ‡ Non-Goalsè¯¥ JEP åªå…³æ³¨åŸå§‹ç±»å’ŒåŸå§‹ç±»å‹çš„å£°æ˜ï¼Œä¸åŒ…å«å…¶ä»– Java è¯­è¨€çš„æ”¹è¿›ï¼Œä½†æœ‰ä¸€äº›ç‰¹æ€§ä¼šå¹¶è¡Œå¼€å‘ï¼š JEP 402 ç»Ÿä¸€åŸºæœ¬ç±»å‹å’Œå¯¹è±¡ åŸºæœ¬ç±»å‹ï¼ˆintã€boolean ç­‰ï¼‰çš„å€¼å°†ä¼šè¢«è§†ä¸ºåŸå§‹å¯¹è±¡ åŒ…è£…ç±»ï¼ˆIntegerã€Boolean ç­‰ï¼‰å°†ä¼šè¢«è§†ä¸ºåŸå§‹ç±» åŸºæœ¬ç±»å‹çš„å€¼æ˜¯åŒ…è£…ç±»çš„å®ä¾‹ï¼ˆä¾‹å¦‚ true instanceof Booleanï¼‰ ä¸€ä¸ªç‹¬ç«‹çš„ JEP å°†ä¿®æ”¹ Java çš„æ³›å‹æœºåˆ¶ï¼Œå…è®¸åŸå§‹å€¼ç±»å‹ä½œä¸ºç±»å‹å‚æ•° é™¤äº†ä¸Šè¿° JEPï¼Œåç»­ä¸€ä¸ªéå¸¸é‡è¦çš„æ”¹è¿›æ˜¯ JVM éœ€è¦æ ¹æ®ä¸åŒåŸå§‹å€¼ç±»å‹çš„å†…å­˜å¸ƒå±€ï¼ˆlayoutsï¼‰ç”Ÿæˆç‰¹åŒ–ï¼ˆspecializeï¼‰çš„æ³›å‹ç±»å’Œå­—èŠ‚ç ã€‚ åç»­è¿˜å¯èƒ½å¢å¼ºç°æœ‰çš„ API ä»¥ä¾¿æ›´å¥½çš„ä½¿ç”¨åŸå§‹å¯¹è±¡çš„ç‰¹æ€§ï¼Œæˆ–è€…å¼•å…¥æ„å»ºåœ¨åŸå§‹å¯¹è±¡ä¹‹ä¸Šçš„è¯­è¨€ç‰¹æ€§å’Œ APIã€‚ åŠ¨æœº MotivationJava ä¸­åŒ…å«ä¸¤ç§ç±»å‹çš„å€¼ï¼ŒåŸºæœ¬ç±»å‹ï¼ˆä¾‹å¦‚æ•°å­—å’Œå¸ƒå°”å€¼ï¼‰å’Œå¼•ç”¨ç±»å‹ã€‚ åŸºæœ¬ç±»å‹æä¾›æ›´é«˜çš„æ€§èƒ½ï¼Œå¯ä»¥ç›´æ¥ï¼ˆæ²¡æœ‰å¯¹è±¡å¤´å’ŒæŒ‡é’ˆï¼‰å­˜å‚¨åœ¨å˜é‡ã€æ ˆå’Œ CPU å¯„å­˜å™¨ä¸­ã€‚å› æ­¤è®¿é—®å†…å­˜ä¸éœ€è¦é¢å¤–çš„é—´æ¥å¯»å€ï¼ŒåŸºæœ¬ç±»å‹æ•°ç»„ä¹Ÿä¼šç´§å¯†ä¸”è¿ç»­åœ°å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚åŸºæœ¬ç±»å‹ä¹Ÿä¸éœ€è¦ GCï¼Œç›¸å…³æ“ä½œéƒ½ç›´æ¥åœ¨ CPU å†…éƒ¨å®Œæˆã€‚ å¼•ç”¨ç±»å‹æä¾›æ›´å¥½çš„æŠ½è±¡ï¼ŒåŒ…æ‹¬å­—æ®µã€æ–¹æ³•ã€è®¿é—®æ§åˆ¶ã€å®ä¾‹éªŒè¯ã€å‘½åç±»å‹å’Œå­ç±»å‹å¤šæ€ã€‚åŒæ—¶ä¹Ÿæ˜¯æœ‰ Identity çš„ï¼Œæ”¯æŒå­—æ®µä¿®æ”¹ã€åŠ é”ç­‰æ“ä½œã€‚ åœ¨æŸäº›é¢†åŸŸï¼Œå¼€å‘äººå‘˜éœ€è¦åŸºæœ¬ç±»å‹æä¾›çš„é«˜æ€§èƒ½ï¼Œä½†ä»£ä»·æ˜¯å¿…é¡»æ”¾å¼ƒé¢å‘å¯¹è±¡ä¸­ä¸€äº›æœ‰æ„ä¹‰çš„æŠ½è±¡ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´ä¸€äº› bugï¼Œä¾‹å¦‚é”™è¯¯çš„è§£é‡Šæ— ç±»å‹çš„æ•°å­—ï¼Œæˆ–è€…é”™è¯¯çš„å¤„ç†å¼‚æ„æ•°æ®çš„æ•°ç»„ï¼ˆç«æ˜Ÿæ°”å€™æ¢æµ‹è€…å·çš„å¤±è´¥æå¤§ç¨‹åº¦åœ°è¯´æ˜äº†æ­¤ç±» bug çš„æ½œåœ¨æˆæœ¬ï¼‰ã€‚ ç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ› JVM åœ¨è¿è¡Œé¢å‘å¯¹è±¡çš„ä»£ç æ—¶ï¼Œä¹Ÿèƒ½å¤Ÿç±»ä¼¼åŸºæœ¬ç±»å‹çš„æ€§èƒ½ã€‚ä¸å¹¸çš„æ˜¯ï¼Œå°½ç®¡å¾ˆå¤šå¯¹è±¡å¹¶ä¸éœ€è¦ï¼Œä½†å¯¹è±¡çš„ Identity æ˜¯è¿™ç±»æ€§èƒ½ä¼˜åŒ–çš„ä¸»è¦é˜»ç¢ã€‚åœ¨ä¸è€ƒè™‘ Identity çš„æƒ…å†µä¸‹ï¼ŒJVM å°±å¯ä»¥æŒ‰ç…§åŸºæœ¬ç±»å‹ä¸€æ ·å¤„ç†è¿™äº›å¯¹è±¡ï¼ˆç›´æ¥å­˜å‚¨åœ¨å˜é‡ä¸Šå’Œç›´æ¥åœ¨ CPU å†…æ“ä½œï¼‰ã€‚ å…·ä½“ä¸éœ€è¦ Identity å¹¶ä¸”å¯ä»¥æå‡æ€§èƒ½çš„ä¾‹å­ï¼š æ²¡æœ‰ä½œä¸ºåŸºæœ¬ç±»å‹çš„æ•°å­—ï¼Œä¾‹å¦‚æ— ç¬¦å·æ•°å­—ã€128 ä½æ•´æ•°å’ŒåŠç²¾åº¦æµ®ç‚¹æ•°ã€‚ ç‚¹ï¼ˆPointsï¼‰ã€å¤æ•°ã€é¢œè‰²ã€å‘é‡å’Œå…¶ä»–å¤šç»´æ•°å­—ï¼ˆçŸ©é˜µï¼‰ã€‚ å¸¦æœ‰å•ä½çš„æ•°å­—ï¼Œä¾‹å¦‚å¤§å°ã€å˜åŒ–ç‡ã€æ¸©åº¦ã€è´§å¸ç­‰ã€‚ æ—¥æœŸå’Œæ—¶é—´çš„æŠ½è±¡ï¼ŒåŒ…æ‹¬å¤§é‡ java.time åŒ…ä¸­çš„ç±»ã€‚ å…ƒç»„ï¼ˆTuplesï¼‰ã€è®°å½•ï¼ˆrecordï¼‰ã€Map ä¸­çš„ entriesã€æ•°æ®åº“è¡Œå’Œå¤šè¿”å›å€¼ã€‚ ä¸å¯å˜çš„ cursorsã€å­æ•°ç»„ã€ä¸­é—´æµï¼ˆintermediate streamsï¼‰å’Œå…¶ä»–æ•°æ®ç»“æ„è§†å›¾çš„æŠ½è±¡ã€‚ åŒæ ·æˆ‘ä»¬å¯ä»¥æœŸå¾…ï¼Œéšç€æ›´å¤šå¯¹åŸå§‹å¯¹è±¡çš„æ“ä½œçš„å®è·µï¼Œæ–°çš„ç¼–ç¨‹èŒƒå¼å’Œ API è®¾è®¡ä¹Ÿä¼šä¸æ–­å‘å±•ã€‚ æè¿° Descriptionä»¥ä¸‹æè¿°æ˜¯é¢„è§ˆä¸­çš„ç‰¹æ€§ï¼Œéœ€è¦åœ¨ç¼–è¯‘å’Œè¿è¡Œæ—¶å¢åŠ  --enable-preview å‚æ•° åŸå§‹å¯¹è±¡å’ŒåŸå§‹ç±» Primitive Objects and ClassesåŸå§‹å¯¹è±¡æ˜¯ä¸€ç§æ²¡æœ‰ Identity çš„ç±»çš„å®ä¾‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŸå§‹å¯¹è±¡æ²¡æœ‰å›ºå®šçš„å†…å­˜åœ°å€æˆ–è€…å…¶ä»–å±æ€§ï¼Œèƒ½å¤Ÿåœ¨æ‰€æœ‰å­—æ®µå€¼ç›¸åŒçš„æƒ…å†µä¸‹åŒºåˆ†ä¸åŒçš„å®ä¾‹ã€‚åŸå§‹å¯¹è±¡å­—æ®µå€¼æ˜¯ä¸èƒ½ä¿®æ”¹çš„ï¼Œä¹Ÿä¸èƒ½è¿›è¡ŒåŒæ­¥æ“ä½œï¼ˆsynchronizedï¼‰ã€‚åœ¨åŸå§‹å¯¹è±¡æ‰§è¡Œ == æ“ä½œæ˜¯æ¯”è¾ƒæ‰€æœ‰å­—æ®µçš„å€¼ã€‚å®ä¾‹ä¸ºåŸå§‹å¯¹è±¡çš„ç±»è¢«ç§°ä¸ºåŸå§‹ç±»ã€‚ Identity å¯¹è±¡æ˜¯æœ‰ identity çš„ç±»çš„å®ä¾‹æˆ–è€…æ•°ç»„ï¼Œæœ‰ä¼ ç»Ÿ Java ä¸­å¯¹è±¡çš„è¡Œä¸ºï¼ŒIdentity å¯¹è±¡å¯ä»¥ä¿®æ”¹é final çš„å­—æ®µå€¼ï¼Œå¹¶ä¸”å¯ä»¥å…³è”åŒæ­¥ç›‘è§†å™¨ï¼ˆæ‰§è¡Œ synchronizedï¼‰ã€‚åœ¨ Identity å¯¹è±¡æ‰§è¡Œ == æ“ä½œæ˜¯æ¯”è¾ƒå®ƒä»¬çš„ Identityï¼ˆå¼•ç”¨ï¼‰ã€‚å®ä¾‹ä¸º Identity å¯¹è±¡çš„ç±»è¢«ç§°ä¸º Identity ç±»ã€‚ åŸå§‹ç±»å£°æ˜ Primitive Class Declarationsç±»å¯ä»¥é€šè¿‡ primitive ä¸Šä¸‹æ–‡å…³é”®å­—å£°æ˜ä¸ºåŸå§‹ç±»ï¼Œè¿™æ ·çš„ç±»ä¼šéšå¼å£°æ˜ä¸º final çš„å¹¶ä¸”ä¸èƒ½æ˜¯ abstract çš„ã€‚é™¤äº†åŸå§‹ç±»å’ŒæŠ½è±¡ç±»ä¹‹å¤–çš„ç±»å°±æ˜¯ Identity ç±»ã€‚ä¾‹å¦‚ 123456789101112131415161718192021222324primitive class Point implements Shape { private double x; private double y; public Point(double x, double y) { this.x = x; this.y = y; } public double x() { return x; } public double y() { return y; } public Point translate(double dx, double dy) { return new Point(x+dx, y+dy); } public boolean contains(Point p) { return equals(p); }}interface Shape { boolean contains(Point p);} åŸå§‹ç±»å£°æ˜å—åˆ°å¦‚ä¸‹çš„é™åˆ¶ï¼ˆè¦åŒºåˆ†å®ä¾‹å­—æ®µ/é™æ€å­—æ®µï¼‰ï¼š æ‰€æœ‰çš„å®ä¾‹å­—æ®µéƒ½è¢«éšå¼å£°æ˜ä¸º final çš„ï¼Œåªèƒ½åœ¨æ„é€ å‡½æ•°ã€åˆå§‹å€¼ã€åˆå§‹åŒ–ä»£ç å—ä¸­è¢«èµ‹å€¼ä¸€æ¬¡ æ‰€æœ‰çš„å®ä¾‹å­—æ®µéƒ½ä¸èƒ½æ˜¯ç›´æ¥æˆ–é—´æ¥ä¾èµ–å½“å‰ç±»çš„åŸå§‹å€¼ç±»å‹ï¼ˆå®šä¹‰è§åæ–‡ï¼‰ã€‚æ¢å¥è¯è¯´ï¼Œé™¤äº†å¼•ç”¨ç±»å‹çš„å­—æ®µï¼Œç±»çš„å¸ƒå±€å¿…é¡»æ˜¯æ‰å¹³çš„ï¼ˆflatï¼‰ã€å›ºå®šå¤§å°ã€æ²¡æœ‰å¾ªç¯ä¾èµ–çš„ ç®€å•æ¥è¯´ï¼Œå°±æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œéœ€è¦èƒ½å¤Ÿè®¡ç®—å‡ºå¯¹è±¡çš„å†…å­˜å¸ƒå±€ ä¸èƒ½ç›´æ¥æˆ–é—´æ¥å®ç° IdentityObject æ¥å£ï¼ˆè§ä¸‹æ–‡ï¼‰ï¼Œè¿™æ„å‘³ç€çˆ¶ç±»ï¼ˆä»¬ï¼‰åªèƒ½æ˜¯ Object æˆ–è€…æ— çŠ¶æ€çš„æŠ½è±¡ç±» æ„é€ å‡½æ•°ä¸èƒ½è°ƒç”¨ super çš„æ„é€ å‡½æ•°ã€‚å®ä¾‹çš„åˆ›å»ºä¸èƒ½æ‰§è¡Œä»»ä½•çˆ¶ç±»çš„åˆå§‹åŒ–ä»£ç ã€‚ æ‰€æœ‰çš„å®ä¾‹æ–¹æ³•éƒ½ä¸èƒ½å£°æ˜ synchronized ï¼ˆå¯èƒ½ï¼‰ä¸èƒ½å®ç° Cloneable æ¥å£æˆ–è€…å£°æ˜ clone() æ–¹æ³• ï¼ˆå¯èƒ½ï¼‰ä¸èƒ½å£°æ˜ finalize() æ–¹æ³• ï¼ˆå¯èƒ½ï¼‰åœ¨æ‰€æœ‰å­—æ®µéƒ½åˆå§‹åŒ–ä¹‹å‰æ˜¯ä¸èƒ½ä½¿ç”¨ this çš„ï¼ˆé™¤äº†é€šè¿‡ this è®¾ç½®å˜é‡ï¼‰ å…¶ä»–å¤§å¤šæ•°çš„å£°æ˜ï¼ŒåŸå§‹ç±»å’Œ Identity ç±»çš„å£°æ˜æ–¹å¼æ˜¯ä¸€æ ·çš„ã€‚å¯ä»¥å®ç°å¤šä¸ªæ¥å£ã€æ”¯æŒç±»å‹å‚æ•°ã€å†…éƒ¨ç±»ã€é‡è½½æ„é€ å‡½æ•°ã€é™æ€æˆå‘˜å’Œæ‰€æœ‰çš„è®¿é—®æ§åˆ¶ä¿®é¥°ç¬¦ã€‚ åŸå§‹å¯¹è±¡ä½¿ç”¨ Working with Primitive ObjectsåŸå§‹å¯¹è±¡åˆ›å»ºæ–¹å¼å°±æ˜¯æ™®é€šçš„å®ä¾‹åˆ›å»ºè¡¨è¾¾å¼ã€‚ 1Point p1 = new Point(1.0, -0.5); åŸå§‹ç±»å®ä¾‹å­—æ®µå’Œæ–¹æ³•è®¿é—®æ–¹å¼ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚ 1Point p2 = p1.translate(p1.y(), 0.0); åŸå§‹ç±»å¯ä»¥è®¿é—®çˆ¶ç±»æˆ–æ¥å£ä¸­çš„æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥è¦†ç›–å®ƒä»¬ã€‚å®ä¾‹å¯ä»¥èµ‹å€¼ç»™çˆ¶ç±»æˆ–æ¥å£ç±»å‹ã€‚ 123System.out.println(p2.toString());Shape s = p2;assert !s.contains(p1); ä¸Šé¢å‡ ä¸ªæ“ä½œæ²¡ä»€ä¹ˆåŒºåˆ« == æ“ä½œå°†æ¯”è¾ƒä¸¤ä¸ªåŸå§‹å¯¹è±¡çš„å­—æ®µå€¼ï¼Œè€Œä¸æ˜¯å¯¹è±¡çš„ Identityã€‚åŸºæœ¬ç±»å‹å­—æ®µä¼šæŒ‰ä½æ¯”è¾ƒï¼Œå…¶ä»–çš„å­—æ®µä¼šé€’å½’é€šè¿‡ == æ¯”è¾ƒã€‚ 12assert new Point(1.0, -0.5) == p1;assert p1.translate(0.0, 0.0) == p1; equalsã€hashCode å’Œ toStringï¼ŒåŒ…æ‹¬ System.identityHashCode åœ¨ç›¸ç­‰çš„è¡Œä¸ºå®šä¹‰ä¸Šæ˜¯ä¸€è‡´çš„ã€‚ 12345Point p3 = p1.translate(0.0, 0.0);assert p1.equals(p3);assert p1.hashCode() == p3.hashCode();assert System.identityHashCode(p1) == System.identityHashCode(p3);assert p1.toString().equals(p3.toString()); åœ¨åŸå§‹å¯¹è±¡ä¸Šè¿›è¡ŒåŒæ­¥ synchronized ä¼šæŠ›å¼‚å¸¸ã€‚ 123Object obj = p1;try { synchronized (obj) { assert false; } }catch (RuntimeException e) { /* expected exception */ } ä¸¤ä¸ªæ¥å£ The PrimitiveObject and IdentityObject Interfacesæ–°å¢äº†ä¸¤ä¸ªå¿…è¦çš„æ¥å£ java.lang.PrimitiveObject java.lang.IdentityObject æ‰€æœ‰çš„åŸå§‹ç±»éƒ½éšå¼å®ç°äº† PrimitiveObject æ¥å£ï¼Œæ‰€æœ‰çš„ Identity ç±»éƒ½éšå¼å®ç°äº† IdentityObject æ¥å£ï¼ŒåŒ…æ‹¬ä¹‹å‰ Java ç”Ÿæ€ä¸­æ‰€æœ‰çš„ç±»ï¼Œæ•°ç»„ä»ç„¶æ˜¯ IdentityObject çš„å­ç±»å‹ã€‚ è¿™äº›æ¥å£é€šè¿‡å¦‚ä¸‹ä¸‰ç§æ–¹å¼å¸®åŠ©åŒºåˆ† Identity å¯¹è±¡å’ŒåŸå§‹å¯¹è±¡ instanceof IdentityObject / instanceof PrimitiveObject å¯ä»¥åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æœ‰ Identityï¼Œä½¿ç”¨ Class çš„åå°„æ–¹æ³•ä¹Ÿæ˜¯ä¸€æ ·çš„ IdentityObject / PrimitiveObject ç±»å‹çš„å˜é‡å¯ä»¥åˆ†åˆ«ä¿å­˜æœ‰/æ²¡æœ‰ Identity çš„å¯¹è±¡ extends IdentityObject / extends PrimitiveObject çš„ç±»å‹å˜é‡ä¸Šç•Œå¯ä»¥è¦æ±‚ç±»å‹å˜é‡åˆ†åˆ«æœ‰/æ²¡æœ‰ Identity æ¥å£å¯ä»¥æ˜¾å¼çš„ç»§æ‰¿ IdentityObject æˆ–è€… PrimitiveObject ä»¥ä¾¿è¦æ±‚æ‰€æœ‰çš„å®ç°ç±»æœ‰/æ²¡æœ‰ Identityï¼Œå¦‚æœä¸€ä¸ªç±»æœ€ç»ˆæ˜¾å¼ã€éšå¼æˆ–è€…é€šè¿‡ç»§æ‰¿ï¼ŒåŒæ—¶å®ç°äº†ä¸¤ä¸ªæ¥å£ï¼Œé‚£ä¹ˆå°±ä¼šå‘ç”Ÿé”™è¯¯ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæ¥å£æ˜¯ä¸ç»§æ‰¿ä»»ä½•ä¸€ä¸ªçš„ä¸Šè¿°æ¥å£çš„ï¼Œå¯ä»¥åŒæ—¶è¢«ä¸¤ç§å…·ä½“çš„ç±»å®ç°ã€‚ ç±»ä¼¼çš„ï¼ŒæŠ½è±¡ç±»ä¹Ÿå¯ä»¥æ˜¾å¼å®ç° IdentityObject æˆ–è€… PrimitiveObject ï¼Œä½†å¦‚æœå£°æ˜äº†å­—æ®µã€åˆå§‹å€¼ã€åˆå§‹åŒ–ä»£ç å—ã€éç©ºæ„é€ å‡½æ•°æˆ–åŒæ­¥æ–¹æ³•ï¼ˆsynchronizedï¼‰ï¼Œå°±ç›¸å½“äºéšå¼å®ç°äº† IdentityObject æ¥å£ï¼ˆå¯èƒ½ä¼šæœ‰è­¦å‘Šä¿¡æ¯ï¼‰ã€‚å¦åˆ™ä¸€ä¸ªæŠ½è±¡ç±»ä¸å®ç°ä»»ä½•ä¸€ä¸ªå°šä¹¦æ¥å£ï¼Œå¯ä»¥åŒæ—¶è¢«ä¸¤ç§å…·ä½“çš„ç±»ç»§æ‰¿ã€‚ java.lang.Object ä¸å®ç°ä»»ä½•ä¸€ä¸ªæ¥å£ï¼Œç›¸å½“äºï¼ˆå¯èƒ½ä¼šè¢«æ˜¾å¼æŒ‡å®šï¼‰æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå¦‚ä¸Šæ‰€è¿°ï¼Œå…·ä½“çš„å­ç±»å¯ä»¥å®ç°ä»»ä½•ä¸€ä¸ªæ¥å£ã€‚åœ¨è°ƒç”¨ new Object() å°†ä¼šè¢«é‡æ–°è§£é‡Šä¸ºåˆå§‹åŒ–ä¸€ä¸ª Identity çš„ Object çš„å­ç±»å‹ï¼ˆåå­—å¾…å®šï¼‰ã€‚ å¦‚æœæœ€ç»ˆé‡‡ç”¨è¿™ä¸ªæ–¹æ¡ˆï¼Œé‚£ä¹ˆæ„å‘³ç€ java.lang.Object å˜æˆä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä½†åŒæ—¶å¯ä»¥è°ƒç”¨ new Object()ï¼Œè€Œä¸” new Object().getClass() != Object.classï¼ˆå¯èƒ½ï¼‰ã€‚æ„å‘³ç€ä¼šå†…ç½®ä¸€ä¸ªç±» class NameTBD implements IdentityObject {}new Object() ä¼šè¢«é‡æ–°è§£é‡Šä¸º new NameTBD()å› ä¸ºéœ€è¦å…¼å®¹ï¼Œè¿™ä¸ªåº”è¯¥ä¼šå‘ç”Ÿåœ¨è¿è¡Œæ—¶ã€‚ åŸå§‹å€¼å’Œå¼•ç”¨ Primitive Values and ReferencesåŸå§‹å¯¹è±¡å¯ä»¥ä½œä¸ºåŸå§‹å€¼ï¼ˆPrimitive Valuesï¼‰å­˜å‚¨åœ¨å˜é‡ä¸­ã€è¿›è¡Œç›´æ¥è®¿é—®ã€æ— éœ€å¯¹è±¡å¤´å’ŒæŒ‡é’ˆï¼Œè¿™äº›å€¼çš„ç±»å‹ç§°ä¸ºåŸå§‹å€¼ç±»å‹ï¼ˆPrimitive Value Typeï¼‰ã€‚ åŸå§‹å¯¹è±¡ä¹Ÿå¯ä»¥åƒå¼•ç”¨ç±»å‹ä¸€æ ·å­˜å‚¨å’Œæ“ä½œï¼Œè¿™äº›å¼•ç”¨çš„ç±»å‹ç§°ä¸ºåŸå§‹å¼•ç”¨ç±»å‹ï¼ˆPrimitive Reference Typeï¼‰ã€‚ å› æ­¤æ¯ä¸€ä¸ªåŸå§‹ç±»å…³è”ä¸¤ä¸ªç±»å‹ï¼ŒåŸå§‹å€¼ç±»å‹å’ŒåŸå§‹å¼•ç”¨ç±»å‹ã€‚åŸå§‹ç±»çš„å®ä¾‹å¯ä»¥ç›´æ¥æˆ–è€…é—´æ¥é€šè¿‡å¼•ç”¨å¤„ç†ï¼Œè¿™å–å†³äºä½¿ç”¨çš„ç±»å‹ã€‚ åŸå§‹å€¼ç±»å‹ Primitive Value TypesåŸå§‹ç±»çš„ç±»åè¡¨ç¤ºè¿™ä¸ªç±»çš„åŸå§‹å€¼ç±»å‹ï¼ˆå¯ä»¥å£°æ˜ reference-favoring ç±»ï¼Œè¿™æ ·ç±»åè¡¨ç¤ºå¼•ç”¨ç±»å‹ï¼Œè§ä¸‹æ–‡è®¨è®ºï¼‰ã€‚è·Ÿä¼ ç»Ÿçš„ç±»å‹ä¸åŒï¼ŒåŸå§‹å€¼ç±»å‹ä¸æ˜¯å¯¹è±¡çš„å¼•ç”¨ï¼Œè€Œæ˜¯å¯¹è±¡æœ¬èº«ã€‚å› æ­¤æœ‰ä¸¤ä¸ªé‡è¦çš„ç»“æœ åŸå§‹å€¼ç±»å‹çš„å˜é‡å¯ä»¥ç›´æ¥å­˜å‚¨å¯¹è±¡çš„å­—æ®µå€¼ï¼Œä¸éœ€è¦å¯¹è±¡å¤´æˆ–è€…æŒ‡é’ˆ åŸå§‹å€¼ç±»å‹çš„å˜é‡ä¸èƒ½ä¸º null Codes like a class, works like an int åŸå§‹å€¼ç±»å‹æ˜¯å•æ€ï¼ˆmonomorphicï¼‰çš„ï¼Œæ‰€æœ‰è¯¥ç±»å‹çš„å€¼éƒ½æ˜¯åŒä¸€ä¸ªç±»çš„å®ä¾‹ï¼Œå¹¶ä¸”æœ‰ç›¸åŒçš„å¸ƒå±€ã€‚ å¦‚æœ Point æ˜¯åŸå§‹ç±»ï¼Œé‚£ä¹ˆPoint point = ...;Points points = [...];ä¸ç®¡ä¸¤ä¸ªå˜é‡æ€ä¹ˆèµ‹å€¼ï¼Œå› ä¸ºæ˜¯å•æ€çš„ï¼Œæ‰€ä»¥ä¸€å®šæœ‰point.getClass() == points[0].getClass() == Point.classä¸çŸ¥é“é€šè¿‡åå°„æ„é€  Object å¯¹è±¡ä¼šæ€ä¹ˆæ · åŸå§‹ç±»çš„åˆ›å»ºè¡¨è¾¾å¼ï¼ˆnewï¼‰çš„ç±»å‹æ˜¯åŸå§‹å€¼ç±»å‹ï¼Œç±»ä¸­çš„ this è¡¨è¾¾å¼çš„ç±»å‹ä¹Ÿæ˜¯åŸå§‹å€¼ç±»å‹ã€‚å¦‚ä¸Šæ‰€ç¤ºï¼ŒåŸå§‹å€¼ç±»å‹å…è®¸è®¿é—®å­—æ®µå’Œæ–¹æ³•ï¼Œä¹Ÿæ”¯æŒé€šè¿‡ == å’Œ !== æ“ä½œæ¥æ¯”è¾ƒä¸¤ä¸ªåŒç±»å‹çš„å€¼ã€‚åŸå§‹å€¼ç±»å‹çš„è¡¨è¾¾å¼æ˜¯ä¸èƒ½ç”¨åœ¨åŒæ­¥ï¼ˆsynchronizedï¼‰è¯­å¥ä¸­çš„ã€‚ åŸå§‹ç±»å‹ï¼ˆintã€booleanã€double ç­‰ï¼‰è¢«è®¤è¯†ä¸€ç§ä¸åŒçš„ç±»å‹ï¼Œä¸å—è¯¥ JEP çš„å½±å“ã€‚ åŸå§‹å€¼ç±»å‹çš„é»˜è®¤å€¼ Default Values of Primitive Value Typesæ¯ä¸ªåŸå§‹å€¼ç±»å‹éƒ½æœ‰ä¸€ä¸ªé»˜è®¤å€¼ï¼Œç”¨äºåˆå§‹åŒ–å­—æ®µå’Œæ•°ç»„çš„å…ƒç´ ã€‚å¼•ç”¨ç±»å‹çš„å­—æ®µé»˜è®¤å€¼æ˜¯ nullï¼Œå…¶ä»–ç±»å‹å­—æ®µçš„é»˜è®¤å€¼æ˜¯ 0 æˆ–è€… false æˆ–è€…é»˜è®¤å€¼ã€‚é»˜è®¤å€¼æ˜¯è¯¥ç±»çš„é»˜è®¤å®ä¾‹ï¼ˆdefault å®ä¾‹ï¼‰ï¼Œæ‰€æœ‰å­—æ®µå€¼éƒ½æ˜¯å…¶ç±»å‹çš„é»˜è®¤å€¼ã€‚Point.default è¡¨è¾¾å¼ç”¨æ¥æŒ‡ä»£åŸå§‹ç±» Point çš„é»˜è®¤å®ä¾‹ã€‚ 123assert new Point(0.0, 0.0) == Point.default;Point[] ps = new Point[100];assert ps[33] == Point.default; æ³¨æ„é»˜è®¤å®ä¾‹çš„åˆ›å»ºï¼Œä¸éœ€è¦è°ƒç”¨ä»»ä½•æ„é€ å‡½æ•°ã€æ‰§è¡Œåˆå§‹åŒ–èµ‹å€¼å’Œåˆå§‹åŒ–ä»£ç å—ã€‚èƒ½è®¿é—®è¯¥ç±»ï¼Œå°±å¯ä»¥è®¿é—®é»˜è®¤å®ä¾‹ï¼ˆé™¤äº† Enforcing å®ä¾‹éªŒè¯ï¼Œè§ä¸‹æ–‡ï¼‰ã€‚åŸå§‹ç±»ä¹Ÿä¸èƒ½è‡ªè¡Œå®šä¹‰é»˜è®¤å®ä¾‹ï¼Œä¿®æ”¹å…¶å­—æ®µçš„é»˜è®¤å€¼ã€‚ å¼•ç”¨ç±»å‹ Reference Typeä¹‹å‰å¼•ç”¨ç±»å‹çš„å˜é‡ä¿å­˜å¯¹è±¡çš„å¼•ç”¨æˆ–è€…ä¸º nullï¼Œä½†ç°åœ¨å¼•ç”¨çš„å¯¹è±¡å¯ä»¥æ˜¯ Identity å¯¹è±¡æˆ–è€…åŸå§‹å¯¹è±¡ã€‚ åŸå§‹å¼•ç”¨ç±»å‹ç”¨ ç±»å.ref æ¥è¡¨ç¤ºï¼Œå˜é‡å¯ä»¥ä¿å­˜è¯¥ç±»å¯¹è±¡çš„å¼•ç”¨æˆ–è€…ä¸º nullã€‚åŸå§‹å¼•ç”¨ç±»å‹æ˜¯æ‰€æœ‰è¯¥ç±»çˆ¶ç±»å‹çš„å­ç±»å‹ã€‚ 123Point pi; // stores a Point object åŸå§‹å€¼ç±»å‹Point.ref pr; // stores a reference to a Point åŸå§‹å¼•ç”¨ç±»å‹Shape s; // stores a reference to a Shape, which may be a Point å¼•ç”¨ç±»å‹ï¼Œå¯èƒ½æ˜¯ Point åœ¨ä½¿ç”¨åŸå§‹å¯¹è±¡çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¸éœ€è¦æ˜¾å¼æŒ‡å®šåŸå§‹å¼•ç”¨ç±»å‹ï¼ˆä¾‹å¦‚ Point.refï¼‰ï¼Œä½†è¿™æ˜¯å¯¹è±¡æ¨¡å‹éå¸¸é‡è¦çš„éƒ¨åˆ†ï¼ŒJava çš„å¼€å‘è€…åº”è¯¥éœ€è¦ç†è§£ã€‚ ä¸€ä¸ªç±»çš„åŸå§‹å¼•ç”¨ç±»å‹ï¼Œå’ŒåŸå§‹å€¼ç±»å‹æ‹¥æœ‰ç›¸åŒçš„æˆå‘˜ï¼Œæ”¯æŒåº”ç”¨ç±»å‹çš„å¸¸è§„æ“ä½œã€‚ç‰¹åˆ«çš„ï¼Œåœ¨è¿è¡Œæ—¶ == å’Œ Object ä¸­çš„æ–¹æ³•ï¼Œåœ¨å¤„ç†åŸå§‹å¯¹è±¡æ“ä½œæ—¶æ˜¯ç›¸åŒçš„ï¼Œä¸ç®¡æ˜¯å½“ä½œå€¼è¿˜æ˜¯å¼•ç”¨ã€‚ åœ¨ä»»ä½• PrimitiveObject å®ä¾‹ä¸Šæ‰§è¡ŒåŒæ­¥ï¼ˆsynchronizedï¼‰æ“ä½œä¼šå‘ç”Ÿé”™è¯¯ï¼ŒåŒ…æ‹¬åŸå§‹å¼•ç”¨ç±»å‹ã€‚ è·Ÿè£…ç®±ç±»ä¼¼ï¼ŒåŸå§‹å€¼ç±»å‹å¯ä»¥éšå¼è½¬æ¢å¼•ç”¨ç±»å‹ï¼Œç§°ä¸ºåŸå§‹å¼•ç”¨è½¬æ¢ï¼ˆprimitive reference conversionsï¼‰ã€‚ä½†åŸå§‹å¼•ç”¨è½¬æ¢æ˜¯éå¸¸è½»é‡çº§çš„ï¼Œä¸ä¼šäº§ç”Ÿæ–°çš„ Identityã€‚ 123Point p1 = new Point(3.0, -2.1);Point.ref[] prs = new Point.ref[1];prs[0] = p1; // convert Point to Point.ref éšå¼è½¬æ¢ è·Ÿæ‹†ç®±ç±»ä¼¼ï¼ŒåŸå§‹å¼•ç”¨ç±»å‹å¯ä»¥éšå¼è½¬æ¢ä¸ºå€¼ç±»å‹ï¼Œç§°ä¸ºåŸå§‹å€¼è½¬æ¢ï¼ˆprimitive value conversionï¼‰ã€‚å¦‚æœå¼•ç”¨ä¸º nullï¼Œè½¬æ¢ä¼šæŠ›å‡º NullPointerExceptionã€‚ 123Point p2 = prs[0]; // Convert Point.ref to Pointprs[0] = null;p2 = prs[0]; // NullPointerException å¼‚å¸¸ åœ¨æ–¹æ³•è°ƒç”¨çš„æ—¶å€™ï¼Œä¸ºäº†è·Ÿæ–¹æ³•çš„å‚æ•°ç±»å‹å®šä¹‰åŒ¹é…ï¼Œä¹Ÿä¼šå‘ç”Ÿéšå¼ç±»å‹è½¬æ¢ã€‚ 123p1.toString(); // Convert Point to ObjectShape s = p1;s.contains(p1); // Convert Shape to Point ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨ä½¿ç”¨åŸå§‹ç±»å‹çš„æ—¶å€™ï¼Œéƒ½å¯ä»¥ç®€å•çš„ä½¿ç”¨å€¼ç±»å‹ã€‚ä¸è¿‡åœ¨ä¸‹åˆ—åœºæ™¯ä¸­ï¼Œå¼•ç”¨ç±»å‹ä¼šå¾ˆæœ‰å¸®åŠ© å½“éœ€è¦å­ç±»å‹å¤šæ€æ—¶ï¼ˆpolymorphismï¼‰ï¼Œä¾‹å¦‚åŸå§‹å¯¹è±¡éœ€è¦ä½œä¸ºæ¥å£çš„å®ä¾‹ å½“éœ€è¦ç©ºå€¼ null æ—¶ï¼Œä¾‹å¦‚æŸäº›ç®—æ³•éœ€è¦ä¸€ä¸ªå“¨å…µ å½“éœ€è¦é€šè¿‡é—´æ¥å¯»å€çš„å¼•ç”¨ï¼Œæ‰“ç ´åŸå§‹ç±»å­—æ®µä¹‹é—´çš„å¾ªç¯å¼•ç”¨ï¼ˆæ ¹æ®ä¸Šæ–‡æè¿°çš„å£°æ˜çš„é™åˆ¶ï¼‰ å½“ä½¿ç”¨å¼•ç”¨æœ‰æ›´é«˜çš„æ€§èƒ½æ—¶ï¼ˆè§ä¸‹æ–‡è®¨è®ºï¼‰ ç›®å‰ Java çš„æ³›å‹åªé€‚ç”¨äºå¼•ç”¨ç±»å‹ï¼Œåç»­çš„ JEP ä¼šæ”¹è¿›æ³›å‹æœºåˆ¶ï¼Œå¯ä»¥åŒæ—¶é€‚ç”¨äºå€¼ç±»å‹ã€‚ é‡è½½è§£æå’Œå‚æ•°ç±»å‹è§£æ Overload Resolution and Type Argument InferenceåŸå§‹å¼•ç”¨/å€¼è½¬æ¢åªèƒ½å‘ç”Ÿåœ¨å®½æ¾çš„ã€éä¸¥æ ¼çš„è°ƒç”¨ä¸Šä¸‹æ–‡ï¼Œè¿™è·Ÿè£…ç®±/æ‹†ç®±çš„æ¨¡å¼æ˜¯ä¸€è‡´çš„ï¼šä¸éœ€è¦è½¬æ¢å°±å¯ä»¥é€‚ç”¨çš„æ–¹æ³•ä¼˜å…ˆçº§é«˜äºéœ€è¦è½¬æ¢çš„ã€‚ 1234567void m(Point p, int i) { ... }void m(Point.ref pr, Integer i) { ... }void test(Point.ref pr, Integer i) { m(pr, i); // prefers the second declaration ä½¿ç”¨ç¬¬äºŒä¸ªæ–¹æ³• m(pr, 0); // ambiguous ä¸¤ä¸ªæ–¹æ³•éƒ½éœ€è¦è½¬æ¢ï¼Œå› æ­¤æ˜¯æœ‰æ­§ä¹‰çš„} å‚æ•°ç±»å‹æ¨æ–­åœ¨å¤„ç†åŸå§‹å¼•ç”¨/å€¼è½¬æ¢æ—¶ï¼Œè¿˜æ˜¯è·Ÿè£…ç®±/æ‹†ç®±ä¸€è‡´çš„ã€‚åœ¨éœ€è¦æ¨æ–­çš„æ—¶å€™ï¼ŒåŸå§‹å€¼ä¼šè¢«æ¨æ–­ä¸ºå¼•ç”¨ç±»å‹ã€‚ 12var list = List.of(new Point(1.0, 5.0));// infers List&lt;Point.ref&gt; é»˜è®¤æ¨æ–­ä¸ºå¼•ç”¨ç±»å‹ ï¼ˆåœ¨æœªæ¥çš„ JEP ä¸­ï¼Œå°†ä¼šè¢«å…è®¸æ¨æ–­ä¸ºå€¼ç±»å‹ï¼‰ æ•°ç»„å­ç±»å‹ Array SubtypingåŸå§‹ç±»å®ä¾‹çš„æ•°ç»„æ˜¯åå˜çš„ï¼Œå³ Point[] æ˜¯ Point.ref[] çš„å­ç±»å‹ï¼ŒPoint.ref[] åˆæ˜¯ Object[] çš„å­ç±»å‹ã€‚ ç›®å‰çš„åŸºæœ¬ç±»å‹æ•°ç»„ï¼ˆint[]ã€double[] ç­‰ï¼‰æ˜¯ä¸å˜çš„ï¼ˆä¸æ”¯æŒåï¼‰ ä¸€ä¸ªé™æ€ç±»å‹ä¸º Object[] è¿è¡Œæ—¶å…ƒç´ ç±»å‹ä¸º Point çš„æ•°ç»„ä¸­ï¼Œå‚¨å­˜ä¸€ä¸ªå¼•ç”¨æ—¶ï¼Œä¼šæ‰§è¡Œæ•°ç»„å­˜å‚¨æ£€æŸ¥ï¼ˆæ£€æŸ¥å¼•ç”¨æ˜¯æŒ‡å‘ Point ç±»çš„å®ä¾‹ï¼‰ï¼Œå¹¶ä¸”æ‰§è¡ŒåŸå§‹å€¼è½¬æ¢ï¼ˆæŠŠå¼•ç”¨è½¬æ¢ä¸ºåŸå§‹å€¼ï¼‰ã€‚åŒæ ·çš„ï¼Œä»é™æ€ç±»å‹ä¸º Object[] æ•°ç»„ä¸­è¯»å–å…ƒç´ ï¼Œå¦‚æœå€¼ä¸ºåŸå§‹å€¼ï¼Œä¼šå‘ç”ŸåŸå§‹å¼•ç”¨è½¬æ¢ã€‚ 123456789Object replace(Object[] objs, int i, Object val) { Object result = objs[i]; // may perform reference conversion å¯èƒ½å‘ç”Ÿå¼•ç”¨è½¬æ¢ objs[i] = val; // may perform value conversion å¯èƒ½å‘ç”Ÿå€¼è½¬æ¢ return result;}Point[] ps = new Point[]{ new Point(3.0, -2.1) };replace(ps, 0, new Point(-2.1, 3.0));replace(ps, 0, null); // NullPointerException from value conversion æœ‰ç‚¹ç±»ä¼¼äº Integer[] ä¿å­˜/è¯»å– int æ—¶çš„è¡Œä¸ºï¼Œç”¨ç°æœ‰ Java æ¥è¯´æ˜çš„è¯ 12345678910Integer replace(Integer[] objs, int i, Integer val) { Integer result = objs[i]; // å¯èƒ½å‘ç”Ÿå¼•ç”¨è½¬æ¢ objs[i] = val; // å¯èƒ½å‘ç”Ÿå€¼è½¬æ¢ return result;}int[] ps = new int[]{ 2, 3 };// æ³¨æ„ç›®å‰ç‰ˆæœ¬ä¸å…è®¸ï¼ŒåŸºæœ¬ç±»å‹æ•°ç»„æ˜¯ä¸å˜çš„ï¼Œint[] ä¸æ˜¯ Integer[] çš„å­ç±»å‹replace(ps, 0, Integer.valueOf(2));replace(ps, 0, null); // NullPointerException from value conversion å¼•ç”¨ä¼˜å…ˆçš„åŸå§‹ç±»å’Œè¿ç§» Reference-Favoring Primitive Classes and Migrationæœ‰ä¸€äº›ç±»æ˜¯å¯ä»¥è¢«å£°æ˜ä¸ºåŸå§‹ç±»çš„ï¼ˆä¸å¯å˜ï¼Œä¹Ÿä¸éœ€è¦ Identityï¼‰ï¼Œä½†ä½¿ç”¨è€…æ›´å¸Œæœ›è·Ÿä¹‹å‰ä¸€æ ·ä½¿ç”¨å¼•ç”¨ç±»å‹ï¼Œå°¤å…¶æ˜¯å¯ä»¥ä¸ºç©º nullã€‚ä¸»è¦çš„åœºæ™¯æ˜¯å¸Œæœ›å£°æ˜ä¸€ä¸ªç±»æ˜¯ Identity ç±»ï¼Œä½†å¯ä»¥å…¼å®¹çš„é‡æ„ä¸ºåŸå§‹ç±»ã€‚ï¼ˆæ ‡å‡†åº“ä¸­æœ‰å¾ˆå¤šç±»å·²ç»è¢«è®¾è®¡ä¸ºåŸºäºå€¼çš„ç±»ï¼ŒæœŸæœ›å¯ä»¥è¿ç§»æˆåŸå§‹ç±»ã€‚ï¼‰åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€ä¸ªç±»å¯ä»¥è¢«å£°æ˜ä¸ºåŸå§‹ç±»ï¼Œä½†ä½¿ç”¨ç‰¹æ®Šçš„åç§°ï¼ˆè¯­æ³•å¯èƒ½ä¼šå˜åŒ–ï¼‰ 123primitive class Time.val { ...} è¿™ç§è¯­æ³•çš„ç±»å‹ Time.val æ˜¯åŸå§‹å€¼ç±»å‹ï¼ŒåŒæ—¶ Time è¡¨ç¤ºå¯¹åº”çš„åŸå§‹å¼•ç”¨ç±»å‹ã€‚ 12Time[] trefs = new Time[]{ new Time(...) };Time.val t = trefs[0]; // primitive value conversion æ€»ç»“ä¸€ä¸‹ç±»åå’Œç±»å‹çš„å…³ç³» åŸå§‹ç±» ç±»å‹ ç±»å å€¼ç±»å‹ å¼•ç”¨ç±»å‹ æ ‡å‡† Foo Foo Foo.ref å¼•ç”¨ä¼˜å…ˆ reference-favoring Bar Bar.val Bar ï¼ˆæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ˜¯å¦å…è®¸åœ¨æ ‡å‡†çš„å€¼ç±»å‹ååé¢å†—ä½™ .val ï¼Œæˆ–è€… reference-favoring çš„å¼•ç”¨ç±»å‹ååé¢å†—ä½™ .refï¼‰é™¤äº†åœ¨æ ¹æ®ç±»åè§£æç±»å‹ä¹‹å¤–ï¼Œreference-favoring åŸå§‹ç±»è·Ÿæ ‡å‡†çš„åŸå§‹ç±»æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚ å¯ä»¥ç†è§£ä¸ºï¼Œä¸ºäº†å…¼å®¹ä¹‹å‰çš„ä»£ç ï¼Œå¼•å…¥äº†è¿™ä¸ªæ–°çš„æ¦‚å¿µï¼Œä¾‹å¦‚ä¹‹å Integer è¿˜æ˜¯å¼•ç”¨ç±»å‹ï¼Œå¯ä»¥ä¸ºç©ºã€‚å¦åˆ™è¿ç§»ä¼šå˜çš„éå¸¸éº»çƒ¦ã€‚ ä¸ºäº†èƒ½å¤ŸæŠŠå·²æœ‰çš„ Identity ç±»è¿ç§»ä¸ºåŸå§‹ç±»ï¼Œå¼€å‘è€…éœ€è¦æ³¨æ„ï¼Œå³ä½¿å·²ç»é‡æ„æˆ reference-favoringï¼Œä½¿ç”¨è€…ä»ç„¶ä¼šèƒ½æ„ŸçŸ¥åˆ°ä¸€äº›å·®å¼‚ è°ƒç”¨äº†éå…¬å¼€æ„é€ æ–¹æ³•çš„ä»£ç ä¼šå¯¼è‡´é“¾æ¥é”™è¯¯ï¼ˆlinkage errorï¼‰ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘ï¼ˆè§åæ–‡è®¨è®ºï¼‰ ä»¥å‰è®¤ä¸º != çš„ä¸¤ä¸ªå®ä¾‹ï¼Œæœ‰å¯èƒ½ä¼šå˜æˆ == ç›¸ç­‰çš„ æ‰§è¡ŒåŒæ­¥ï¼ˆsynchronizedï¼‰ä¼šå¤±è´¥ æœªå®Œå¾…ç»­","link":"/2021/10/jep-401/"}],"tags":[{"name":"hexo","slug":"hexo","link":"/tags/hexo/"},{"name":"icarus","slug":"icarus","link":"/tags/icarus/"},{"name":"linux","slug":"linux","link":"/tags/linux/"},{"name":"ubuntu","slug":"ubuntu","link":"/tags/ubuntu/"},{"name":"python","slug":"python","link":"/tags/python/"},{"name":"matplotlib","slug":"matplotlib","link":"/tags/matplotlib/"},{"name":"java","slug":"java","link":"/tags/java/"},{"name":"quine","slug":"quine","link":"/tags/quine/"},{"name":"jvm","slug":"jvm","link":"/tags/jvm/"},{"name":"classloader","slug":"classloader","link":"/tags/classloader/"}],"categories":[{"name":"hexo","slug":"hexo","link":"/categories/hexo/"},{"name":"linux","slug":"linux","link":"/categories/linux/"},{"name":"python","slug":"python","link":"/categories/python/"},{"name":"icarus","slug":"hexo/icarus","link":"/categories/hexo/icarus/"},{"name":"java","slug":"java","link":"/categories/java/"},{"name":"ubuntu","slug":"linux/ubuntu","link":"/categories/linux/ubuntu/"},{"name":"matplotlib","slug":"python/matplotlib","link":"/categories/python/matplotlib/"}]}