<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Java 进阶 — 类加载机制 - Alpha Lxy</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Alpha Lxy"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Alpha Lxy"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="类加载机制是 Java 技术体系中非常核心的部分，负责把 class 文件加载到 JVM。  类加载器可以说是 Java 语言的一项创新，它是早期 Java 语言能够快速流行的重要原因之一。类加载器最初是为了满足 Java Applet 的需求而设计出来的，在今天用在浏览器上的 Java Applet 技术基本上已经被淘汰，但类加载器却在类层次划分、OSGi、程序热部署、代码加密等领域大放异彩，成"><meta property="og:type" content="blog"><meta property="og:title" content="Java 进阶 — 类加载机制"><meta property="og:url" content="https://www.alphalxy.com/2021/09/java-classloader/"><meta property="og:site_name" content="Alpha Lxy"><meta property="og:description" content="类加载机制是 Java 技术体系中非常核心的部分，负责把 class 文件加载到 JVM。  类加载器可以说是 Java 语言的一项创新，它是早期 Java 语言能够快速流行的重要原因之一。类加载器最初是为了满足 Java Applet 的需求而设计出来的，在今天用在浏览器上的 Java Applet 技术基本上已经被淘汰，但类加载器却在类层次划分、OSGi、程序热部署、代码加密等领域大放异彩，成"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://www.alphalxy.com/img/2021/java-classloader-00.png"><meta property="og:image" content="https://www.alphalxy.com/img/2021/java-classloader-01.png"><meta property="og:image" content="https://www.alphalxy.com/img/2021/java-classloader-02.png"><meta property="og:image" content="https://www.alphalxy.com/img/2021/java-classloader-03.png"><meta property="og:image" content="https://www.alphalxy.com/img/2021/java-classloader-04.png"><meta property="og:image" content="https://www.alphalxy.com/img/2021/java-classloader-05.png"><meta property="og:image" content="https://www.alphalxy.com/img/2021/java-classloader-06.png"><meta property="og:image" content="https://www.alphalxy.com/img/2021/java-classloader-07.png"><meta property="og:image" content="https://www.alphalxy.com/img/2021/java-classloader-08.png"><meta property="og:image" content="https://www.alphalxy.com/img/2021/java-classloader-10.jpg"><meta property="og:image" content="https://www.alphalxy.com/img/2021/java-classloader-09.png"><meta property="og:image" content="https://www.alphalxy.com/img/2021/java-classloader-11.png"><meta property="article:published_time" content="2021-09-06T05:01:03.000Z"><meta property="article:modified_time" content="2022-05-09T07:09:02.148Z"><meta property="article:author" content="Xinyu Liu"><meta property="article:tag" content="java"><meta property="article:tag" content="jvm"><meta property="article:tag" content="classloader"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/2021/java-classloader-00.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alphalxy.com/2021/09/java-classloader/"},"headline":"Java 进阶 — 类加载机制","image":["https://www.alphalxy.com/img/2021/java-classloader-00.png","https://www.alphalxy.com/img/2021/java-classloader-01.png","https://www.alphalxy.com/img/2021/java-classloader-02.png","https://www.alphalxy.com/img/2021/java-classloader-03.png","https://www.alphalxy.com/img/2021/java-classloader-04.png","https://www.alphalxy.com/img/2021/java-classloader-05.png","https://www.alphalxy.com/img/2021/java-classloader-06.png","https://www.alphalxy.com/img/2021/java-classloader-07.png","https://www.alphalxy.com/img/2021/java-classloader-08.png","https://www.alphalxy.com/img/2021/java-classloader-10.jpg","https://www.alphalxy.com/img/2021/java-classloader-09.png","https://www.alphalxy.com/img/2021/java-classloader-11.png"],"datePublished":"2021-09-06T05:01:03.000Z","dateModified":"2022-05-09T07:09:02.148Z","author":{"@type":"Person","name":"Xinyu Liu"},"publisher":{"@type":"Organization","name":"Alpha Lxy","logo":{"@type":"ImageObject","url":"https://www.alphalxy.com/img/logo.svg"}},"description":"类加载机制是 Java 技术体系中非常核心的部分，负责把 class 文件加载到 JVM。  类加载器可以说是 Java 语言的一项创新，它是早期 Java 语言能够快速流行的重要原因之一。类加载器最初是为了满足 Java Applet 的需求而设计出来的，在今天用在浏览器上的 Java Applet 技术基本上已经被淘汰，但类加载器却在类层次划分、OSGi、程序热部署、代码加密等领域大放异彩，成"}</script><link rel="canonical" href="https://www.alphalxy.com/2021/09/java-classloader/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.15.2/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/github-gist.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?104eebd0d22643395068945f4cf0d478";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/cookieconsent/3.1.1/cookieconsent.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-C1W0LERLL1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-C1W0LERLL1');</script><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Alpha Lxy" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives/">Archives</a><a class="navbar-item" href="/categories/">Categories</a><a class="navbar-item" href="/tags/">Tags</a><a class="navbar-item" href="/about/">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="AlphaLxy GitHub" href="https://www.github.com/AlphaLxy"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal"><i class="fas fa-angle-double-right"></i>Java 进阶 — 类加载机制</h1><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><i class="far fa-calendar-alt"> </i><time dateTime="2021-09-06T05:01:03.000Z" title="2021-09-06T05:01:03.000Z">2021-09-06</time></span><span class="level-item is-hidden-mobile"><i class="far fa-calendar-check"> </i><time dateTime="2022-05-09T07:09:02.148Z" title="2022-05-09T07:09:02.148Z">2022-05-09</time></span><span class="level-item"><i class="far fa-folder-open has-text-grey"></i> <a class="link-muted" href="/categories/java/">java</a></span><span class="level-item"><i class="far fa-clock"></i> an hour read (About 8203 words)</span><span class="level-item" id="busuanzi_container_page_pv"><i class="far fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv">0</span>&nbsp;visits</span></div></div><div class="content"><p>类加载机制是 Java 技术体系中非常核心的部分，负责把 <code>class</code> 文件加载到 JVM。</p>
<blockquote>
<p>类加载器可以说是 Java 语言的一项创新，它是早期 Java 语言能够快速流行的重要原因之一。类加载器最初是为了满足 Java Applet 的需求而设计出来的，在今天用在浏览器上的 Java Applet 技术基本上已经被淘汰，但类加载器却在类层次划分、OSGi、程序热部署、代码加密等领域大放异彩，成为 Java 技术体系中一块重要的基石，可谓是失之桑榆，收之东隅。</p>
<p align="right">——《深入理解 Java 虚拟机》</p>
</blockquote>
<a id="more"></a>

<p>开始之前先抛出五个问题，看看能否给出准确的回答</p>
<ol>
<li>如何启动一个 Java 应用？JVM 启动的时候是如何查找类的？</li>
<li>是先有的 Class 还是先有的 ClassLoader？JVM 启动的时候是如何处理 ClassLoader 的？</li>
<li>ClassLoader 的层次结构是什么样的？双亲委派模型是什么？contextClassLoader 是什么？</li>
<li>类加载过程中会遇到哪些错误 Error 或者异常 Exception？NoClassDefFoundError 和 ClassNotFoundException 区别是什么？</li>
<li>什么情况下需要自定义 ClassLoader？如何自定义 ClassLoader？</li>
</ol>
<h2 id="Java-应用启动"><a href="#Java-应用启动" class="headerlink" title="Java 应用启动"></a>Java 应用启动</h2><p>无论是通过什么脚本启动还是在 IDE 里面直接执行，最终都是通过执行 <code>java</code> 命令。</p>
<p>IDEA 启动应用的第一行日志</p>
<p><img src="/img/2021/java-classloader-00.png"></p>
<p><code>mvn</code> 命令，其实是个脚本</p>
<figure class="highlight bash"><figcaption><span>apache-maven-3.6.3/bin/mvn</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Provide a &quot;standardized&quot; way to retrieve the CLI args that will</span></span><br><span class="line"><span class="comment"># work with both Windows and non-Windows executions.</span></span><br><span class="line">MAVEN_CMD_LINE_ARGS=<span class="string">&quot;<span class="variable">$MAVEN_CONFIG</span> <span class="variable">$@</span>&quot;</span></span><br><span class="line"><span class="built_in">export</span> MAVEN_CMD_LINE_ARGS</span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> <span class="string">&quot;<span class="variable">$JAVACMD</span>&quot;</span> \</span><br><span class="line">  <span class="variable">$MAVEN_OPTS</span> \</span><br><span class="line">  <span class="variable">$MAVEN_DEBUG_OPTS</span> \</span><br><span class="line">  -classpath <span class="string">&quot;<span class="variable">$&#123;CLASSWORLDS_JAR&#125;</span>&quot;</span> \</span><br><span class="line">  <span class="string">&quot;-Dclassworlds.conf=<span class="variable">$&#123;MAVEN_HOME&#125;</span>/bin/m2.conf&quot;</span> \</span><br><span class="line">  <span class="string">&quot;-Dmaven.home=<span class="variable">$&#123;MAVEN_HOME&#125;</span>&quot;</span> \</span><br><span class="line">  <span class="string">&quot;-Dlibrary.jansi.path=<span class="variable">$&#123;MAVEN_HOME&#125;</span>/lib/jansi-native&quot;</span> \</span><br><span class="line">  <span class="string">&quot;-Dmaven.multiModuleProjectDirectory=<span class="variable">$&#123;MAVEN_PROJECTBASEDIR&#125;</span>&quot;</span> \</span><br><span class="line">  <span class="variable">$&#123;CLASSWORLDS_LAUNCHER&#125;</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>来看一下 <code>java</code> 命令的帮助</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> java -<span class="built_in">help</span></span></span><br><span class="line">Usage: java [-options] class [args...]</span><br><span class="line">           (to execute a class)</span><br><span class="line">   or  java [-options] -jar jarfile [args...]</span><br><span class="line">           (to execute a jar file)</span><br></pre></td></tr></table></figure>

<p>文档中对于 Java 启动时类查找的说明 <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/findingclasses.html">https://docs.oracle.com/javase/8/docs/technotes/tools/findingclasses.html</a></p>
<blockquote>
<p><strong>How the Java Launcher Finds Classes</strong></p>
<p>The Java launcher, <strong>java</strong>, initiates the Java virtual machine. The virtual machine searches for and loads classes in this order:</p>
<ul>
<li><strong>Bootstrap classes</strong> - Classes that comprise the Java platform, including the classes in rt.jar and several other important jar files.</li>
<li><strong>Extension classes</strong> - Classes that use the Java Extension mechanism. These are bundled as .jar files located in the extensions directory.</li>
<li><strong>User classes</strong> - Classes defined by developers and third parties that do not take advantage of the extension mechanism.</li>
</ul>
</blockquote>
<style>
    div.inline-code-gray code  {
        color: steelblue !important
    }
</style>

<div class="inline-code-gray">

<blockquote>
<p><strong>How the Java Launcher Finds User Classes</strong></p>
<p>User classes are classes which build on the Java platform. To find user classes, the launcher refers to the user class path – a list of directories, JAR archives, and ZIP archives which contain class files.<br>A class file has a subpath name that reflects the class’s fully-qualified name. For example, if the class <code>com.mypackage.MyClass</code> is stored under <code>/myclasses</code>, then <code>/myclasses</code> must be in the user class path and the full path to the class file must be <code>/myclasses/com/mypackage/MyClass.class</code>. If the class is stored in an archive named <code>myclasses.jar</code>, then <code>myclasses.jar</code> must be in the user class path, and the class file must be stored in the archive as <code>com/mypackage/MyClass.class</code>.<br>The user class path is specified as a string, with a colon (:) separating the class path entries on Solaris, and a semi-colon (;) separating entries on Microsoft Windows systems. The <strong>java</strong> launcher puts the user class path string in the java.class.path system property. The possible sources of this value are:</p>
<ul>
<li>The default value, “.”, meaning that user class files are all the class files in the current directory (or under it, if in a package).</li>
<li>The value of the <strong>CLASSPATH</strong> environment variable, which overrides the default value.</li>
<li>The value of the <strong>-cp</strong> or <strong>-classpath</strong> command line option, which overrides both the default value and the <strong>CLASSPATH</strong> value.</li>
<li>The JAR archive specified by the <strong>-jar</strong> option, which overrides all other values. If this option is used, all user classes must come from the specified archive.</li>
</ul>
</blockquote>
</div>

<h3 id="IDE-和-maven"><a href="#IDE-和-maven" class="headerlink" title="IDE 和 maven"></a>IDE 和 maven</h3><p>IDE 会通过 maven 插件，解析项目模块，计算 classpath，最终通过 <code>-classpath</code> 影响启动，所以修改依赖的时候需要重新加载项目。</p>
<p><img src="/img/2021/java-classloader-01.png"></p>
<h3 id="IDE-多模块的-classpath"><a href="#IDE-多模块的-classpath" class="headerlink" title="IDE 多模块的 classpath"></a>IDE 多模块的 classpath</h3><p>每个模块的 classpath 是独立计算的，在不同模块启动 main 方法的的时候 <code>-classpath</code> 参数是不同的，例如有两个模块 <code>A</code> <code>B</code>，<code>A</code> 依赖 <code>B</code> 和第三方 <code>C.jar</code> , <code>B</code> 依赖第三方 <code>D.jar</code></p>
<div class="highlight-tree">
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">A</span><br><span class="line">├── C.jar</span><br><span class="line">└── B</span><br><span class="line">    └──D.jar</span><br></pre></td></tr></table></figure>
</div>

<p>最终启动 A 中的 main 方法（会指向对应模块的 target/classes 目录）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -classpath <span class="variable">$&#123;项目&#125;</span>/A/target/classes:<span class="variable">$&#123;项目&#125;</span>/B/target/classes:<span class="variable">$&#123;仓库&#125;</span>/C.jar:<span class="variable">$&#123;仓库&#125;</span>/D.jar ...</span><br></pre></td></tr></table></figure>

<p>如果是启动 B 中的 main 方法（此时是找不到 A 中定义类的）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -classpath <span class="variable">$&#123;项目&#125;</span>/B/target/classes:<span class="variable">$&#123;仓库&#125;</span>/D.jar ...</span><br></pre></td></tr></table></figure>

<h3 id="Spring-包扫描与-classpath-的关系"><a href="#Spring-包扫描与-classpath-的关系" class="headerlink" title="Spring 包扫描与 classpath 的关系"></a>Spring 包扫描与 classpath 的关系</h3><p>Spring 只能扫描类加载能加载到的类，可以简单认为就是只能加载 classpath 下的类。</p>
<h2 id="Object-Class-ClassLoader-java-lang"><a href="#Object-Class-ClassLoader-java-lang" class="headerlink" title="Object Class ClassLoader (java.lang.*)"></a>Object Class ClassLoader (java.lang.*)</h2><p>任何对象都是一个类的实例，那么 <code>java.lang.String.class</code> 是一个对象吗？（<code>java.lang.Class</code> extend <code>java.lang.Object</code>）</p>
<p><img src="/img/2021/java-classloader-02.png"></p>
<p>Class 实例是通过 ClassLoader 的实例加载的，但 ClassLoader 实例本身也是一个对象，所以也会有 Class，下面这几个值是什么关系？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Class.class</span><br><span class="line">ClassLoader.class</span><br><span class="line">Class.class.getClassLoader()</span><br><span class="line">ClassLoader.class.getClassLoader()</span><br></pre></td></tr></table></figure>

<h3 id="从-JDK-源码看类的加载"><a href="#从-JDK-源码看类的加载" class="headerlink" title="从 JDK 源码看类的加载"></a>从 JDK 源码看类的加载</h3><p><code>SystemDictionary</code> 管理了所有加载的类</p>
<figure class="highlight c++"><figcaption><span>hotspot/src/share/vm/classfile/systemDictionary.hpp</span><a target="_blank" rel="noopener" href="https://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/classfile/systemDictionary.hpp">systemDictionary.hpp</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SystemDictionary</span> :</span> AllStatic &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Hashtable holding loaded classes.</span></span><br><span class="line">    <span class="keyword">static</span> Dictionary* _dictionary;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而 <code>Dictionary</code> 就是一个 Hashtable</p>
<figure class="highlight c++"><figcaption><span>hotspot/src/share/vm/classfile/dictionary.hpp</span><a target="_blank" rel="noopener" href="https://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/classfile/dictionary.hpp">dictionary.hpp</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dictionary</span> :</span> <span class="keyword">public</span> TwoOopHashtable&lt;Klass*, mtClass&gt; &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再来看下 <code>Klass</code></p>
<figure class="highlight c++"><figcaption><span>hotspot/src/share/vm/oops/klass.hpp</span><a target="_blank" rel="noopener" href="https://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/oops/klass.hpp">klass.hpp</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// A Klass provides:</span></span><br><span class="line"><span class="comment">//  1: language level class object (method dictionary etc.)</span></span><br><span class="line"><span class="comment">//  2: provide vm dispatch behavior for the object</span></span><br><span class="line"><span class="comment">// Both functions are combined into one C++ class.</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Klass</span> :</span> <span class="keyword">public</span> Metadata &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>hotspot/src/share/vm/oops/instanceKlass.hpp</span><a target="_blank" rel="noopener" href="https://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/oops/instanceKlass.hpp">instanceKlass.hpp</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// An InstanceKlass is the VM level representation of a Java class.</span></span><br><span class="line"><span class="comment">// It contains all information needed for at class at execution runtime.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  InstanceKlass layout:</span></span><br><span class="line"><span class="comment">//    [C++ vtbl pointer           ] Klass</span></span><br><span class="line"><span class="comment">//    [subtype cache              ] Klass</span></span><br><span class="line"><span class="comment">//    [instance size              ] Klass</span></span><br><span class="line"><span class="comment">//    [java mirror                ] Klass</span></span><br><span class="line"><span class="comment">//    [super                      ] Klass</span></span><br><span class="line"><span class="comment">//    [access_flags               ] Klass</span></span><br><span class="line"><span class="comment">//    [name                       ] Klass</span></span><br><span class="line"><span class="comment">//    [first subklass             ] Klass</span></span><br><span class="line"><span class="comment">//    [next sibling               ] Klass</span></span><br><span class="line"><span class="comment">//    [array klasses              ]</span></span><br><span class="line"><span class="comment">//    [methods                    ]</span></span><br><span class="line"><span class="comment">//    [local interfaces           ]</span></span><br><span class="line"><span class="comment">//    [transitive interfaces      ]</span></span><br><span class="line"><span class="comment">//    [fields                     ]</span></span><br><span class="line"><span class="comment">//    [constants                  ]</span></span><br><span class="line"><span class="comment">//    [class loader               ]</span></span><br><span class="line"><span class="comment">//    [source file name           ]</span></span><br><span class="line"><span class="comment">//    [inner classes              ]</span></span><br><span class="line"><span class="comment">//    [static field size          ]</span></span><br><span class="line"><span class="comment">//    [nonstatic field size       ]</span></span><br><span class="line"><span class="comment">//    [static oop fields size     ]</span></span><br><span class="line"><span class="comment">//    [nonstatic oop maps size    ]</span></span><br><span class="line"><span class="comment">//    [has finalize method        ]</span></span><br><span class="line"><span class="comment">//    [deoptimization mark bit    ]</span></span><br><span class="line"><span class="comment">//    [initialization state       ]</span></span><br><span class="line"><span class="comment">//    [initializing thread        ]</span></span><br><span class="line"><span class="comment">//    [Java vtable length         ]</span></span><br><span class="line"><span class="comment">//    [oop map cache (stack maps) ]</span></span><br><span class="line"><span class="comment">//    [EMBEDDED Java vtable             ] size in words = vtable_len</span></span><br><span class="line"><span class="comment">//    [EMBEDDED nonstatic oop-map blocks] size in words = nonstatic_oop_map_size</span></span><br><span class="line"><span class="comment">//      The embedded nonstatic oop-map blocks are short pairs (offset, length)</span></span><br><span class="line"><span class="comment">//      indicating where oops are located in instances of this klass.</span></span><br><span class="line"><span class="comment">//    [EMBEDDED implementor of the interface] only exist for interface</span></span><br><span class="line"><span class="comment">//    [EMBEDDED host klass        ] only exist for an anonymous class (JSR 292 enabled)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InstanceKlass</span>:</span> <span class="keyword">public</span> Klass &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 hotspot 代码里面 <code>Klass</code> 是类的底层实现，类加载最终的结果就是创建一个 <code>Klass</code> （或其子类）对象，而 <code>SystemDictionary</code> 管理了所有的加载的类。</p>
<h3 id="Java-虚拟机启动"><a href="#Java-虚拟机启动" class="headerlink" title="Java 虚拟机启动"></a>Java 虚拟机启动</h3><p>来看一下 JVM 启动的时候跟 ClassLoader 相关的主要流程，从 main 方法到 java main 方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">main (jdk&#x2F;src&#x2F;share&#x2F;bin&#x2F;main.c)</span><br><span class="line">-&gt; JLI_Launch (jdk&#x2F;src&#x2F;share&#x2F;bin&#x2F;java.c)</span><br><span class="line"> -&gt; LoadJavaVM (jdk&#x2F;src&#x2F;share&#x2F;bin&#x2F;java.c) &#x2F;&#x2F; 加载动态库找到hotspot实现</span><br><span class="line"> -&gt; JVMInit (jdk&#x2F;src&#x2F;share&#x2F;bin&#x2F;java.c)</span><br><span class="line">  -&gt; ContinueInNewThread (jdk&#x2F;src&#x2F;share&#x2F;bin&#x2F;java.c)</span><br><span class="line">   -&gt; ContinueInNewThread0 (jdk&#x2F;src&#x2F;solaris&#x2F;bin&#x2F;java_md_solinux.c)</span><br><span class="line">    -&gt; JavaMain (jdk&#x2F;src&#x2F;share&#x2F;bin&#x2F;java.c)</span><br><span class="line">     -&gt; InitializeJVM (jdk&#x2F;src&#x2F;share&#x2F;bin&#x2F;java.c)</span><br><span class="line">      -&gt; JNI_CreateJavaVM (hotspot&#x2F;src&#x2F;share&#x2F;vm&#x2F;prims&#x2F;jni.cpp)</span><br><span class="line">       -&gt; Threads::create_vm (hotspot&#x2F;src&#x2F;share&#x2F;vm&#x2F;runtime&#x2F;thread.cpp)</span><br><span class="line">        -&gt; init_globals (hotspot&#x2F;src&#x2F;share&#x2F;vm&#x2F;runtime&#x2F;init.cpp)</span><br><span class="line">         -&gt; universe2_init (hotspot&#x2F;src&#x2F;share&#x2F;vm&#x2F;runtime&#x2F;universe.cpp)</span><br><span class="line">          -&gt; Universe::genesis (hotspot&#x2F;src&#x2F;share&#x2F;vm&#x2F;runtime&#x2F;universe.cpp)</span><br><span class="line">           -&gt; SystemDictionary::initialize (hotspot&#x2F;src&#x2F;share&#x2F;vm&#x2F;classfile&#x2F;systemDictionary.cpp)</span><br><span class="line">            -&gt; SystemDictionary::initialize_preloaded_classes (hotspot&#x2F;src&#x2F;share&#x2F;classfile&#x2F;systemDictionary.cpp)</span><br><span class="line">       -&gt; SystemDictionary::compute_java_system_loader (hotspot&#x2F;src&#x2F;share&#x2F;classfile&#x2F;systemDictionary.cpp)</span><br><span class="line">     -&gt; LoadMainClass (jdk&#x2F;src&#x2F;share&#x2F;bin&#x2F;java.c) &#x2F;&#x2F; 加载 MainClass</span><br><span class="line">     -&gt; GetStaticMethodID (jdk&#x2F;src&#x2F;share&#x2F;bin&#x2F;java.c) &#x2F;&#x2F; 找 main 方法</span><br><span class="line">     -&gt; CallStaticVoidMethod (jdk&#x2F;src&#x2F;share&#x2F;bin&#x2F;java.c) &#x2F;&#x2F; 调用 main 方法</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>hotspot/src/share/vm/classfile/systemDictionary.hpp</span><a target="_blank" rel="noopener" href="https://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/classfile/systemDictionary.hpp">systemDictionary.hpp</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WK_KLASSES_DO(do_klass)                                                                                          \</span></span><br><span class="line">  <span class="comment">/* well-known classes */</span>                                                                                               \</span><br><span class="line">  do_klass(Object_klass,                                java_lang_Object,                          Pre                 ) \</span><br><span class="line">  do_klass(String_klass,                                java_lang_String,                          Pre                 ) \</span><br><span class="line">  do_klass(Class_klass,                                 java_lang_Class,                           Pre                 ) \</span><br><span class="line">  do_klass(Cloneable_klass,                             java_lang_Cloneable,                       Pre                 ) \</span><br><span class="line">  do_klass(ClassLoader_klass,                           java_lang_ClassLoader,                     Pre                 ) \</span><br><span class="line">  do_klass(Serializable_klass,                          java_io_Serializable,                      Pre                 ) \</span><br><span class="line">  do_klass(System_klass,                                java_lang_System,                          Pre                 ) \</span><br><span class="line">  do_klass(Throwable_klass,                             java_lang_Throwable,                       Pre                 ) \</span><br><span class="line">  do_klass(Error_klass,                                 java_lang_Error,                           Pre                 ) \</span><br><span class="line">  do_klass(ThreadDeath_klass,                           java_lang_ThreadDeath,                     Pre                 ) \</span><br><span class="line">  do_klass(Exception_klass,                             java_lang_Exception,                       Pre                 ) \</span><br><span class="line">  do_klass(RuntimeException_klass,                      java_lang_RuntimeException,                Pre                 ) \</span><br><span class="line">  do_klass(SecurityManager_klass,                       java_lang_SecurityManager,                 Pre                 ) \</span><br><span class="line">  do_klass(ProtectionDomain_klass,                      java_security_ProtectionDomain,            Pre                 ) \</span><br><span class="line">  do_klass(AccessControlContext_klass,                  java_security_AccessControlContext,        Pre                 ) \</span><br><span class="line">  do_klass(ClassNotFoundException_klass,                java_lang_ClassNotFoundException,          Pre                 ) \</span><br><span class="line">  do_klass(NoClassDefFoundError_klass,                  java_lang_NoClassDefFoundError,            Pre                 ) \</span><br><span class="line">  do_klass(LinkageError_klass,                          java_lang_LinkageError,                    Pre                 ) \</span><br><span class="line">  do_klass(ClassCastException_klass,                    java_lang_ClassCastException,              Pre                 ) \</span><br><span class="line">  do_klass(ArrayStoreException_klass,                   java_lang_ArrayStoreException,             Pre                 ) \</span><br><span class="line">  do_klass(VirtualMachineError_klass,                   java_lang_VirtualMachineError,             Pre                 ) \</span><br><span class="line">  do_klass(OutOfMemoryError_klass,                      java_lang_OutOfMemoryError,                Pre                 ) \</span><br><span class="line">  do_klass(StackOverflowError_klass,                    java_lang_StackOverflowError,              Pre                 ) \</span><br><span class="line">  do_klass(IllegalMonitorStateException_klass,          java_lang_IllegalMonitorStateException,    Pre                 ) \</span><br><span class="line">  do_klass(Reference_klass,                             java_lang_ref_Reference,                   Pre                 ) \</span><br><span class="line">                                                                                                                         \</span><br><span class="line">  <span class="comment">/* Preload ref klasses and set reference types */</span>                                                                      \</span><br><span class="line">  do_klass(SoftReference_klass,                         java_lang_ref_SoftReference,               Pre                 ) \</span><br><span class="line">  do_klass(WeakReference_klass,                         java_lang_ref_WeakReference,               Pre                 ) \</span><br><span class="line">  do_klass(FinalReference_klass,                        java_lang_ref_FinalReference,              Pre                 ) \</span><br><span class="line">  do_klass(PhantomReference_klass,                      java_lang_ref_PhantomReference,            Pre                 ) \</span><br><span class="line">  <span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><figcaption><span>hotspot/src/share/vm/classfile/systemDictionary.cpp</span><a target="_blank" rel="noopener" href="https://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/classfile/systemDictionary.cpp">systemDictionary.cpp</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SystemDictionary::initialize_preloaded_classes</span><span class="params">(TRAPS)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    initialize_wk_klasses_through(WK_KLASS_ENUM_NAME(Class_klass), scan, CHECK);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    Universe::initialize_basic_type_mirrors(CHECK);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    initialize_wk_klasses_through(WK_KLASS_ENUM_NAME(Reference_klass), scan, CHECK);.</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    initialize_wk_klasses_through(WK_KLASS_ENUM_NAME(PhantomReference_klass), scan, CHECK);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    initialize_wk_klasses_until(WKID_LIMIT, scan, CHECK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SystemClassLoader"><a href="#SystemClassLoader" class="headerlink" title="SystemClassLoader"></a>SystemClassLoader</h3><p>除了 Bootstrap ClassLoader 之外的类加载器都是在 Java 代码里面定义的，系统类加载器 <code>ClassLoader.getSystemClassLoader()</code></p>
<figure class="highlight java"><figcaption><span>java.lang.ClassLoader</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The class loader for the system</span></span><br><span class="line">    <span class="comment">// @GuardedBy(&quot;ClassLoader.class&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ClassLoader scl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set to true once the system class loader has been set</span></span><br><span class="line">    <span class="comment">// @GuardedBy(&quot;ClassLoader.class&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> sclSet;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@CallerSensitive</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClassLoader <span class="title">getSystemClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        initSystemClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (scl == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        SecurityManager sm = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">            checkClassLoaderPermission(scl, Reflection.getCallerClass());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> scl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">initSystemClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!sclSet) &#123;</span><br><span class="line">            <span class="keyword">if</span> (scl != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;recursive invocation&quot;</span>);</span><br><span class="line">            sun.misc.Launcher l = sun.misc.Launcher.getLauncher();</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            sclSet = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>sun.misc.Launcher</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Launcher</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Launcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Create the extension class loader</span></span><br><span class="line">        ClassLoader extcl;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            extcl = ExtClassLoader.getExtClassLoader();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">&quot;Could not create extension class loader&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now create the class loader to use to launch the application</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            loader = AppClassLoader.getAppClassLoader(extcl);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">&quot;Could not create application class loader&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Also set the context class loader for the primordial thread.</span></span><br><span class="line">        Thread.currentThread().setContextClassLoader(loader);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时可以看到 AppClassLoader 的 parent 是 ExtClassLoader，同时 SystemClassLoader 也是在 JVM 初始化的时候进行初始化的</p>
<figure class="highlight c++"><figcaption><span>hotspot/src/share/vm/classfile/systemDictionary.cpp</span><a target="_blank" rel="noopener" href="https://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/classfile/systemDictionary.cpp">systemDictionary.cpp</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SystemDictionary::compute_java_system_loader</span><span class="params">(TRAPS)</span> </span>&#123;</span><br><span class="line">    <span class="function">KlassHandle <span class="title">system_klass</span><span class="params">(THREAD, WK_KLASS(ClassLoader_klass))</span></span>;</span><br><span class="line">    <span class="function">JavaValue <span class="title">result</span><span class="params">(T_OBJECT)</span></span>;</span><br><span class="line">    JavaCalls::call_static(&amp;result,</span><br><span class="line">                           KlassHandle(THREAD, WK_KLASS(ClassLoader_klass)),</span><br><span class="line">                           vmSymbols::getSystemClassLoader_name(),</span><br><span class="line">                           vmSymbols::void_classloader_signature(),</span><br><span class="line">                           CHECK);</span><br><span class="line"></span><br><span class="line">    _java_system_loader = (oop)result.get_jobject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MainClass-的加载"><a href="#MainClass-的加载" class="headerlink" title="MainClass 的加载"></a>MainClass 的加载</h3><figure class="highlight c++"><figcaption><span>jdk/src/share/bin/java.c</span><a target="_blank" rel="noopener" href="https://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/bin/java.c">java.c</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> JNICALL <span class="title">JavaMain</span><span class="params">(<span class="keyword">void</span> * _args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    mainClass = LoadMainClass(env, mode, what);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    mainID = (*env)-&gt;GetStaticMethodID(env, mainClass, <span class="string">&quot;main&quot;</span>,</span><br><span class="line">                                       <span class="string">&quot;([Ljava/lang/String;)V&quot;</span>);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">/* Invoke main method. */</span></span><br><span class="line">    (*env)-&gt;CallStaticVoidMethod(env, mainClass, mainID, mainArgs);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jclass <span class="title">LoadMainClass</span><span class="params">(JNIEnv *env, <span class="keyword">int</span> mode, <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    jclass cls = GetLauncherHelperClass(env);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// sun.launcher.LauncherHelper#checkAndLoadMain</span></span><br><span class="line">    NULL_CHECK0(mid = (*env)-&gt;GetStaticMethodID(env, cls,</span><br><span class="line">                <span class="string">&quot;checkAndLoadMain&quot;</span>,</span><br><span class="line">                <span class="string">&quot;(ZILjava/lang/String;)Ljava/lang/Class;&quot;</span>));</span><br><span class="line"></span><br><span class="line">    str = NewPlatformString(env, name);</span><br><span class="line">    result = (*env)-&gt;CallStaticObjectMethod(env, cls, mid, USE_STDERR, mode, str);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> (jclass)result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>sun.launcher.LauncherHelper</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">LauncherHelper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ClassLoader scloader = ClassLoader.getSystemClassLoader();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; checkAndLoadMain(<span class="keyword">boolean</span> printToStderr,</span><br><span class="line">                                            <span class="keyword">int</span> mode,</span><br><span class="line">                                            String what) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        mainClass = scloader.loadClass(cn);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">return</span> mainClass;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此 MainClass 是由 <code>ClassLoader.getSystemClassLoader()</code> 加载的</p>
<h3 id="一些结论"><a href="#一些结论" class="headerlink" title="一些结论"></a>一些结论</h3><ol>
<li>从 hotspot 的角度来讲，所有类都是通过 <code>Klass</code> 对象来描述的</li>
<li>类是一个抽象的概念</li>
<li>Object.class != Object 类，可以说 <code>Object.class</code> 也是一个对象，是用来表示底层（C++）<code>Klass</code> 的一个对象</li>
<li>一定是先有类，才有对象。一切都是对象，都继承自<code>java.lang.Object</code>（除了基本类型）</li>
<li>在 JVM 加载的过程中，会预先初始化一些 Klass 对象（well known classes），来描述具体的类</li>
<li>最早加载的几个类（按照顺序）<code>java.lang.Object</code> , <code>java.lang.String</code> , <code>java.lang.Class</code> , 9 个基本类型（包含 <code>Void.TYPE</code>）, <code>java.lang.Cloneable</code> , <code>java.lang.ClassLoader</code></li>
<li>这些类是预加载，不需要有一个 <code>java.lang.ClassLoader</code> 的实例来加载，这个时候 JVM 都没有完全初始化</li>
<li>默认会有三个 ClassLoader，Bootstrap ClassLoader 是 C++实现的</li>
<li>Class.class.getClassLoader() == null （Bootstrap ClassLoader 在 Java 层面就是 null）</li>
<li>主类的 ClassLoader 就是 <code>ClassLoader.getSystemClassLoader()</code></li>
</ol>
<p>Bootstrap ClassLoader 的存在是一个比较自然的事情，不需要死记硬背。</p>
<p>下面语句分别输出什么？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(Test.class.getClassLoader());</span><br><span class="line">        System.out.println(javax.sql.DataSource.class.getClassLoader());</span><br><span class="line">        System.out.println(String.class.getClassLoader());</span><br><span class="line">        System.out.println(ClassLoader.getSystemClassLoader());</span><br><span class="line">        System.out.println(ClassLoader.getSystemClassLoader().getParent());</span><br><span class="line">        System.out.println(ClassLoader.getSystemClassLoader().getParent().getParent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以自己试一下，不同版本会有差异。</p>
<h2 id="类的加载、链接、初始化"><a href="#类的加载、链接、初始化" class="headerlink" title="类的加载、链接、初始化"></a>类的加载、链接、初始化</h2><p>通过类的全名（binary name）获取二进制流加载到 JVM，并生成一个 <code>java.lang.Class</code> 对象表示这个类。</p>
<p align="center"><img src="/img/2021/java-classloader-03.png"/><br/>图片来源于网络</p>

<p>来看一下 Java 虚拟机规范关于类加载的描述 <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-5.html">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-5.html</a></p>
<p><img src="/img/2021/java-classloader-04.png"></p>
<blockquote>
<p><strong>How the Java Launcher Finds Classes</strong></p>
<p>The Java launcher, <strong>java</strong>, initiates the Java virtual machine. The virtual machine searches for and loads classes in this order:</p>
<ul>
<li><strong>Bootstrap classes</strong> - Classes that comprise the Java platform, including the classes in rt.jar and several other important jar files.</li>
<li><strong>Extension classes</strong> - Classes that use the Java Extension mechanism. These are bundled as .jar files located in the extensions directory.</li>
<li><strong>User classes</strong> - Classes defined by developers and third parties that do not take advantage of the extension mechanism.</li>
</ul>
</blockquote>
<p>现在我们知道，系统启动的时候，一共有三个 ClassLoader</p>
<ul>
<li>Bootstrap ClassLoader (C++ null)</li>
<li>ExtClassLoader (SystemDictionary::compute_java_system_loader 时初始化)</li>
<li>AppClassLoader (SystemDictionary::compute_java_system_loader 时初始化)</li>
</ul>
<blockquote>
<p>后续 ExtClassLoader 指 <code>sun.misc.Launcher$ExtClassLoader</code> 一个的实例，AppClassLoader 指 <code>sun.misc.Launcher$AppClassLoader</code> 的一个的实例</p>
</blockquote>
<h3 id="类型判断"><a href="#类型判断" class="headerlink" title="类型判断"></a>类型判断</h3><p>两个类型是否相等，是指全名（binary name）相等且是<strong>同一个类加载器</strong>完成加载的。包括兼容性判断</p>
<ul>
<li>java.lang.Class.isAssignableFrom</li>
<li>java.lang.Class.isInstance</li>
<li>java.lang.Class.equals</li>
<li>instanceof 关键字</li>
<li>类型转换</li>
</ul>
<p>那么不同类加载器在加载同一个类的时候，应该如何处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException </span>&#123;</span><br><span class="line">        String name = <span class="string">&quot;java.lang.Object&quot;</span>;</span><br><span class="line">        Class&lt;?&gt; objectClass1 = Object.class;</span><br><span class="line">        Class&lt;?&gt; objectClass2 = ClassLoader.getSystemClassLoader().loadClass(name);</span><br><span class="line">        Class&lt;?&gt; objectClass3 = <span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[<span class="number">0</span>]).loadClass(name);</span><br><span class="line"></span><br><span class="line">        objectClass2.isAssignableFrom(Test.class);</span><br><span class="line">        objectClass3.isInstance(<span class="keyword">new</span> Test());</span><br><span class="line"></span><br><span class="line">        objectClass1.getClassLoader(); <span class="comment">// null</span></span><br><span class="line">        objectClass2.getClassLoader(); <span class="comment">// ?</span></span><br><span class="line">        objectClass3.getClassLoader(); <span class="comment">// ?</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果每个 ClassLoader 都去加载一遍 <code>java.lang.Object</code> 那么不同类加载加载的 Class 是不是相等的？<br>如果不想等对象就没有办法相互转换，那么整个程序就会表现的很奇怪，从这个角度上讲</p>
<ul>
<li>AppClassLoader 去加载 Bootstrap classes 也应该是由 Bootstrap ClassLoader 加载的</li>
<li>AppClassLoader 去加载 Extension classes 也应该是由 ExtClassLoader 加载的</li>
<li>ExtClassLoader 去加载 Bootstrap classes 也应该是由 Bootstrap ClassLoader 加载的</li>
</ul>
<p>这就是一个委托（delegation）的模型。</p>
<h3 id="双亲委派"><a href="#双亲委派" class="headerlink" title="双亲委派"></a>双亲委派</h3><p>来看一下 ClassLoader 是如何加载一个类的<br><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/lang/ClassLoader.html">https://docs.oracle.com/javase/8/docs/api/java/lang/ClassLoader.html</a></p>
<p><img src="/img/2021/java-classloader-05.png"></p>
<blockquote>
<p>The ClassLoader class uses a delegation model to search for classes and resources. Each instance of ClassLoader has an associated parent class loader. When requested to find a class or resource, a ClassLoader instance will delegate the search for the class or resource to its parent class loader before attempting to find the class or resource itself. The virtual machine’s built-in class loader, called the “bootstrap class loader”, does not itself have a parent but may serve as the parent of a ClassLoader instance.</p>
</blockquote>
<p>这个一般就称为双亲委派模型（Parent Delegation Model ）。</p>
<blockquote>
<p>这个名词的翻译不好，“双”这个字不是很准确</p>
</blockquote>
<figure class="highlight java"><figcaption><span>java.lang.ClassLoader</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">registerNatives</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        registerNatives();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The parent class loader for delegation</span></span><br><span class="line">    <span class="comment">// Note: VM hardcoded the offset of this field, thus all new fields</span></span><br><span class="line">    <span class="comment">// must be added *after* it.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader parent;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 AppClassLoader 的 parent 是 ExtClassLoader，ExtClassLoader 的 parent 是 Bootstrap ClassLoader（null），这个跟之前的理解是一致的</p>
<blockquote>
<ul>
<li>AppClassLoader 去加载 Bootstrap classes 也应该是由 Bootstrap ClassLoader 加载的</li>
<li>AppClassLoader 去加载 Extension classes 也应该是由 ExtClassLoader 加载的</li>
<li>ExtClassLoader 去加载 Bootstrap classes 也应该是由 Bootstrap ClassLoader 加载的</li>
</ul>
</blockquote>
<p>加载类对应的方法<br><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/lang/ClassLoader.html#loadClass-java.lang.String-boolean-">https://docs.oracle.com/javase/8/docs/api/java/lang/ClassLoader.html#loadClass-java.lang.String-boolean-</a></p>
<p><img src="/img/2021/java-classloader-06.png"></p>
<figure class="highlight java"><figcaption><span>java.lang.ClassLoader</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">            <span class="comment">// First, check if the class has already been loaded</span></span><br><span class="line">            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">long</span> t0 = System.nanoTime();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        c = findBootstrapClassOrNull(name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                    <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">                    <span class="comment">// from the non-null parent class loader</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// If still not found, then invoke findClass in order</span></span><br><span class="line">                    <span class="comment">// to find the class.</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                    c = findClass(name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">                resolveClass(c);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Finds the class with the specified &lt;a href=&quot;#name&quot;&gt;binary name&lt;/a&gt;.</span></span><br><span class="line"><span class="comment">     * This method should be overridden by class loader implementations that</span></span><br><span class="line"><span class="comment">     * follow the delegation model for loading classes, and will be invoked by</span></span><br><span class="line"><span class="comment">     * the &#123;<span class="doctag">@link</span> #loadClass &lt;tt&gt;loadClass&lt;/tt&gt;&#125; method after checking the</span></span><br><span class="line"><span class="comment">     * parent class loader for the requested class.  The default implementation</span></span><br><span class="line"><span class="comment">     * throws a &lt;tt&gt;ClassNotFoundException&lt;/tt&gt;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p align="center"><img src="/img/2021/java-classloader-07.png"/><br/>图片来源于网络</p>

<p>从上面的代码来看，双亲委派的实现时非常简单的。那为什么需要双亲委派？总感觉这个问题不是很好回答，因为从上面的分析来看，如果是这个 ClassLoader 的模型，那么双亲委派就是比较自然的方案</p>
<ul>
<li>保证类的唯一性</li>
<li>避免重复加载</li>
<li>安全，核心类不会被篡改（比如 <code>-classpath</code> 中包含 <code>java.lang.Object</code>，但委托给 Bootstrap ClassLoader 之后就只能加载默认的类）</li>
</ul>
<p>为了保证安全性，<code>java.</code> 开头的类是不能去定义的（例如在 <code>-classpath</code> 中包含 <code>java.lang.Object2</code>）</p>
<figure class="highlight java"><figcaption><span>java.lang.ClassLoader</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ProtectionDomain <span class="title">preDefineClass</span><span class="params">(String name, ProtectionDomain pd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// relies on the fact that spoofing is impossible if a class has a name</span></span><br><span class="line">    <span class="comment">// of the form &quot;java.*&quot;</span></span><br><span class="line">    <span class="keyword">if</span> ((name != <span class="keyword">null</span>) &amp;&amp; name.startsWith(<span class="string">&quot;java.&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">&quot;Prohibited package name: &quot;</span> + name.substring(<span class="number">0</span>, name.lastIndexOf(<span class="string">&#x27;.&#x27;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里有对上述过程更详细的解释<br><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/spec/security-spec.doc5.html">https://docs.oracle.com/javase/8/docs/technotes/guides/security/spec/security-spec.doc5.html</a></p>
<h4 id="SPI-与-ContextClassLoader"><a href="#SPI-与-ContextClassLoader" class="headerlink" title="SPI 与 ContextClassLoader"></a>SPI 与 ContextClassLoader</h4><p>我们来看一下 SPI</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Connection conn = DriverManager.getConnection(<span class="string">&quot;jdbc:mysql://localhost:3306/mysql&quot;</span>, <span class="string">&quot;root&quot;</span>, <span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        System.out.println(conn.getClass() == com.mysql.cj.jdbc.ConnectionImpl.class);</span><br><span class="line">        System.out.println(com.mysql.cj.jdbc.ConnectionImpl.class.getClassLoader());</span><br><span class="line">        System.out.println(DriverManager.class.getClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可能这里看上去没有什么问题，但是 <code>DriverManager</code> 是 Bootstrap ClassLoader 加载的，最终 <code>ConnectionImpl</code> 是应用自己的 classpath 下，是 AppClassLoader 加载的。</p>
<blockquote>
<p>那能不能写死 SPI 就用 <code>java.lang.ClassLoader.getSystemClassLoader()</code> 来加载呢？</p>
</blockquote>
<p>来看一下 <code>DriverManager</code> 是如何加载具体 <code>Driver</code> 实现的</p>
<figure class="highlight java"><figcaption><span>java.sql.DriverManager</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DriverManager</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        loadInitialDrivers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadInitialDrivers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// SPI</span></span><br><span class="line">        ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);</span><br><span class="line">        Iterator&lt;Driver&gt; driversIterator = loadedDrivers.iterator();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>java.util.ServiceLoader</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceLoader</span>&lt;<span class="title">S</span>&gt; <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">S</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;S&gt; <span class="function">ServiceLoader&lt;S&gt; <span class="title">load</span><span class="params">(Class&lt;S&gt; service)</span> </span>&#123;</span><br><span class="line">        ClassLoader cl = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="keyword">return</span> ServiceLoader.load(service, cl);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解决这个问题是通过线程上下文类加载器 <code>Thread.currentThread().getContextClassLoader()</code> ，每个线程绑定一个类加载器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Thread.currentThread().setContextClassLoader(classloader1)</span><br><span class="line">ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);</span><br><span class="line"></span><br><span class="line">Thread.currentThread().setContextClassLoader(classloader2)</span><br><span class="line">ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader.load(Driver.class);</span><br></pre></td></tr></table></figure>

<p>ContextClassLoader 并不是一个优雅的设计，不过一般在代码中很少需要关注。主要使用场景是各种框架，框架利用上下文加载器加载对应的资源或者类。</p>
<h4 id="双亲委派机制的破坏"><a href="#双亲委派机制的破坏" class="headerlink" title="双亲委派机制的破坏"></a>双亲委派机制的破坏</h4><p>双亲委派的核心就是 parent 属性和 loadClass 方法</p>
<figure class="highlight java"><figcaption><span>java.lang.ClassLoader</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve)</span><br></pre></td></tr></table></figure>

<p><code>protected</code> 说明这个方法是可以覆盖的，因此双亲委派不是强制的，肯定有一些场景是可以改写这个逻辑的。</p>
<p>一般认为 SPI 是破坏了双亲委派机制的（委派给另外一个上下文 ClassLoader 而不 parent），此外就是覆盖 loadClass 方法破坏双亲委派的机制，具体的使用场景后面会讲。</p>
<h3 id="类的初始化时机"><a href="#类的初始化时机" class="headerlink" title="类的初始化时机"></a>类的初始化时机</h3><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-5.html">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-5.html</a></p>
<blockquote>
<p><strong>Initialization</strong> of a class or interface consists of executing its class or interface initialization method (§2.9).</p>
<p>A class or interface C may be initialized only as a result of:</p>
<ul>
<li>The execution of any one of the Java Virtual Machine instructions new, getstatic, putstatic, or invokestatic that references C (§new, §getstatic, §putstatic, §invokestatic). These instructions reference a class or interface directly or indirectly through either a field reference or a method reference.Upon execution of a new instruction, the referenced class is initialized if it has not been initialized already.Upon execution of a getstatic, putstatic, or invokestatic instruction, the class or interface that declared the resolved field or method is initialized if it has not been initialized already.</li>
<li>The first invocation of a java.lang.invoke.MethodHandle instance which was the result of method handle resolution (§5.4.3.5) for a method handle of kind 2 (REF_getStatic), 4 (REF_putStatic), 6 (REF_invokeStatic), or 8 (REF_newInvokeSpecial).This implies that the class of a bootstrap method is initialized when the bootstrap method is invoked for an invokedynamic instruction (§invokedynamic), as part of the continuing resolution of the call site specifier.</li>
<li>Invocation of certain reflective methods in the class library (§2.12), for example, in class Class or in package java.lang.reflect.</li>
<li>If C is a class, the initialization of one of its subclasses.</li>
<li>If C is an interface that declares a non-abstract, non-static method, the initialization of a class that implements C directly or indirectly.</li>
<li>If C is a class, its designation as the initial class at Java Virtual Machine startup (§5.2).</li>
</ul>
</blockquote>
<p>有且只有上述 6 种情况（且这个类没有被加载）会去加载一个类，简单来说</p>
<ul>
<li>new 读取/修改静态变量（排除在常量池的）调用静态方法</li>
<li>动态语言支持 java.lang.invoke.MethodHandle 相关</li>
<li>class library 中的一些方法，例如 Class 和 ClassLoader 的部分方法、反射（java.lang.reflect）等</li>
<li>初始化类的某个子类的时候</li>
<li>初始化包含默认方法接口的某个实现类的</li>
<li>Java 启动类（main Class）</li>
</ul>
<p>其中 4 和 5 可以统一成一个递归的描述，如果要初始化一个类，需要先初始化父类和包含 default 方法的接口。<br>6 在实现的时候其实属于 3 的，是通过<code>java.lang.ClassLoader.loadClass</code>加载的（<code>sun.launcher.LauncherHelper</code>）。</p>
<h3 id="类加载的相关异常"><a href="#类加载的相关异常" class="headerlink" title="类加载的相关异常"></a>类加载的相关异常</h3><p>类加载过程，需要进行验证，比如文件格式、JAVA 版本、final 约束、可访问性约束等，具体细节就不赘述了</p>
<p><img src="/img/2021/java-classloader-08.png"></p>
<p>同时还有一个有一个非常重要的异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        c = parent.loadClass(name, <span class="keyword">false</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        c = findBootstrapClassOrNull(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">    <span class="comment">// ClassNotFoundException thrown if class not found</span></span><br><span class="line">    <span class="comment">// from the non-null parent class loader</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在双亲委派的过程中 parent 如果加载不了某个类，需要抛出 <code>java.lang.ClassNotFoundException</code>（这里只 catch 了这个异常）。</p>
<blockquote>
<p>public class <code>ClassNotFoundException</code> extends <code>ReflectiveOperationException</code></p>
<p>Thrown when an application tries to load in a class through its string name using:</p>
<ul>
<li>The forName method in class Class.</li>
<li>The findSystemClass method in class ClassLoader .</li>
<li>The loadClass method in class ClassLoader.<br>but no definition for the class with the specified name could be found.</li>
</ul>
</blockquote>
<blockquote>
<p>public class <code>NoClassDefFoundError</code> extends <code>LinkageError</code></p>
<p>Thrown if the Java Virtual Machine or a ClassLoader instance tries to load in the definition of a class (as part of a normal method call or as part of creating a new instance using the new expression) and no definition of the class could be found.<br>The searched-for class definition existed when the currently executing class was compiled, but the definition can no longer be found.</p>
</blockquote>
<p><code>java.lang.NoClassDefFoundError</code> 是一个 Error，发生在实例化一个类的时候（类已经找到了），一般情况是这个类依赖的某些定义不存在，一般会出现在 jar 包的版本不兼容上。</p>
<h3 id="类的卸载"><a href="#类的卸载" class="headerlink" title="类的卸载"></a>类的卸载</h3><p>满足如下条件，则类会被卸载</p>
<ol>
<li>该类的所有实例（包含子类的实例）都被回收</li>
<li>该类的 ClassLoader 不存在任何引用</li>
<li>该类的 Class 对象不存在任何引用（包括相关的 Method Field 等，无法通过反射访问）</li>
</ol>
<p>注意默认的三个类加载对应的类是不会被卸载的（ClassLoader 会一直被引用）。</p>
<h2 id="自定义-ClassLoader"><a href="#自定义-ClassLoader" class="headerlink" title="自定义 ClassLoader"></a>自定义 ClassLoader</h2><h3 id="如何自定义-ClassLoader"><a href="#如何自定义-ClassLoader" class="headerlink" title="如何自定义 ClassLoader"></a>如何自定义 ClassLoader</h3><p>一般是继承 <code>java.net.URLClassLoader</code> 或者直接继承 <code>java.lang.ClassLoader</code>，然后覆盖 <code>findClass</code> 或 <code>loadClass</code> 方法</p>
<h4 id="覆盖-findClass"><a href="#覆盖-findClass" class="headerlink" title="覆盖 findClass"></a>覆盖 findClass</h4><p>这种修改一般不破坏双亲委派，会修改查找类的逻辑，实现某些动态的逻辑。可以实现但不限于以下的逻辑</p>
<ol>
<li>从网络获取</li>
<li>从特定目录获取</li>
<li>特定目录结构的压缩包</li>
<li>War 包 WEB-INF</li>
<li>SpringBoot FatJar</li>
<li>对二进制流做预处理，例如解密或验证签名</li>
<li>内存直接定义 Class 文件（配合字节码的库）（动态代理）</li>
<li>实现热加载</li>
<li>类似 JSP 的技术</li>
<li>…</li>
</ol>
<h4 id="覆盖-loadClass"><a href="#覆盖-loadClass" class="headerlink" title="覆盖 loadClass"></a>覆盖 loadClass</h4><p>一般是修改类加载的层级结构，可以实现但不限于以下的逻辑</p>
<ol>
<li>模块化</li>
<li>自定义某种类隔离的机制，例如 Tomcat</li>
<li>…</li>
</ol>
<p>当然上面两种也可以进行组合</p>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><h4 id="SpringBoot"><a href="#SpringBoot" class="headerlink" title="SpringBoot"></a>SpringBoot</h4><p>spring boot 应用打包之后可以直接通过 <code>java -jar</code> 命令启动 。</p>
<p>实现原理是 <code>spring-boot-maven-plugin</code> 在构建（repackage）的时候，会通过 <code>org.springframework.boot.maven.RepackageMojo</code> 打包成特定结构的 Jar 包<br><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/maven-plugin/reference/htmlsingle/#packaging.layers">https://docs.spring.io/spring-boot/docs/current/maven-plugin/reference/htmlsingle/#packaging.layers</a></p>
<figure class="highlight java"><figcaption><span>org.springframework.boot.loader.tools.Layouts.Jar</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Executable JAR layout.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Jar</span> <span class="keyword">implements</span> <span class="title">RepackagingLayout</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLauncherClassName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;org.springframework.boot.loader.JarLauncher&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLibraryDestination</span><span class="params">(String libraryName, LibraryScope scope)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;BOOT-INF/lib/&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getClassesLocation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRepackagedClassesLocation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;BOOT-INF/classes/&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isExecutable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以找一个 spring boot 的 Fat Jar 解压看一下看看</p>
<div class="highlight-tree">
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── BOOT-INF</span><br><span class="line">│   ├── classes</span><br><span class="line">│   │   ├── application.properties</span><br><span class="line">│   │   └── com</span><br><span class="line">│   │       └── example</span><br><span class="line">│   │           └── demo</span><br><span class="line">│   │               └── DemoApplication.class</span><br><span class="line">│   ├── classpath.idx</span><br><span class="line">│   ├── layers.idx</span><br><span class="line">│   └── lib</span><br><span class="line">│       ├── ...</span><br><span class="line">│       ├── spring-boot-2.5.4.jar</span><br><span class="line">│       ├── spring-boot-autoconfigure-2.5.4.jar</span><br><span class="line">│       ├── spring-context-5.3.9.jar</span><br><span class="line">│       └── spring-core-5.3.9.jar</span><br><span class="line">├── META-INF</span><br><span class="line">│   └── MANIFEST.MF</span><br><span class="line">└── org</span><br><span class="line">    └── springframework</span><br><span class="line">        └── boot</span><br><span class="line">            └── loader</span><br><span class="line">                ├── JarLauncher.class</span><br><span class="line">                ├── LaunchedURLClassLoader.class</span><br><span class="line">                ├── Launcher.class</span><br><span class="line">                ├── ...</span><br></pre></td></tr></table></figure>
</div>

<p><code>java -jar</code> 命令会在 <code>MANIFEST.MF</code> 里面找 <code>Main-Class</code> 来运行，看下 <code>META-INF/MANIFEST.MF</code> 文件内容</p>
<figure class="highlight text"><figcaption><span>META-INF/MANIFEST.MF</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Spring-Boot-Classpath-Index: BOOT-INF/classpath.idx</span><br><span class="line">Implementation-Title: demo</span><br><span class="line">Implementation-Version: 0.0.1-SNAPSHOT</span><br><span class="line">Spring-Boot-Layers-Index: BOOT-INF/layers.idx</span><br><span class="line">Start-Class: com.example.demo.DemoApplication</span><br><span class="line">Spring-Boot-Classes: BOOT-INF/classes/</span><br><span class="line">Spring-Boot-Lib: BOOT-INF/lib/</span><br><span class="line">Build-Jdk-Spec: 1.8</span><br><span class="line">Spring-Boot-Version: 2.5.4</span><br><span class="line">Created-By: Maven Jar Plugin 3.2.0</span><br><span class="line">Main-Class: org.springframework.boot.loader.JarLauncher</span><br></pre></td></tr></table></figure>

<p>那么是如何启动的呢？</p>
<figure class="highlight java"><figcaption><span>org.springframework.boot.loader.JarLauncher</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JarLauncher</span> <span class="keyword">extends</span> <span class="title">ExecutableArchiveLauncher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String BOOT_INF_CLASSES = <span class="string">&quot;BOOT-INF/classes/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String BOOT_INF_LIB = <span class="string">&quot;BOOT-INF/lib/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JarLauncher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">JarLauncher</span><span class="params">(Archive archive)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(archive);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isNestedArchive</span><span class="params">(Archive.Entry entry)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (entry.isDirectory()) &#123;</span><br><span class="line">            <span class="keyword">return</span> entry.getName().equals(BOOT_INF_CLASSES);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> entry.getName().startsWith(BOOT_INF_LIB);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> JarLauncher().launch(args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>org.springframework.boot.loader.ExecutableArchiveLauncher</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutableArchiveLauncher</span> <span class="keyword">extends</span> <span class="title">Launcher</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getMainClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Manifest manifest = <span class="keyword">this</span>.archive.getManifest();</span><br><span class="line">        String mainClass = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (manifest != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mainClass = manifest.getMainAttributes().getValue(<span class="string">&quot;Start-Class&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mainClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;No &#x27;Start-Class&#x27; manifest entry specified in &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mainClass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> List&lt;Archive&gt; <span class="title">getClassPathArchives</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;Archive&gt; archives = <span class="keyword">new</span> ArrayList&lt;Archive&gt;(<span class="keyword">this</span>.archive.getNestedArchives(<span class="keyword">new</span> EntryFilter() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(Entry entry)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> isNestedArchive(entry);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">        postProcessClassPathArchives(archives);</span><br><span class="line">        <span class="keyword">return</span> archives;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><figcaption><span>org.springframework.boot.loader.Launcher</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Launcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Launch the application. This method is the initial entry point that should be</span></span><br><span class="line"><span class="comment">     * called by a subclass &#123;<span class="doctag">@code</span> public static void main(String[] args)&#125; method.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args the incoming arguments</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception if the application fails to launch</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">launch</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        JarFile.registerUrlProtocolHandler();</span><br><span class="line">        ClassLoader classLoader = createClassLoader(getClassPathArchives());</span><br><span class="line">        launch(args, getMainClass(), classLoader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a classloader for the specified archives.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> archives the archives</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the classloader</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception if the classloader cannot be created</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ClassLoader <span class="title">createClassLoader</span><span class="params">(List&lt;Archive&gt; archives)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;URL&gt; urls = <span class="keyword">new</span> ArrayList&lt;URL&gt;(archives.size());</span><br><span class="line">        <span class="keyword">for</span> (Archive archive : archives) &#123;</span><br><span class="line">            urls.add(archive.getUrl());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> createClassLoader(urls.toArray(<span class="keyword">new</span> URL[urls.size()]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a classloader for the specified URLs.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> urls the URLs</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the classloader</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception if the classloader cannot be created</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ClassLoader <span class="title">createClassLoader</span><span class="params">(URL[] urls)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LaunchedURLClassLoader(urls, getClass().getClassLoader());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Launch the application given the archive file and a fully configured classloader.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args the incoming arguments</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mainClass the main class to run</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classLoader the classloader</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception if the launch fails</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">launch</span><span class="params">(String[] args, String mainClass, ClassLoader classLoader)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(classLoader);</span><br><span class="line">        createMainMethodRunner(mainClass, args, classLoader).run();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为是 Fat Jar 的模式（Jar in Jar），因此需要自己实现 <code>LaunchedURLClassLoader</code> 来定制类的查找逻辑。</p>
<h4 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h4><p>Tomcat 可以同时加载多个 web 应用，并且可以热加载，支持动态加载或者卸载 web 应用。大概的实现思路</p>
<ol>
<li>Tomcat 自身的代码会有一个 ClassLoader</li>
<li>Tomcat 为每个 Web 应用创建一个 <code>org.apache.catalina.loader.WebappClassLoader</code> 加载 Web 应用自己的类，且 <code>parent</code> 会指向 Tomcat 自身的类加载器</li>
<li>WebappClassLoader 加载的时候<ul>
<li>会先通过 <code>javaseClassLoader</code> 加载，默认为 <code>ClassLoader.getSystemClassLoader().getParent()</code></li>
<li>部分类会通过 <code>parent</code> 来进行加载，这样应用可以共享一些类的定义（例如 <code>javax.servlet.*</code> 和 <code>org.apache.tomcat.*</code>）</li>
<li>之后会加载 Web 应用目录下的类，因此可以实现不同应用之间的类是隔离的</li>
</ul>
</li>
</ol>
<p>上述过程会破坏双亲委派的模型。来看一下 Tomcat 的目录结构，webapps 目录下包含了所有的 Web 应用</p>
<div class="highlight-tree">
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── bin</span><br><span class="line">│   ├── ...</span><br><span class="line">│   ├── shutdown.sh</span><br><span class="line">│   └── startup.sh</span><br><span class="line">├── conf</span><br><span class="line">│   ├── ...</span><br><span class="line">│   ├── server.xml</span><br><span class="line">│   └── web.xml</span><br><span class="line">├── lib</span><br><span class="line">│   ├── ...</span><br><span class="line">│   ├── servlet-api.jar</span><br><span class="line">│   ├── tomcat-api.jar</span><br><span class="line">│   └── tomcat-websocket.jar</span><br><span class="line">├── logs</span><br><span class="line">├── webapps</span><br><span class="line">│   ├── ROOT</span><br><span class="line">│   ├── docs</span><br><span class="line">│   ├── examples</span><br><span class="line">│   ├── host-manager</span><br><span class="line">│   └── manager</span><br><span class="line">└── work</span><br></pre></td></tr></table></figure>
</div>

<p>Tomcat 文档关于 <code>WebappClassLoaderBase.loadClass</code> 的描述 <a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-8.5-doc/api/org/apache/catalina/loader/WebappClassLoaderBase.html">https://tomcat.apache.org/tomcat-8.5-doc/api/org/apache/catalina/loader/WebappClassLoaderBase.html</a><br><img src="/img/2021/java-classloader-10.jpg"></p>
<figure class="highlight java"><figcaption><span>org.apache.catalina.loader.WebappClassLoaderBase</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">WebappClassLoaderBase</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> <span class="keyword">implements</span> ... </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// (0) Check our previously loaded local class cache</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// (0.1) Check our previously loaded class cache</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 之前会判断是否已经加载过</span></span><br><span class="line">        <span class="comment">// javaseLoader 默认就是 java.lang.ClassLoader.getSystemClassLoader().getParent()</span></span><br><span class="line">        ClassLoader javaseLoader = getJavaseClassLoader();</span><br><span class="line">        <span class="keyword">boolean</span> tryLoadingFromJavaseLoader;</span><br><span class="line">        <span class="comment">// 判断是否应该用 javaseLoader 加载</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 通过 javaseLoader 加载</span></span><br><span class="line">        <span class="keyword">if</span> (tryLoadingFromJavaseLoader) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clazz = javaseLoader.loadClass(name);</span><br><span class="line">                <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> delegateLoad = delegate || filter(name, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (1) Delegate to our parent if requested</span></span><br><span class="line">        <span class="keyword">if</span> (delegateLoad) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clazz = Class.forName(name, <span class="keyword">false</span>, parent);</span><br><span class="line">                <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// Ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (2) Search local repositories</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clazz = findClass(name);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// (3) Delegate to parent unconditionally</span></span><br><span class="line">        <span class="keyword">if</span> (!delegateLoad) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clazz = Class.forName(name, <span class="keyword">false</span>, parent);</span><br><span class="line">                <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(String name, <span class="keyword">boolean</span> isClassName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">if</span> (name.startsWith(<span class="string">&quot;javax&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">/* 5 == length(&quot;javax&quot;) */</span></span><br><span class="line">            <span class="keyword">if</span> (name.length() == <span class="number">5</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ch = name.charAt(<span class="number">5</span>);</span><br><span class="line">            <span class="keyword">if</span> (isClassName &amp;&amp; ch == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">/* 6 == length(&quot;javax.&quot;) */</span></span><br><span class="line">                <span class="keyword">if</span> (name.startsWith(<span class="string">&quot;servlet.jsp.jstl.&quot;</span>, <span class="number">6</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (name.startsWith(<span class="string">&quot;el.&quot;</span>, <span class="number">6</span>) ||</span><br><span class="line">                    name.startsWith(<span class="string">&quot;servlet.&quot;</span>, <span class="number">6</span>) ||</span><br><span class="line">                    name.startsWith(<span class="string">&quot;websocket.&quot;</span>, <span class="number">6</span>) ||</span><br><span class="line">                    name.startsWith(<span class="string">&quot;security.auth.message.&quot;</span>, <span class="number">6</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Tomcat ClassLoader 的层次结构</p>
<p align="center"><img width="400px" src="/img/2021/java-classloader-09.png"/><br/>图片来源于网络</p>

<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>动态语言，例如 <code>groovy.lang.GroovyClassLoader</code><br>依赖冲突隔离 <a target="_blank" rel="noopener" href="https://www.zhihu.com/question/46719811/answer/1739289578">https://www.zhihu.com/question/46719811/answer/1739289578</a> 。<br>OSGI 模块化，后来 Java 标准也引入了的模块化。<br>热加载也可以用多个 ClassLoader 来处理（IDEA 重新加载类，不是通过 ClassLoader 实现的）。</p>
<h2 id="ClassLoader-问题排查思路"><a href="#ClassLoader-问题排查思路" class="headerlink" title="ClassLoader 问题排查思路"></a>ClassLoader 问题排查思路</h2><p>在遇到 ClassLoader 相关问题的时候，可以试试如下的思路（一般在有多个 ClassLoader 的时候）</p>
<ol>
<li><code>object.getClass().getClassLoader()</code> / <code>clazz.getClassLoader()</code> 查看某个类的 ClassLoader，判断是否符合预期</li>
<li><code>Thread.currentThread().getContextClassLoader()</code> 获取当前线程上下文 ClassLoader，判断是否符合预期</li>
<li>在遇到类加载相关错误，要能想到可能是 ClassLoader 不对</li>
<li>在使用框架的时候，如果遇到类加载相关错误，要想到可能是 ContextClassLoader 不对</li>
<li><code>object.getClass().getProtectionDomain().getCodeSource()</code> / <code>clazz.getProtectionDomain().getCodeSource()</code> 可以查看某个类加载的路径（如果两个 Jar 包都有相同的类，可以看到最终是加载了哪个 Jar 包的类），判断是否符合预期</li>
<li>能通过 <a target="_blank" rel="noopener" href="https://arthas.aliyun.com/doc/commands.html">arthas</a> 类和类加载相关的命令（<code>sc</code>，<code>classloader</code>，<code>jad</code> 等）来排查问题</li>
</ol>
<p>在修改 contextClassLoader 的时候，要注意恢复上下文，可以参考如下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader classLoader;</span><br><span class="line">ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Thread.currentThread().setContextClassLoader(classLoader);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    Thread.currentThread().setContextClassLoader(contextClassLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="补充：oop-klass-模型"><a href="#补充：oop-klass-模型" class="headerlink" title="补充：oop klass 模型"></a>补充：oop klass 模型</h2><p>上面提到，在 hotspot 代码里面 <code>Klass</code> 是类的底层实现，类加载最终的结果就是创建一个 <code>Klass</code> 对象，<code>oop</code> 是描述对象各种信息的指针，<code>oop klass</code> 模型是 JVM（hotspot）内非常核心的模型。</p>
<figure class="highlight c++"><figcaption><span>hotspot/src/share/vm/oops/klass.hpp</span><a target="_blank" rel="noopener" href="https://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/oops/klass.hpp">klass.hpp</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A Klass provides:</span></span><br><span class="line"><span class="comment">//  1: language level class object (method dictionary etc.)</span></span><br><span class="line"><span class="comment">//  2: provide vm dispatch behavior for the object</span></span><br><span class="line"><span class="comment">// Both functions are combined into one C++ class.</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Klass</span> :</span> <span class="keyword">public</span> Metadata &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p align="center"><img src="/img/2021/java-classloader-11.png"/><br/>图片来源于网络</p>

<p>在 C++层面有多个不同的类来描述这个体系，<code>oop klass</code> 模型这部分内容有兴趣可以自行搜索。</p>
<h3 id="基本类型"><a href="#基本类型" class="headerlink" title="基本类型"></a>基本类型</h3><p><code>int.class</code> 和 <code>java.lang.Integer.class</code> 是不同的，<code>int.class == java.lang.Integer.TYPE</code>。基本类型的值本质上来说不是 <code>oop</code>（也没有类型指针），所以 <code>int.class</code> 更像是 JVM 类型系统的一个特例（<code>create_basic_type_mirror</code> 从名字也能看出来），这些类型也是在 JVM 初始化过程中进行加载的（<code>SystemDictionary::initialize_preloaded_classes</code>）。</p>
<figure class="highlight c++"><figcaption><span>hotspot/src/share/vm/memory/universe.cpp</span><a target="_blank" rel="noopener" href="https://hg.openjdk.java.net/jdk8/jdk8/hotspot/file/87ee5ee27509/src/share/vm/memory/universe.cpp">universe.cpp</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Universe::initialize_basic_type_mirrors</span><span class="params">(TRAPS)</span> </span>&#123;</span><br><span class="line">    assert(_int_mirror==<span class="literal">NULL</span>, <span class="string">&quot;basic type mirrors already initialized&quot;</span>);</span><br><span class="line">    _int_mirror     =</span><br><span class="line">      java_lang_Class::create_basic_type_mirror(<span class="string">&quot;int&quot;</span>,    T_INT, CHECK);</span><br><span class="line">    _float_mirror   =</span><br><span class="line">      java_lang_Class::create_basic_type_mirror(<span class="string">&quot;float&quot;</span>,  T_FLOAT,   CHECK);</span><br><span class="line">    _double_mirror  =</span><br><span class="line">      java_lang_Class::create_basic_type_mirror(<span class="string">&quot;double&quot;</span>, T_DOUBLE,  CHECK);</span><br><span class="line">    _byte_mirror    =</span><br><span class="line">      java_lang_Class::create_basic_type_mirror(<span class="string">&quot;byte&quot;</span>,   T_BYTE, CHECK);</span><br><span class="line">    _bool_mirror    =</span><br><span class="line">      java_lang_Class::create_basic_type_mirror(<span class="string">&quot;boolean&quot;</span>,T_BOOLEAN, CHECK);</span><br><span class="line">    _char_mirror    =</span><br><span class="line">      java_lang_Class::create_basic_type_mirror(<span class="string">&quot;char&quot;</span>,   T_CHAR, CHECK);</span><br><span class="line">    _long_mirror    =</span><br><span class="line">      java_lang_Class::create_basic_type_mirror(<span class="string">&quot;long&quot;</span>,   T_LONG, CHECK);</span><br><span class="line">    _short_mirror   =</span><br><span class="line">      java_lang_Class::create_basic_type_mirror(<span class="string">&quot;short&quot;</span>,  T_SHORT,   CHECK);</span><br><span class="line">    _void_mirror    =</span><br><span class="line">      java_lang_Class::create_basic_type_mirror(<span class="string">&quot;void&quot;</span>,   T_VOID, CHECK);</span><br><span class="line"></span><br><span class="line">    _mirrors[T_INT]     = _int_mirror;</span><br><span class="line">    _mirrors[T_FLOAT]   = _float_mirror;</span><br><span class="line">    _mirrors[T_DOUBLE]  = _double_mirror;</span><br><span class="line">    _mirrors[T_BYTE]    = _byte_mirror;</span><br><span class="line">    _mirrors[T_BOOLEAN] = _bool_mirror;</span><br><span class="line">    _mirrors[T_CHAR]    = _char_mirror;</span><br><span class="line">    _mirrors[T_LONG]    = _long_mirror;</span><br><span class="line">    _mirrors[T_SHORT]   = _short_mirror;</span><br><span class="line">    _mirrors[T_VOID]    = _void_mirror;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数组类型"><a href="#数组类型" class="headerlink" title="数组类型"></a>数组类型</h3><p>需要注意的是数组是 JVM 内部直接生成的，是一个特殊的类型（<code>ArrayKlass</code>）。在定义 <code>SomeClass[] array = new SomeClass[1]</code> 时并不会导致 <code>SomeClass</code> 类的初始化。数组也是 JVM 类型系统的特例。</p>
<h2 id="补充：Java-标准模块化（Java-9-）"><a href="#补充：Java-标准模块化（Java-9-）" class="headerlink" title="补充：Java 标准模块化（Java 9+）"></a>补充：Java 标准模块化（Java 9+）</h2><p>在引入模块化之后，整个类加载机制会有一些变化，后面会单独写一遍文章来讲解。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-5.html">https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-5.html</a><br><a target="_blank" rel="noopener" href="https://hg.openjdk.java.net/jdk8">https://hg.openjdk.java.net/jdk8</a><br><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/findingclasses.html">https://docs.oracle.com/javase/8/docs/technotes/tools/findingclasses.html</a><br><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/spec/security-spec.doc5.html">https://docs.oracle.com/javase/8/docs/technotes/guides/security/spec/security-spec.doc5.html</a><br>《深入理解 Java 虚拟机》<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/mazhimazhi/">https://www.cnblogs.com/mazhimazhi/</a></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Java 进阶 — 类加载机制</p><p><a href="https://www.alphalxy.com/2021/09/java-classloader/">https://www.alphalxy.com/2021/09/java-classloader/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Xinyu Liu</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-09-06</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2022-05-09</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="" rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><i class="fab fa-creative-commons"></i> <i class="fab fa-creative-commons-by"></i> <i class="fab fa-creative-commons-nc"></i> <i class="fab fa-creative-commons-sa"></i> CC BY-NC-SA 4.0</a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <a class="link-muted" rel="tag" href="/tags/java/">java, </a><a class="link-muted" rel="tag" href="/tags/jvm/">jvm, </a><a class="link-muted" rel="tag" href="/tags/classloader/">classloader </a></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/09/quine-java/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Quine 自产生程序 — Java</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2019/03/customize-icarus/"><span class="level-item">Icarus 主题自定义</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/disqusjs@1.2.5/dist/disqusjs.css"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script src="https://cdn.jsdelivr.net/npm/disqusjs@1.2.5/dist/disqus.js"></script><script>new DisqusJS({
            shortname: 'alphalxy-blog',
            apikey: ["5vNlbaVFbUWJEfg45a4W2eS1pGk6YDf3BoRmbUt5oCteUtJalJxdik6EgZWDGICC","M6U0tycmlOwkeadjgjGrrUYJZzR7LFakiur7ad78eImTGkJjqU1lFgHXAPzZHNb8","lVltbGH4pPUYFwdOi0JDh1hmwMRtuUF05Yyc1MyBUoJRBQhn4wQoG90VB0j3N1NJ","uQbbc193Lwj7pyDJRszhRZRs6Kl7PPfpVjAgfN46WNmUoFaqTpiZ7dxkPYL13NNZ","mu8gCIMF7kJw1sxvCsrndjV8HfRzswjS38kjPkpimTIfZ3DmSvA3UK3r7WWVLdNJ"],
            siteName: "Alpha Lxy",
            identifier: "/2021/09/java-classloader/",
            url: "https://www.alphalxy.com/2021/09/java-classloader/",
            title: "Java 进阶 — 类加载机制",
            api: "https://disqus.skk.moe/disqus/",
            
            
            
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level" style="margin-bottom:1rem"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/favicon.svg" alt="Xinyu Liu"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Xinyu Liu</p><p class="is-size-6 is-block">liuxinyu0922@163.com</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Hangzhou, China</span></p></div></div></nav><nav class="level menu-list is-mobile" style="margin-bottom:1rem"><a class="level-item has-text-centered is-marginless" href="/archives/"><div><p class="heading">Posts</p><div><p class="title">14</p></div></div></a><a class="level-item has-text-centered is-marginless" href="/categories/"><div><p class="heading">Categories</p><div><p class="title">7</p></div></div></a><a class="level-item has-text-centered is-marginless" href="/tags/"><div><p class="heading">Tags</p><div><p class="title">11</p></div></div></a></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://www.github.com/AlphaLxy" target="_blank" rel="noopener"><i class="fab fa-github"></i>  Follow</a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Java-应用启动"><span class="level-left"><span class="level-item">1</span><span class="level-item">Java 应用启动</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#IDE-和-maven"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">IDE 和 maven</span></span></a></li><li><a class="level is-mobile" href="#IDE-多模块的-classpath"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">IDE 多模块的 classpath</span></span></a></li><li><a class="level is-mobile" href="#Spring-包扫描与-classpath-的关系"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">Spring 包扫描与 classpath 的关系</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Object-Class-ClassLoader-java-lang"><span class="level-left"><span class="level-item">2</span><span class="level-item">Object Class ClassLoader (java.lang.*)</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#从-JDK-源码看类的加载"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">从 JDK 源码看类的加载</span></span></a></li><li><a class="level is-mobile" href="#Java-虚拟机启动"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">Java 虚拟机启动</span></span></a></li><li><a class="level is-mobile" href="#SystemClassLoader"><span class="level-left"><span class="level-item">2.3</span><span class="level-item">SystemClassLoader</span></span></a></li><li><a class="level is-mobile" href="#MainClass-的加载"><span class="level-left"><span class="level-item">2.4</span><span class="level-item">MainClass 的加载</span></span></a></li><li><a class="level is-mobile" href="#一些结论"><span class="level-left"><span class="level-item">2.5</span><span class="level-item">一些结论</span></span></a></li></ul></li><li><a class="level is-mobile" href="#类的加载、链接、初始化"><span class="level-left"><span class="level-item">3</span><span class="level-item">类的加载、链接、初始化</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#类型判断"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">类型判断</span></span></a></li><li><a class="level is-mobile" href="#双亲委派"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">双亲委派</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#SPI-与-ContextClassLoader"><span class="level-left"><span class="level-item">3.2.1</span><span class="level-item">SPI 与 ContextClassLoader</span></span></a></li><li><a class="level is-mobile" href="#双亲委派机制的破坏"><span class="level-left"><span class="level-item">3.2.2</span><span class="level-item">双亲委派机制的破坏</span></span></a></li></ul></li><li><a class="level is-mobile" href="#类的初始化时机"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">类的初始化时机</span></span></a></li><li><a class="level is-mobile" href="#类加载的相关异常"><span class="level-left"><span class="level-item">3.4</span><span class="level-item">类加载的相关异常</span></span></a></li><li><a class="level is-mobile" href="#类的卸载"><span class="level-left"><span class="level-item">3.5</span><span class="level-item">类的卸载</span></span></a></li></ul></li><li><a class="level is-mobile" href="#自定义-ClassLoader"><span class="level-left"><span class="level-item">4</span><span class="level-item">自定义 ClassLoader</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#如何自定义-ClassLoader"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">如何自定义 ClassLoader</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#覆盖-findClass"><span class="level-left"><span class="level-item">4.1.1</span><span class="level-item">覆盖 findClass</span></span></a></li><li><a class="level is-mobile" href="#覆盖-loadClass"><span class="level-left"><span class="level-item">4.1.2</span><span class="level-item">覆盖 loadClass</span></span></a></li></ul></li><li><a class="level is-mobile" href="#应用场景"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">应用场景</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#SpringBoot"><span class="level-left"><span class="level-item">4.2.1</span><span class="level-item">SpringBoot</span></span></a></li><li><a class="level is-mobile" href="#Tomcat"><span class="level-left"><span class="level-item">4.2.2</span><span class="level-item">Tomcat</span></span></a></li><li><a class="level is-mobile" href="#其他"><span class="level-left"><span class="level-item">4.2.3</span><span class="level-item">其他</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#ClassLoader-问题排查思路"><span class="level-left"><span class="level-item">5</span><span class="level-item">ClassLoader 问题排查思路</span></span></a></li><li><a class="level is-mobile" href="#补充：oop-klass-模型"><span class="level-left"><span class="level-item">6</span><span class="level-item">补充：oop klass 模型</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#基本类型"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">基本类型</span></span></a></li><li><a class="level is-mobile" href="#数组类型"><span class="level-left"><span class="level-item">6.2</span><span class="level-item">数组类型</span></span></a></li></ul></li><li><a class="level is-mobile" href="#补充：Java-标准模块化（Java-9-）"><span class="level-left"><span class="level-item">7</span><span class="level-item">补充：Java 标准模块化（Java 9+）</span></span></a></li><li><a class="level is-mobile" href="#参考"><span class="level-left"><span class="level-item">8</span><span class="level-item">参考</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Alpha Lxy" height="28"></a><p class="is-size-7"><span>&copy; 2022 Xinyu Liu</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">Visited by <span id="busuanzi_value_site_uv">0</span> users</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><i class="fab fa-creative-commons"></i> <i class="fab fa-creative-commons-by"></i> <i class="fab fa-creative-commons-nc"></i> <i class="fab fa-creative-commons-sa"></i> </a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="AlphaLxy GitHub" href="https://www.github.com/AlphaLxy"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/cookieconsent/3.1.1/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.css"><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/katex.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/auto-render.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/KaTeX/0.11.1/contrib/mhchem.js" defer></script><script>window.addEventListener("load", function() {
            document.querySelectorAll('[role="article"] > .content').forEach(function(element) {
                renderMathInElement(element);
            });
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>